CREATE OR ALTER PROC OSP_GetDeliveryList
@Customer VARCHAR(25)
AS
SELECT A.VCHRNO, A.TRNAC, A.MCODE, A.BARCODE, MI.DESCA, MI.MENUCODE, A.RATE, A.CONFACTOR, A.ALTRATE, A.ALTUNIT, A.REALRATE, A.UNIT, A.DELIVEREDQTY, A.INDDISCOUNTRATE, 
SUM(ISNULL(TP_DR.ALTQTY_IN,0)) RETURNQTY, 
SUM(ISNULL(TP_SR.ALTQTY_IN,0)) SRETURNQTY,
SUM(ISNULL(TP_TI.REALQTY,0)) SOLDQTY, 
A.DELIVEREDQTY - SUM(ISNULL(TP_DR.ALTQTY_IN,0)) - SUM(ISNULL(TP_TI.AltQty,0)) - SUM(ISNULL(TP_SR.ALTQTY_IN,0)) REMAININGQTY, 
A.WAREHOUSE,A.REMARKS, A.TOTALFLATDISCOUNT,A.FLATDISCOUNT,A.INDDISCOUNT,A.PRESCRIBEBY FROM
(
	SELECT TM.DIVISION, TM.PhiscalID, TM.VCHRNO, TM.TRNAC, TP.MCODE, TP.BC BARCODE, TP.RATE, ISNULL(TPS.CONFACTOR,1) CONFACTOR, TP.ALTRATE, TP.REALRATE, TP.ALTUNIT, TP.UNIT, 
	SUM(TP.AltQty) DELIVEREDQTY,TP.WAREHOUSE, 
	IIF(TP.AMOUNT = 0 , 0, TP.INDDISCOUNT/TP.AMOUNT) * 100 INDDISCOUNTRATE,
	TM.REMARKS, TM.TOTALFLATDISCOUNT,TP.FLATDISCOUNT,TP.INDDISCOUNT,TM.PRESCRIBEBY FROM INVMAIN TM 
	INNER JOIN INVPROD TP ON TM.VCHRNO=TP.VCHRNO  AND TM.VoucherType = TP.VoucherType
	LEFT JOIN RMD_TRNPROD_STATUS TPS ON TM.VCHRNO = TPS.VCHRNO AND TP.MCODE = TPS.MCODE AND ISNULL(TP.BC,'') = ISNULL(TPS.BC, '') AND TP.SNO = TPS.SNO
	WHERE TM.VoucherType = 'DL' AND (TP.REALQTY-TP.REALQTY_IN)>0 
	AND TM.TRNAC = 'PA640'
	GROUP BY TM.DIVISION,TM.PhiscalID,TM.VCHRNO,TM.TRNAC,TP.MCODE,TP.BC,TP.REALRATE, TP.ALTUNIT,TP.WAREHOUSE, TP.RATE, TP.UNIT, TPS.CONFACTOR, TP.ALTRATE, TP.ALTUNIT, TP.INDDISCOUNT, TP.AMOUNT ,TM.REMARKS, 
	TM.TOTALFLATDISCOUNT,TP.FLATDISCOUNT,TP.INDDISCOUNT,TM.PRESCRIBEBY
) AS A LEFT JOIN MENUITEM MI ON A.MCODE=MI.MCODE
LEFT JOIN 
(
	SELECT * FROM INVPROD WHERE VoucherType = 'DR' AND ISNULL(REALQTY_IN,0)>0
) TP_DR ON A.MCODE=TP_DR.MCODE AND A.VCHRNO=TP_DR.INVOICENO AND A.DIVISION=TP_DR.DIVISION AND COALESCE(A.BARCODE,'') = COALESCE(TP_DR.BC,'')
LEFT JOIN 
(
	SELECT * FROM TRNPROD WHERE VOUCHERTYPE = 'TI' AND ISNULL(REALQTY,0)>0
) TP_TI ON A.MCODE=TP_TI.MCODE AND A.VCHRNO=TP_TI.INVOICENO AND A.DIVISION=TP_TI.DIVISION  AND COALESCE(A.BARCODE,'') = COALESCE(TP_TI.BC,'')
LEFT JOIN 
(
	SELECT * FROM RMD_TRNPROD WHERE VOUCHERTYPE IN ('SR', 'CN') AND ISNULL(REALQTY_IN,0)>0
) TP_SR ON A.MCODE=TP_SR.MCODE AND A.VCHRNO=TP_SR.INVOICENO AND A.DIVISION=TP_SR.DIVISION  AND COALESCE(A.BARCODE,'') = COALESCE(TP_SR.BC,'')
GROUP BY A.VCHRNO,A.TRNAC,A.MCODE,A.BARCODE,MI.DESCA,MI.MENUCODE,A.REALRATE,A.ALTUNIT,A.DELIVEREDQTY,A.WAREHOUSE, A.RATE, A.UNIT, A.CONFACTOR, A.ALTRATE, A.IndDiscountRate, A.REMARKS, A.TOTALFLATDISCOUNT,
A.FLATDISCOUNT,A.INDDISCOUNT,A.PRESCRIBEBY
HAVING DELIVEREDQTY > SUM(ISNULL(TP_TI.REALQTY,0)) + SUM(ISNULL(TP_SR.REALQTY_IN,0)) + SUM(ISNULL(TP_DR.REALQTY_IN,0))
