CREATE OR ALTER VIEW vwInactiveInvoices
AS
SELECT VCHRNO, SUM(Quantity) Quantity, 0 IS_ACTIVE FROM
(
	SELECT A.VCHRNO, SUM(A.Quantity) Quantity FROM SALES_TRNPROD A JOIN (SELECT DISTINCT REFBILL FROM TRNMAIN WHERE VOUCHERTYPE IN ('CN')) B ON A.VCHRNO = B.REFBILL WHERE A.VoucherType IN ('SI', 'TI') 
	GROUP BY A.VCHRNO
	UNION ALL
	SELECT B.REFBILL VCHRNO, - SUM(A.Quantity) Quantity FROM TRNPROD A JOIN TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.VoucherType = B.VoucherType WHERE A.VoucherType IN ('CN') 
	GROUP BY B.REFBILL
) X GROUP BY X.VCHRNO
HAVING SUM(Quantity) = 0