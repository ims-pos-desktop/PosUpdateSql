CREATE OR ALTER PROCEDURE [dbo].[TertiaryMonthlySales]
AS 
IF OBJECT_ID('TEMPDB..#NEPMONTHS') IS NOT NULL DROP TABLE #NEPMONTHS
SELECT MAHINA,MAHINANAME,MINDATE,MAXDATE,N, DATEADD(D,B.N-1,MINDATE) TRNDATE 
INTO #NEPMONTHS FROM  NEPMONTH_FISCAL   CROSS JOIN Tally B 
WHERE DATEADD(D,B.N-1,MINDATE) <= MAXDATE 

SELECT A.MAHINA,A.MAHINANAME, COUNT(DISTINCT B.VCHRNO) [No of Bill Generated],SUM(REALQTY) [Qty Solds],SUM(AMOUNT-DISCOUNT) [Value Realized],
SUM(AMOUNT-DISCOUNT)/COUNT(DISTINCT B.VCHRNO) [Average Ticket Value],
SUM(AMOUNT-DISCOUNT)/SUM(REALQTY) [Avg Garment Realization],SUM(REALQTY)/COUNT(DISTINCT B.VCHRNO) [Avg Basket Size]
FROM #NEPMONTHS A LEFT JOIN SALES_TRNMAIN B ON A.TRNDATE = B.TRNDATE
INNER JOIN  SALES_TRNPROD C ON B.VCHRNO=C.VCHRNO AND B.DIVISION=C.DIVISION 
AND B.PHISCALID=C.PHISCALID
GROUP BY A.MAHINA,A.MAHINANAME


