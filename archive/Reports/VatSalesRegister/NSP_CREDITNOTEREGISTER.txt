ALTER PROCEDURE [dbo].[NSP_CREDITNOTEREGISTER]

--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@TMR VARCHAR(25) = '%',
@DIVISION AS VARCHAR(25) = '%'

AS

--SET @DATE1 = '01-15-16'; SET @DATE2 = '01-15-17';SET @TMR = '%'; SET @DIV = '%'
set nocount on
IF OBJECT_ID('TEMPDB..#REPORT') is not null drop table #REPORT

SELECT TRNDATE, BSDATE, VCHRNO, REFBILL,
CASE WHEN BILLTO = '' THEN CASE WHEN TRNMODE = 'CASH' THEN 'Cash Sales' ELSE ACNAME END ELSE BILLTO END  AS PARTICULARS,
CASE WHEN BILLTOTEL = '' THEN CASE WHEN TRNMODE = 'CASH' THEN '' ELSE VATNO END ELSE BILLTOTEL END  AS VATNO,
(TAXABLE+NONTAXABLE+DCAMNT) NET,NONTAXABLE AS NONTAXABLE,NULL ZERORATED,TAXABLE,VATAMNT,DCAMNT, REMARKS,
ISNULL(VNUM,VCHRNO) VNO,DIVISION INTO #REPORT 
FROM RMD_TRNMAIN, RMD_ACLIST WHERE RMD_TRNMAIN.TRNAC = RMD_ACLIST.ACID AND LEFT(VCHRNO,2) in ('CN','SR')
AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND ISNULL(TERMINAL,'') LIKE @TMR 		
AND DIVISION LIKE @DIVISION 

SELECT TRNDATE,BSDATE,VCHRNO,REFBILL, PARTICULARS,VATNO,CONVERT(VARCHAR,CAST(NET AS MONEY),1)NET,CONVERT(VARCHAR,CAST(NONTAXABLE AS MONEY),1) NONTAXABLE,CONVERT(VARCHAR,CAST(ZERORATED AS MONEY),1) ZERORATED,
CONVERT(VARCHAR,CAST(TAXABLE AS MONEY),1) TAXABLE,CONVERT(VARCHAR,CAST(VATAMNT AS MONEY),1) VATAMNT,CONVERT(VARCHAR,CAST(DCAMNT AS MONEY),1) DCAMNT,REMARKS,VCHRNO,DIVISION, [TYPE] FROM
(
SELECT TRNDATE,BSDATE,VCHRNO,REFBILL,PARTICULARS,VATNO,NET,NONTAXABLE,ZERORATED,TAXABLE,VATAMNT,DCAMNT, REMARKS,VNO,DIVISION,'A' FLG, 'A' [TYPE] FROM #REPORT
UNION ALL
SELECT NULL,NULL,NULL,NULL,'TOTAL >>' PARTICULARS,NULL VATNO,SUM(NET),SUM(NONTAXABLE),SUM(ZERORATED),SUM(TAXABLE),SUM(VATAMNT), SUM(DCAMNT), NULL REMARKS,NULL VNO,NULL DIVISION,'B' FLG, 'G' [TYPE] FROM #REPORT
)A ORDER BY FLG,TRNDATE, left(VNO,2),CAST(SUBSTRING(VNO,3,LEN(VNO)) AS NUMERIC)
