CREATE OR ALTER   PROCEDURE [dbo].[TertiaryMonthlyFootFallSales] 
@DATE1 DATE =NULL,
@DATE2 DATE = NULL,
@DIVISION VARCHAR(3) = '%',
@OPT_VATINCLUSIVE TINYINT = 1
AS 
SET NOCOUNT ON;
--DECLARE @DATE1 DATE ='16-JUL-2014',@DATE2 DATE = '17-AUG-2019'
DECLARE @FBDATE DATE,@FEDATE DATE
SELECT @FBDATE=FBDATE,@FEDATE = FEDATE FROM COMPANY ;
IF @DATE1 IS NULL SET @DATE1  = @FBDATE;
IF @DATE2 IS NULL SET @DATE2 = @FEDATE;
IF OBJECT_ID('TEMPDB..#NEPMONTHS') IS NOT NULL DROP TABLE #NEPMONTHS


SELECT SAL,A.MAHINA,MAHINANAME,MINDATE,MAXDATE,AD TRNDATE 
INTO #NEPMONTHS
FROM
	(
	SELECT LEFT(MITI,2) GATE,SUBSTRING(MITI,4,2) MAHINA,SUBSTRING(MITI,7,4) SAL,AD,
	MIN(AD) OVER (PARTITION BY  SUBSTRING(MITI,7,4), SUBSTRING(MITI,4,2)) MINDATE,
	MAX(AD) OVER (PARTITION BY SUBSTRING(MITI,7,4),SUBSTRING(MITI,4,2)) MAXDATE  
	FROM DATEMITI A 
		WHERE AD BETWEEN @DATE1 AND @DATE2  
	) A INNER JOIN NEPMONTH  B ON A.MAHINA=B.MAHINA

SELECT A.SAL,A.MAHINA,A.MAHINANAME,B.Footfall,[No of Bill Generated],[Qty Solds],cast(cast((([No of Bill Generated]/B.Footfall) *100) as decimal(5,2)) as varchar(20)) + '%' [Conversion],[Value Realized],[Average Ticket Value],
[Avg Garment Realization],[Avg Basket Size] FROM 
(
SELECT A.SAL,A.MAHINA,A.MAHINANAME, CAST(COUNT(DISTINCT B.VCHRNO) AS DECIMAL(5,2)) [No of Bill Generated],SUM(REALQTY) [Qty Solds],
CASE WHEN @OPT_VATINCLUSIVE = 0 THEN SUM(AMOUNT-DISCOUNT) ELSE SUM(NETAMOUNT) END [Value Realized],
CASE WHEN @OPT_VATINCLUSIVE = 0 THEN SUM(AMOUNT-DISCOUNT) ELSE SUM(NETAMOUNT) END/COUNT(DISTINCT B.VCHRNO) [Average Ticket Value],
CASE WHEN @OPT_VATINCLUSIVE = 0 THEN SUM(AMOUNT-DISCOUNT) ELSE SUM(NETAMOUNT) END/SUM(REALQTY) [Avg Garment Realization],SUM(REALQTY)/COUNT(DISTINCT B.VCHRNO) [Avg Basket Size]
FROM #NEPMONTHS A LEFT JOIN SALES_TRNMAIN B ON A.TRNDATE = B.TRNDATE
LEFT JOIN  SALES_TRNPROD C ON B.VCHRNO=C.VCHRNO AND B.DIVISION=C.DIVISION 
AND B.PHISCALID=C.PHISCALID
WHERE B.DIVISION LIKE @DIVISION AND B.VoucherType IN ('SI', 'TI')
GROUP BY A.SAL,A.MAHINA,A.MAHINANAME) A
LEFT JOIN 
(
SELECT A.SAL,A.MAHINA,SUM(B.TOTALFOOTFALLS)  Footfall FROM #NEPMONTHS A LEFT JOIN Footfall B ON A.TRNDATE=B.Date
GROUP BY A.SAL,A.MAHINA
) B ON A.SAL=B.SAL AND A.MAHINA=B.MAHINA
ORDER BY A.SAL,A.MAHINA 

--DROP TABLE #NEPMONTHS
SET NOCOUNT OFF

--SELECT * FROM #NEPMONTHS ORDER BY TRNDATE