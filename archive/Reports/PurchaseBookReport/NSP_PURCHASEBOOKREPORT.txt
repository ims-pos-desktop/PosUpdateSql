CREATE OR ALTER PROCEDURE [dbo].[NSP_PURCHASEBOOKREPORT]

--DECLARE
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIV varchar(10)='%',
	@VOUCHER_TYPE CHAR(2) = 'SI',
	@INCLUDE_RETURN TINYINT = 0,									--	0 Exclude Return   1 Include Return
	@REPORT_TYPE TINYINT = 0,										--  0 VOUCHER WISE  1 DAY WISE  2 MONTH WISE	
	@SHOWDETAL_REPORT TINYINT = 0,									--  0 SUMMARY REPORT  1 DETAIL REPORT
	@VCHR VARCHAR(25) = 'A',
	@PARTY VARCHAR(25) = '%',
	@INAD TINYINT = 0												-- 0 ENGLISH DATE  1 NEPALI DATE
AS

--SET @DATE1 = '01-01-2017'; SET @DATE2 = '01-01-2019'; SET @DIV  ='%'; SET @VOUCHER_TYPE = 'PI'; SET @INCLUDE_RETURN = 0 ; SET @REPORT_TYPE = 3 ; SET @SHOWDETAL_REPORT = 0 ; SET @VCHR = 'X' ; 
--SET @PARTY = '%'; SET @INAD =0

set nocount on

DECLARE @V1 VARCHAR(2),@V2 VARCHAR(2),@V3 VARCHAR(2),@V4 VARCHAR(2),@V5 VARCHAR(2)
BEGIN 
	SET @V1 = @VOUCHER_TYPE
	IF @INCLUDE_RETURN = 1
		BEGIN
			SET @V4 = 'DN';SET @V5 = 'PR'
		END
	ELSE
		BEGIN
			SET @V4 = 'A~';SET @V5 = 'B~'
		END
END

BEGIN	
	IF @REPORT_TYPE = 1		--VOUCHER WISE
		BEGIN
			IF OBJECT_ID('TEMPDB..#RMD_TRNMAIN') is not null drop table #RMD_TRNMAIN
			IF OBJECT_ID('TEMPDB..#TRNMAIN') is not null drop table #TRNMAIN

			SELECT TRNDATE,DIVISION,BSDATE, ISNULL(BILLTO,'') AS BILLTO,VCHRNO,CHALANNO,TRNMODE,TRNAC, TOTAMNT,DCAMNT,TAXABLE,NONTAXABLE,VATAMNT,NETAMNT,
			REMARKS,ISNULL(REFBILL,'')REFBILL,ISNULL(VNUM,VCHRNO)VNUM,TRNTIME,TRNUSER,PHISCALID 
			INTO #RMD_TRNMAIN FROM RMD_TRNMAIN WHERE LEFT(VCHRNO,2) IN (@V1,@V4,@V5) AND DIVISION LIKE @DIV AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) 
			AND TRNAC LIKE @PARTY 

			SELECT A.TRNDATE,A.BSDATE, A.VCHRNO, A.REFBILL REFNO, 
			CASE WHEN A.TRNMODE = 'Cash' THEN CASE WHEN ISNULL(A.BILLTO,'') <> '' THEN A.BILLTO ELSE B.ACNAME END ELSE B.ACNAME END AS PARTY,A.TRNMODE,
			CASE WHEN LEFT(VCHRNO,2) IN (@V4,@V5) THEN A.TOTAMNT *-1 ELSE A.TOTAMNT END AS TOTAMNT,
			CASE WHEN LEFT(VCHRNO,2) IN (@V4,@V5) THEN A.DCAMNT *-1 ELSE A.DCAMNT END AS DCAMNT,
			CASE WHEN LEFT(VCHRNO,2) IN (@V4,@V5) THEN (A.TAXABLE + A.NONTAXABLE) *-1 ELSE (A.TAXABLE + A.NONTAXABLE) END AS NETSALE,
			CASE WHEN LEFT(VCHRNO,2) IN (@V4,@V5) THEN A.NONTAXABLE  * -1 ELSE A.NONTAXABLE END AS NONTAXABLE,
			CASE WHEN LEFT(VCHRNO,2) IN (@V4,@V5) THEN A.TAXABLE  * -1 ELSE A.TAXABLE END AS TAXABLE,
			CASE WHEN LEFT(VCHRNO,2) IN (@V4,@V5) THEN A.VATAMNT * -1 ELSE A.VATAMNT END AS VATAMNT,
			CASE WHEN LEFT(VCHRNO,2) IN (@V4,@V5) THEN A.NETAMNT * -1 ELSE A.NETAMNT END AS TOTAL,
			A.TRNTIME,A.TRNUSER,X.NAME DIVNAME,VNUM, A.DIVISION,A.PHISCALID,A.REMARKS INTO #TRNMAIN FROM 
			#RMD_TRNMAIN AS A LEFT JOIN RMD_ACLIST B ON A.TRNAC = B.ACID LEFT JOIN DIVISION X ON A.DIVISION = X.INITIAL
			 
			
			IF @SHOWDETAL_REPORT = 0		-- SUMMARY REPORT					
				SELECT * FROM 
				(
					SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.REFNO,A.TRNMODE,A.TOTAMNT,A.DCAMNT,0 STAX,A.NETSALE,A.NONTAXABLE,A.TAXABLE,A.VATAMNT,A.TOTAL, A.REMARKS,A.PARTY, A.DIVNAME,A.TRNUSER,A.VNUM,A.DIVISION,'A' FLG FROM #TRNMAIN A
					UNION ALL
					SELECT NULL TRNDATE,NULL BSDATE,NULL VCHRNO,NULL REFNO,'TOTAL >>' TRNMODE,SUM(A.TOTAMNT),SUM(A.DCAMNT),0,SUM(A.NETSALE),SUM(A.NONTAXABLE),SUM(A.TAXABLE),SUM(A.VATAMNT),SUM(A.TOTAL),NULL REMARKS,NULL PARTY,NULL DIVISION,NULL TRNUSER,'ZZ9999999' VNO,NULL DIVID,'B' FLG FROM #TRNMAIN A
				) A ORDER BY FLG, TRNDATE,left(VNUM,2),CAST(RIGHT(A.VNUM,len(A.VNUM)-2) as numeric)

			ELSE			-- DETAIL REPORT
				BEGIN
					--print @v4
					--print @v5
					IF OBJECT_ID('TEMPDB..#RMD_TRNPROD') is not null drop table #RMD_TRNPROD

					select NULL AS TRNDATE, '' AS BSDATE, '' AS VCHRNO, C.MENUCODE AS MENUCODE,CASE WHEN ISNULL(C.ISUNKNOWN,0) = 0 THEN C.DESCA ELSE A.MANUFACTURER END AS PRODUCT,
					A.UNIT, CASE WHEN LEFT(A.VCHRNO,2) ='PI' THEN A.REALQTY_IN ELSE  A.REALQTY END AS QUANTITY,  A.RATE AS RATE, A.AMOUNT, 
					CASE WHEN(A.DISCOUNT =0) THEN NULL ELSE A.DISCOUNT END AS DISCOUNT,0 SERVICETAX, 
					A.TAXABLE,A.NONTAXABLE,CASE WHEN (A.VAT = 0) THEN NULL ELSE A.VAT END AS VAT,(A.TAXABLE+A.NONTAXABLE+A.VAT) NETAMNT,B.VNUM,A.DIVISION,B.TRNDATE TDATE INTO #RMD_TRNPROD FROM RMD_TRNPROD A INNER JOIN
					#TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PHISCALID = B.PHISCALID INNER JOIN MENUITEM C ON A.MCODE = C.MCODE
			

					SELECT * FROM 
					(
					SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.REFNO,A.PARTY,A.TRNMODE,X.QTY, NULL RATE,A.TOTAMNT,A.DCAMNT,0 STAX,A.NONTAXABLE,A.TAXABLE,A.VATAMNT,A.TOTAL,A.REMARKS,A.TRNTIME, A.TRNUSER,A.DIVNAME,A.VNUM,A.DIVISION,'A' FLG,A.TRNDATE TDATE FROM #TRNMAIN A
					INNER JOIN (SELECT VNUM,DIVISION,SUM(CASE WHEN LEFT(VNUM,2) IN (@V4 ,@V5) THEN QUANTITY*-1 ELSE QUANTITY END) QTY FROM #RMD_TRNPROD GROUP BY VNUM,DIVISION) X ON A.VNUM =X.VNUM AND A.DIVISION = X.DIVISION
					UNION ALL
					SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.MENUCODE,A.PRODUCT,A.UNIT,A.QUANTITY,A.RATE,A.AMOUNT,A.DISCOUNT,0 SERVICETAX,A.NONTAXABLE,A.TAXABLE,A.VAT,A.NETAMNT,NULL PAXNO,NULL TRNTIME,NULL TRNUSER,NULL DIVISION,A.VNUM, NULL DIVID,'B' FLG,A.TDATE FROM #RMD_TRNPROD A
					UNION ALL
					SELECT NULL TRNDATE,NULL BSDATE,NULL VCHRNO,NULL CHALANNO,NULL PARTY,NULL TRNMODE,NULL QTY, NULL RATE,NULL TOTAMNT,NULL DCAMNT,NULL STAX,NULL NONTAXABLE,NULL TAXABLE,NULL VATAMNT,NULL TOTAL,NULL PAXNO,NULL TRNTIME, NULL TRNUSER,NULL DIVISION,A.VNUM,A.DIVISION DIVID,'C' FLG,A.TRNDATE TDATE FROM #TRNMAIN A
					UNION ALL

					SELECT NULL TRNDATE,NULL BSDATE,NULL VCHRNO,NULL CHALANNO,'TOTAL >>' PARTY,NULL TRNMODE,SUM(QTY) QTY, NULL RATE,SUM(A.TOTAMNT)TOTAMNT,SUM(A.DCAMNT)DCAMNT,
					0 STAX,SUM(A.NONTAXABLE) NONTAXABLE,SUM(A.TAXABLE) TAXABLE,SUM(A.VATAMNT) VATAMMT,SUM(A.TOTAL) TOTAL,NULL REMARKS, NULL TRNTIME, NULL TRNUSER,
					NULL DIVISION,'ZZ99999999'  VNUM,NULL DIVID,'D' FLG,'01-01-2045' TDATE FROM 
					(SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.REFNO,A.PARTY,A.TRNMODE,X.QTY, NULL RATE,A.TOTAMNT,A.DCAMNT,0 STAX,A.NONTAXABLE,A.TAXABLE,A.VATAMNT,A.TOTAL,NULL PAXNO,A.TRNTIME, A.TRNUSER,A.DIVNAME,A.VNUM,A.DIVISION,'A' FLG FROM #TRNMAIN A
					INNER JOIN (SELECT VNUM,DIVISION,SUM(CASE WHEN LEFT(VNUM,2) IN (@V4 ,@V5) THEN QUANTITY*-1 ELSE QUANTITY END) QTY FROM #RMD_TRNPROD GROUP BY VNUM,DIVISION) X ON A.VNUM =X.VNUM AND A.DIVISION = X.DIVISION
					) A
					) A ORDER BY TDATE, LEFT(VNUM,2), CAST(RIGHT(VNUM,LEN(VNUM)-2) AS NUMERIC),FLG

					IF OBJECT_ID('TEMPDB..#RMD_TRNPROD') is not null drop table #RMD_TRNPROD
				
				END
			END
	ELSE IF @REPORT_TYPE = 2		-- DAY WISE 		

		SELECT TRNDATE, BSDATE,SUM(TOTAMNT) AS TOTAMNT, SUM(DCAMNT) AS DCAMNT, 0 STAX, SUM(NETAMNT) AS NETAMNT, SUM(NONTAXABLE) AS NONTAXABLE,SUM(TAXABLE) AS TAXABLE, SUM(VATAMNT) AS VATAMNT, SUM(TAMNT) AS TAMNT,SUM(CASH) AS CASH, 0 CCARD, SUM(CREDIT) AS CREDIT,0 GVOUCHER,0 PREPAID,0 [ONLINE],0 PAXNO 
		FROM
		(
		SELECT A.TRNDATE,A.BSDATE, 
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.TOTAMNT *-1 ELSE A.TOTAMNT END AS TOTAMNT,
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.DCAMNT *-1 ELSE A.DCAMNT END AS DCAMNT,
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.STAX *-1 ELSE A.STAX END AS STAX,
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN (A.TAXABLE + A.NONTAXABLE)*-1 ELSE (A.TAXABLE + A.NONTAXABLE)  END AS NETAMNT,
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.NONTAXABLE  * -1 ELSE A.NONTAXABLE END AS NONTAXABLE,
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.TAXABLE  * -1 ELSE A.TAXABLE END AS TAXABLE,
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.VATAMNT * -1 ELSE A.VATAMNT END AS VATAMNT,
		CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.NETAMNT * -1 ELSE A.NETAMNT END AS TAMNT,
		CASE WHEN (TRNMODE = 'CASH') THEN CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN NETAMNT *-1 ELSE NETAMNT END ELSE 0 END CASH,
		CASE WHEN (TRNMODE = 'CREDIT') THEN CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN NETAMNT * -1 ELSE NETAMNT END ELSE null END AS CREDIT,
		DIVISION FROM RMD_TRNMAIN A WHERE 
		LEFT(A.VCHRNO,2) IN (@V1,@V2,@V3,@V4,@V5) AND A.DIVISION LIKE @DIV AND (A.TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) AND A.TRNAC LIKE @PARTY 
		) A
		GROUP BY TRNDATE, BSDATE ORDER BY TRNDATE
			
	ELSE IF @REPORT_TYPE = 3				-- MONTH WISE
		
		BEGIN
			
			DECLARE @BDATE DATETIME; DECLARE @EDATE DATETIME;DECLARE @BDATE_BS VARCHAR(25); DECLARE @EDATE_BS VARCHAR(25)
			SELECT @BDATE = FBDATE,@EDATE = FEDATE,@BDATE_BS = FBDATE_BS,@EDATE_BS = FEDATE_BS FROM COMPANY
					
			IF @INAD = 1	-- REPORT IN ENGLISH DATE				
				--SELECT * FROM DBO.GETMONTHLIST('01-01-2017','01-01-2018')

				SELECT  B.MNAME PARTICULARS,SUM(TOTAMNT) AS TOTAMNT, SUM(DCAMNT) AS DCAMNT,SUM(STAX)STAX, SUM(NETAMNT) AS NETAMNT, SUM(NONTAXABLE) AS NONTAXABLE, SUM(TAXABLE) AS TAXABLE, SUM(VATAMNT) AS VATAMNT, SUM(TAMNT) AS TAMNT,SUM(CASH) AS CASH, 0 AS CCARD, SUM(CREDIT) AS CREDIT,0 GVOUCHER,0 OTHERS,0 [ONLINE],0 PAXNO, MON, YER
				FROM DBO.GETMONTHLIST(@BDATE,@EDATE) B LEFT JOIN 
				(
				SELECT * FROM (
				SELECT CAST(DATEPART(m,A.TRNDATE) AS NUMERIC) AS MON, CAST(DATEPART(yy,A.TRNDATE) AS NUMERIC) AS YER, 
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.TOTAMNT *-1 ELSE A.TOTAMNT END AS TOTAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.DCAMNT *-1 ELSE A.DCAMNT END AS DCAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.STAX *-1 ELSE A.STAX END AS STAX,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN (A.TAXABLE + A.NONTAXABLE)*-1 ELSE (A.TAXABLE + A.NONTAXABLE)  END AS NETAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.NONTAXABLE  * -1 ELSE A.NONTAXABLE END AS NONTAXABLE,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.TAXABLE  * -1 ELSE A.TAXABLE END AS TAXABLE,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.VATAMNT * -1 ELSE A.VATAMNT END AS VATAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.NETAMNT * -1 ELSE A.NETAMNT END AS TAMNT,
				CASE WHEN (TRNMODE = 'CASH') THEN CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN NETAMNT *-1 ELSE NETAMNT END ELSE 0 END CASH,
				CASE WHEN (TRNMODE = 'CREDIT') THEN CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN NETAMNT * -1 ELSE NETAMNT END ELSE null END AS CREDIT,
				DIVISION FROM RMD_TRNMAIN A WHERE 
				LEFT(A.VCHRNO,2) IN (@V1,@V4,@V5) AND A.DIVISION LIKE @DIV AND (A.TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) AND A.TRNAC LIKE @PARTY
				) AS Z 
				) A ON A.MON = B.ID AND A.YER = B.YNAME GROUP BY B.MNAME,A.MON,A.YER  ORDER BY YER,MON
			
			ELSE	-- REPORT IN NEPALI MONTH
						
				SELECT  B.MNAME PARTICULARS,SUM(TOTAMNT) AS TOTAMNT, SUM(DCAMNT) AS DCAMNT,SUM(STAX)STAX, SUM(NETAMNT) AS NETAMNT, SUM(NONTAXABLE) AS NONTAXABLE, SUM(TAXABLE) AS TAXABLE, SUM(VATAMNT) AS VATAMNT, SUM(TAMNT) AS TAMNT,SUM(CASH) AS CASH, 0 CCARD, SUM(CREDIT) AS CREDIT,0 GVOUCHER,0 OTHERS,0 [ONLINE],0 PAXNO, MON, YER
				FROM DBO.GETNEPALIMONTHLIST(@BDATE_BS,@EDATE_BS) B LEFT JOIN 
				(
				SELECT * FROM
				(
				SELECT CAST(RIGHT(LEFT(BSDATE,5),2) AS NUMERIC) AS MON, CAST(RIGHT(BSDATE,4) AS NUMERIC) AS YER,  
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.TOTAMNT *-1 ELSE A.TOTAMNT END AS TOTAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.DCAMNT *-1 ELSE A.DCAMNT END AS DCAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.STAX *-1 ELSE A.STAX END AS STAX,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN (A.TAXABLE + A.NONTAXABLE)*-1 ELSE (A.TAXABLE + A.NONTAXABLE)  END AS NETAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.NONTAXABLE  * -1 ELSE A.NONTAXABLE END AS NONTAXABLE,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.TAXABLE  * -1 ELSE A.TAXABLE END AS TAXABLE,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.VATAMNT * -1 ELSE A.VATAMNT END AS VATAMNT,
				CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN A.NETAMNT * -1 ELSE A.NETAMNT END AS TAMNT,
				CASE WHEN (TRNMODE = 'CASH') THEN CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN NETAMNT *-1 ELSE NETAMNT END ELSE 0 END CASH,
				CASE WHEN (TRNMODE = 'CREDIT') THEN CASE WHEN LEFT(VCHRNO,2) IN (@V3,@V4,@V5) THEN NETAMNT * -1 ELSE NETAMNT END ELSE null END AS CREDIT,
				DIVISION FROM RMD_TRNMAIN A WHERE 
				LEFT(A.VCHRNO,2) IN (@V1,@V4,@V5) AND A.DIVISION LIKE @DIV AND (A.TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) AND A.TRNAC LIKE @PARTY
				) AS Z 
				) A ON A.MON = B.ID AND A.YER = B.YNAME GROUP BY B.MNAME,A.MON,A.YER  ORDER BY YER,MON
			
			
		END
END		
