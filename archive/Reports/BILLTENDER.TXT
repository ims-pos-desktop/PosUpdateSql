CREATE OR ALTER VIEW [dbo].[BILLTENDER]
AS
	SELECT A.VCHRNO VNO,A.DIVISION DIV,
	SUM(CASE WHEN A.TRNMODE = 'CASH' THEN A.AMOUNT ELSE 0 END) CASH,
	SUM(CASE WHEN A.TRNMODE = 'CREDIT' THEN A.AMOUNT ELSE 0 END) CREDIT,
	SUM(CASE WHEN A.TRNMODE IN ('CREDITCARD', 'CREDIT CARD')  THEN A.AMOUNT ELSE 0 END) CREDITCARD,
	SUM(CASE WHEN A.TRNMODE = 'CHEQUE' THEN A.AMOUNT ELSE 0 END) CHEQUE,
	SUM(CASE WHEN A.TRNMODE IN ('GIFTVOUCHER', 'Gift Voucher') THEN A.AMOUNT ELSE 0 END) GIFTVOUCHER,
	SUM(CASE WHEN A.TRNMODE = 'CREDITVOUCHER' THEN A.AMOUNT ELSE 0 END) CREDITVOUCHER,	
	SUM(CASE WHEN A.TRNMODE = 'PREPAID' THEN A.AMOUNT ELSE 0 END) PREPAID,
	SUM(CASE WHEN A.TRNMODE = 'ONLINE' THEN A.AMOUNT ELSE 0 END) ONLINE,
	SUM(CASE WHEN A.TRNMODE = 'Sales Return Voucher' THEN A.AMOUNT ELSE 0 END) SalesReturnVoucher,
	SUM(CASE WHEN A.TRNMODE = 'Complimentary' THEN A.AMOUNT ELSE 0 END) Complimentary,
	SUM(CASE WHEN A.TRNMODE = 'CASH' THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NCASH,
	SUM(CASE WHEN A.TRNMODE = 'CREDIT' THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NCREDIT,
	SUM(CASE WHEN A.TRNMODE IN ('CREDITCARD', 'CREDIT CARD') THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NCREDITCARD,
	SUM(CASE WHEN A.TRNMODE IN ('GIFTVOUCHER', 'Gift Voucher') THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NGVOUCHER,
	SUM(CASE WHEN A.TRNMODE = 'CREDITVOUCHER' THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NCVOUCHER,	
	SUM(CASE WHEN A.TRNMODE = 'PREPAID' THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NPREPAID,
	SUM(CASE WHEN A.TRNMODE = 'ONLINE' THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) N_ONLINE,
	SUM(CASE WHEN A.TRNMODE = 'Sales Return Voucher' THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NSalesReturnVoucher,
	SUM(CASE WHEN A.TRNMODE = 'Complimentary' THEN CASE WHEN VoucherType IN ('CN','RE') THEN AMOUNT*-1 ELSE AMOUNT END ELSE 0 END) NComplimentary,
	A.PHISCALID,SUM(ISNULL(B.CHANGE,0)) CHANGE,
	SUM(CASE WHEN A.TRNMODE = 'CASH' THEN CASE WHEN VoucherType IN ('CN','RE') THEN (AMOUNT- ISNULL(B.CHANGE,0))*-1 ELSE 
	A.AMOUNT- ISNULL(B.CHANGE,0) END ELSE 0 END) NETCASH, A.SALESMANID
	FROM RMD_BILLTENDER A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PHISCALID = B.PHISCALID 
	GROUP BY A.VCHRNO,A.DIVISION,A.PHISCALID, A.SALESMANID


