CREATE OR ALTER PROCEDURE OSP_GetEditableStock 
--DECLARE
@VCHRNO VARCHAR(50)
AS
--SELECT @VCHRNO ='PI10-MMD-79/80'

DECLARE @PURDATE DATE
DECLARE @DIVISION VARCHAR(3)
DECLARE @PHISCALID VARCHAR(10)
DECLARE @BCStock BIT
DECLARE @BatchWiseStock BIT

SELECT @BCStock = CONVERT(BIT,COALESCE(EnableBarcodeDetails,0)), @BatchWiseStock = EnableBatch FROM SETTING

SELECT @PURDATE = TRNDATE, @DIVISION = DIVISION, @PHISCALID = PhiscalId FROM RMD_TRNMAIN WITH (NOLOCK) WHERE VCHRNO = @VCHRNO

--ISOLATE transactional data related voucher into #TRAN
SELECT M.TRNDATE, P.VCHRNO, P.DIVISION, P.PHISCALID, P.WAREHOUSE, P.MCODE, SUM(REALQTY_IN) REALQTY_IN, SUM(REALQTY) REALQTY,
IIF(@BCStock=1 OR MI.PTYPE = 4, COALESCE(BC,''), '') BC,
CASE WHEN @BatchWiseStock = 1 THEN COALESCE(BATCH, '') ELSE '' END BATCH
INTO #TRAN
FROM RMD_TRNMAIN M WITH (NOLOCK) JOIN RMD_TRNPROD P WITH (NOLOCK) ON M.VCHRNO = P.VCHRNO 
JOIN
(	
	SELECT MCODE FROM RMD_TRNPROD WHERE VCHRNO = @VCHRNO
) PUR ON P.MCODE = PUR.MCODE 
JOIN MENUITEM MI ON P.MCODE = MI.MCODE
WHERE P.DIVISION = @DIVISION AND P.PhiscalID = @PHISCALID
GROUP BY M.TRNDATE, P.VCHRNO, P.DIVISION, P.PHISCALID, P.WAREHOUSE, P.MCODE,
IIF(@BCStock=1 OR MI.PTYPE = 4, COALESCE(BC,''), ''),
CASE WHEN @BatchWiseStock = 1 THEN COALESCE(BATCH, '') ELSE '' END

--SELECT * FROM #TRAN
--Calculate Editable Stock
SELECT P.MCODE, P.BC, P.BATCH, P.REALQTY_IN InvoiceQtyIn, P.REALQTY InvoiceQtyOut, TRAN_IN.WAREHOUSE, ISNULL(TRAN_IN.REALQTY_IN,0) TotalInWardStock, ISNULL(TRAN_OUT.REALQTY,0) TotalOutWardStock, 
IIF(ISNULL(TRAN_IN.REALQTY_IN,0) > ISNULL(TRAN_OUT.REALQTY,0), ISNULL(TRAN_IN.REALQTY_IN,0) - ISNULL(TRAN_OUT.REALQTY,0), 0) EditableQty FROM #TRAN P
LEFT JOIN
(
	SELECT MCODE, BC, BATCH, WAREHOUSE, SUM(REALQTY_IN) REALQTY_IN FROM #TRAN WHERE TRNDATE <= @PURDATE 
	GROUP BY MCODE, BC,BATCH, WAREHOUSE
	HAVING SUM(REALQTY_IN) > 0
) TRAN_IN ON P.MCODE = TRAN_IN.MCODE AND P.BC = TRAN_IN.BC AND P.BATCH = TRAN_IN.BATCH AND P.WAREHOUSE = TRAN_IN.WAREHOUSE
LEFT JOIN
(
	SELECT MCODE, BC, BATCH, WAREHOUSE, SUM(RealQty) REALQTY FROM #TRAN 
	GROUP BY MCODE, BC,BATCH, WAREHOUSE
	HAVING SUM(RealQty) > 0
) TRAN_OUT ON P.MCODE = TRAN_OUT.MCODE AND P.BC = TRAN_OUT.BC AND P.BATCH = TRAN_OUT.BATCH  AND P.WAREHOUSE = TRAN_OUT.WAREHOUSE
WHERE P.VCHRNO = @VCHRNO --AND TRAN_IN.WAREHOUSE IS NOT NULL AND TRAN_OUT.WAREHOUSE IS NOT NULL

DROP TABLE #TRAN
