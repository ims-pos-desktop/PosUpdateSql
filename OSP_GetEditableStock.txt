CREATE OR ALTER  PROCEDURE OSP_GetEditableStock 
@VCHRNO VARCHAR(50)
AS
--DECLARE @VCHRNO VARCHAR(25) = 'PI2-MMM-78/79'
DECLARE @PURDATE DATE
DECLARE @DIVISION VARCHAR(3)
DECLARE @PHISCALID VARCHAR(10)
DECLARE @BarcodeWiseStock BIT
DECLARE @BatchWiseStock BIT

SELECT @BarcodeWiseStock = CONVERT(BIT,COALESCE(EnableBarcodeDetails,0)) & CONVERT(BIT,COALESCE(HasVehicleSale,0)), @BatchWiseStock = EnableBatch FROM SETTING
PRINT @BarcodeWiseStock
SELECT @PURDATE = TRNDATE, @DIVISION = DIVISION, @PHISCALID = PhiscalId FROM RMD_TRNMAIN WITH (NOLOCK) WHERE VCHRNO = @VCHRNO

--ISOLATE transactional data related voucher into #TRAN
SELECT M.TRNDATE, P.VCHRNO, P.DIVISION, P.PHISCALID, P.WAREHOUSE, P.MCODE, SUM(REALQTY_IN) REALQTY_IN, SUM(REALQTY) REALQTY,
CASE WHEN @BarcodeWiseStock = 1 THEN COALESCE(BC, '') ELSE '' END BC,
CASE WHEN @BatchWiseStock = 1 THEN COALESCE(BATCH, '') ELSE '' END BATCH
INTO #TRAN
FROM RMD_TRNMAIN M WITH (NOLOCK) JOIN RMD_TRNPROD P WITH (NOLOCK) ON M.VCHRNO = P.VCHRNO 
JOIN
(	
	SELECT MCODE FROM RMD_TRNPROD WHERE VCHRNO = @VCHRNO
) PUR ON P.MCODE = PUR.MCODE 
WHERE P.DIVISION = @DIVISION AND P.PhiscalID = @PHISCALID
GROUP BY M.TRNDATE, P.VCHRNO, P.DIVISION, P.PHISCALID, P.WAREHOUSE, P.MCODE,
CASE WHEN @BarcodeWiseStock = 1 THEN COALESCE(BC, '') ELSE '' END,
CASE WHEN @BatchWiseStock = 1 THEN COALESCE(BATCH, '') ELSE '' END

--SELECT * FROM #TRAN
--Calculate Editable Stock
SELECT P.MCODE, P.BC, P.BATCH,  P.REALQTY_IN InvoiceQty, TRAN_IN.WAREHOUSE, TRAN_IN.REALQTY_IN TotalInWardStock, TRAN_OUT.REALQTY TotalOutWardStock, 
IIF(TRAN_IN.REALQTY_IN > TRAN_OUT.REALQTY, TRAN_IN.REALQTY_IN - TRAN_OUT.REALQTY, 0) EditableQty FROM #TRAN P
LEFT JOIN
(
	SELECT MCODE, BC, BATCH, WAREHOUSE, SUM(REALQTY_IN) REALQTY_IN FROM #TRAN WHERE TRNDATE <= @PURDATE 
	GROUP BY MCODE, BC,BATCH, WAREHOUSE
	HAVING SUM(REALQTY_IN) > 0
) TRAN_IN ON P.MCODE = TRAN_IN.MCODE AND P.BC = TRAN_IN.BC AND P.BATCH = TRAN_IN.BATCH AND P.WAREHOUSE = TRAN_IN.WAREHOUSE
LEFT JOIN
(
	SELECT MCODE, BC, BATCH, WAREHOUSE, SUM(RealQty) REALQTY FROM #TRAN 
	GROUP BY MCODE, BC,BATCH, WAREHOUSE
	HAVING SUM(RealQty) > 0
) TRAN_OUT ON P.MCODE = TRAN_OUT.MCODE AND P.BC = TRAN_OUT.BC AND P.BATCH = TRAN_OUT.BATCH  AND P.WAREHOUSE = TRAN_OUT.WAREHOUSE
WHERE P.VCHRNO = @VCHRNO --AND TRAN_IN.WAREHOUSE IS NOT NULL AND TRAN_OUT.WAREHOUSE IS NOT NULL

DROP TABLE #TRAN