CREATE OR ALTER  FUNCTION [dbo].[RMD_TRNPROD_FN](@GRNWISE TINYINT, @PhiscalId VARCHAR(10) = '%')
RETURNS @RMD_TRNPROD TABLE (VCHRNO varchar(25) NOT NULL, CHALANNO varchar(15), DIVISION char(3) NOT NULL, MCODE varchar(25) NOT NULL, UNIT varchar(20), Quantity numeric(18, 3),
RealQty numeric(18, 3), AltQty numeric(18, 3), RATE decimal(22, 12), AMOUNT numeric(22, 12), DISCOUNT numeric(22, 12), VAT numeric(22, 12), 
REALRATE decimal(22, 12), EXPORT tinyint, IDIS varchar(100), OPQTY numeric(18, 3), REALQTY_IN numeric(18, 3), ALTQTY_IN numeric(18, 3), 
WAREHOUSE varchar(50), REFBILLQTY numeric(18, 3), SPRICE numeric(22, 12), EXPDATE datetime NULL, REFOPBILL numeric(18, 0), ALTUNIT varchar(20), 
TRNAC varchar(25), PRATE numeric(18, 2), VRATE numeric(22, 12), ALTRATE decimal(22, 12), VPRATE numeric(15, 2), VSRATE numeric(15, 2), 
TAXABLE numeric(22, 12), NONTAXABLE numeric(22, 12), INVRATE numeric(18, 8), EXRATE numeric(18, 2), NCRATE numeric(18, 2), CRATE numeric(18, 6), 
SNO int NULL, CUSTOM numeric(18, 6), [WEIGHT] numeric(18, 6), DRATE numeric(18, 6), CARTON numeric(18, 6), INVOICENO varchar(50), ISSUENO varchar(50), 
BC varchar(50), GENERIC varchar(50), BATCH varchar(50), MFGDATE datetime NULL, MANUFACTURER varchar(100), SERVICETAX numeric(22, 12), 
BCODEID numeric(18, 0), VoucherType varchar(2) NOT NULL, SALESMANID int NULL, PhiscalID varchar(20), STAMP float NULL, ITEMDESC varchar(200), 
DNID numeric(18, 0), COSTCENTER varchar(100), PROMOTION numeric(18, 8), LOYALTY numeric(18, 8), INDDISCOUNT numeric(18, 8), FLATDISCOUNT numeric(18, 8), 
NETAMOUNT numeric(18, 8), ADDTIONALROW numeric(18, 8), ISVAT tinyint, PRODCONDITION varchar(20), PRODMODE varchar(20), 
ITEMTYPE varchar(20), RECEIVEDTYPE varchar(20), REMARKS varchar(255))
AS
BEGIN
	INSERT INTO @RMD_TRNPROD

	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, 
		CASE WHEN REALRATE = 0 THEN RATE ELSE REALRATE END REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS                          
	FROM dbo.ABBPROD WHERE PhiscalId LIKE @PhiscalId 
                   
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, 
		CASE WHEN VOUCHERTYPE = 'CN' THEN 0 ELSE RealQty END RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, 
		CASE WHEN REALRATE = 0 THEN RATE ELSE REALRATE END REALRATE, EXPORT, IDIS, OPQTY, 
		CASE WHEN VOUCHERTYPE = 'CN' AND QUANTITY <> REALQTY_IN THEN QUANTITY ELSE REALQTY_IN END REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS                          
	FROM dbo.TRNPROD WHERE PhiscalId LIKE @PhiscalId	  
 
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.INVPROD WHERE PhiscalId LIKE @PhiscalId	 
                          
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.PURPROD WHERE PhiscalId LIKE @PhiscalId	 

	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.ACCPROD WHERE PhiscalId	LIKE @PhiscalId	 
 
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.OPAPROD WHERE PhiscalId	LIKE @PhiscalId	
 
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.OPPROD WHERE PhiscalId	LIKE @PhiscalId	 
	
	UNION ALL
	SELECT  VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.ABBCONPROD WHERE PhiscalId	LIKE @PhiscalId	 

	UNION ALL
	SELECT  VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.TRNCONPROD WHERE PhiscalId	LIKE @PhiscalId	
	
	UNION ALL 
	SELECT A.VCHRNO, A.CHALANNO, A.DIVISION, A.MCODE, A.UNIT, A.Quantity - ISNULL(TP_PI.QUANTITY, 0 ) + ISNULL(TP_DN.QUANTITY,0) Quantity, 0 RealQty, 0 AltQty, A.RATE, 0 AMOUNT, 0 DISCOUNT,0 VAT,	A.REALRATE, 0 EXPORT, 
		NULL IDIS, 0 OPQTY, A.REALQTY_IN - ISNULL(TP_PI.REALQTY_IN, 0) + ISNULL(TP_DN.REALQTY, 0) REALQTY_IN, A.ALTQTY_IN - ISNULL(TP_PI.ALTQTY_IN,0) + ISNULL(TP_DN.ALTQTY, 0) ALTQTY_IN, A.WAREHOUSE, 0 REFBILLQTY, 0 SPRICE, 
		A.EXPDATE, 0 REFOPBILL, A.ALTUNIT, NULL TRNAC, A.PRATE, 0 VRATE, A.ALTRATE, 0 VPRATE, 0 VSRATE,	0 TAXABLE, 0 NONTAXABLE, 0 INVRATE, 1 EXRATE, 0 NCRATE, 0 CRATE, 
		ROW_NUMBER() OVER (PARTITION BY VCHRNO ORDER BY A.MCODE, A.BATCH) SNO, 0 CUSTOM, 0 WEIGHT, 0 DRATE, 0 CARTON, NULL INVOICENO, NULL ISSUENO, A.BC, NULL GENERIC, A.BATCH, NULL MFGDATE, NULL MANUFACTURER, 0 SERVICETAX, 
		0 BCODEID, A.VoucherType, 0 SALESMANID, A.PHISCALID, CONVERT(FLOAT, GETDATE()) STAMP, A.ITEMDESC, 0 DNID, NULL COSTCENTER, 0 PROMOTION, 0 LOYALTY, 0 INDDISCOUNT, 0 FLATDISCOUNT,0.0 NETAMOUNT, 0 ADDTIONALROW, A.ISVAT, 
		NULL PRODCONDITION, NULL PRODMODE, NULL ITEMTYPE, NULL RECEIVEDTYPE, NULL REMARKS  FROM
		(
			SELECT TP.VCHRNO, TP.CHALANNO, TP.DIVISION, TP.MCODE, TP.UNIT, SUM(TP.REALQTY_IN - TP.REALQTY) Quantity, TP.RATE,
			TP.REALRATE, SUM(TP.REALQTY_IN - TP.REALQTY) REALQTY_IN, SUM(TP.ALTQTY_IN-TP.ALTQTY) ALTQTY_IN, 
			TP.WAREHOUSE, TP.EXPDATE, TP.ALTUNIT, TP.PRATE, TP.ALTRATE, TP.BC, 
			TP.BATCH, TP.VoucherType, TP.PhiscalID, 
			TP.ITEMDESC, TP.ISVAT
			FROM dbo.GRNPROD TP
			WHERE @GRNWISE = 1 AND TP.VOUCHERTYPE = 'GR' AND(TP.REALQTY_IN - TP.REALQTY) > 0 AND TP.PHISCALID LIKE @PhiscalId
			GROUP BY TP.VCHRNO, TP.CHALANNO, TP.DIVISION, TP.MCODE, TP.UNIT, TP.RATE, TP.REALRATE,  TP.WAREHOUSE, TP.EXPDATE, TP.ALTUNIT, TP.PRATE, TP.ALTRATE, TP.BC, TP.BATCH, TP.PHISCALID, TP.VoucherType, TP.ISVAT, 
			TP.ITEMDESC
		) AS A
		LEFT JOIN
		(
			SELECT MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID, SUM(QUANTITY) QUANTITY, SUM(ALTQTY_IN) ALTQTY_IN, SUM(REALQTY_IN) REALQTY_IN FROM dbo.PURPROD WHERE VOUCHERTYPE = 'PI' 
			AND ISNULL(INVOICENO,'') <> ''
			GROUP BY MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID
		) TP_PI ON A.MCODE = TP_PI.MCODE AND A.BC = TP_PI.BC AND ISNULL(A.BATCH,'') = ISNULL(TP_PI.BATCH,'') AND A.ALTUNIT = TP_PI.ALTUNIT AND A.VCHRNO = TP_PI.INVOICENO AND A.DIVISION = TP_PI.DIVISION 
		AND A.PhiscalID = TP_PI.PhiscalID
		LEFT JOIN
		(
			SELECT MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID, SUM(QUANTITY) QUANTITY, SUM(ALTQTY) ALTQTY, SUM(REALQTY) REALQTY FROM dbo.PURPROD WHERE VOUCHERTYPE IN ('DN', 'PR') AND ISNULL(INVOICENO,'') <> ''
			GROUP BY MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID
		) TP_DN ON A.MCODE = TP_DN.MCODE AND A.BC = TP_DN.BC AND ISNULL(A.BATCH,'') = ISNULL(TP_DN.BATCH,'') AND A.ALTUNIT = TP_PI.ALTUNIT  AND A.VCHRNO = TP_DN.INVOICENO AND A.DIVISION = TP_DN.DIVISION 
		AND A.PhiscalID = TP_DN.PhiscalID
	WHERE A.Quantity - ISNULL(TP_PI.QUANTITY, 0 ) + ISNULL(TP_DN.QUANTITY,0)>0
	RETURN
END