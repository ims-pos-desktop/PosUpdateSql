CREATE OR ALTER FUNCTION [dbo].[RMD_TRNPROD_FN](@GRNWISE TINYINT, @PhiscalId VARCHAR(10) = '%')
RETURNS TABLE
AS
RETURN
(
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, 
		CASE WHEN REALRATE = 0 THEN RATE ELSE REALRATE END REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS                          
	FROM dbo.ABBPROD WITH (NOLOCK) WHERE PhiscalId LIKE @PhiscalId 
                   
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, 
		CASE WHEN VOUCHERTYPE = 'CN' THEN 0 ELSE RealQty END RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, 
		CASE WHEN REALRATE = 0 THEN RATE ELSE REALRATE END REALRATE, EXPORT, IDIS, OPQTY, 
		CASE WHEN VOUCHERTYPE = 'CN' AND QUANTITY <> REALQTY_IN THEN QUANTITY ELSE REALQTY_IN END REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS                          
	FROM dbo.TRNPROD WITH (NOLOCK) WHERE PhiscalId LIKE @PhiscalId	  
 
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.INVPROD WITH (NOLOCK) WHERE PhiscalId LIKE @PhiscalId	 
                          
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.PURPROD WITH (NOLOCK) WHERE PhiscalId LIKE @PhiscalId	 

	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.ACCPROD WITH (NOLOCK) WHERE PhiscalId	LIKE @PhiscalId	 
 
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.OPAPROD WITH (NOLOCK) WHERE PhiscalId	LIKE @PhiscalId	
 
	UNION ALL
	SELECT VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.OPPROD WITH (NOLOCK) WHERE PhiscalId	LIKE @PhiscalId	 
	
	UNION ALL
	SELECT  VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.ABBCONPROD WITH (NOLOCK) WHERE PhiscalId	LIKE @PhiscalId	 

	UNION ALL
	SELECT  VCHRNO, CHALANNO, DIVISION, MCODE, UNIT, Quantity, RealQty, AltQty, RATE, AMOUNT, DISCOUNT, VAT, REALRATE, EXPORT, IDIS, OPQTY, REALQTY_IN, ALTQTY_IN, WAREHOUSE, REFBILLQTY, SPRICE, 
		EXPDATE, REFOPBILL, ALTUNIT, TRNAC, PRATE, VRATE, ALTRATE, VPRATE, VSRATE, TAXABLE, NONTAXABLE, INVRATE, EXRATE, NCRATE, CRATE, SNO, CUSTOM, WEIGHT, DRATE, CARTON, INVOICENO, 
		ISSUENO, BC, GENERIC, BATCH, MFGDATE, MANUFACTURER, SERVICETAX, BCODEID, VoucherType, SALESMANID, PhiscalID, STAMP, ITEMDESC, DNID, COSTCENTER, PROMOTION, LOYALTY, INDDISCOUNT, 
		FLATDISCOUNT, NETAMOUNT, ADDTIONALROW, ISVAT, PRODCONDITION, PRODMODE, ITEMTYPE, RECEIVEDTYPE, REMARKS
	FROM dbo.TRNCONPROD WITH (NOLOCK) WHERE PhiscalId	LIKE @PhiscalId	
	
	UNION ALL 
	SELECT A.VCHRNO, A.CHALANNO, A.DIVISION, A.MCODE, A.UNIT, A.Quantity - ISNULL(TP_PI.QUANTITY, 0 ) + ISNULL(TP_DN.QUANTITY,0) Quantity, 0 RealQty, 0 AltQty, A.RATE, 0 AMOUNT, 0 DISCOUNT,0 VAT,	A.REALRATE, 0 EXPORT, 
		NULL IDIS, 0 OPQTY, A.REALQTY_IN - ISNULL(TP_PI.REALQTY_IN, 0) + ISNULL(TP_DN.REALQTY, 0) REALQTY_IN, A.ALTQTY_IN - ISNULL(TP_PI.ALTQTY_IN,0) + ISNULL(TP_DN.ALTQTY, 0) ALTQTY_IN, A.WAREHOUSE, 0 REFBILLQTY, 0 SPRICE, 
		A.EXPDATE, 0 REFOPBILL, A.ALTUNIT, NULL TRNAC, A.PRATE, 0 VRATE, A.ALTRATE, 0 VPRATE, 0 VSRATE,	0 TAXABLE, 0 NONTAXABLE, 0 INVRATE, 1 EXRATE, 0 NCRATE, 0 CRATE, 
		ROW_NUMBER() OVER (PARTITION BY VCHRNO ORDER BY A.MCODE, A.BATCH) SNO, 0 CUSTOM, 0 WEIGHT, 0 DRATE, 0 CARTON, NULL INVOICENO, NULL ISSUENO, A.BC, NULL GENERIC, A.BATCH, NULL MFGDATE, NULL MANUFACTURER, 0 SERVICETAX, 
		0 BCODEID, A.VoucherType, 0 SALESMANID, A.PHISCALID, CONVERT(FLOAT, GETDATE()) STAMP, A.ITEMDESC, 0 DNID, NULL COSTCENTER, 0 PROMOTION, 0 LOYALTY, 0 INDDISCOUNT, 0 FLATDISCOUNT,0.0 NETAMOUNT, 0 ADDTIONALROW, A.ISVAT, 
		NULL PRODCONDITION, NULL PRODMODE, NULL ITEMTYPE, NULL RECEIVEDTYPE, NULL REMARKS  FROM
		(
			SELECT TP.VCHRNO, TP.CHALANNO, TP.DIVISION, TP.MCODE, TP.UNIT, SUM(TP.REALQTY_IN - TP.REALQTY) Quantity, TP.RATE,
			TP.REALRATE, SUM(TP.REALQTY_IN - TP.REALQTY) REALQTY_IN, SUM(TP.ALTQTY_IN-TP.ALTQTY) ALTQTY_IN, 
			TP.WAREHOUSE, TP.EXPDATE, TP.ALTUNIT, TP.PRATE, TP.ALTRATE, TP.BC, 
			TP.BATCH, TP.VoucherType, TP.PhiscalID, 
			TP.ITEMDESC, TP.ISVAT
			FROM dbo.GRNPROD TP WITH (NOLOCK)
			WHERE @GRNWISE = 1 AND TP.VOUCHERTYPE = 'GR' AND(TP.REALQTY_IN - TP.REALQTY) > 0 AND TP.PHISCALID LIKE @PhiscalId
			GROUP BY TP.VCHRNO, TP.CHALANNO, TP.DIVISION, TP.MCODE, TP.UNIT, TP.RATE, TP.REALRATE,  TP.WAREHOUSE, TP.EXPDATE, TP.ALTUNIT, TP.PRATE, TP.ALTRATE, TP.BC, TP.BATCH, TP.PHISCALID, TP.VoucherType, TP.ISVAT, 
			TP.ITEMDESC
		) AS A
		LEFT JOIN
		(
			SELECT MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID, SUM(QUANTITY) QUANTITY, SUM(ALTQTY_IN) ALTQTY_IN, SUM(REALQTY_IN) REALQTY_IN FROM dbo.PURPROD WITH (NOLOCK) WHERE VOUCHERTYPE = 'PI' 
			AND ISNULL(INVOICENO,'') <> ''
			GROUP BY MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID
		) TP_PI ON A.MCODE = TP_PI.MCODE AND A.BC = TP_PI.BC AND ISNULL(A.BATCH,'') = ISNULL(TP_PI.BATCH,'') AND A.ALTUNIT = TP_PI.ALTUNIT AND A.VCHRNO = TP_PI.INVOICENO AND A.DIVISION = TP_PI.DIVISION 
		AND A.PhiscalID = TP_PI.PhiscalID
		LEFT JOIN
		(
			SELECT MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID, SUM(QUANTITY) QUANTITY, SUM(ALTQTY) ALTQTY, SUM(REALQTY) REALQTY FROM dbo.PURPROD WITH (NOLOCK) WHERE VOUCHERTYPE IN ('DN', 'PR') AND ISNULL(INVOICENO,'') <> ''
			GROUP BY MCODE, BC, BATCH, ALTUNIT, INVOICENO, DIVISION, PHISCALID
		) TP_DN ON A.MCODE = TP_DN.MCODE AND A.BC = TP_DN.BC AND ISNULL(A.BATCH,'') = ISNULL(TP_DN.BATCH,'') AND A.ALTUNIT = TP_PI.ALTUNIT  AND A.VCHRNO = TP_DN.INVOICENO AND A.DIVISION = TP_DN.DIVISION 
		AND A.PhiscalID = TP_DN.PhiscalID
	WHERE A.Quantity - ISNULL(TP_PI.QUANTITY, 0 ) + ISNULL(TP_DN.QUANTITY,0)>0
)
