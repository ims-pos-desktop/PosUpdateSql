CREATE OR ALTER PROCEDURE OSP_GETITEMLIST
--DECLARE
@DIVISION VARCHAR(3),
@WAREHOUSE VARCHAR(50),
@TERMINAL VARCHAR(5),
@RateGroupId INT
AS
DECLARE @ItemWiseWarehouse TINYINT
DECLARE @PRODUCTMAP TINYINT
SELECT @PRODUCTMAP = PRODUCTMAP, @ItemWiseWarehouse =ItemWiseWarehouse FROM SETTING
--DECLARE @RateGroupId INT
--SELECT @RateGroupId = RateGroupID FROM DIVISION WHERE INITIAL = @DIVISION

SELECT DISTINCT A.MCODE,A.MENUCODE,A.DESCA,A.DESCB,A.PARENT,A.TYPE,ISNULL(A.BASEUNIT, '') BASEUNIT,A.ALTUNIT,A.CONFACTOR, 
A.RATE_A OriginalRate,
CASE WHEN ISNULL(C.RG_RATE,0)=0 THEN A.RATE_A ELSE C.RG_RATE END RATE_A, A.RATE_B, A.RATE_C, A.BillingDisplay, A.IsQtyUnknown,
0 RATE_D, A.VAT, LEVELS, BRAND, MODEL, A.MGROUP, DISMODE, CASE WHEN DR.DISID IS NULL THEN 0 ELSE  A.DISRATE END DISRATE, A.MCAT1, 
CASE WHEN DR.DISID IS NULL THEN 0 ELSE  A.DISAMOUNT END DISAMOUNT, RECRATE, MARGIN, DISCONTINUE, ISNULL([PATH],'') [PATH], PTYPE, 
SUPCODE, ISNULL(A.MCAT, '') MCAT, SAC, SRAC, PAC, PRAC, GENERIC, ISUNKNOWN, A.EDATE, BARCODE, HASSERIAL, HASSERVICECHARGE, DIMENSION, 
COLOR, ISNULL(PACK, 0) PACK, PRODTYPE, GWEIGHT, NWEIGHT, CBM, HASBATCH, SUPITEMCODE, LPDATE, CRDATE, TAXGROUP_ID, null LEADTIME, 
A.PRATE_A, CASE WHEN ISNULL(A.CRATE,0)=0 THEN A.PRATE_A ELSE ISNULL(A.CRATE,0) END CRATE, SCHEME_A,SCHEME_B,SCHEME_C,SCHEME_D,SCHEME_E,
CASE WHEN ISNULL(A.CRATE,0) <> 0 THEN A.CRATE
ELSE A.PRATE_A END AS COSTINGRATE, d.NATURETYPE,DR.SchemeName,
CASE WHEN @ItemWiseWarehouse = 1 AND ISNULL(WHOUSE, '') <> '' THEN WHOUSE ELSE @WAREHOUSE END WHOUSE,
MINLEVEL,MAXLEVEL,ROLEVEL,MINWARN,MAXWARN,ROWARN,location
FROM MENUITEM A OUTER APPLY DBO.FNGETRATEGROUP(A.MCODE, A.RATE_A, @RateGroupId) C
LEFT JOIN COUNTERPRODUCT CP ON A.MGROUP = CP.PRODUCT 
LEFT JOIN ptype D on a.ptype= d.ptypeid
LEFT JOIN Discount_Rate DR ON A.SCHEME_E = DR.DISID
LEFT JOIN Discount_Scheme DS ON DR.ScheduleID = DS.DisID 
left join TBL_ITEM_LOCATIONS l on a.MCODE=l.ITEM
WHERE (CONVERT(DATE, GETDATE()) BETWEEN ISNULL(DS.DateStart, CONVERT(DATE, GETDATE())) AND ISNULL(DS.DateEnd, CONVERT(DATE, GETDATE()))) AND 
A.PTYPE NOT IN (1, 12) AND
A.DISCONTINUE NOT IN(1,2) AND ISNULL(A.DIVISIONS, @DIVISION) LIKE '%'+@DIVISION+'%' 
AND (@PRODUCTMAP = 0 OR CP.COUNTER = @TERMINAL)