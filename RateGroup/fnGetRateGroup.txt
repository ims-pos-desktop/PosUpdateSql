CREATE OR ALTER FUNCTION fnGetRateGroup (@CODE VARCHAR(25), @BaseRate DECIMAL(22,12), @RateGroup INT) 
RETURNS @TABLE TABLE 
(
	RateGroup_ID INT, 
	RateGroup_Name VARCHAR(100), 
	RateGroup_Type VARCHAR(20), 
	MGroup VARCHAR(25),
	Parent VARCHAR(25),
	MCode VARCHAR(25),
	MCat VARCHAR(25),
	Rate Decimal(5,2),
	Amount Decimal(18,12),
	RG_MRP Decimal (12,2),
	RG_RATE DECIMAL(22,12)
)
AS
BEGIN
--DECLARE @CODE VARCHAR(25) = 'M5375'
--DECLARE @BaseRate DECIMAL(22,12) = 106.1946902654867
--DECLARE @RateGroup INT  =1
DECLARE @ExclusiveVatRate TINYINT
SELECT @ExclusiveVatRate = ExclusiveVatRate FROM SETTING
INSERT INTO @TABLE
SELECT A.RateGroup_ID, A.RateGroup_Name, A.RateGroup_Type, MGroup, Parent, MCODE, MCat,Rate,Amount, 
ROUND(CASE WHEN A.RATE <> 0 THEN @BaseRate * (1 + A.RATE/100) * VATCONRATE ELSE (@BaseRate + A.Amount/VATCONRATE) * VATCONRATE END, 0) RG_MRP,
ROUND(CASE WHEN A.RATE <> 0 THEN @BaseRate * (1 + A.RATE/100) * VATCONRATE ELSE (@BaseRate + A.Amount/VATCONRATE) * VATCONRATE END, 0) / VATCONRATE RG_RATE FROM
(
	SELECT A.*,CASE WHEN B.VAT = 1 AND (A.Rate <> 0 OR @ExclusiveVatRate = 0) THEN 1.13 ELSE 1 END VATCONRATE FROM vwValidRateGroup A 
	JOIN MENUITEM B ON A.MCODE = B.MCODE OR A.PARENT = B.PARENT OR A.MGroup = B.MGROUP OR A.MCAT = B.MCAT
	WHERE B.MCODE = @CODE 
	AND A.RateGroup_ID = @RateGroup 	
) A WHERE A.RateGroup_ID = @RateGroup   
RETURN 
END