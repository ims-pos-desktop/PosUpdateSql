CREATE OR ALTER PROC OSP_GetItemAltUnits
--DECLARE
@MCODE VARCHAR(50) ,
@DIVISION VARCHAR(3),
@RateGroupId INT
AS
--DECLARE @RateGroupId INT
--SELECT @RateGroupId = RateGroupID FROM DIVISION WHERE INITIAL = @DIVISION
DECLARE @AltRateByDiscount TINYINT
SELECT @AltRateByDiscount = EnableBatch & EnableBatchWisePrice FROM SETTING
SELECT A.MCODE, A.ALTUNIT, A.CONFACTOR, A.ISDEFAULT, A.BRCODE, A.PRATE, ISNULL(C.RG_RATE, A.RATE) RATE, A.RATE_B, A.SRATE_DISCOUNT, A.WSRATE_DISCOUNT  FROM
(
	SELECT A.MCODE, A.BASEUNIT ALTUNIT, 1 CONFACTOR, 0 ISDEFAULT, NULL BRCODE, A.PRATE_A PRATE, A.RATE_A RATE, RATE_B, 0 SRATE_DISCOUNT, 0 WSRATE_DISCOUNT FROM MENUITEM A
	WHERE A.MCODE = @MCODE
	UNION ALL 
	SELECT A.MCODE, A.ALTUNIT, A.CONFACTOR, A.ISDEFAULT, A.BRCODE, 
	CASE WHEN A.PRATE = 0 THEN M.PRATE_A * A.CONFACTOR ELSE A.PRATE END PRATE, 	
	CASE WHEN @AltRateByDiscount = 1 OR A.RATE = 0 THEN M.RATE_A * A.CONFACTOR * (1 - COALESCE(A.SRATE_DISCOUNT, 0)/100) ELSE A.RATE END RATE, 
	M.RATE_B * A.CONFACTOR * (1 - COALESCE(A.WSRATE_DISCOUNT,0)/100) RATE_B, A.SRATE_DISCOUNT, A.WSRATE_DISCOUNT 
	FROM MENUITEM M 
	JOIN MULTIALTUNIT A ON M.MCODE = A.MCODE WHERE M.MCODE = @MCODE
) A OUTER APPLY DBO.FNGETRATEGROUP(A.MCODE, A.RATE, @RateGroupId) C