CREATE OR ALTER PROC [dbo].[HSP_GET_ROOM_STATEMENT]
--DECLARE 
@BOOKINGID VARCHAR(25) --= 'HB13-JHM-76/77'
AS

SELECT ROW_NUMBER() OVER (ORDER BY STAMP) TranID, * FROM
(
	SELECT VCHRNO, TRNDATE, BSDATE, 
	CASE WHEN VoucherType = 'RV' AND ISNULL(RETTO,'') = '' THEN 'Advance' 
	WHEN VoucherType = 'RV' AND RETTO = 'Hotel Room Bill Settlement' THEN  'Bill Settlement'
	WHEN VoucherType IN ('SI', 'TI') AND RETTO = 'Room Billing' THEN 'Check Out'  Else 'Restaurant Bill' END Remarks,
	CASE WHEN VoucherType = 'RV' THEN 0 ELSE  NETAMNT END TOTAMNT,
	CASE WHEN VoucherType = 'RV' THEN NETAMNT ELSE  0 END NETAMNT, STAMP FROM RMD_TRNMAIN 
	WHERE REFORDBILL = @BOOKINGID
	UNION ALL
	SELECT '', CONVERT(VARCHAR(10),GETDATE(),101), DBO.DateToMiti(GETDATE(),'/'), CONCAT('Room Charge (',A.interval,' Night/s)'), a.interval * a.bookingrate, 0, CONVERT(FLOAT, GETDATE()) FROM
	(
		SELECT CASE WHEN DATEDIFF(D,CD.CheckInDate, GETDATE()) = 0 THEN 1 ELSE DATEDIFF(D,CheckInDate, GETDATE()) END interval, CD.* FROM htl_CheckIn_Details CD JOIN HTL_CHECKIN_STATUS CS ON CD.CheckInId = CS.CheckInId WHERE CD.BookingId = @bookingId AND [STATU
S] IN ('CHECKED IN', 'TRANSFERRED')
	) A 
) A
ORDER BY STAMP

SELECT M.VCHRNO, P.MCODE, P.ITEMDESC, P.SNO, P.Quantity,  (P.TAXABLE + P.NONTAXABLE + P.VAT) NETAMOUNT FROM RMD_TRNMAIN M 
JOIN RMD_TRNPROD P ON M.VCHRNO = P.VCHRNO
WHERE REFORDBILL = @BOOKINGID