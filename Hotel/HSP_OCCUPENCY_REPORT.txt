CREATE OR ALTER PROCEDURE [dbo].[HSP_OCCUPENCY_REPORT]
     @DATE1 DATE ,
	 @DATE2 DATE ,
	 @OPT_FLAG VARCHAR(10) = 'CW',
	 @OPT_PERIOD VARCHAR(10) = 'MONTHLY'
AS
	--DECLARE @DATE1 DATE , 
	--DECLARE @DATE2 DATE ,
	--DECLARE @OPT_FLAG VARCHAR(10) = 'CW',
	--DECLARE @OPT_PERIOD VARCHAR(10) = 'MONTHLY'

	SET NOCOUNT ON;	
	IF OBJECT_ID('#CATEGORY_ROOM_COUNT') IS NOT NULL DROP TABLE #CATEGORY_ROOM_COUNT
	DECLARE @TOTALROOM INT		
	SELECT @TOTALROOM=COUNT(DISTINCT ROOMNO) FROM HTL_ROOM

	SELECT CategoryId, COUNT(*) TOTALROOM INTO #CATEGORY_ROOM_COUNT FROM HTL_ROOM GROUP BY CategoryId

	DECLARE @REPORTDATA TABLE (BEGINDATE DATE, CATEGORYID INT , ROOMID INT, STATUS VARCHAR(20), CHECKINDATE DATE, CHECKOUTDATE DATE)
    WHILE @DATE1 <= @DATE2
	BEGIN 
		INSERT INTO @REPORTDATA
		SELECT BEGINDATE, CATEGORYID,ROOMID,CASE WHEN BEGINDATE BETWEEN CHECKINDATE AND DATEADD(DAY, -1, CHECKOUTDATE) THEN 'OCCUPIED' END AS STATUS,CHECKINDATE, CHECKOUTDATE 
		FROM 
		(			
			SELECT @DATE1 BEGINDATE,R.CATEGORYID,R.ROOMID,CHECKINDATE, CHECKOUTDATE FROM HTL_ROOM R
			LEFT JOIN
			(
				SELECT B.* FROM HTL_CHECKIN_DETAILS B
				JOIN HTL_CHECKIN_STATUS BS ON B.CHECKINID = BS.CHECKINID AND B.DIVISION = BS.DIVISION AND B.PHISCALID = BS.PHISCALID
				WHERE @DATE1 BETWEEN CHECKINDATE AND DATEADD(DAY, -1, CHECKOUTDATE)
			) B ON B.ROOMID = R.ROOMID
		)A
		SET @DATE1 = DATEADD(DAY, 1, @DATE1) 
	END
	--SELECT * FROM @REPORTDATA ORDER BY BEGINDATE, ROOMID
	IF @OPT_PERIOD = 'DAILY'
	BEGIN
		IF @OPT_FLAG='S'
		BEGIN
		SELECT cast(DATE as date) DATE,TOTALROOM [TOTAL ROOMS],SOLD [SOLD ROOMS],CAST((CAST(SOLD AS DECIMAL(10,2)))/(CAST(TOTALROOM AS DECIMAL(10,2))) AS DECIMAL(10,2))*100 [OCCUPANCY RATE]
		FROM (
			SELECT BEGINDATE DATE,@TOTALROOM TOTALROOM,
			COUNT(CASE WHEN STATUS='OCCUPIED' THEN ROOMID END) SOLD 
				FROM  @REPORTDATA GROUP BY BEGINDATE
			) A ORDER BY [DATE]
		END
		IF @OPT_FLAG='CW'
		BEGIN
		SELECT cast(DATE as date) DATE,CATEGORY,TOTALROOM [TOTAL ROOMS],SOLD [SOLD ROOMS],CAST((CAST(SOLD AS DECIMAL(10,2)))/(CAST(TOTALROOM AS DECIMAL(10,2))) AS DECIMAL(10,2))*100 [OCCUPANCY RATE]
		FROM (
			SELECT BEGINDATE DATE,rc.category, RC.CATEGORYID,
			COUNT(CASE WHEN STATUS='OCCUPIED' THEN ROOMID END) SOLD 
				FROM  @REPORTDATA mt inner join HTL_ROOM_CATEGORY rc on mt.categoryid=rc.CategoryId
				GROUP BY BEGINDATE,rc.Category, RC.CategoryId
			) A LEFT JOIN #CATEGORY_ROOM_COUNT RC ON A.CATEGORYID = RC.CATEGORYID
			ORDER BY DATE, CATEGORY
		END
	END
	ELSE 
		BEGIN
			SELECT MONTH,CATEGORY,SUM(CAST((CAST(SOLD AS DECIMAL(10,2)))/(CAST(@TOTALROOM AS decimal(10,2))) AS decimal(10,2))*100) [OCCUPANCY RATE] 
			FROM 
			(
				select case  month(begindate) 
						when 1 then 'JANUARY'
						when 2 then 'FEBRUARY'
						when 3 then 'MARCH'
						when 4 then 'APRIL'
						when 5 then 'MAY'
						when 6 then 'JUNE'
						when 7 then 'JULY'
						when 8 then 'AUGUST'
						when 9 then 'SEPTEMBER'
						when 10 then 'OCTOBER'
						when 11 then 'NOVEMBER'
						when 12 then 'DECEMBER' end [MONTH],month(BEGINDATE) monthnum,Category,@TOTALROOM TOTALROOM,COUNT(CASE WHEN STATUS='OCCUPIED' THEN ROOMID END) SOLD 
				FROM  @REPORTDATA MT INNER JOIN HTL_ROOM_CATEGORY RC ON RC.CategoryId=MT.categoryid
				GROUP BY BEGINDATE,Category
			)A GROUP BY [MONTH],Category,monthnum 
			ORDER by a.monthnum
		END

	
