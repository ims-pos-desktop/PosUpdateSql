CREATE OR ALTER PROC OSP_GetStockDetail
--DECLARE
@JSON VARCHAR(MAX),
@DIVISION VARCHAR(3),
@PhiscalId VARCHAR(10),
@WAREHOUSE VARCHAR(50),
@VCHRNO VARCHAR(25) = ''
AS
--SET @JSON = '[{"MCODE": "M100"},{"MCODE": "M8542"},{"MCODE": "M2304"}]'; SET @DIVISION = 'HAV'; SET @PhiscalId = '79/80'; SET @WAREHOUSE = 'KTM Showroom'
DECLARE @BCStock BIT
SELECT @BCStock = CONVERT(BIT,COALESCE(EnableBarcodeDetails,0)) FROM SETTING

SELECT P.MCODE, IIF(@BCStock=1 OR M.PTYPE = 4, COALESCE(BC,''), '') BC, COALESCE(BATCH,'') BATCH, sum(realqty_in)-sum(realqty) STOCK from RMD_TRNPROD P WITH (NOLOCK) 
JOIN OPENJSON(@JSON) 
WITH
(
	MCODE VARCHAR(25) '$.MCODE'
) D ON P.MCODE = D.MCODE
JOIN MENUITEM M ON D.MCODE = M.MCODE
WHERE PhiscalID = @PhiscalId and division = @DIVISION AND WAREHOUSE = @WAREHOUSE AND VCHRNO <> @VCHRNO 
GROUP BY P.MCODE, COALESCE(BATCH,''),IIF(@BCStock=1 OR M.PTYPE = 4, COALESCE(BC,''), '')
HAVING sum(realqty_in)-sum(realqty) <> 0