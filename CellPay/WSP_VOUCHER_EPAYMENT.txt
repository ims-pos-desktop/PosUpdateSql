
CREATE  OR ALTER   PROCEDURE [dbo].[WSP_VOUCHER_EPAYMENT]
--DECLARE 
	@DATE1 DATE,
	@DATE2 DATE,
	@VTYPE NVARCHAR(1000) = '%',
	@VSERIES VARCHAR(25) = '%',
	@ACID VARCHAR(25) = '%',
	@DIV VARCHAR(3) = '%',
	@PHISCALID VARCHAR(25)	
AS

--SET @DATE1 = '07-17-2019'; SET @DATE2 = '07-17-2021';SET @VTYPE = 'JV'; SET @VSERIES = 'JV';SET @ACID = 'PA51'; SET @DIV = 'MMX';  
--SET @PHISCALID = '77/78'

SET NOCOUNT ON 


IF @ACID = ''
	SET @ACID = '%'


IF OBJECT_ID('TEMPDB..#VLIST') IS NOT NULL DROP TABLE #VLIST
IF OBJECT_ID('TEMPDB..#RESULT2') IS NOT NULL DROP TABLE #RESULT2
IF OBJECT_ID('TEMPDB..#RESULT3') IS NOT NULL DROP TABLE #RESULT3


IF @ACID = '%'

	BEGIN
		SELECT CONVERT(VARCHAR(10), cast(TRNDATE as date), 101) TRNDATE,A.BSDATE,A.VCHRNO,A.REFBILL REFNO,A_ACID,SUM(DRAMNT)DRAMNT,SUM(CRAMNT)CRAMNT,ISNULL(B.NARATION,'')NARATION,
		ISNULL(B.COSTCENTER,'')COSTCENTER,ISNULL(B.ChequeNo,'')ChequeNo,ISNULL(B.BankName,'') BankName,ISNULL(B.CHEQUEDATE,'') CHEQUEDATE,A.VOUCHERSTATUS,A.TRNUSER,A.TRNTIME,A.DIVISION,ISNULL(A.VNUM,LEFT(A.VCHRNO,2)+'1') 
		VNUM,B.SL_ACID INTO #RESULT2 
		FROM ACCMAIN A INNER JOIN Cellpay_tran B	
		ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PHISCALID = B.PHISCALID 
		WHERE A.TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.VoucherType LIKE @VTYPE
		AND LEFT(A.VCHRNO,2) LIKE @VSERIES AND A.DIVISION LIKE @DIV AND A.PHISCALID = @PHISCALID
		GROUP BY A.TRNDATE,A.BSDATE,A.VCHRNO,A.REFBILL,A_ACID,ISNULL(B.NARATION,''),ISNULL(B.COSTCENTER,''),ISNULL(B.ChequeNo,''),ISNULL(B.BankName,''),ISNULL(B.CHEQUEDATE,''),A.VOUCHERSTATUS,A.TRNUSER,A.TRNTIME,A.DIVISION,ISNULL(A.VNUM,LEFT(A.VCHRNO,2)+'1'),B.SL_ACID
		
		--SELECT * FROM #RESULT2
		SELECT 
		CASE WHEN SNO =1 THEN TRNDATE ELSE NULL END TRNDATE,
		CASE WHEN SNO =1 THEN MITI ELSE NULL END MITI,		
		CASE WHEN SNO =1 THEN VCHRNO ELSE NULL END [VOUCHERNO],
		CASE WHEN SNO =1 THEN REFNO ELSE NULL END REFNO,
		ACNAME [ACCOUNTNAME],ACCODE,DRAMNT,CRAMNT,A.NARATION,
		CASE WHEN SNO =1 THEN VOUCHER_NAME ELSE NULL END [VOUCHERTYPE],
		CASE WHEN SNO =1 THEN X.COSTCENTERNAME ELSE NULL END COSTCENTER,
		A.ChequeNo,A.CHEQUEDATE,A.BankName,
		CASE WHEN SNO =1 THEN A.VOUCHERSTATUS ELSE NULL END VOUCHERSTATUS,
		CASE WHEN SNO =1 THEN A.TRNUSER ELSE NULL END TRNUSER,
		CASE WHEN SNO =1 THEN A.TRNTIME ELSE NULL END TRNTIME,
		CASE WHEN SNO =1 THEN B.NAME ELSE NULL END DIVNAME,A.DIVISION,A.FFLG,SL_ACNAME, TAG FROM
		(
		SELECT ROW_NUMBER() OVER (PARTITION BY A.VCHRNO ORDER BY A.VCHRNO,DRAMNT DESC)SNO,A.TRNDATE,A.BSDATE MITI,A.VCHRNO,B.VOUCHER_NAME,A.REFNO,C.ACNAME,  C.ACCODE,FORMAT(A.DRAMNT,'N')DRAMNT,FORMAT(A.CRAMNT,'N')CRAMNT,A.DIVISION,VCHRNO VNO,'A' FLG,
		A.NARATION,A.COSTCENTER,A.ChequeNo,A.BankName,A.CHEQUEDATE,A.VOUCHERSTATUS,A.TRNUSER,A.TRNTIME,'R' FFLG,X.SL_ACNAME,A.TRNDATE TDATE,A.VCHRNO TAG FROM 
		#RESULT2 A LEFT JOIN RMD_ACLIST C ON A.A_ACID = C.ACID 
		LEFT JOIN VOUCHERTYPE B ON LEFT(A.VCHRNO,2)=B.VOUCHER_ID 
		LEFT JOIN RMD_SUBLEDGER_ACLIST X ON ISNULL(A.SL_ACID,'') = X.SL_ACID
		UNION ALL
		SELECT DISTINCT 0 SNO,NULL TRNDATE,NULL MITI,NULL VCHRNO,NULL VNAME,NULL REFNO,'TOTAL >>' ACNAME, NULL ACCODE,FORMAT(SUM(DRAMNT),'N')DRAMNT,FORMAT(SUM(CRAMNT),'N')CRAMNT,NULL DIV,VCHRNO VNO,'B' FLG,
		NULL NARATION,NULL COSTCENTER,NULL ChequeNo,NULL BankName,NULL CHEQUEDATE,NULL VOUCHERSTATUS,NULL TRNUSER,NULL TRNTIME,'B' FFLG,NULL SL_ACNAME,A.TRNDATE TDATE,A.VCHRNO TAG
		FROM #RESULT2 A GROUP BY A.VCHRNO,A.TRNDATE
		UNION ALL
		SELECT DISTINCT 0 SNO,NULL TRNDATE,NULL MITI,NULL VCHRNO,NULL VNAME,NULL REFNO,NULL ACNAME, NULL ACCODE,NULL,NULL,NULL DIV,VCHRNO VNO,'C' FLG,
		NULL NARATION,NULL COSTCENTER,NULL ChequeNo,NULL BankName,NULL CHEQUEDATE,NULL VOUCHERSTATUS,NULL TRNUSER,NULL TRNTIME,'R' FFLG,NULL SL_ACNAME,A.TRNDATE TDATE,A.VCHRNO TAG
		FROM #RESULT2 A GROUP BY A.VCHRNO,A.TRNDATE
		) A LEFT JOIN DIVISION B ON A.DIVISION = B.INITIAL LEFT JOIN  COSTCENTER X ON A.COSTCENTER = CAST(X.CCID AS VARCHAR(25)) ORDER BY TDATE,LEFT(VNO,2),VNO,FLG,DRAMNT DESC

	END
ELSE
	BEGIN
		SELECT A.VCHRNO,A.DIVISION,A.PHISCALID,A.COMPANYID INTO #VLIST FROM Cellpay_tran A INNER JOIN ACCMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PHISCALID = B.PhiscalID
		WHERE A.A_ACID = @ACID AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND B.VoucherType LIKE @VTYPE AND LEFT(A.VCHRNO,2) LIKE @VSERIES AND A.DIVISION LIKE @DIV AND A.PHISCALID = @PHISCALID

		SELECT CONVERT(VARCHAR(10), cast(TRNDATE as date), 101) TRNDATE,A.BSDATE,A.VCHRNO,A.REFBILL REFNO,A_ACID,SUM(DRAMNT)DRAMNT,SUM(CRAMNT)CRAMNT,ISNULL(B.NARATION,'')NARATION,ISNULL(B.COSTCENTER,'')COSTCENTER,ISNULL(B.CHEQUENO,'')CHEQUENO,ISNULL(B.CHEQUEDATE,'') CHEQUEDATE,A.VOUCHERSTATUS,A.TRNUSER,A.TRNTIME,A.DIVISION,ISNULL(A.VNUM,LEFT(A.VCHRNO,2)+'1') VNUM,B.SL_ACID,A.ISCHECKED INTO #RESULT3
		FROM ACCMAIN A INNER JOIN Cellpay_tran B	ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.COMPANYID = B.COMPANYID AND A.PHISCALID = B.PHISCALID 
		INNER JOIN #VLIST X ON  A.VCHRNO = X.VCHRNO AND A.DIVISION = X.DIVISION AND A.COMPANYID = X.COMPANYID AND A.PHISCALID = X.PHISCALID 			
		GROUP BY A.TRNDATE,A.BSDATE,A.VCHRNO,A.REFBILL,A_ACID,ISNULL(B.NARATION,''),ISNULL(B.COSTCENTER,''),ISNULL(B.ChequeNo,''),ISNULL(B.BankName,''),ISNULL(B.CHEQUEDATE,''),A.VOUCHERSTATUS,A.TRNUSER,A.TRNTIME,A.DIVISION,ISNULL(A.VNUM,LEFT(A.VCHRNO,2)+'1'),B.SL_ACID,A.ISCHECKED
		
		--SELECT * FROM #RESULT3
		SELECT 
		CASE WHEN SNO =1 THEN TRNDATE ELSE NULL END TRNDATE,
		CASE WHEN SNO =1 THEN MITI ELSE NULL END MITI,		
		CASE WHEN SNO =1 THEN VCHRNO ELSE NULL END [VOUCHERNO],
		CASE WHEN SNO =1 THEN REFNO ELSE NULL END REFNO,
		ACNAME [ACCOUNTNAME],ACCODE,DRAMNT,CRAMNT,A.NARATION,
		CASE WHEN SNO =1 THEN VOUCHER_NAME ELSE NULL END [VOUCHERTYPE],
		CASE WHEN SNO =1 THEN X.COSTCENTERNAME ELSE NULL END COSTCENTER,
		A.ChequeNo,A.CHEQUEDATE,A.BankName,
		CASE WHEN SNO =1 THEN A.VOUCHERSTATUS ELSE NULL END VOUCHERSTATUS,
		CASE WHEN SNO =1 THEN A.TRNUSER ELSE NULL END TRNUSER,
		CASE WHEN SNO =1 THEN A.TRNTIME ELSE NULL END TRNTIME,
		CASE WHEN SNO =1 THEN B.NAME ELSE NULL END DIVNAME,A.DIVISION,A.FFLG,SL_ACNAME, TAG FROM
		(
		SELECT ROW_NUMBER() OVER (PARTITION BY A.VCHRNO ORDER BY A.VCHRNO,DRAMNT DESC)SNO,A.TRNDATE,A.BSDATE MITI,A.VCHRNO,B.VOUCHER_NAME,A.REFNO,C.ACNAME,  C.ACCODE,FORMAT(A.DRAMNT,'N')DRAMNT,FORMAT(A.CRAMNT,'N')CRAMNT,A.DIVISION,VCHRNO VNO,'A' FLG,
		A.NARATION,A.COSTCENTER,A.ChequeNo,A.BankName,A.CHEQUEDATE,A.VOUCHERSTATUS,A.TRNUSER,A.TRNTIME,'R' FFLG,X.SL_ACNAME,A.TRNDATE TDATE,A.VCHRNO TAG FROM 
		#RESULT3 A LEFT JOIN RMD_ACLIST C ON A.A_ACID = C.ACID LEFT JOIN VOUCHERTYPE B ON LEFT(A.VCHRNO,2)=B.VOUCHER_ID LEFT JOIN RMD_SUBLEDGER_ACLIST X ON ISNULL(A.SL_ACID,'') = X.SL_ACID
		UNION ALL
		SELECT DISTINCT 0 SNO,NULL TRNDATE,NULL MITI,NULL VCHRNO,NULL VNAME,NULL REFNO,'TOTAL >>' ACNAME, NULL ACCODE,FORMAT(SUM(DRAMNT),'N')DRAMNT,FORMAT(SUM(CRAMNT),'N')CRAMNT,NULL DIV,VCHRNO VNO,'B' FLG,
		NULL NARATION,NULL COSTCENTER,NULL ChequeNo,A.BankName,NULL CHEQUEDATE,NULL VOUCHERSTATUS,NULL TRNUSER,NULL TRNTIME,'B' FFLG,NULL SL_ACNAME,A.TRNDATE TDATE,A.VCHRNO TAG
		FROM #RESULT3 A GROUP BY A.VCHRNO,A.TRNDATE
		UNION ALL
		SELECT DISTINCT 0 SNO,NULL TRNDATE,NULL MITI,NULL VCHRNO,NULL VNAME,NULL REFNO,NULL ACNAME, NULL ACCODE,NULL,NULL,NULL DIV,VCHRNO VNO,'C' FLG,
		NULL NARATION,NULL COSTCENTER,NULL ChequeNo,A.BankName,NULL CHEQUEDATE,NULL VOUCHERSTATUS,NULL TRNUSER,NULL TRNTIME,'R' FFLG,NULL SL_ACNAME,A.TRNDATE TDATE,A.VCHRNO TAG
		FROM #RESULT3 A GROUP BY A.VCHRNO,A.TRNDATE
		) A LEFT JOIN DIVISION B ON A.DIVISION = B.INITIAL 
		LEFT JOIN  COSTCENTER X ON A.COSTCENTER = CAST(X.CCID AS VARCHAR(25)) ORDER BY TDATE,LEFT(VNO,2),VNO,FLG,DRAMNT DESC
	END


IF OBJECT_ID('TEMPDB..#VLIST') IS NOT NULL DROP TABLE #VLIST
IF OBJECT_ID('TEMPDB..#RESULT2') IS NOT NULL DROP TABLE #RESULT2
IF OBJECT_ID('TEMPDB..#RESULT3') IS NOT NULL DROP TABLE #RESULT3
SET NOCOUNT OFF