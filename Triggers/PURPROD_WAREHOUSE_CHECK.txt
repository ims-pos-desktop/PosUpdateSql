CREATE OR ALTER TRIGGER [dbo].[PURPROD_WAREHOUSE_CHECK] ON [dbo].[PURPROD] FOR INSERT, UPDATE
AS 
BEGIN
	IF TRIGGER_NESTLEVEL() > 1
		RETURN;

	IF EXISTS (SELECT A.VCHRNO FROM RMD_TRNPROD A JOIN RMD_WAREHOUSE B ON A.WAREHOUSE = B.NAME WHERE A.DIVISION <> B.DIVISION)
	BEGIN
		ROLLBACK
		RAISERROR('Selected warehouse does not belong to current branch.', 16, 1) WITH LOG
	END
END