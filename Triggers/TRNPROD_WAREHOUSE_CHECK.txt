CREATE OR ALTER TRIGGER [dbo].[TRNPROD_WAREHOUSE_CHECK] ON [dbo].[TRNPROD] FOR INSERT, UPDATE
AS 
BEGIN
	IF TRIGGER_NESTLEVEL() > 1
		RETURN;

	IF EXISTS (SELECT A.VCHRNO FROM INSERTED A JOIN RMD_WAREHOUSE B ON A.WAREHOUSE = B.NAME WHERE A.DIVISION <> B.DIVISION)
	BEGIN
		ROLLBACK
		RAISERROR('Selected warehouse does not belong to current branch.', 16, 1) WITH LOG
	END
END