CREATE OR ALTER TRIGGER [dbo].[ABBPROD_COGS_UPDATE] ON [dbo].[ABBPROD_COGS] AFTER UPDATE, DELETE
AS 
BEGIN
	IF TRIGGER_NESTLEVEL() > 1
		RETURN;

	DECLARE @IsDelete BIT = 1;
	IF EXISTS(SELECT * FROM inserted)
		SET @IsDelete = 0
	INSERT INTO LOGPROD_COGS(LOGDATE, LOGUSER, LOGACTION, VCHRNO, VoucherType, MCODE, BC, BATCH, SNO, COSTING_INVOICE, Quantity, CRATE, STAMP)
	SELECT GETDATE(), SUSER_NAME(), IIF(@IsDelete = 1, 'D','E'), VCHRNO, VoucherType, MCODE, BC, BATCH, SNO, COSTING_INVOICE, Quantity, CRATE, STAMP FROM deleted 

	UPDATE A SET A.STAMP = GETDATE() FROM dbo.ABBPROD_COGS A JOIN Inserted i ON A.VCHRNO = I.VCHRNO AND A.MCODE = I.MCODE AND A.SNO = I.SNO
END