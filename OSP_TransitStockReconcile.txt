CREATE OR ALTER PROC OSP_TransitStockReconcile
--DECLARE
@DIVISION VARCHAR(3) = '%'
AS
--SET @DIVISION = 'BTD'
SET NOCOUNT ON
SELECT X.VCHRNO TO_INVOICE, A.VCHRNO TC_INVOICE, X.TRNDATE TO_DATE, X.BSDATE TO_BSDATE, X.FROM_BRANCH, B.VCHRNO TR_INVOICE, B.TRNDATE TR_DATE, B.BSDATE TR_BSDATE FROM
(
	SELECT A.*, B.[NAME] FROM_BRANCH FROM INVMAIN A JOIN DIVISION B ON A.DIVISION = B.INITIAL WHERE VOUCHERTYPE = 'TO'
) X JOIN 
(
	SELECT * FROM INVMAIN_TMP WHERE VOUCHERTYPE = 'TC'
) A ON X.VCHRNO = A.REFBILL LEFT JOIN
(
	SELECT * FROM INVMAIN WHERE VOUCHERTYPE = 'TR'
) B ON A.REFBILL = B.REFBILL
LEFT JOIN
(
	SELECT * FROM INVMAIN WHERE VOUCHERTYPE = 'TC'-- ORDER BY STAMP DESC
) C ON A.VCHRNO = C.VCHRNO
WHERE B.VCHRNO IS NOT NULL AND C.VCHRNO IS NULL AND X.BILLTOADD LIKE @DIVISION
SET NOCOUNT OFF
