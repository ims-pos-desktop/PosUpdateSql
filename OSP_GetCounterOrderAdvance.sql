CREATE OR ALTER     PROC [dbo].[OSP_GetCounterOrderAdvance]
@OrderNo VARCHAR(25),
@AdvanceAc VARCHAR(25)
AS
SELECT ISNULL(D.Flavour,'')Flavour,ISNULL(D.Design,'')Design,ISNULL(D.Shape,'')Shape,ISNULL(D.[Weight],'0')[Weight], D.CakeMessage, M.PhiscalID FISCALID,M.VCHRNO, M.ORDERNO ORDNO, M.TRNDATE,M.NETAMNT, M.TRNTIME,ISNULL(M.MEMBERNO,'') MEMBERNO,M.DELIVERYDATE ESTIMATEDDELIVERY,M.REMARKS,M.TRNUSER,ISNULL(M.DELIVERYADDRESS,'')DELIVERYADDRESS, ISNULL(M.CHALANNO,'')CHALANNO, ISNULL(M.CustomerName,'')CustomerName,
ISNULL(M.MOBILENO,'')MOBILENO, IIF(M.STATUS = 8,ISNULL(B.ADVANCE, 0),ISNULL(M.ADVANCE,0)) ADVANCE, M.TRNMODE, ISNULL(P.ITEMDESC,MT.DESCA) ITEMDESC, P.MCODE,ISNULL(P.BC,'')BC ,AC.ACID,AC.ACNAME,
AC.ADDRESS,AC.PHONE, P.ALTQTY - ISNULL(T.QUANTITY, 0) QUANTITY, P.ALTRATE RATE, (P.ALTQTY - ISNULL(T.QUANTITY, 0)) * P.ALTRATE AMOUNT, MT.DESCA,B.BILLTOTEL PANNo,
ISNULL(P.INDDISCOUNTRATE,0) INDDISRATE, M.DCRATE * 100 DCRATE, P.ALTUNIT,P.INDDISCOUNTRATE, CONVERT(INT, P.SNO) SNO
from RMD_ORDERMAIN M 
join RMD_ORDERPROD P on P.VCHRNO = M.VCHRNO 
Left JOIN RMD_Order_AdditionalDetail D on D.VCHRNO = M.VCHRNO and P.MCODE = D.MCODE
join MENUITEM MT on P.MCODE = MT.MCODE 
LEFT JOIN RMD_ACLIST AC ON M.TRNAC = AC.ACID
LEFT JOIN
( 
	SELECT TM.REFORDBILL, TP.MCODE, SUM(TP.Quantity) Quantity FROM RMD_TRNMAIN TM 
	JOIN RMD_TRNPROD TP ON TM.VCHRNO = TP.VCHRNO         
	GROUP BY TM.REFORDBILL, TP.MCODE
) T ON M.VCHRNO = T.REFORDBILL AND P.MCODE = T.MCODE 
LEFT JOIN
(
	select RTM.VCHRNO,AC.BILLTOTEL , SUM(ATN.CRAMNT - ATN.DRAMNT) ADVANCE from RMD_ORDERMAIN RTM 
	join RMD_TRNMAIN AC on RTM.VCHRNO = AC.REFORDBILL
	join RMD_TRNTRAN ATN on AC.VCHRNO = ATN.VCHRNO
	WHERE ATN.A_ACID= @AdvanceAc and RTM.VCHRNO = @OrderNo
	GROUP BY RTM.VCHRNO,AC.BILLTOTEL
) B ON B.VCHRNO = M.VCHRNO
WHERE P.QUANTITY - isnull(T.Quantity, 0) > 0 AND M.VCHRNO LIKE 'SO%'AND ISNULL(M.ORDERNO,M.VCHRNO)  = @OrderNo