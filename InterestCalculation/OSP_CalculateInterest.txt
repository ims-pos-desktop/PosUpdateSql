CREATE OR ALTER PROC [dbo].[OSP_CalculateInterest]
--DECLARE 
@CreditPeriod INT,
@Rate DECIMAL(5,2),
@TRNAC VARCHAR(10),
@DATE DATE,
@VCHRNO VARCHAR(25)
AS
--SET @CreditPeriod = 0; SET @Rate = .12; SET @TRNAC = 'PA3389'; SET @DATE = '05/20/2022'; SET @VCHRNO = 'RV1634-MMX-78/79'

if Object_ID('tempdb..#DueVoucher') is not null drop table  #DueVoucher
SELECT A.VCHRNO, A.TRNDATE, A.BSDATE, A.NETAMNT, A.TRNAC, MAX(L.TRNDATE) LastPaymentDate,
DATEDIFF(D,ISNULL(MAX(L.TRNDATE), A.TRNDATE), GETDATE()) AGE,
SUM(PRINCIPAL_PAID) PRINCIPAL_PAID, SUM(INTEREST_PAID) INTEREST_PAID, 
A.NETAMNT - ISNULL(SUM(PRINCIPAL_PAID),0) DUE_AMNT,SUM(ISNULL(INTEREST,0) - ISNULL(INTEREST_PAID,0)) DUE_INTEREST, A.IntRate INTO #DueVoucher  FROM vawDueVoucher A 
LEFT JOIN VOUCHER_WISE_RECEIPT_LOG L ON A.VCHRNO = L.VCHRNO
WHERE ISNULL(L.RECEIVE_VCHRNO,'') <> @VCHRNO AND A.TRNAC = @TRNAC 
GROUP BY A.VCHRNO, A.TRNDATE, A.BSDATE, A.NETAMNT, A.TRNAC, A.IntRate

SELECT  *, DATEDIFF (D, IIF(LastPaymentDate IS NULL OR LastPaymentDate <= DATEADD(D, @CreditPeriod, TRNDATE), TRNDATE, LastPaymentDate), @DATE) * (DUE_AMNT * IIF(ISNULL(IntRate,0) =0, @RATE, IntRate/100)) / 365 INTEREST 
FROM #DueVoucher 
