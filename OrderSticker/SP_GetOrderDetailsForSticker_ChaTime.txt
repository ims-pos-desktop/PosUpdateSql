CREATE OR ALTER PROC SP_GetOrderDetailsForSticker
--DECLARE
@VCHRNO VARCHAR(25)
AS

--SELECT @VCHRNO = 'TI17-MMX-80/81'
SELECT CONCAT(A.orderMode, '/', A.vnum) vnum,  CONVERT(VARCHAR(5), TRNDATE, 101) + ' ' + TRNTIME orderTime, B.itemName, CONCAT(B.IceLevels, '/', B.SugarLevels) modifiers, C.addOns
, CONCAT('Rs. ', CONVERT(NUMERIC(10,2), B.NETAMOUNT + C.NETAMOUNT)) amount, Quantity
, CONCAT(ROW_NUMBER() OVER (ORDER BY SNO) ,'/', COUNT(*) OVER (PARTITION BY A.VCHRNO)) sno FROM RMD_TRNMAIN A JOIN
(

	SELECT
		MAX(CASE WHEN rn = 1 THEN value END) AS ItemName,
		MAX(CASE WHEN rn = 2 THEN value END) AS IceLevels,
		MAX(CASE WHEN rn = 3 THEN value END) AS SugarLevels, VCHRNO, MCODE, SNO, RefGuid, NETAMOUNT, CONVERT(INT,Quantity) Quantity
	FROM
	(
		SELECT A.*, B.REFGUID, C.[Value], ROW_NUMBER() OVER (PARTITION BY B.RefGuid ORDER BY (SELECT NULL)) AS rn
		FROM RMD_TRNPROD A JOIN RMD_TRNPROD_STATUS B ON A.VCHRNO = B.VCHRNO AND A.MCODE = B.MCODE AND A.SNO = B.SNO 
		CROSS APPLY STRING_SPLIT(ITEMDESC, ',') C
		WHERE A.VCHRNO = @VCHRNO AND ISNULL(A.MasterMCode, '') = ''
	) AS SplitData
	GROUP BY VCHRNO, MCODE, SNO, RefGuid, NETAMOUNT, Quantity
) B ON A.VCHRNO = B.VCHRNO LEFT JOIN
(
	SELECT A.VCHRNO, B.RefGuid, STRING_AGG(ITEMDESC,'/') AddOns, SUM(A.NETAMOUNT) NETAMOUNT FROM RMD_TRNPROD A 
	JOIN RMD_TRNPROD_STATUS B ON A.VCHRNO = B.VCHRNO AND A.MCODE = B.MCODE AND A.SNO = B.SNO 
	WHERE A.VCHRNO = @VCHRNO AND ISNULL(A.MasterMCode, '') <> ''
	GROUP BY A.VCHRNO, B.RefGuid
) C ON A.VCHRNO = C.VCHRNO AND B.RefGuid = C.RefGuid
