IF NOT EXISTS (SELECT * FROM SYS.indexes WHERE NAME ='IX_BARCODE_UNIQUE')
BEGIN
	WITH CTE AS
	(
		SELECT ROW_NUMBER() OVER (PARTITION BY MCODE, BCODE ORDER BY MCODE, IsActive DESC) RN, * FROM BARCODE
	)
	DELETE FROM CTE 
	OUTPUT 0, GETDATE(), 'Auto','D', deleted.BCODE, deleted.MCODE, deleted.UNIT, deleted.SUPCODE, deleted.BATCHNO, deleted.EXPIRY, deleted.REMARKS, deleted.SRATE, deleted.ISACTIVE, deleted.BAR_DISRATE 
	INTO _LOG_BARCODE (LOGID, LOGDATE, LOGUSER, LOGACTION, BCODE, MCODE, UNIT, SUPCODE, BATCHNO, EXPIRY, REMARKS, SRATE, ISACTIVE, BAR_DISRATE)
	WHERE RN>1

	CREATE UNIQUE INDEX IX_BARCODE_UNIQUE ON BARCODE(MCODE, BCODE)
END

IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'RMD_KOTMAIN_STATUS') 
	AND NOT EXISTS (SELECT * FROM SYS.indexes WHERE NAME ='IX_RMD_KOTMAIN_STATUS')
CREATE UNIQUE INDEX IX_RMD_KOTMAIN_STATUS ON RMD_KOTMAIN_STATUS(TABLENO, STATUS) WHERE STATUS = 'ACTIVE'