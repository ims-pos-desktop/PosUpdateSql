CREATE OR ALTER PROCEDURE [dbo].[RSP_ITEMEXPIRYREPORT_BATCHWISE]
--DECLARE
	@DATE1 DATE,
	@DATE2 DATE,
	@FYID VARCHAR(25) = '%',
	@OPT_REPORTTYPE TINYINT = 0,						--NearExpiry:0,Expired:1,All:2
	@WAREHOUSE VARCHAR(50) = '%',
	@DIVISION VARCHAR(3) = '%',
	@MGROUP VARCHAR(25) = '%',
	@MCAT VARCHAR(25) = '%',
	@SUPPLIER_ACID VARCHAR(25) = '%'
AS

--SET @DATE1 = '2020-07-16'; SET @DATE2 = '2022-04-15'; SET @FYID = '77/78';SET @OPT_REPORTTYPE = 2; 

DECLARE @CURRENTDATE DATE
SET @CURRENTDATE = GETDATE()
set nocount on

IF OBJECT_ID('TEMPDB..#STK') is not null drop table #STK

SELECT A.MCODE,B.DESCA,B.MENUCODE,B.BASEUNIT UNIT,A.BATCH,B.MGROUP,B.MCAT,SUM(REALQTY_IN)-SUM(REALQTY) STK INTO #STK 
FROM RMD_TRNPROD A INNER JOIN MENUITEM B ON A.MCODE = B.MCODE  
WHERE A.PHISCALID = @FYID  AND A.WAREHOUSE LIKE @WAREHOUSE AND A.DIVISION LIKE @DIVISION AND B.MCAT LIKE @MCAT AND B.MGROUP LIKE @MGROUP 
GROUP BY A.MCODE,A.BATCH,B.DESCA,B.MENUCODE,B.BASEUNIT,B.MGROUP,B.MCAT HAVING SUM(REALQTY_IN)-SUM(REALQTY) <> 0

--SELECT * FROM #STK

IF @OPT_REPORTTYPE = 0	-- GOING TO EXPIRED REPORT
	SET @DATE1 = @CURRENTDATE
ELSE IF @OPT_REPORTTYPE = 1	-- ALREADY EXPIRED REPORT
	SET @DATE2 = @CURRENTDATE

IF OBJECT_ID('TEMPDB..#REPORT') is not null drop table #REPORT

SELECT  ROW_NUMBER() over(ORDER BY A.DESCA,B.BATCHCODE) SNO,A.MENUCODE,A.DESCA,A.UNIT,A.STK STOCKQTY,B.LANDINGCOST PRATE,A.STK * B.LANDINGCOST STKVALUE,B.BATCHCODE,B.EXPDATE,DATEDIFF(DD,@CURRENTDATE,ISNULL(B.EXPDATE,@CURRENTDATE)) REMAINGDAYS,
A.MCAT CATEGORY,C.DESCA MAINGROUP,'R' FFLG INTO #REPORT FROM #STK A 
INNER JOIN BATCHPRICE_MASTER B ON A.MCODE = B.MCODE AND A.BATCH = B.BATCHCODE 
LEFT JOIN MENUITEM C ON A.MGROUP=C.MCODE
WHERE B.EXPDATE BETWEEN @DATE1 AND @DATE2

SELECT SNO,MENUCODE,DESCA,UNIT,STOCKQTY,FORMAT(PRATE,'N2')PRATE,FORMAT(STKVALUE,'N2')STKVALUE,BATCHCODE,EXPDATE,REMAINGDAYS,CATEGORY,MAINGROUP,FFLG FROM #REPORT 
ORDER BY REMAINGDAYS

IF OBJECT_ID('TEMPDB..#STK') is not null drop table #STK

set nocount off


