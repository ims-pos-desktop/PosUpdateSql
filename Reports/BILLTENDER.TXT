CREATE OR ALTER VIEW [dbo].[BILLTENDER]
AS
SELECT B.VCHRNO VNO,B.DIVISION DIV,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'CASH', COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) CASH,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'CREDIT' , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) CREDIT,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) IN ('CREDITCARD', 'CREDIT CARD')  , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) CREDITCARD,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'CHEQUE' , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) CHEQUE,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) IN ('GIFTVOUCHER', 'Gift Voucher') ,COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) GIFTVOUCHER,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'CREDITVOUCHER' , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) CREDITVOUCHER,	
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'PREPAID' , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) PREPAID,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) IN ('ONLINE', 'ESEWA', 'FONEPAY', 'QR', 'QR MODE') , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) ONLINE,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'Sales Return Voucher' , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) SalesReturnVoucher,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'Complimentary' , COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) Complimentary,

	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'CASH', IIF(VoucherType IN ('CN','RE') , -1,1) * COALESCE(A.AMOUNT, B.NETAMNT), 0 )) NCASH,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'CREDIT', IIF(VoucherType IN ('CN','RE') , -1,1)* COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) NCREDIT,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) IN ('CREDITCARD', 'CREDIT CARD') , IIF(VoucherType IN ('CN','RE') , -1,1)* COALESCE(A.AMOUNT, B.NETAMNT), 0 )) NCREDITCARD,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) IN ('GIFTVOUCHER', 'Gift Voucher') , IIF(VoucherType IN ('CN','RE') , -1,1)* COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) NGVOUCHER,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'CREDITVOUCHER' , IIF(VoucherType IN ('CN','RE') ,-1,1)* COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) NCVOUCHER,	
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'PREPAID' , IIF(VoucherType IN ('CN','RE') , -1,1)* COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) NPREPAID,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) IN ('ONLINE', 'ESEWA', 'FONEPAY', 'QR', 'QR MODE') , IIF(VoucherType IN ('CN','RE') , -1,1) * COALESCE(A.AMOUNT, B.NETAMNT), 0 )) N_ONLINE,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'Sales Return Voucher' , IIF(VoucherType IN ('CN','RE') , -1,1)* COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) NSalesReturnVoucher,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) =  'Complimentary' , IIF(VoucherType IN ('CN','RE') ,-1,1)* COALESCE(A.AMOUNT, B.NETAMNT) , 0 )) NComplimentary,
	SUM( ISNULL( B.CHANGE,0)) CHANGE,
	SUM( IIF( COALESCE( A.TRNMODE, B.TRNMODE) = 'CASH' , IIF(VoucherType IN ('CN','RE') ,-1,1)* COALESCE(A.AMOUNT, B.NETAMNT)- ISNULL(A.CHANGE,0) , 0 )) NETCASH, B.PHISCALID,A.SALESMANID,A.TRANSACTIONID
	FROM RMD_TRNMAIN B INNER JOIN  RMD_BILLTENDER A ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PHISCALID = B.PHISCALID 
	WHERE B.VoucherType IN ('SI','TI','CN','SR', 'RE','RR')
	GROUP BY B.VCHRNO,B.DIVISION,B.PHISCALID, A.SALESMANID, A.TRANSACTIONID