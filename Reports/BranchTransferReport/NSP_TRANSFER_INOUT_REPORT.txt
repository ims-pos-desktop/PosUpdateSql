CREATE OR ALTER PROCEDURE [dbo].[NSP_TRANSFER_INOUT_REPORT]
  --DECLARE
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIV VARCHAR(3) = '%',
	@BRANCH VARCHAR(25) = '%',	
	@VNO VARCHAR(3) = 'TR%',
	@DETAILREPORT TINYINT = 1
AS

set nocount on

IF OBJECT_ID('TEMPDB..#TRNMAIN_BT') IS NOT NULL DROP TABLE #TRNMAIN_BT
IF OBJECT_ID('TEMPDB..#TRNPROD_BT') IS NOT NULL DROP TABLE #TRNPROD_BT

--SET @DATE1 = '01-01-2015'
--SET @DATE2 = '01-01-2019'

SELECT * INTO #TRNMAIN_BT FROM
(
SELECT A.VCHRNO, A.TRNDATE, A.BSDATE,ISNULL(A.REFBILL,'') REFNO,
B.NAME AS TRANSFER_FROM,C.NAME AS TRANSFER_TO,'' ITEMCODE,'' BARCODE, '' ITEMNAME,'' UNIT,NULL QTY,NULL RATE, NULL AMOUNT,'' WAREHOUSE,A.REMARKS,A.TRNUSER,
0 SNO, 'A' FLG, DIVISION DIV, CASE WHEN @VNO = 'TO%' THEN C.INITIAL ELSE B.INITIAL END REFDIV,
A.TRNDATE TDATE,ISNULL(A.VNUM,A.VCHRNO) VNO FROM RMD_TRNMAIN A INNER JOIN DIVISION B ON A.BILLTO = B.INITIAL INNER JOIN DIVISION C ON A.BILLTOADD = C.INITIAL
WHERE A.VCHRNO LIKE @VNO AND DIVISION LIKE @DIV AND A.TRNDATE BETWEEN @DATE1 AND @DATE2 
AND ((@VNO = 'TO%' AND ISNULL(A.BILLTOADD,'') LIKE @BRANCH) OR  (@VNO = 'TR%' AND ISNULL(A.BILLTO,'') LIKE @BRANCH))
) A 

SELECT * INTO #TRNPROD_BT FROM
(
SELECT '' VCHRNO,NULL TRNDATE,'' BSDATE,'' REFNO,'' TRANSFER_FROM,'' TRANSFER_TO,
C.MENUCODE,C.BARCODE,C.DESCA ITEM,B.UNIT,B.QUANTITY QTY,B.RATE,B.AMOUNT,B.WAREHOUSE,'' RMK,'' USR,ISNULL(B.SNO,0) SNO,'B' FLG,
A.DIVISION DIV,A.TRNDATE TDATE,ISNULL(A.VNUM,A.VCHRNO) VNO,CASE WHEN @VNO = 'TO%' THEN A.BILLTOADD ELSE A.BILLTO END REFDIV
FROM RMD_TRNPROD B INNER JOIN RMD_tRNMAIN A ON A.VCHRNO = B.VCHRNO AND A.DIVISION  = B.DIVISION INNER JOIN MENUITEM C ON B.MCODE = C.MCODE 
WHERE A.VCHRNO LIKE @VNO AND A.DIVISION LIKE @DIV AND A.TRNDATE BETWEEN @DATE1 AND @DATE2 
AND ((@VNO = 'TO%' AND ISNULL(A.BILLTOADD,'') LIKE @BRANCH) OR  (@VNO = 'TR%' AND ISNULL(A.BILLTO,'') LIKE @BRANCH))
) A

--SELECT * FROM #TRNPROD_BT	
IF @DETAILREPORT = 1
	SELECT * FROM 
	(
	SELECT VCHRNO,TRNDATE,BSDATE,REFNO,TRANSFER_FROM,TRANSFER_TO,ITEMCODE,BARCODE,ITEMNAME,UNIT,QTY,RATE,AMOUNT,WAREHOUSE,REMARKS,TRNUSER,SNO,FLG,DIV,TRNDATE TDATE,VNO FROM #TRNMAIN_BT
	UNION ALL
	SELECT  VCHRNO,TRNDATE,BSDATE,REFNO,TRANSFER_FROM,TRANSFER_TO,MENUCODE,BARCODE,ITEM,UNIT,QTY,RATE,AMOUNT,WAREHOUSE,RMK,USR,SNO,FLG,DIV,TDATE,VNO FROM #TRNPROD_BT	
	UNION ALL
	SELECT NULL VCHRNO,NULL TRNDATE,'' BSDATE,'' REFNO,'' TRANSER_FROM,'' TRANSFER_TO,'' ITEMCODE,'' BARCODE,'TOTAL >>' ITEM,NULL UNIT,SUM(QTY)QTY,NULL RATE,SUM(AMOUNT)AMOUNT,
	NULL WAREHOUSE,'' REMARKS,'' USR,100000 SN,'C' FLG,DIV,TDATE,VNO FROM #TRNPROD_BT
	GROUP BY DIV,VNO,TDATE
	UNION ALL
	SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,10000 SN,'D' FLG,DIV,TDATE,VNO FROM #TRNMAIN_BT
	UNION ALL
	SELECT NULL VCHRNO,NULL TRNDATE,'' BSDATE,NULL REFNO,NULL,NULL TRANSFER_TO,NULL ITEMCODE,NULL BARCODE,'GRAND TOTAL >>' ITEM,NULL UNIT,SUM(QTY)QTY,NULL RATE,SUM(AMOUNT)AMOUNT,
	NULL WAREHOUSE,'' REMARKS,'' USR,100000 SN,'E' FLG,'ZZZZZ' DIV,'01-01-2050' TDATE,'ZZZ' VNO FROM #TRNPROD_BT
	) A ORDER BY TDATE,VNO,FLG

ELSE if @DETAILREPORT = 0		-- SUMMARY REPORT
	
	SELECT * FROM 
	(
	SELECT DISTINCT CASE WHEN @VNO = 'TO%' THEN 'TRANSFER TO :' ELSE 'TRANSFER FROM :' END ITEM_CODE, 
	CASE WHEN @VNO = 'TO%' THEN A.TRANSFER_TO ELSE A.TRANSFER_FROM END BARCODE, NULL ITEM, NULL UNIT, NULL QTY,NULL RATE, NULL AMOUNT,FLG,REFDIV FROM #TRNMAIN_BT A
	WHERE A.DIV LIKE @DIV
	GROUP BY (CASE WHEN @VNO = 'TO%' THEN A.TRANSFER_TO ELSE A.TRANSFER_FROM END),REFDIV,FLG
	UNION ALL
	SELECT A.MENUCODE,A.BARCODE,A.ITEM,A.UNIT,SUM(A.QTY) QTY,SUM(A.AMOUNT)/SUM(A.QTY) RATE,SUM(A.AMOUNT) AMOUNT,'B' FLG, A.REFDIV FROM #TRNPROD_BT A
	INNER JOIN #TRNMAIN_BT B ON A.VNO = B.VNO AND A.DIV = B.DIV WHERE B.DIV LIKE @DIV
	GROUP BY A.MENUCODE,A.BARCODE,A.ITEM,A.UNIT,A.REFDIV
	UNION ALL
	SELECT NULL MENUCODE,NULL BARCODE,'TOTAL >>' ITEM,NULL UNIT,SUM(A.QTY) QTY,NULL RATE,SUM(A.AMOUNT) AMOUNT,'C' FLG, A.REFDIV FROM #TRNPROD_BT A
	INNER JOIN #TRNMAIN_BT B ON A.VNO = B.VNO AND A.DIV = B.DIV WHERE B.DIV LIKE @DIV
	GROUP BY A.REFDIV
	UNION ALL
	SELECT DISTINCT NULL ITEM_CODE,NULL BARCODE, NULL ITEM, NULL UNIT, NULL QTY,NULL RATE, NULL AMOUNT,'D' FLG,REFDIV FROM #TRNMAIN_BT A
	WHERE A.DIV LIKE @DIV
	GROUP BY REFDIV
	UNION ALL
	SELECT NULL MENUCODE,NULL BARCODE,'GRAND TOTAL >>'ITEM,NULL UNIT,SUM(QTY) QTY,NULL RATE,SUM(AMOUNT) AMOUNT,'E' FLG, 'ZZZZZZ' REFDIV FROM #TRNPROD_BT A
	WHERE A.DIV LIKE @DIV
	) A ORDER BY REFDIV,FLG

set nocount off

