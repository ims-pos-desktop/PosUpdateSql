
CREATE OR ALTER PROCEDURE [dbo].[RSP_KOT_VS_PREBILL_VS_SALES_DETAIL]
--DECLARE
	@DATE1 DATETIME,
	@DATE2 DATETIME
AS
--SELECT @DATE1 = '06 AUG 2020', @DATE2 = '16 OCT 2020'
set nocount ON;

IF OBJECT_ID('TEMPDB..#KotDetail') IS NOT NULL DROP TABLE #KotDetail
IF OBJECT_ID('TEMPDB..#PREBILL') IS NOT NULL DROP TABLE #PREBILL

SELECT KOTID,TABLENO,[STATUS],REMARKS [Bill No],[1] prebill1,[2] prebill2,[3] prebill3 into #PREBILL 
FROM
(
	SELECT b.*, TABLENO, [STATUS]
    FROM
	(
        SELECT ROW_NUMBER() OVER (PARTITION BY KS.KOTID, KS.Remarks ORDER BY KS.KOTID) SNO, KS.KOTID, KS.REMARKS, [value] from RMD_KOTMAIN_STATUS KS
		JOIN RMD_KOTMAIN KM ON KS.KOTID = KM.KOTID
        CROSS APPLY STRING_SPLIT(KS.REF_PREBILL_NOS, ',') 
		WHERE KM.TRNDATE BETWEEN @DATE1 AND @DATE2
    ) B JOIN  RMD_KOTMAIN_STATUS rks ON rks.KOTID=b.KOTID 	
) A
PIVOT( max([value]) for sno IN ([1],[2],[3]))as b
	     
	     
	     
SELECT kp.KOTID,KP.TABLENO,kp.TRNDATE,MCODE,ItemDesc,sum(IIF(Quantity > 0, Quantity,0)) orderQty,sum(IIF(Quantity < 0, Quantity,0)) cancelQty
INTO  #KotDetail
FROM RMD_KOTMAIN km 
JOIN RMD_KOTPROD kp ON km.KOTID=kp.KOTID 
JOIN RMD_KOTMAIN_STATUS rks ON rks.KOTID=kp.KOTID
WHERE  Quantity>0 AND KP.TRNDATE BETWEEN @DATE1 AND @DATE2 
group by kp.KOTID,kp.TABLENO,kp.TRNDATE,MCODE,ItemDesc


SELECT ROW_NUMBER() OVER (ORDER BY T.TRNDATE, P.KOTID) SNO, CAST(T.TRNDATE AS DATE) TRNDATE, p.KOTID,p.TABLENO,t.MCODE [ITEM CODE]
	,T.ITEMDESC [ITEM NAME], ORDERQTY [ORDER QTY], ISNULL(CANCELQTY,0) [CANCEL QTY], P.PREBILL1,P.PREBILL2,P.PREBILL3, TM.VCHRNO [BILL NO],TP.NETAMOUNT 		
FROM #PREBILL P
JOIN #KotDetail T ON P.KOTID = T.KOTID AND P.TABLENO=T.TABLENO
LEFT JOIN SALES_TRNMAIN TM ON P.[Bill No] = TM.VCHRNO
LEFT JOIN SALES_TRNPROD TP ON TM.VCHRNO=TP.VCHRNO AND TP.MCODE = T.MCODE

IF OBJECT_ID('TEMPDB..#KotDetail') IS NOT NULL DROP TABLE #KotDetail
IF OBJECT_ID('TEMPDB..#PREBILL') IS NOT NULL DROP TABLE #PREBILL