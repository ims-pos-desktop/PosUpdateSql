CREATE OR ALTER PROCEDURE RSP_KOT_VS_PREBILL_VS_SALES_REPORT
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME
AS
--SET @DATE1 = '2021-01-01'
--SET @DATE2 = '2021-03-01'
set nocount on;
select KOTID,TABLENO,STATUS,REMARKS [Bill No],[1] prebill1,[2] prebill2,[3] prebill3 into #temp 
from
(
	SELECT B.*,TABLENO,STATUS FROM
	(
		SELECT ROW_NUMBER() over (partition by kotid,remarks order by kotid) sno,kotid,REMARKS,[value] from RMD_KOTMAIN_STATUS 
		CROSS APPLY STRING_SPLIT(REF_PREBILL_NOS, ',') 
	)b join  RMD_KOTMAIN_STATUS rks on rks.KOTID=b.KOTID
)as a
pivot( max([value]) for sno IN ([1],[2],[3]))as b
      
      
select ROW_NUMBER() over (order by TM.trndate,T.KOTID) SNO,CAST(TM.TRNDATE AS DATE)TRNDATE,TM.BSDATE,t.TABLENO,t.KOTID,t.STATUS,
t.PREBILL1,pm.REMARKS PREBILL1_REMARKS, CONVERT(NUMERIC(18,2), PM.NETAMNT) PREBILL1_NETAMNT,
t.PREBILL2,pm1.REMARKS PREBILL2_REMARKS, CONVERT(NUMERIC(18,2), PM1.NETAMNT) PREBILL_NETAMNT,
t.PREBILL3,pm2.REMARKS PREBILL3_REMARKS, CONVERT(NUMERIC(18,2), PM2.NETAMNT) PREBILL3_NETAMNT,
t.[BILL NO],CONVERT(NUMERIC(18,2), TM.NETAMNT) [BILL AMOUNT]
from TRNMAIN tm  
JOIN #temp t on tm.VCHRNO=t.[Bill No] 
JOIN RMD_KOTMAIN RK ON RK.KOTID=T.KOTID AND RK.TABLENO=T.TABLENO
left join (select VCHRNO,REMARKS, NETAMNT  from PREMAIN)pm on pm.VCHRNO=t.prebill1 
left join (select VCHRNO,REMARKS, NETAMNT  from PREMAIN)pm1 on pm1.VCHRNO=t.PREBILL2
left join (select VCHRNO,REMARKS, NETAMNT  from PREMAIN)pm2 on pm2.VCHRNO=t.PREBILL3
WHERE RK.TRNDATE BETWEEN @DATE1 AND @DATE2
drop table #temp