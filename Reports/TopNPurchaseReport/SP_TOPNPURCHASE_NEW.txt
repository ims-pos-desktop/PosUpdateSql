ALTER     PROCEDURE [dbo].[SP_TOPNPURCHASE_NEW]
	@MGROUP VARCHAR(15)= '%',
	@RMODE TINYINT = 1,
	@DIV VARCHAR(3),
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@FLAG TINYINT = 1,
	@VCHR VARCHAR(10) = 'X',
	@PARTY VARCHAR(50) = 'A'
	
AS
--declare @MGROUP VARCHAR(15),@RMODE TINYINT,	@DIV VARCHAR(3),@DATE1 DATETIME,@DATE2 DATETIME,@FLAG TINYINT ,	@VCHR VARCHAR(10),@PARTY VARCHAR(50) 
--set @party = '%';set @MGROUP = '%';set @Rmode='1';set @DIV='%';set @date1= '06-15-13';set @date2='06-19-14';set @FLAG='4';set @VCHR='X'

IF @FLAG = 1			-- ITEM WISE

	SELECT NULL AS SNO, A.MENUCODE, A.DESCA, A.BASEUNIT AS UNIT, B.QTY, B.AMOUNT AS GROSS, B.DISCOUNT, NETSALE,VRATE,NETAMOUNT,ISNULL(X.ACNAME,'') SUPPLIER,A.MCODE
	FROM MENUITEM A INNER JOIN 
	(
	SELECT SUM(REALQTY_IN-REALQTY) AS QTY, SUM( CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') 
                      THEN AMOUNT ELSE AMOUNT * - 1 END)  AS AMOUNT,SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN DISCOUNT ELSE DISCOUNT * - 1 END) AS DISCOUNT, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.TAXABLE ELSE B.TAXABLE * - 1 END + CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.NONTAXABLE ELSE B.NONTAXABLE * - 1 END ) AS NETSALE, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN VAT ELSE VAT * - 1 END) AS VRATE,
                      SUM(CASE  LEFT(A.VCHRNO, 2) When 'PI' THEN AMOUNT + B.VAT - DISCOUNT ELSE (AMOUNT + B.VAT - DISCOUNT) * - 1 END ) AS NETAMOUNT,
	B.MCODE FROM RMD_TRNMAIN A INNER JOIN Rmd_Trnprod B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
	Where A.DIVISION LIKE @DIV AND (TRNDATE>= @DATE1 AND TRNDATE<=@DATE2) 
	and left(A.vchrno,2) in ('PI','PR')
	GROUP BY B.MCODE
	) AS B ON A.MCODE = B.MCODE LEFT JOIN RMD_ACLIST X ON A.SUPCODE = X.ACID WHERE A.MGROUP LIKE @MGROUP
	ORDER BY CASE WHEN(@RMODE = 1) THEN B.Qty ELSE (B.NETAMOUNT) END DESC , A.DESCA
				
ELSE IF @FLAG = 2		-- MGROUP WISE

	SELECT NULL AS SNO, A.MENUCODE, A.DESCA, A.BASEUNIT AS UNIT, B.QTY, B.AMOUNT AS GROSS, B.DISCOUNT, NETSALE,VRATE,NETAMOUNT,A.MCODE
	FROM MENUITEM A,
	(
	SELECT SUM(REALQTY_IN-REALQTY) AS QTY, SUM( CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') 
                      THEN AMOUNT ELSE AMOUNT * - 1 END)  AS AMOUNT,SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN DISCOUNT ELSE DISCOUNT * - 1 END) AS DISCOUNT, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.TAXABLE ELSE B.TAXABLE * - 1 END + CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.NONTAXABLE ELSE B.NONTAXABLE * - 1 END ) AS NETSALE, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.VAT ELSE B.VAT * - 1 END) AS VRATE,
                      SUM(CASE  LEFT(A.VCHRNO, 2) When 'PI' THEN AMOUNT + B.VAT - DISCOUNT ELSE (AMOUNT + B.VAT - DISCOUNT) * - 1 END ) AS NETAMOUNT,
	C.MGROUP FROM RMD_TRNMAIN A INNER JOIN Rmd_Trnprod B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION inner join menuitem C on b.mcode=c.mcode
	Where A.DIVISION LIKE @DIV AND (TRNDATE>= @DATE1 AND TRNDATE<=@DATE2) 
	and left(A.vchrno,2) in ('PI','PR')
	GROUP BY C.Mgroup
	) AS B WHERE A.MCODE = B.MGROUP AND A.MGROUP LIKE @MGROUP
	ORDER BY CASE WHEN(@RMODE = 1) THEN B.Qty ELSE (B.NETAMOUNT) END DESC , A.DESCA


ELSE IF @FLAG = 3		-- SUPPLIER WISE
	SELECT NULL AS SNO, ISNULL(A.ACNAME,'UNKNOWN SUPPLIER') AS ACNAME,
	B.QTY, B.AMOUNT AS GROSS, B.DISCOUNT, B.NETSALE,B.VRATE,B.NETAMOUNT, B.SUPCODE
	FROM 
	(
	SELECT SUM(REALQTY_IN-REALQTY) AS QTY, SUM( CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') 
                      THEN AMOUNT ELSE AMOUNT * - 1 END)  AS AMOUNT,SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN DISCOUNT ELSE DISCOUNT * - 1 END) AS DISCOUNT, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.TAXABLE ELSE B.TAXABLE * - 1 END + CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.NONTAXABLE ELSE B.NONTAXABLE * - 1 END ) AS NETSALE, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.VAT ELSE B.VAT * - 1 END) AS VRATE,
                      SUM(CASE  LEFT(A.VCHRNO, 2) When 'PI' THEN AMOUNT + B.VAT - DISCOUNT ELSE (AMOUNT + B.VAT - DISCOUNT) * - 1 END ) AS NETAMOUNT,
	C.SUPCode FROM RMD_TRNMAIN A INNER JOIN Rmd_Trnprod B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION inner join menuitem C on b.mcode=c.mcode
	Where A.DIVISION LIKE @DIV AND (TRNDATE>= @DATE1 AND TRNDATE<=@DATE2) 
	and left(A.vchrno,2) in ('PI','PR') and C.MGROUP LIKE @MGROUP
	GROUP BY C.SUPCODE
	) AS B LEFT JOIN RMD_ACLIST A ON B.SUPCODE = A.ACID 
	ORDER BY CASE WHEN(@RMODE = 1) THEN B.Qty ELSE (B.NETAMOUNT) END DESC ,  A.ACNAME
	
	
ELSE IF @FLAG = 4		-- SUPPLIER WISE ITEM


		BEGIN
			SELECT NULL AS SNO, A.MENUCODE, A.DESCA, A.BASEUNIT AS UNIT, B.QTY, B.AMOUNT AS GROSS, B.DISCOUNT,B.NETSALE,B.VRATE,B.NETAMOUNT,B.MCODE 
			FROM MENUITEM A inner join 
			(
			SELECT SUM(REALQTY_IN-REALQTY) AS QTY, SUM( CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') 
                      THEN AMOUNT ELSE AMOUNT * - 1 END)  AS AMOUNT,SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN DISCOUNT ELSE DISCOUNT * - 1 END) AS DISCOUNT, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.TAXABLE ELSE B.TAXABLE * - 1 END + CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN B.NONTAXABLE ELSE B.NONTAXABLE * - 1 END ) AS NETSALE, 
                      SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN VAT ELSE VAT * - 1 END) AS VRATE,
                      SUM(CASE  LEFT(A.VCHRNO, 2) When 'PI' THEN AMOUNT + B.VAT - DISCOUNT ELSE (AMOUNT + B.VAT - DISCOUNT) * - 1 END ) AS NETAMOUNT,
	B.MCODE FROM RMD_TRNMAIN A INNER JOIN Rmd_Trnprod B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
	Where A.DIVISION LIKE @DIV AND (TRNDATE>= @DATE1 AND TRNDATE<=@DATE2) 
	and left(A.vchrno,2) in ('PI','PR')
	GROUP BY B.MCODE
			) AS B on A.MCODE = B.MCODE  where A.MGROUP LIKE @MGROUP AND A.SUPCODE LIKE @PARTY
			ORDER BY CASE WHEN(@RMODE = 1) THEN B.Qty ELSE (B.NETAMOUNT) END DESC , A.DESCA	
		END


--select SUM(CASE WHEN LEFT(A.VCHRNO, 2) IN ('PI') THEN Vat ELSE VAT * - 1 END) AS VRATE  from rmd_trnprod A where vchrno like 'PI%'
--select * from rmd_trnprod where left(vchrno,2) in ('PI','PR') and mcode='M500752'

--select * from menuitem where menucode='318-06B'

