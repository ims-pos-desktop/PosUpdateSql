CREATE OR ALTER   PROCEDURE  [dbo].[SP_ANNEX7]
--DECLARE
	@DATE1 DATETIME ,
	@DATE2 DATETIME ,
	@DIV VARCHAR(5) = '%'
AS

--select @date1 = '2024-01-01' , @date2 = '2024-04-01'

DROP TABLE IF EXISTS #TRNMAIN

SELECT PHISCALID FISCAL_YEAR, posTm.VCHRNO BILL_NO, BILLTO CUSTOMER_NAME, BILLTOTEL CUSTOMER_PAN, TRNDATE BILL_DATE,
TAXABLE+NONTAXABLE+DCAMNT AMOUNT, DCAMNT DISCOUNT, TAXABLE TAXABLE_AMOUNT, VATAMNT TAX_AMOUNT,
'YES' IS_PRINTED, IIF(ISNULL(activeStatus.activeVoucher,'~') = '~',0,1) IS_ACTIVE,
TRNTIME PRINTED_TIME, TRNUSER ETERED_BY, TRNUSER PRINTED_BY, TRNDATE AS EDATE, STAMP, DIVISION, PhiscalID, TRNMODE 
INTO #TRNMAIN
FROM RMD_TRNMAIN posTm WITH (NOLOCK)
outer apply	(

			select distinct activeCheck.VCHRNO activeVoucher
			from	(

					SELECT posTp.VCHRNO,posTp.MCODE,sum(posTp.Quantity) quantity 
					FROM RMD_TRNPROD posTp WITH (NOLOCK)
					WHERE posTp.VCHRNO = posTm.VCHRNO
					GROUP BY posTp.VCHRNO,posTp.MCODE

					UNION ALL

					SELECT negTM.REFBILL,negTP.MCODE,sum(negTP.Quantity)*-1 quantity
					FROM RMD_TRNMAIN negTM WITH (NOLOCK)
					JOIN RMD_TRNPROD negTP WITH (NOLOCK) ON negTm.VCHRNO = negTP.VCHRNO
					WHERE negTm.REFBILL = posTm.VCHRNO
					GROUP BY negTM.REFBILL,negTP.MCODE

					) activeCheck
			GROUP BY activeCheck.VCHRNO , activeCheck.MCODE
			HAVING SUM(quantity) > 0

			) activeStatus
WHERE VoucherType IN ('SI','TI','RE')
AND TRNDATE BETWEEN @DATE1 AND @DATE2 
AND DIVISION LIKE @DIV


SELECT bills.FISCAL_YEAR, bills.BILL_NO, bills.CUSTOMER_NAME, bills.CUSTOMER_PAN, bills.BILL_DATE, bills.AMOUNT, bills.DISCOUNT, bills.TAXABLE_AMOUNT, bills.TAX_AMOUNT,
bills.IS_PRINTED, bills.IS_ACTIVE, bills.PRINTED_TIME, ISNULL(printCount.PRINTNOS,1) [PRINT NOS], bills.ETERED_BY, bills.PRINTED_BY, bills.EDATE, bills.Stamp,
ISNULL(syncStatus.SYNC_WITH_IRD,'NO') SYNC_WITH_IRD, ISNULL(syncStatus.ISREALTIME,'NO') ISREALTIME, bills.TRNMODE Payment_Method, BOPI.VatRefund VAT_Refund_Amount, BOPI.PSO_TranId Transaction_Id
FROM #TRNMAIN bills
LEFT JOIN	(

			SELECT VCHRNO,COUNT(VCHRNO) + 1 PRINTNOS 
			FROM  tblPrintLog A WITH (NOLOCK)
			JOIN #TRNMAIN B ON A.VCHRNO = B.BILL_NO
			GROUP BY VCHRNO

			) printCount ON bills.BILL_NO = printCount.VCHRNO 
LEFT JOIN	(

			SELECT A.VCHRNO,
			IIF(COALESCE(C.[STATUS], A.[STATUS], 2) = 0 , 'YES' , 'NO' ) SYNC_WITH_IRD,
			IIF(COALESCE(C.[ISREALTIME], A.[IsRealTime], 0) = 0 , 'NO' , 'YES' ) ISREALTIME
			FROM TBLSYNCLOG A WITH (NOLOCK) 
			JOIN #TRNMAIN B ON A.VCHRNO = B.BILL_NO
			LEFT JOIN tblSyncLogStatus C WITH (NOLOCK) ON B.BILL_NO = C.VCHRNO

			) syncStatus ON bills.BILL_NO = syncStatus.VCHRNO 
LEFT JOIN RMD_BillOnlinePaymentInfo BOPI WITH (NOLOCK) ON bills.BILL_NO = BOPI.VCHRNO

SELECT NULL

DROP TABLE IF EXISTS #TRNMAIN