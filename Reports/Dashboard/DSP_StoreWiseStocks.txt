CREATE OR ALTER  PROC [dbo].[DSP_StoreWiseStocks]
@Date1 datetime ,@Date2 datetime
AS
--declare @Date1 datetime ='2020-02-1',@Date2 datetime='2020-11-30'
SELECT C.NAME + CASE WHEN C.NAME = ISNULL(D.NAME, 'HO') THEN '' ELSE  ' (' + ISNULL(D.NAME,'HO') + ')' END StoreName, C.COMPANYID, A.DIVISION, ISNULL(C.IS_FRANCHISE,0) IsFranchise,  UnitsInStock, TotalStockValue
FROM 
(
	SELECT COMPANYID, DIVISION, SUM(Stock) UnitsInStock, CONVERT(NUMERIC(14,2), SUM(PRATE_A * Stock)) TotalStockValue
	FROM
	(
		SELECT  TM.COMPANYID, TM.DIVISION, TP.MCODE, SUM(TP.REALQTY_IN - TP.REALQTY) Stock
		FROM RMD_TRNMAIN TM JOIN RMD_TRNPROD TP ON TM.VCHRNO=TP.VCHRNO AND TM.COMPANYID = TP.COMPANYID		
		WHERE TM.TRNDATE <= @Date2  --AND TP.WAREHOUSE IN (SELECT [NAME] FROM RMD_WAREHOUSE WHERE ISNULL(ISDELWARE,0) = 0 AND ISNULL(ISVIRTUAL,0) = 0)
		GROUP BY TM.COMPANYID, tm.DIVISION, TP.MCODE
	)X
	JOIN MENUITEM MI ON X.MCODE = MI.MCODE
	GROUP BY COMPANYID, DIVISION
) A
RIGHT JOIN COMPANY C ON C.COMPANYID = A.COMPANYID
LEFT JOIN DIVISION D ON D.INITIAL = A.DIVISION
GO

