CREATE OR ALTER   PROC [dbo].[DSP_StoreWiseSales]
@Date1 datetime ,@Date2 datetime
AS
--declare @Date1 datetime ='2020-11-1',@Date2 datetime='2020-11-30'
DECLARE @ShowDashboardInNet BIT
SELECT @ShowDashboardInNet = ShowDashboardInNet FROM SETTING
SELECT C.NAME + CASE WHEN C.NAME = ISNULL(D.NAME, 'HO') THEN '' ELSE  ' (' + ISNULL(D.NAME,'HO') + ')' END StoreName, C.COMPANYID, A.DIVISION, ISNULL(C.IS_FRANCHISE,0) IsFranchise, TotalSales, UnitSold
FROM 
(
    SELECT  TM.COMPANYID, TM.DIVISION,CONVERT(NUMERIC(14,2), SUM(CASE WHEN 0 = 1 THEN 
			(
				CASE WHEN  TM.VoucherType IN ('SI','TI') THEN TP.TAXABLE + TP.NONTAXABLE  ELSE -1 * (TP.TAXABLE + TP.NONTAXABLE) END
			) ELSE 
			(
				case when  tm.vouchertype in ('SI','TI') then TP.TAXABLE + TP.NONTAXABLE + TP.VAT  else -1 * (TP.TAXABLE + TP.NONTAXABLE + TP.VAT) END
			) end)) TotalSales, SUM(TP.REALQTY - TP.REALQTY_IN) UnitSold
    FROM RMD_TRNMAIN TM JOIN RMD_TRNPROD TP ON TM.VCHRNO=TP.VCHRNO AND TM.COMPANYID = TP.COMPANYID
    WHERE TM.TRNDATE BETWEEN @Date1 AND @Date2 AND 
	TM.VoucherType IN  ('SI','TI','CN') GROUP BY TM.COMPANYID, tm.DIVISION
) A
RIGHT JOIN COMPANY C ON C.COMPANYID = A.COMPANYID
LEFT JOIN DIVISION D ON D.INITIAL = A.DIVISION
ORDER BY TotalSales DESC