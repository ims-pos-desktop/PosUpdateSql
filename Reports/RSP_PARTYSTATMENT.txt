CREATE OR ALTER   PROCEDURE [dbo].[RSP_PARTYSTATEMENT]
--Declare
	@PLEDGER_ACID AS VARCHAR(25),
	@DATE1 AS DATETIME,
	@DATE2 AS DATETIME,
	@DIV VARCHAR(15)='%',
	@FYID VARCHAR(10) = '%',
	@CHK_ProductDetail TINYINT =0                  --ProductDetail:1:0  
AS

set nocount on 
DECLARE @ACID VARCHAR(25)
SET @ACID = @PLEDGER_ACID
--SEt @Acid ='PA2';set @date1='03/17/20';set @date2='9/30/20';set @div='%';

--TEMPORARY TABLE DECLARATION
-----------------------------

DECLARE @LedgerTable table(Sno numeric,trndate datetime,bsdate varchar(20),vchrno varchar(20),chalanno varchar(50),particulars varchar(100),
	Dramnt numeric(24,10),Cramnt numeric(24,10),naration VARCHAR(1500),B_acid varchar(20),division varchar(5),Balance numeric(24,10),A_acid varchar(20),Ccenter varchar(50), Rmk VARCHAR(1500),stamp numeric(22,8),Cheque varchar(50))

DECLARE @LedgerTable_tmp table(Sno numeric,trndate datetime,bsdate varchar(20),vchrno varchar(20),chalanno varchar(50),particulars varchar(100),
	Dramnt numeric(24,10),Cramnt numeric(24,10),naration VARCHAR(1500),B_acid varchar(20),division varchar(5),Balance numeric(24,10),A_acid varchar(20),Ccenter varchar(50), Rmk VARCHAR(1500),stamp numeric(22,8),Cheque varchar(50))

--DECLARING VARIABLES
---------------------
Declare @Sno numeric,@A_Acid varchar(20),@Dramnt numeric(24,10),@Cramnt numeric(24,10),@RunningTotal numeric(24,10)=0,
@A_Acid_Tmp varchar(20)='',@trndate datetime,@Bsdate varchar(20),@vchrno varchar(20),@Chalanno varchar(20),@particulars varchar(100),@naration VARCHAR(1500),
@B_acid varchar(20),@division varchar(5),@CCenter varchar(50), @Rmk VARCHAR(1500),@stamp numeric(22,8),@CHEQUE varchar(50),@vtype varchar(50),@CUSID VARCHAR(50)

SELECT @CUSID = CUSTID FROM CustomerProfile WHERE CUSTACCOUNT = @ACID

if @div='' set @div='%'
BEGIN

			Insert into @LedgerTable_tmp
			SELECT  ROW_NUMBER() over(PARTITION by  A_ACID  ORDER BY TRNDATE, VCHRNO) as SNo, TRNDATE, BSDATE, VCHRNO, CHALANNO, PARTICULARS,DRAMNT,CRAMNT,
			CASE WHEN CHARINDEX(CHAR(10),NARATION,0) >0 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END as NARATION, 
			B_ACID,DIVISION,DRAMNT-CRAMNT AS BALANCE,A_ACID,COSTCENTER,REMARKS,STAMP,CHEQUE
			FROM
			(
				--MAIN REPORT QUERY
				--------------------		
				SELECT NULL AS TRNDATE, NULL AS BSDATE, NULL AS VCHRNO, NULL AS CHALANNO, 'OPENING BALANCE' AS PARTICULARS,
				CASE WHEN(x.OPBAL >=0) THEN x.OPBAL ELSE 0 END AS DRAMNT, CASE WHEN(x.OPBAL<0) THEN x.OPBAL * -1 ELSE 0 END AS CRAMNT,'' AS NARATION,NULL AS DIVISION,'X001' A_acid,COSTCENTER COSTCENTER,NULL REMARKS,0 STAMP,NULL CHEQUE, NULL B_ACID 
				FROM
				(
					SELECT 'AT' A_ACID,'' COSTCENTER,sum(DRAMNT)-SUM(CRAMNT) AS OPBAL FROM DBO.RMD_TRNTRAN_FN(@FYID) A INNER JOIN DBO.RMD_TRNMAIN_FN(0,@FYID) B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION 
					WHERE A.A_ACID IN (select * from dbo.split(@acid,',')) AND A.DIVISION LIKE @DIV AND 
					(LEFT(A.VCHRNO,2) = 'OB' OR B.TRNDATE < @DATE1)					
				) as X right join rmd_aclist Y on x.A_acid=Y.acid WHERE Y.ACID = 'AT'
				
				UNION ALL

				SELECT M.TRNDATE, M.BSDATE,  M.VCHRNO, M.CHALANNO,
				dbo.GetParticularForLedger(M.VCHRNO,M.DIVISION)  AS PARTICULAR, CONVERT(MONEY,CAST(M.DRAMNT AS VARCHAR(25)),2) AS DRAMNT,
				CONVERT(MONEY, CAST(M.CRAMNT AS VARCHAR(25)),1) AS CRAMNT, M.NARATION, M.DIVISION,A_ACID,M.COSTCENTER,
				CASE WHEN M.NARATION = M.REMARKS THEN '' ELSE M.REMARKS END REMARKS,STAMP,
				CASE WHEN ISNULL(M.CHEQUENO,'') <> '' THEN ' Chq. No : ' + CAST(M.ChequeNo AS VARCHAR(25)) +  '  Dt : ' +  CAST(m.chequedate AS VARCHAR(25)) ELSE '' END AS CHEQUE, B_ACID
				FROM
				(
					SELECT B.TRNDATE,B.BSDATE,B.VCHRNO, B.CHALANNO, A.DIVISION, 'X001' A_ACID, SUM(DRAMNT) AS DRAMNT, SUM(CRAMNT) AS CRAMNT, case when isnull(NARATION1,'')='' then NARATION ELSE NARATION1 END  AS NARATION,'' COSTCENTER,ISNULL(B.REMARKS,'')REMARKS,
					ISNULL(B.STAMP,convert(float,convert(datetime,B.TRNDATE + ' ' + ISNULL(B.TRNTIME,'00:01:00')))) STAMP,ISNULL(A.CHEQUENO,'') CHEQUENO,ISNULL(A.CHEQUEDATE,'') CHEQUEDATE, CASE WHEN A.A_ACID = A.B_ACID THEN NULL ELSE A.B_ACID END B_ACID from 
					DBO.RMD_TRNTRAN_FN(@FYID) AS A INNER JOIN DBO.RMD_TRNMAIN_FN(0,@FYID) B ON A.VCHRNO=B.VCHRNO AND A.DIVISION=B.DIVISION 
					WHERE (A_ACID = @ACID OR (B.TRNMODE <> 'Credit' AND B.RECEIVEBY = @CUSID)) AND A.DIVISION LIKE @DIV  AND (B.TRNDATE between @DATE1 and @DATE2)
					AND LEFT(A.VCHRNO,2) <> 'OB' 
					GROUP BY B.VCHRNO,B.CHALANNO,A.DIVISION,case when isnull(NARATION1,'')='' then NARATION ELSE NARATION1 END,B.REMARKS,B.TRNDATE,B.BSDATE,ISNULL(A.CHEQUENO,''),ISNULL(A.CHEQUEDATE,''),
					ISNULL(B.STAMP,convert(float,convert(datetime,B.TRNDATE + ' ' + ISNULL(B.TRNTIME,'00:01:00')))), CASE WHEN A.A_ACID = A.B_ACID THEN NULL ELSE A.B_ACID END
				) AS M
			)A


--SELECT * FROM @LedgerTable_tmp

----PREPARING RECORD WITH RUNNING TOTAL
---------------------------------------
INSERT INTO @LedgerTable SELECT SNO, TRNDATE, BSDATE, VCHRNO, CHALANNO, PARTICULARS, DRAMNT, CRAMNT, NARATION, B_ACID, DIVISION, SUM(DRAMNT-CRAMNT) OVER (PARTITION BY A_ACID ORDER BY SNO), A_ACID, CCENTER, RMK, STAMP, CHEQUE FROM @Ledgertable_tmp

--select * from @LedgerTable order by a_acid,sno


----PREPARING REPORT OUTPUT
----------------------------
SELECT [DATE], MITI, VNO,PARTICULAR,VTYPE,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT,
		BALANCE,B_ACID,DIVISION,XSNO,NULL CCENTER FROM 
		(
		--ACCOUNT NAME

		SELECT 0 SNO,NULL AS [DATE], NULL AS MITI,NULL VNO,'A/C : ' + UPPER(Y.ACNAME)  AS PARTICULAR,NULL VTYPE,NULL AS DRAMNT,NULL AS CRAMNT,NULL BALANCE,NULL B_ACID,NULL AS DIVISION,NULL AS ORD,0 STAMP,A_acid,5 XSNO 
		FROM @LedgerTable X INNER JOIN RMD_ACLIST Y ON X.A_ACID = Y.ACID  GROUP BY A_ACID,Y.ACNAME
 		
		UNION ALL		

		--DETAIL PART
		SELECT A.SNO, CONVERT(VARCHAR(25),A.TRNDATE,105) [DATE], A.BSDATE,
		CASE WHEN UPPER(A.PARTICULARS) <> 'OPENING BALANCE' THEN A.VCHRNO + CASE WHEN A.chalanno <> '' AND A.chalanno <> A.VCHRNO 
		THEN ' (' + A.CHALANNO + ')' ELSE '' END ELSE '' END VNO,
		CASE WHEN UPPER(A.PARTICULARS) <> 'OPENING BALANCE' THEN ISNULL(X.ACNAME, 'As Per Journal') ELSE A.PARTICULARS END PARTICULARS,
		CASE WHEN UPPER(A.PARTICULARS) <> 'OPENING BALANCE' THEN A.PARTICULARS ELSE '' END VTYPE, 
		A.DRAMNT,A.CRAMNT,
		CONVERT(VARCHAR,CAST(ABS(A.BALANCE) AS MONEY),1) + CASE WHEN A.BALANCE >=0 THEN ' DR' ELSE ' CR' END BALANCE,
		A.B_ACID,A.DIVISION,'A' ORD,A.STAMP,A_acid, 
		CASE WHEN UPPER(A.PARTICULARS) = 'OPENING BALANCE' then 10 else 0 end XSNO  
		FROM @LedgerTable A
		LEFT JOIN RMD_ACLIST X ON A.B_ACID = X.ACID

		UNION ALL
		--ITEM DETAIL 
		SELECT X.SNO,NULL [DATE], NULL MITI,NULL VNO, CAST(B.SNO AS VARCHAR(25)) + '. ' + LEFT(A.DESCA,30) + '  (@' + CAST(B.RATE AS VARCHAR(25)) + ' X ' + CAST(B.QUANTITY AS VARCHAR(25)) + ' = ' + CAST(B.AMOUNT AS VARCHAR(25)) +')' [PARTICULARS],
		NULL VTYPE,NULL DRAMNT, NULL CRAMNT,NULL BALANCE,NULL B_ACID,X.DIVISION,'A1' ORD,X.STAMP,X.A_acid,ISNULL(B.SNO,0) XSNO  FROM @LedgerTable X INNER JOIN DBO.RMD_TRNPROD_FN(0,@FYID) B ON X.vchrno = B.VCHRNO AND 
		X.DIVISION = B.DIVISION INNER JOIN MENUITEM A ON B.MCODE = A.MCODE AND @CHK_ProductDetail = 1

		UNION ALL
		--NARATION
		SELECT Sno,'' AS [DATE], '' MITI, '                    Nar :' VNO,  X.naration + ' ' + case when x.cheque <> '' then x.Cheque else '' end  AS PARTICULAR,NULL VTYPE,NULL AS DRAMNT,NULL AS CRAMNT,NULL BALANCE,NULL B_ACID,NULL AS DIVISION,'C' AS ORD,0 STAMP,A_acid,100 XSNO  
		FROM @LedgerTable X LEFT JOIN RMD_ACLIST Y ON X.A_ACID = Y.ACID WHERE ISNULL(X.NARATION,'') <> '' 
		GROUP BY A_ACID,X.naration,x.vchrno,sno,cheque,case when x.cheque <> '' then x.Cheque else '' end

		UNION ALL

		SELECT Sno,'' [DATE], '' MITI, '                    Rmk :' VNO, X.rmk  AS PARTICULAR,NULL VTYPE,NULL AS DRAMNT,NULL AS CRAMNT,NULL BALANCE,NULL B_ACID,NULL AS DIVISION,'D' AS ORD,0 STAMP,A_acid,100 XSNO  
		FROM @LedgerTable X LEFT JOIN RMD_ACLIST Y ON X.A_ACID = Y.ACID WHERE ISNULL(X.rmk,'') <> '' GROUP BY A_ACID,X.rmk,x.vchrno,sno

		UNION ALL
		--BLANK
		SELECT MAX(SNO)+1,NULL AS [DATE], NULL MITI,NULL VNO,NULL AS PARTICULAR,NULL VTYPE,NULL DRAMNT, NULL CRAMNT,NULL BALANCE,NULL B_ACID,NULL AS DIVISION,'E' AS ORD,0 STAMP, A_acid,0 XSNO
		FROM @LedgerTable GROUP BY A_ACID

		UNION ALL	
		--RUNNING TOTAL
		
		SELECT MAX(SNO)+2,NULL AS [DATE], NULL MITI,NULL VNO,'RUNNING TOTAL >>' PARTICULAR,NULL VTYPE,SUM(DRAMNT) DRAMNT, SUM(CRAMNT) CRAMNT,
		CONVERT(VARCHAR,CAST(ABS(SUM(DRAMNT)- SUM(CRAMNT)) AS MONEY),1) + CASE WHEN SUM(DRAMNT)- SUM(CRAMNT) >=0 THEN ' DR' ELSE ' CR' END BALANCE,
		NULL B_ACID,NULL AS DIVISION,'F' AS ORD,0 STAMP,A_ACID A_acid,1000 XSNO
		FROM @LedgerTable WHERE PARTICULARS NOT LIKE 'OPENING BALANCE' GROUP BY A_ACID

		UNION ALL	
		--LEDGER TOTAL
		SELECT MAX(SNO)+3,NULL AS [DATE], NULL MITI,NULL VNO,'LEDGER TOTAL >>' PARTICULAR,NULL VTYPE,SUM(DRAMNT) DRAMNT, SUM(CRAMNT) CRAMNT,
		CONVERT(VARCHAR,CAST(ABS(SUM(DRAMNT)- SUM(CRAMNT)) AS MONEY),1) + CASE WHEN SUM(DRAMNT)- SUM(CRAMNT) >=0 THEN ' DR' ELSE ' CR' END BALANCE,
		NULL B_ACID,NULL AS DIVISION,'F' AS ORD,0 STAMP,A_ACID A_acid,1000 XSNO
		FROM @LedgerTable GROUP BY A_ACID

		UNION ALL
		--BLANK
		SELECT MAX(SNO)+4,NULL AS [DATE], NULL MITI,NULL VNO,NULL AS PARTICULAR,NULL VTYPE,NULL DRAMNT, NULL CRAMNT,NULL BALANCE,NULL B_ACID,NULL AS DIVISION,'G' AS ORD,0 STAMP, A_acid,0 XSNO
		FROM @LedgerTable GROUP BY A_ACID

		UNION ALL
		--GRAND TOTAL OPENING
		SELECT MAX(SNO)+5,NULL AS [DATE], NULL MITI,NULL VNO,'GRAND TOTAL OPENING >>' PARTICULAR,NULL VTYPE,SUM(DRAMNT) DRAMNT, SUM(CRAMNT) CRAMNT,
		NULL BALANCE,NULL B_ACID,NULL AS DIVISION,'H' AS ORD,0 STAMP, 'Z0000001' A_acid,1000 XSNO 
		FROM @LedgerTable WHERE PARTICULARS  = 'OPENING BALANCE' 

		UNION ALL
		--GRAND TOTAL RUNNING TOTAL
		SELECT MAX(SNO)+6,NULL AS [DATE], NULL MITI,NULL VNO,'GRAND RUNNING TOTAL >>' PARTICULAR,NULL VTYPE,SUM(DRAMNT) DRAMNT, SUM(CRAMNT) CRAMNT,
		CONVERT(VARCHAR,CAST(ABS(SUM(DRAMNT)- SUM(CRAMNT)) AS MONEY),1) + CASE WHEN SUM(DRAMNT)- SUM(CRAMNT) >=0 THEN ' DR' ELSE ' CR' END BALANCE,
		NULL B_ACID,NULL AS DIVISION,'I' AS ORD,0 STAMP,'Z0000001' A_acid,1000 XSNO
		FROM @LedgerTable WHERE PARTICULARS NOT LIKE 'OPENING BALANCE' 
		UNION ALL
		--GRAND TOTAL
		SELECT MAX(SNO)+7,NULL AS [DATE], NULL MITI,NULL VNO,'GRAND TOTAL >>' PARTICULAR,NULL VTYPE,SUM(DRAMNT) DRAMNT, SUM(CRAMNT) CRAMNT,
		CONVERT(VARCHAR,CAST(ABS(SUM(DRAMNT)- SUM(CRAMNT)) AS MONEY),1)  + CASE WHEN SUM(DRAMNT)- SUM(CRAMNT) >=0 THEN ' DR' ELSE ' CR' END BALANCE,
		NULL B_ACID,NULL AS DIVISION,'J' AS ORD,0 STAMP,'Z0000001' A_acid,1000 XSNO 
		FROM @LedgerTable

		) A WHERE SNO IS NOT NULL ORDER BY A_ACID,SNO,ORD,STAMP,XSNO
END