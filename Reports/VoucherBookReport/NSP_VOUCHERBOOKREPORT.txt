CREATE OR ALTER PROCEDURE [dbo].[NSP_VOUCHERBOOKREPORT]
--DECLARE
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIV varchar(10)='%',
	@SERIES AS VARCHAR(15) = '%',
	@TMODE VARCHAR(50) = '%',
	@VNO1 FLOAT = 0,
	@VNO2 FLOAT = 0,
	@REPMODE TINYINT = 0,
	@VTYPE VARCHAR(2) = 'RV'
AS

set nocount on

IF OBJECT_ID('TEMPDB..#RESULT') is not null drop table #RESULT


--SET @DATE1 = '01-01-2016'
--SET @DATE2 = '01-01-2018'
--SET @REPMODE = 1
--SET @VTYPE = 'PV'
--SET @VNO1 = 500
--SET @VNO2 = 500


	SET @SERIES = @SERIES + '%'

	SELECT * INTO #RESULT FROM
	(
		SELECT B.TRNDATE,A.VCHRNO,A.DIVISION,A.ACID,CASE @VTYPE WHEN 'RV' THEN NULL ELSE A.AMNT END DRAMNT,CASE @VTYPE WHEN 'RV' THEN A.AMNT ELSE NULL END CRAMNT,A.NARRATION,A.COSTCENTER,A.SNO+1 SNO,A.CHEQUENO,A.CHEQUEDATE,A.PhiscalID,ISNULL(B.VNUM,B.VCHRNO) VNUM FROM RMD_RECPAY A
		INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND ISNULL(A.PHISCALID,'') = ISNULL(B.PHISCALID,'')
		WHERE ((@REPMODE = 0 AND B.TRNDATE BETWEEN @DATE1 AND @DATE2) OR (@REPMODE = 1 AND CAST(SUBSTRING(ISNULL(B.VNUM,B.VCHRNO),3,LEN(ISNULL(B.VNUM,B.VCHRNO))) AS NUMERIC) BETWEEN @VNO1 AND @VNO2))
		AND A.VCHRNO LIKE @SERIES and A.DIVISION like @DIV AND dbo.getvouchertype(A.VCHRNO) like @VTYPE AND ISNULL(B.TRNMODE,'') LIKE @TMODE
		
		UNION ALL	
		
		SELECT A.TRNDATE, A.VCHRNO,A.DIVISION,A.TRNAC ACID,CASE @VTYPE WHEN 'RV' THEN B.AMNT ELSE NULL END DRAMNT,CASE @VTYPE WHEN 'RV' THEN NULL ELSE B.AMNT  END CRAMNT,NULL NARRATION,NULL COSTCENTER,0 SNO,NULL CHEQUENO,NULL CHEQUEDATE,A.PHISCALID,ISNULL(A.VNUM,A.VCHRNO)
		FROM RMD_TRNMAIN A INNER JOIN 
		(SELECT A.VCHRNO,A.DIVISION,A.PHISCALID,SUM(AMNT)AMNT FROM RMD_RECPAY A GROUP BY VCHRNO,DIVISION,PHISCALID) B
		ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND ISNULL(A.PHISCALID,'') = ISNULL(B.PHISCALID,'')
		WHERE ((@REPMODE = 0 AND A.TRNDATE BETWEEN @DATE1 AND @DATE2) OR (@REPMODE = 1 AND CAST(SUBSTRING(ISNULL(A.VNUM,A.VCHRNO),3,LEN(ISNULL(A.VNUM,A.VCHRNO))) AS NUMERIC) BETWEEN @VNO1 AND @VNO2))
		AND A.VCHRNO LIKE @SERIES and A.DIVISION like @DIV AND dbo.getvouchertype(A.VCHRNO) like @VTYPE AND ISNULL(A.TRNMODE,'') LIKE @TMODE
	) B

	SELECT TRNDATE, BSDATE,VCHRNO,CHALANNO, VOUCHERTYPE,	
	ACNAME, CASE WHEN(DRAMNT=0) THEN  NULL ELSE DRAMNT END AS DRAMNT, 
	CASE WHEN(CRAMNT=0) THEN  NULL ELSE CRAMNT END AS CRAMNT, 
	CASE WHEN CHARINDEX(CHAR(10),NARRATION,0) >0 THEN LEFT(NARRATION,LEN(NARRATION)-2) ELSE NARRATION END as NARRATION,CHEQUENO,CHEQUEDATE,
	COSTCENTER,DIVISION,TRNUSER,TRNTIME,POSTUSER,DIV,FLAG	
	FROM
	(
	SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.CHALANNO,
	TRNMODE VOUCHERTYPE,
	NULL ACNAME, NULL DRAMNT,  NULL CRAMNT, A.REMARKS NARRATION,NULL COSTCENTER,NULL CHEQUENO,NULL CHEQUEDATE,D.NAME DIVISION,A.TRNUSER,A.TRNTIME,A.POSTUSER,D.INITIAL DIV, A.TRNDATE AS TDATE,A.VCHRNO AS VCHR, 'A' AS FLAG,0 SNO,ISNULL(A.VNUM,A.VCHRNO) VNUM
	FROM RMD_TRNMAIN A INNER JOIN DIVISION D ON A.DIVISION = D.INITIAL 
	WHERE ((@REPMODE = 0 AND A.TRNDATE BETWEEN @DATE1 AND @DATE2) OR (@REPMODE = 1 AND CAST(SUBSTRING(ISNULL(A.VNUM,A.VCHRNO),3,LEN(ISNULL(A.VNUM,A.VCHRNO))) AS NUMERIC) BETWEEN @VNO1 AND @VNO2))
	AND A.VCHRNO LIKE @SERIES and A.DIVISION like @DIV AND dbo.getvouchertype(A.VCHRNO) like @VTYPE AND ISNULL(A.TRNMODE,'') LIKE @TMODE
	
	UNION ALL

	SELECT NULL VCHRNO, NULL CHALANNO, NULL TRNDATE,  NULL BSDATE,NULL,	C.ACNAME, B.DRAMNT,  B.CRAMNT, B.NARRATION,B.COSTCENTER,B.CHEQUENO,CASE WHEN ISNULL(B.CHEQUEDATE,'') = '__/__/__' THEN NULL ELSE B.CHEQUEDATE END CHEQUEDATE ,NULL  DIVISION,NULL TRNUSER,NULL TRNTIME,NULL POSTUSER,B.DIVISION DIV, B.TRNDATE AS TDATE,B.VCHRNO AS VCHR, 'B' AS FLAG,B.SNO,ISNULL(B.VNUM,B.VCHRNO) VNUM
	FROM #RESULT B INNER JOIN RMD_ACLIST C ON B.ACID = C.ACID
		
	UNION ALL
	
	SELECT NULL,NULL,NULL,NULL,NULL,'TOTAL >>' ACNAME, SUM(A.DRAMNT) DRAMNT,  SUM(A.CRAMNT) CRAMNT, NULL NARATION,NULL,NULL,NULL,NULL,NULL,NULL,NULL, A.DIVISION DIV,A.TRNDATE AS TDATE,A.VCHRNO AS VCHR, 'C' AS FLAG,0 SNO,ISNULL(A.VNUM,A.VCHRNO) VNUM FROM
	#RESULT A GROUP BY A.DIVISION,A.TRNDATE,A.VCHRNO,ISNULL(A.VNUM,A.VCHRNO)
	
	UNION ALL
	
	SELECT NULL,NULL,NULL,NULL,NULL,NULL ACNAME, NULL DRAMNT,  NULL CRAMNT, NULL NARATION,NULL,NULL,NULL,NULL,NULL,NULL,NULL, A.DIVISION DIV, A.TRNDATE AS TDATE,A.VCHRNO AS VCHR, 'D' AS FLAG,0 SNO,ISNULL(A.VNUM,A.VCHRNO) VNUM
	FROM RMD_TRNMAIN A
	WHERE ((@REPMODE = 0 AND A.TRNDATE BETWEEN @DATE1 AND @DATE2) OR (@REPMODE = 1 AND CAST(SUBSTRING(ISNULL(A.VNUM,A.VCHRNO),3,LEN(ISNULL(A.VNUM,A.VCHRNO))) AS NUMERIC) BETWEEN @VNO1 AND @VNO2))
	AND A.VCHRNO LIKE @SERIES and A.DIVISION like @DIV AND dbo.getvouchertype(A.VCHRNO) like @VTYPE AND ISNULL(A.TRNMODE,'') LIKE @TMODE
	
	UNION ALL
	
	SELECT NULL,NULL,NULL,NULL,NULL,'GRAND TOTAL >>' ACNAME, SUM(A.DRAMNT) DRAMNT,  SUM(A.CRAMNT) CRAMNT, NULL NARATION,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'ZZZZZZZ' DIV, '01-01-2050' AS TDATE,'ZZ1' AS VCHR, 'Z' AS FLAG,0 SNO,'ZZ1' VNUM
	FROM #RESULT A
	
	) AS Z ORDER BY TDATE,DIV,LEFT(VNUM,2), CAST(SUBSTRING(VNUM,3, LEN(VNUM)) AS NUMERIC),FLAG,SNO

set nocount off

