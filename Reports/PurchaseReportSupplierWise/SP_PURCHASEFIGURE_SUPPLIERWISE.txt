CREATE OR ALTER PROCEDURE [dbo].[SP_PURCHASEFIGURE_SUPPLIERWISE]
	@DATE1 AS DATETIME,
	@DATE2 AS DATETIME,
	@ACID AS VARCHAR(25) = '%',
	@TOPNSORT AS TINYINT,
	@DIV AS VARCHAR(10),
	@AMOUNT AS NUMERIC(18,2) = 0,
	@SUMMARY TINYINT = 0
AS

IF @SUMMARY = 1
	
	SELECT * FROM 
	(
	SELECT ROW_NUMBER() OVER (ORDER BY ISNULL(B.ACNAME,'UNKNOWN SUPPLIER')) AS SNO,ISNULL(B.ACNAME,'UNKNOWN SUPPLIER') AS ACNAME,VATNO, SUM(AMOUNT) AS GROSS, SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE) + SUM(A.NONTAXABLE) AS NETSALE,SUM(A.TAXABLE)AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXABLE,
	SUM(A.VAT) AS VATAMNT,SUM(A.NETAMOUNT) AS NETAMOUNT,B.ACID
	FROM TRNPROD_PURCHASEVIEW A INNER JOIN RMD_TRNMAIN C ON A.VCHRNO = C.VCHRNO AND A.DIVISION = C.DIVISION AND A.PHISCALID = C.PhiscalID 
	LEFT JOIN RMD_ACLIST B ON C.TRNAC = B.ACID WHERE C.DIVISION LIKE @DIV AND C.TRNDATE BETWEEN @DATE1 AND @DATE2 AND C.TRNAC LIKE @ACID AND
	LEFT(A.VCHRNO,2) IN ('PI','PR','DN') GROUP BY ISNULL(B.ACNAME,'UNKNOWN SUPPLIER'),VATNO,B.ACID,C.TRNAC
	) A WHERE (@AMOUNT=0 AND ABS(NETSALE)>=0) OR (@AMOUNT<>0 AND NETSALE >=@AMOUNT) 
	ORDER BY CASE WHEN @TOPNSORT = 1 THEN NETAMOUNT END DESC,ACNAME

ELSE

	SELECT ROW_NUMBER() OVER (ORDER BY MENUCODE) AS SNO, MENUCODE,DESCA,SUM(REALQTY_IN) - SUM(REALQTY) AS QUANTITY,
	CASE WHEN SUM(REALQTY_IN) - SUM(REALQTY) = 0 THEN 0 ELSE ROUND(SUM(AMOUNT)/(SUM(REALQTY_IN) - SUM(REALQTY)),2) END RATE ,SUM(AMOUNT) AS AMOUNT, SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VAT) AS VAT,SUM(A.NETAMOUNT) AS BILLAMNT,MCODE
	FROM TRNPROD_PURCHASEVIEW A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
	WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('PI','PR','DN') AND ISNULL(B.TRNAC,'') = @ACID
	GROUP BY MCODE,MENUCODE,DESCA ORDER BY DESCA

