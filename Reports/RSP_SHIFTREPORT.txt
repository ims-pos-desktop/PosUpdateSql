CREATE OR ALTER   PROC[dbo].[RSP_SHIFTREPORT]
--Declare 
@DIVISION  varchar(20)='',
@PHISCALID  varchar(20)=''
AS
/*
set @DIVISION  ='PKR';
set @PHISCALID  ='79/80';
*/
SELECT  A.DAYSTARTID, 
	CAST( A.DAYSTARTDATE as date) DAYSTARTDATE, 
	FORMAT(CAST( A.DAYSTARTDATE as datetime2), N'hh:mm tt') DAYSTARTTIME, 
	B.SessionID, 
	c.NAME TERMINAL,
	B.UserID, 
	CAST(B.SessionStartDate as date) SessionStartDate, 
	FORMAT(CAST( B.SessionStartDate as datetime2), N'hh:mm tt') SessionStartTime,
	IIF(B.SessionEndDate is null ,'ACTIVE','CLOSED') SessionStatus,
	D.BILLS TotalBills,
	IIF(B.SessionEndDate is null,0,CAST(D.TOTALSALES AS decimal(20,2))) TOTALSALES, 
	CAST(ISNULL(E.AMOUNT, 0) AS decimal(20,2)) AS COUNTERAMOUNT,
	CAST(ISNULL(P.AMOUNT, 0) AS decimal(20,2)) AS PAYOUTAMOUNT, 
	CAST(ISNULL(Q.AMOUNT, 0) AS decimal(20,2)) AS CASHDROPAMOUNT 
From [DAYS] A 
JOIN [Session] B ON A.DAYSTARTID=B.DAYSTARTID AND A.DIVISION=B.Division AND A.PhiscalID=B.PhiscalID 
JOIN SALESTERMINAL c on b.TerminalID=c.INITIAL
LEFT JOIN 
( 
	SELECT SHIFT SESSIONID,DIVISION,PhiscalID , SUM(BILLS) BILLS,
	SUM( NETAMNT * MPLR) TOTALSALES FROM 
	(
		SELECT VoucherType, SHIFT,NETAMNT,DIVISION,PhiscalID, 1 BILLS, 1 MPLR FROM ABBMAIN 
		UNION ALL 
		SELECT VoucherType, SHIFT,NETAMNT,DIVISION,PhiscalID, 1 BILLS, IIF(VoucherType = 'CN',-1,1)MPLR FROM TRNMAIN 
	)
	AS A GROUP BY SHIFT,DIVISION,PhiscalID 
) as D ON B.SessionID=D.SESSIONID AND B.Division=D.DIVISION AND B.PhiscalID =D.PhiscalID 
LEFT JOIN 
(
	SELECT SESSIONID,DIVISION,PhiscalID,SUM(AMOUNT) AMOUNT FROM tblDenomination GROUP BY SESSIONID,DIVISION,PhiscalID
)  AS E ON B.SessionID = E.SESSIONID AND B.Division=E.DIVISION AND B.PhiscalID=E.PhiscalID 
LEFT JOIN 
(
	SELECT SUM(AMOUNT) AMOUNT,DIVISION,SHIFTID,PHISCALID FROM CASHFLOWTRAN GROUP BY SHIFTID,DIVISION,PhiscalID
) P ON B.Division=P.division AND B.SessionID=P.SHIFTID AND B.PhiscalID=P.PhiscalID
LEFT JOIN 
(
	SELECT SUM(AMOUNT) AMOUNT,DIVISION,SHIFTID,PHISCALID FROM PARTIALSETTLEMENT GROUP BY SHIFTID,DIVISION,PhiscalID
) Q ON B.Division=Q.division AND B.SessionID=Q.SHIFTID AND B.PhiscalID=Q.PhiscalID
WHERE  A.DIVISION =@DIVISION AND A.PHISCALID = @PHISCALID
