CREATE OR ALTER   PROC [dbo].[RSP_SHIFTCLOSEREPORT]
--DECLARE 
@DIVISION VARCHAR(3) = '%',
@DATE1 DATETIME,
@DATE2 DATETIME,
@USER VARCHAR(50) = '%',
@SALESTERMINAL VARCHAR(3) = '%'
AS
--SET @DATE1 = '2022-07-01'
--SET @DATE2 = '2022-07-27'
--set @DIVISION=N'%' ; set @DATE1='2021-06-01 00:00:00' ; set @DATE2='2022-06-20 00:00:00' ; set @USER=N'%' ; set @SALESTERMINAL=N'%'

;WITH SETTLEMENT AS
(
	select S.SESSIONID, S.DIVISION, S.PhiscalID, S.USERID, S.SessionStartDate, S.SessionEndDate, S.SessionEndUser, S.TerminalID, SUM(D.AMOUNT) SETTLEMENTAMOUNT
	, ISNULL(P.AMOUNT,0) PAYOUTAMOUNT, ISNULL(C.AMOUNT,0) CASHDROPAMOUNT
	FROM Session S 
	LEFT JOIN tblDenomination D ON D.SESSIONID = S.SessionID AND S.DIVISION = D.DIVISION AND S.PhiscalID = D.PhiscalID
	LEFT JOIN (SELECT SUM(AMOUNT) AMOUNT,DIVISION,SHIFTID,PHISCALID FROM CASHFLOWTRAN GROUP BY SHIFTID,DIVISION,PhiscalID) P ON S.Division=P.division AND S.SessionID=P.SHIFTID AND S.PhiscalID=P.PhiscalID
	LEFT JOIN (SELECT SUM(AMOUNT) AMOUNT,DIVISION,SHIFTID,PHISCALID FROM PARTIALSETTLEMENT GROUP BY SHIFTID,DIVISION,PhiscalID) C ON S.Division=C.division AND S.SessionID=C.SHIFTID AND S.PhiscalID=C.PhiscalID
	WHERE S.DIVISION LIKE @DIVISION AND S.UserID LIKE @USER AND S.TERMINALID LIKE @SALESTERMINAL AND CONVERT(DATE,SessionStartDate) BETWEEN @DATE1 AND @DATE2
	GROUP BY S.SESSIONID, S.USERID, S.SessionStartDate, S.SessionEndDate, S.SessionEndUser, S.TerminalID, S.DIVISION, S.PhiscalID,C.AMOUNT, P.AMOUNT
)

SELECT S.SessionID ShiftId, B.NAME AS TNAME, S.UserID, s.SessionStartDate,S.SessionEndDate, S.SessionEndUser, 
CONVERT(decimal(18,2),SUM(CASHSALE)) AS CASHSALE, 
CONVERT(decimal(18,2),SUM(CREDITCARD)) AS CREDITCARD, 
CONVERT(decimal(18,2),SUM(CREDIT)) AS CREDIT,
CONVERT(decimal(18,2),SUM(OTHER)) AS OTHER,
CONVERT(decimal(18,2),SUM(TOT)) AS TOT, 
CONVERT(decimal(18,2),SUM(SRETURN)) AS SRETURN, 
CONVERT(decimal(18,2),SUM(NET)) AS NET, 
CONVERT(decimal(18,2), S.SETTLEMENTAMOUNT) SETTLEMENTAMOUNT
,CONVERT(decimal(18,2),S.PAYOUTAMOUNT) PAYOUTAMOUNT,CONVERT(decimal(18,2),S.CASHDROPAMOUNT) CASHDROPAMOUNT
,CONVERT(decimal(18,2), S.SETTLEMENTAMOUNT + S.PAYOUTAMOUNT + S.CASHDROPAMOUNT - ISNULL(SUM(CASHSALE), 0)) [EXCESSSHORT]
FROM SETTLEMENT S LEFT JOIN 
(
	SELECT SHIFT, DIVISION, A.PHISCALID, TERMINAL, 
	X.NETCASH CASHSALE, 
	NCREDITCARD CREDITCARD,
	NCREDIT CREDIT,
	X.NGVOUCHER +X.NCVOUCHER + X.NPREPAID + X.N_ONLINE + X.NSalesReturnVoucher + X. NComplimentary  OTHER,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE 0 END AS TOT, 
	CASE WHEN(VCHRNO LIKE 'SR%' OR VCHRNO LIKE 'CN%' OR VCHRNO LIKE 'NR%' ) THEN NETAMNT ELSE 0 END AS SRETURN,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN NETAMNT ELSE NETAMNT *-1 END AS NET,
	CASE WHEN (LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN 1 ELSE 0 END AS NOS
	FROM RMD_TRNMAIN A JOIN BILLTENDER X ON A.VCHRNO = X.VNO AND A.DIVISION = X.DIV AND A.PhiscalID = X.PHISCALID 
	WHERE (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2)
	AND DIVISION LIKE @DIVISION AND LEFT(VCHRNO,2) IN ('SI','SR','TI','CN','NR','RE')
) AS A ON A.SHIFT = S.SessionID AND A.DIVISION = S.Division AND A.PhiscalID = S.PhiscalID
LEFT JOIN SALESTERMINAL B ON S.terminalid = B.INITIAL
WHERE ISNULL(B.INITIAL,'') LIKE @SALESTERMINAL
GROUP BY s.SessionID,A.TERMINAL, B.NAME, s.UserID, s.SessionStartDate, S.SessionEndDate, s.SessionEndUser, s.SETTLEMENTAMOUNT,S.PAYOUTAMOUNT,S.CASHDROPAMOUNT
ORDER BY s.SessionID
