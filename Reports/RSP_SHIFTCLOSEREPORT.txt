CREATE OR ALTER PROC RSP_SHIFTCLOSEREPORT
--DECLARE 
@DIVISION VARCHAR(3) = '%',
@DATE1 DATETIME,
@DATE2 DATETIME,
@USER VARCHAR(50) = '%',
@SALESTERMINAL VARCHAR(3) = '%'
AS
--SET @DATE1 = '2019-01-01'
--SET @DATE2 = '2019-01-31'

;WITH SETTLEMENT AS
(
	select S.SESSIONID, S.DIVISION, S.PhiscalID, S.USERID, S.SessionStartDate, S.SessionEndDate, S.SessionEndUser, S.TerminalID, SUM(AMOUNT) SETTLEMENTAMOUNT  
	FROM Session S LEFT JOIN tblDenomination D ON D.SESSIONID = S.SessionID AND S.DIVISION = D.DIVISION AND S.PhiscalID = D.PhiscalID
	WHERE S.DIVISION LIKE @DIVISION AND S.UserID LIKE @USER AND S.TERMINALID LIKE @SALESTERMINAL AND SessionStartDate BETWEEN @DATE1 AND @DATE2
	GROUP BY S.SESSIONID, S.USERID, S.SessionStartDate, S.SessionEndDate, S.SessionEndUser, S.TerminalID, S.DIVISION, S.PhiscalID
)

SELECT S.SessionID ShiftId, B.NAME AS TNAME, S.UserID, s.SessionStartDate,S.SessionEndDate, S.SessionEndUser, 
CONVERT(decimal(18,2),SUM(CASHSALE)) AS CASHSALE, CONVERT(decimal(18,2),SUM(CREDITCARD)) AS CREDITCARD, 
CONVERT(decimal(18,2),SUM(CREDIT)) AS CREDIT,CONVERT(decimal(18,2),SUM(OTHER)) AS OTHER,
CONVERT(decimal(18,2),SUM(TOT)) AS TOT, CONVERT(decimal(18,2),SUM(SRETURN)) AS SRETURN, 
CONVERT(decimal(18,2),SUM(NET)) AS NET, CONVERT(decimal(18,2), S.SETTLEMENTAMOUNT) SETTLEMENTAMOUNT, 
CONVERT(decimal(18,2), S.SETTLEMENTAMOUNT - ISNULL(SUM(CASHSALE), 0)) [EXCESSSHORT]
FROM SETTLEMENT S LEFT JOIN 
(
	SELECT SHIFT, DIVISION, A.PHISCALID, TERMINAL,
	CASE WHEN(TRNMODE = 'Cash' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE = 'MIXEDMODE' THEN ISNULL(NETCASH,0) ELSE 0 END END AS CASHSALE,
	CASE WHEN(TRNMODE IN('CreditCard', 'Credit Card') AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE = 'MIXEDMODE' THEN ISNULL(NCREDITCARD,0) ELSE 0 END  END AS CREDITCARD,
	CASE WHEN(TRNMODE = 'Credit' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE = 'MIXEDMODE' THEN ISNULL(NCREDIT,0) ELSE 0 END  END AS CREDIT,
	CASE WHEN(TRNMODE NOT IN ('Credit', 'CreditCard','Credit Card','Cash') AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE = 'MIXEDMODE' THEN ISNULL(NCREDIT,0) ELSE 0 END  END AS OTHER,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE 0 END AS TOT, 
	CASE WHEN(VCHRNO LIKE 'SR%' OR VCHRNO LIKE 'CN%' OR VCHRNO LIKE 'NR%' ) THEN NETAMNT ELSE 0 END AS SRETURN,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN NETAMNT ELSE NETAMNT *-1 END AS NET,
	CASE WHEN (LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN 1 ELSE 0 END AS NOS
	FROM RMD_TRNMAIN A LEFT JOIN BILLTENDER X ON A.VCHRNO = X.VNO AND A.DIVISION = X.DIV AND A.PhiscalID = X.PHISCALID 
	WHERE (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2)
	AND DIVISION LIKE @DIVISION AND LEFT(VCHRNO,2) IN ('SI','SR','TI','CN','NR','RE')
) AS A ON A.SHIFT = S.SessionID AND A.DIVISION = S.Division AND A.PhiscalID = S.PhiscalID
LEFT JOIN SALESTERMINAL B ON S.terminalid = B.INITIAL
WHERE ISNULL(B.INITIAL,'') LIKE @SALESTERMINAL
GROUP BY s.SessionID,A.TERMINAL, B.NAME, s.UserID, s.SessionStartDate, S.SessionEndDate, s.SessionEndUser, s.SETTLEMENTAMOUNT
ORDER BY s.SessionID