CREATE OR ALTER   PROCEDURE [dbo].[SP_SUPPLIERVSPRODUCT_EXVAT]
	@DATE1 AS DATETIME,
	@DATE2 AS DATETIME,
	@PARTY AS VARCHAR(25),
	@FLG AS TINYINT,
	@DIV AS VARCHAR(3) = '%'
AS

IF @FLG = 2	--ITEM WISE REPORT

BEGIN
	SELECT A.MENUCODE, A.DESCA, A.BASEUNIT, B.OPSTOCK, B.OPSTOCK *  A.PRATE_A AS OPSTOCKVALUE, B.PQTY, B.PAMOUNT, B.SQTY, B.SAMOUNT, B.ADJQTY, B.STOCK, A.PRATE_A AS RATE,B.STOCK * A.PRATE_A AS  STOCKVALUE,
	A.MCODE FROM MENUITEM A INNER JOIN 
	(
	SELECT MCODE, SUM(OP_IN) - SUM(OP_OUT) AS OPSTOCK, SUM(PQTY) - SUM(PRQTY) AS PQTY, SUM(PAMOUNT) - SUM(PRAMOUNT) AS PAMOUNT,
	SUM(SQTY) - SUM(SRQTY) AS SQTY, SUM(SAMOUNT) - SUM(SRAMOUNT) AS SAMOUNT, SUM(ADJQTY) AS ADJQTY, SUM(STOCK) AS STOCK
	FROM (
	SELECT MCODE,
	CASE WHEN A.TRNDATE <  @DATE1 OR A.VCHRNO LIKE 'OP%'  THEN B.REALQTY_IN ELSE 0 END AS OP_IN,
	CASE WHEN A.TRNDATE <  @DATE1 THEN B.REALQTY ELSE 0 END AS OP_OUT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PI' THEN B.REALQTY_IN ELSE 0 END AS PQTY,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PI' THEN B.NETAMOUNT-B.VAT ELSE 0 END AS PAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PR' THEN B.REALQTY ELSE 0 END AS PRQTY,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PR' THEN ABS(B.NETAMOUNT-B.VAT)  ELSE 0 END  AS PRAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','TI','NC','IC','RE') THEN B.REALQTY-B.REALQTY_IN  ELSE 0 END AS SQTY,
	CASE WHEN A.TRNDATE > @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','TI','NC','IC','RE') THEN B.NETAMOUNT-B.VAT  ELSE 0 END AS SAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SR','CN','IR','NR') THEN B.REALQTY_IN  ELSE 0 END AS SRQTY,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SR','CN','IR','NR') THEN ABS(B.NETAMOUNT-B.VAT)  ELSE 0 END AS SRAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('DM','SA') THEN B.REALQTY_IN- B.REALQTY ELSE 0 END AS ADJQTY,
	CASE WHEN  A.TRNDATE <= @DATE2 THEN B.REALQTY_IN- B.REALQTY ELSE 0 END AS STOCK 
	 FROM RMD_TRNMAIN A INNER JOIN RMD_TRNPROD_REPORT_COSTVALUE B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION WHERE A.VCHRNO NOT LIKE 'IS%'
	AND A.DIVISION LIKE @DIV
	) AS A GROUP BY MCODE
	) AS B ON A.MCODE = B.MCODE WHERE ISNULL(SUPCODE,'') = @PARTY

END
ELSE IF @FLG = 1	--ITEM WISE REPORT

BEGIN	
	SELECT B.ACCODE,ISNULL(B.ACNAME, 'UNKNOWN SUPPLIER') AS SUPPLIERNAME,NULL,OPSTOCK, OPSTOCKVALUE,PQTY,PAMOUNT,SQTY,SAMOUNT,ADJQTY, STOCK,RATE,STOCKVALUE,B.ACID
	FROM (
	SELECT A.SUPCODE, SUM(B.OPSTOCK) AS OPSTOCK, SUM(B.OPSTOCK *  A.PRATE_A) AS OPSTOCKVALUE, SUM(B.PQTY) AS PQTY, SUM(B.PAMOUNT) AS PAMOUNT, SUM(B.SQTY) AS SQTY,
	SUM(B.SAMOUNT) AS SAMOUNT, SUM(B.ADJQTY) AS ADJQTY, SUM(B.STOCK) AS STOCK,NULL AS RATE, SUM(B.STOCK * A.PRATE_A) AS  STOCKVALUE
	FROM MENUITEM A INNER JOIN 
	(
	SELECT MCODE, SUM(OP_IN) - SUM(OP_OUT) AS OPSTOCK, SUM(PQTY) - SUM(PRQTY) AS PQTY, SUM(PAMOUNT) - SUM(PRAMOUNT) AS PAMOUNT,
	SUM(SQTY) - SUM(SRQTY) AS SQTY, SUM(SAMOUNT) - SUM(SRAMOUNT) AS SAMOUNT, SUM(ADJQTY) AS ADJQTY, SUM(STOCK) AS STOCK
	FROM (	SELECT MCODE,
	CASE WHEN A.TRNDATE < @DATE1  OR A.VCHRNO LIKE 'OP%' THEN B.REALQTY_IN ELSE 0 END AS OP_IN,
	CASE WHEN A.TRNDATE < @DATE1 THEN B.REALQTY ELSE 0 END AS OP_OUT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PI' THEN B.REALQTY_IN ELSE 0 END AS PQTY,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PI' THEN B.NETAMOUNT-B.VAT ELSE 0 END AS PAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PR' THEN B.REALQTY ELSE 0 END AS PRQTY,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) = 'PR' THEN ABS(B.NETAMOUNT-B.VAT)  ELSE 0 END  AS PRAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','TI','NC','IC','RE') THEN B.REALQTY-B.REALQTY_IN  ELSE 0 END AS SQTY,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','TI','NC','IC','RE') THEN B.NETAMOUNT-B.VAT  ELSE 0 END AS SAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SR','CN','IR','NR') THEN B.REALQTY_IN  ELSE 0 END AS SRQTY,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('SR','CN','IR','NR') THEN ABS(B.NETAMOUNT-B.VAT)  ELSE 0 END AS SRAMOUNT,
	CASE WHEN A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2 AND LEFT(A.VCHRNO,2) IN ('DM','SA') THEN B.REALQTY_IN- B.REALQTY ELSE 0 END AS ADJQTY,
	CASE WHEN  A.TRNDATE <= @DATE2 THEN B.REALQTY_IN- B.REALQTY ELSE 0 END AS STOCK
	 FROM RMD_TRNMAIN A INNER JOIN RMD_TRNPROD_REPORT_COSTVALUE B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION WHERE A.VCHRNO NOT LIKE 'IS%'
	AND A.DIVISION LIKE @DIV
	) AS A GROUP BY MCODE
	) AS B ON A.MCODE = B.MCODE GROUP BY SUPCODE
	) AS A LEFT JOIN RMD_ACLIST B ON A.SUPCODE = B.ACID ORDER BY ISNULL(B.ACNAME, 'UNKNOWN SUPPLIER')

END
