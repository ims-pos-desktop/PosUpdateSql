ALTER  PROCEDURE [dbo].[SP_ACLEDGER_PROC]
	@DATE1 AS DATETIME = '01-01-2004',
	@DATE2 AS DATETIME = '01-01-2004',
	@ACID AS VARCHAR(25) = '%',
	@DIV AS VARCHAR(3) = '%',
	@FLG AS TINYINT

AS
	DECLARE @ISVAT AS TINYINT
	SELECT @ISVAT =ISVAC FROM SETTING 
	IF @FLG = 1		-- DONOT MERGE VAT A/C
		BEGIN
			SELECT TRNDATE, BSDATE,VCHRNO, CHALANNO, PARTICULARS,DRAMNT,CRAMNT,CASE WHEN CHARINDEX(CHAR(10),NARATION,0) >0 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END as NARATION,B_ACID,DIVISION,DRAMNT-CRAMNT AS BALANCE,CHEQUENO,CHEQUEDATE,
			CASE WHEN PARTICULARS = 'OPENING BALANCE' THEN '' else ISNULL(CASE WHEN CHARINDEX(CHAR(10),NARATION,0) >0 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END,'') END NAR,
			CASE WHEN CASE WHEN CHARINDEX(CHAR(10),NARATION,0) >0 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END = '' THEN '' ELSE 'A' END XNAR
			FROM
			(
			SELECT NULL AS TRNDATE, NULL AS BSDATE, NULL AS VCHRNO, NULL AS CHALANNO, 'OPENING BALANCE' AS PARTICULARS,
			CASE WHEN(OPBAL >=0) THEN OPBAL ELSE 0 END AS DRAMNT, CASE WHEN(OPBAL<0) THEN OPBAL * -1 ELSE 0 END AS CRAMNT,
			NULL AS NARATION, NULL AS B_ACID, null as vno,null as vchr,null as division,NULL AS CHEQUENO, NULL AS CHEQUEDATE
			FROM
			(
			SELECT SUM(DRAMNT)-SUM(CRAMNT) AS OPBAL FROM RMD_TRNTRAN A, RMD_TRNMAIN B WHERE A.VCHRNO = B.VCHRNO
			AND A.DIVISION = B.DIVISION AND A.A_ACID = @ACID AND A.DIVISION LIKE @DIV AND 
			(LEFT(A.VCHRNO,2) = 'OP' OR B.TRNDATE < @DATE1)
			) AS A
		
			UNION ALL
			
			select trndate, bsdate, vchrno,chalanno, acname, dramnt,cramnt,  naration, b_acid,cast(right(VNUM,len(VNUM)-2) as numeric) as vno,left(vchrno,2) as vchr,DIVISION,CHEQUENO,CHEQUEDATE 
			from
			(
			SELECT TRNDATE, BSDATE, A.VCHRNO, A.CHALANNO, B.DRAMNT, B.CRAMNT, B.NARATION, B.B_ACID,B.DIVISION,
			CASE WHEN ISNULL(B.CHEQUENO,'') <> '' THEN B.CHEQUENO ELSE ISNULL(A.CHEQUENO,'') END CHEQUENO,
			CASE WHEN ISNULL(B.CHEQUENO,'') <> '' THEN B.CHEQUEDATE ELSE CASE WHEN ISNULL(A.CHEQUENO,'') <> '' THEN CAST(A.CHEQUEDATE AS VARCHAR(25)) ELSE NULL END END CHEQUEDATE,
			ISNULL(A.VNUM,A.VCHRNO) VNUM
			FROM RMD_TRNTRAN B, RMD_TRNMAIN A WHERE B.VCHRNO = A.VCHRNO AND B.DIVISION = A.DIVISION
			AND B.A_ACID = @ACID AND (A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2)
			AND (B.VCHRNO NOT LIKE 'OP%' AND B.VCHRNO NOT LIKE 'AO%') 
			AND B.DIVISION LIKE @DIV
			) as z, rmd_aclist x where z.b_acid = x.acid			
			) AS Z ORDER BY TRNDATE, vchr,vno
		END
		
	ELSE 
	IF @FLG = 2 -- MERGE VAT A/C IN SALES / PURCHASE TRANSACTION
		BEGIN
			DECLARE @VATAC AS VARCHAR(15)
			
			SELECT     @VATAC = TRNAC FROM RMD_TAXCHARGES_CONFIG WHERE (TYPEFLAG = 'V')
			
			SELECT TRNDATE, BSDATE, VCHRNO, CHALANNO, PARTICULARS,DRAMNT,CRAMNT,CASE WHEN CHARINDEX(CHAR(10),NARATION,0) > 1 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END as NARATION,B_ACID, DIVISION,DRAMNT-CRAMNT AS BALANCE,
			CASE WHEN PARTICULARS = 'OPENING BALANCE' THEN 'Opening Balance c/d' else ISNULL(CASE WHEN CHARINDEX(CHAR(10),NARATION,0) >0 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END,'') END NAR
			FROM
			(
			SELECT NULL AS TRNDATE, NULL AS BSDATE, NULL AS VCHRNO, NULL AS CHALANNO, 'OPENING BALANCE' AS PARTICULARS,
			CASE WHEN(OPBAL >=0) THEN OPBAL ELSE 0 END AS DRAMNT, CASE WHEN(OPBAL<0) THEN OPBAL * -1 ELSE 0 END AS CRAMNT,
			NULL AS NARATION, NULL AS B_ACID,null as vno,null as vchr,NULL AS DIVISION
			FROM
			(
			SELECT SUM(DRAMNT)-SUM(CRAMNT) AS OPBAL FROM RMD_TRNTRAN A, RMD_TRNMAIN B WHERE A.VCHRNO = B.VCHRNO
			AND A.DIVISION = B.DIVISION AND A.A_ACID = @ACID AND A.DIVISION LIKE @DIV AND 
			(LEFT(A.VCHRNO,2) = 'OP' OR B.TRNDATE < @DATE1)
			) AS A
			
			UNION ALL
			
			SELECT A.TRNDATE, A.BSDATE, A.VCHRNO,A.CHALANNO, B.ACNAME,A.DRAMNT, A.CRAMNT,  A.NARATION,A.B_ACID,cast(right(VNUM,len(VNUM)-2) as numeric) as vno,left(vchrno,2) as vchr,A.DIVISION
			FROM
			(SELECT VCHRNO, CHALANNO, TRNDATE, BSDATE, A_ACID,SUM(DRAMNT)AS DRAMNT,SUM(CRAMNT)AS CRAMNT,B_ACID, NARATION,DIVISION,VNUM FROM 
			(
			SELECT B.TRNDATE, B.BSDATE, A.VCHRNO, B.CHALANNO, A.A_ACID, A.DRAMNT, A.CRAMNT,
			CASE WHEN(A.B_ACID = @VATAC) THEN CASE WHEN(LEFT(A.VCHRNO,2) = 'PR') THEN 'DE01003' ELSE CASE WHEN(LEFT(A.VCHRNO,2) = 'PI') THEN 'DE01002' ELSE
			CASE WHEN(LEFT(A.VCHRNO,2) = 'SR') THEN 'DI01002' ELSE CASE WHEN(LEFT(A.VCHRNO,2) = 'SI') THEN 'DI01001' ELSE A.B_ACID END END END END ELSE A.B_ACID END AS B_ACID,
			A.NARATION,A.DIVISION,ISNULL(B.VNUM,B.VCHRNO) VNUM FROM RMD_TRNTRAN A, RMD_TRNMAIN B WHERE A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION 
			AND A.A_ACID = @ACID AND (B.TRNDATE >= @DATE1 AND B.TRNDATE <= @DATE2)
			AND (LEFT(A.VCHRNO,2) <> 'OP' AND LEFT(A.VCHRNO,2) <> 'AO') AND A.DIVISION LIKE @DIV 
			) AS Z GROUP BY VCHRNO,  A_ACID, B_ACID, NARATION,CHALANNO,TRNDATE,BSDATE,DIVISION,VNUM
			) A, RMD_ACLIST B WHERE  A.B_ACID =B.ACID
			) AS M  ORDER BY TRNDATE,Vchr,vno

		END
	ELSE 
	IF @FLG = 3			-- ACCOUNT LISTING IN DIALOG BOX

		SELECT RMD_ACLIST.ACID, RMD_ACLIST.ACNAME
		FROM RMD_ACLIST WHERE RMD_ACLIST.ACID Not Like 'PA%'  AND RMD_ACLIST.TYPE='A'
		AND COMMON >= @ISVAT
		ORDER BY RMD_ACLIST.ACNAME