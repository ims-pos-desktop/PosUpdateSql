CREATE OR ALTER PROCEDURE [dbo].[SP_SUMMARYLEDGER]
	@ACID AS VARCHAR(15),
	@DATE1 AS DATETIME,
	@DATE2 AS DATETIME,
	@DIV VARCHAR(15)
AS

SELECT * FROM 
(
SELECT TRNDATE, BSDATE, VCHRNO, CHALANNO, 
CASE WHEN LEFT(VCHRNO,2) LIKE 'GN' THEN TRNMODE ELSE dbo.GetParticularForLedger(VCHRNO,DIVISION) END PARTICULARS
,DRAMNT,CRAMNT,ISNULL(CASE WHEN CHARINDEX(CHAR(10),NARATION,0) >0 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END,'') as NARATION,NULL AS B_ACID, DIVISION,
DRAMNT-CRAMNT AS BALANCE,trndate TDATE,VNUM,CHEQUENO,CHEQUEDATE,
CASE WHEN PARTICULARS = 'OPENING BALANCE' THEN 'Opening Balance c/d' else ISNULL(CASE WHEN CHARINDEX(CHAR(10),NARATION,0) >0 THEN LEFT(NARATION,LEN(NARATION)-2) ELSE NARATION END,'') END NAR

FROM
(
SELECT NULL AS TRNDATE, NULL AS BSDATE, NULL AS VCHRNO, NULL AS CHALANNO, 'OPENING BALANCE' AS PARTICULARS,
CASE WHEN(OPBAL >=0) THEN OPBAL ELSE 0 END AS DRAMNT, CASE WHEN(OPBAL<0) THEN OPBAL * -1 ELSE 0 END AS CRAMNT,
'' AS NARATION,NULL AS DIVISION,NULL AS CHEQUENO,NULL AS CHEQUEDATE,'' TRNMODE,NULL VNUM
FROM
(
SELECT SUM(DRAMNT)-SUM(CRAMNT) AS OPBAL FROM RMD_TRNTRAN A, RMD_TRNMAIN B WHERE A.VCHRNO = B.VCHRNO
AND A.DIVISION = B.DIVISION 
AND A.A_ACID = @ACID AND A.DIVISION LIKE @DIV AND (LEFT(A.VCHRNO,2) = 'OP' OR B.TRNDATE < @DATE1)
) AS A 

UNION ALL

SELECT A.TRNDATE, A.BSDATE,  A.VCHRNO, A.CHALANNO,NULL PARTICUALRS,
CONVERT(MONEY,CAST(B.DRAMNT AS VARCHAR(25)),1) AS DRAMNT, CONVERT(MONEY, CAST(B.CRAMNT AS VARCHAR(25)),1) AS CRAMNT , B.NARATION, A.DIVISION,
CASE WHEN CHQNO <> '' THEN CHQNO ELSE A.CHEQUENO END CHEQUENO,
CASE WHEN CHQNO <> '' THEN CHQDATE ELSE CASE WHEN ISNULL(A.CHEQUENO,'') <> '' THEN CAST(A.CHEQUEDATE AS VARCHAR(25)) ELSE NULL END END CHEQUEDATE,A.TRNMODE,
ISNULL(A.VNUM,A.VCHRNO) VNUM
FROM RMD_TRNMAIN A, (SELECT VCHRNO, CHALANNO,CHQNO,CHQDATE, DIVISION, A_ACID, SUM(DRAMNT) AS DRAMNT, SUM(CRAMNT) AS CRAMNT, NAR AS NARATION
FROM (SELECT *,ISNULL(CHEQUENO,'')CHQNO,CASE WHEN ISNULL(CHEQUENO,'') = '' THEN NULL ELSE CHEQUEDATE END CHQDATE,CASE WHEN ISNULL(NARATION1,'') = '' THEN NARATION ELSE NARATION1 END AS NAR FROM RMD_TRNTRAN) A --WHERE A_ACID = @ACID AND DIVISION  LIKE @DIV 
GROUP BY A_ACID,VCHRNO, CHALANNO, DIVISION, NAR,CHQNO,CHQDATE) AS B
WHERE A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.DIVISION LIKE @DIV AND B.A_ACID= @ACID AND (A.TRNDATE >= @DATE1 AND A.TRNDATE <= @DATE2)
AND A.VCHRNO NOT LIKE 'OP%'
) AS Z 
) A ORDER BY A.TRNDATE, LEFT(A.VNUM,2), CAST(SUBSTRING(A.VNUM,3,LEN(A.VNUM)) AS NUMERIC)