CREATE OR ALTER PROCEDURE [dbo].[SP_BANKSTATUS]
--DECLARE
	@DATE1 DATETIME, 
	@DIV VARCHAR(15) ,
	@FLG TINYINT = 1
	
AS

IF @FLG = 1	-- BANK STATUS

SELECT ROW_NUMBER() OVER (ORDER BY ACNAME) AS SNO,  B.ACNAME, 
CASE WHEN(SUM(Z.OPBAL) >=0) THEN CAST(SUM(Z.OPBAL) AS VARCHAR(25)) + ' DR'  ELSE CAST(SUM(Z.OPBAL) * -1 AS VARCHAR(25)) + ' CR' END AS OPBAL, 
SUM(DEPOSIT) AS DEPOSIT, SUM(WITHDRAW) AS WITHDRAW,
CASE WHEN ((ISNULL(SUM(Z.OPBAL),0)+SUM(DEPOSIT) - SUM(WITHDRAW)) >=0) THEN CAST(CAST((ISNULL(SUM(Z.OPBAL),0)+SUM(DEPOSIT) - SUM(WITHDRAW)) AS numeric(18,2)) AS VARCHAR(25)) + ' DR' ELSE CAST(CAST((ISNULL(SUM(Z.OPBAL),0)+SUM(DEPOSIT) - SUM(WITHDRAW))*-1 AS numeric(18,2))  AS VARCHAR(25)) + ' CR' END AS CLSBALANCE,
B.ACID
FROM
(
	SELECT CASE WHEN (LEFT(A.VCHRNO,2) = 'OP') THEN A.DRAMNT-A.CRAMNT ELSE NULL END AS OPBAL,
	CASE WHEN (LEFT(A.VCHRNO,2) <> 'OP') THEN A.DRAMNT ELSE 0 END AS DEPOSIT,CASE WHEN (LEFT(A.VCHRNO,2) <> 'OP') THEN CRAMNT ELSE 0 END AS WITHDRAW,A_ACID
	FROM RMD_TRNTRAN A, RMD_TRNMAIN B WHERE A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A_ACID IN (SELECT ACID FROM RMD_ACLIST WHERE MAPID = 'B' AND TYPE = 'A')
	AND B.TRNDATE <=@DATE1 AND B.DIVISION like @DIV
) AS Z, RMD_ACLIST B WHERE B.ACID = Z.A_ACID GROUP BY B.ACNAME,ACID ORDER BY ACNAME,ACID