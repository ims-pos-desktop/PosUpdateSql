CREATE OR ALTER PROCEDURE NSP_COSTSHEET
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@FYID VARCHAR(25)='%',
@DIVISION VARCHAR(25)='%', 
@VOUCHER VARCHAR(50)='%', --PURCHASE BILL FILTER
@SUPPLIER_ACID NVARCHAR(MAX)='%'
AS
--SELECT @DATE1='2020-01-01' ,@DATE2='2023-07-03',@FYID='78/79',@VOUCHER='%',@DIVISION='%',@SUPPLIER_ACID='PA16,PA95'
IF OBJECT_ID('TEMPDB..#DATA') IS NOT NULL DROP TABLE #DATA
IF OBJECT_ID('TEMPDB..#COLS') IS NOT NULL DROP TABLE #COLS
IF OBJECT_ID('TEMPDB..#dynamicColumns') IS NOT NULL DROP TABLE #dynamicColumns
IF OBJECT_ID('TEMPDB..#ADDITIONALCOST_JSON') IS NOT NULL DROP TABLE #ADDITIONALCOST_JSON

  
  SELECT RX.ACNAME SUPPLIERNAME,AD.TRNDATE,A.* INTO #ADDITIONALCOST_JSON FROM ADDITIONALCOST_JSON A  WITH(NOLOCK)    JOIN RMD_TRNMAIN AD WITH(NOLOCK)  ON AD.VCHRNO=A.VCHRNO
  JOIN RMD_TRNMAIN PM WITH (NOLOCK) ON PIVCHRNO=PM.VCHRNO
  JOIN RMD_ACLIST RX WITH (NOLOCK) ON RX.ACID=PM.PARAC
	WHERE  A.PIVCHRNO LIKE @VOUCHER 
	AND A.DIVISION LIKE @DIVISION
	AND AD.TRNDATE  BETWEEN @DATE1
	AND @DATE2 AND A.PhiscalId =@FYID
	AND  (@SUPPLIER_ACID = '%' OR (@SUPPLIER_ACID <> '%' AND PM.PARAC IN (SELECT * FROM DBO.SPLIT(@SUPPLIER_ACID,','))))
 
 

SELECT  A.VCHRNO, A.PIVCHRNO,  TRNDATE , A.DIVISION, A.PhiscalId, A.VoucherType, C.[KEY], C.[VALUE] INTO #DATA FROM #ADDITIONALCOST_JSON A  CROSS APPLY OPENJSON(A.JSONADDITIONALCOST) B
CROSS APPLY OPENJSON(B.VALUE) C

 

SELECT DISTINCT [Key] INTO #dynamicColumns FROM #DATA WHERE [Key] NOT IN ('Amount','Code','Description','ExRate','Mcode','NRate','Quantity','Rate','Sno','Total','Unit','UnitCost')


CREATE TABLE #COLS(RN INT NOT NULL, SELECTION_COLS VARCHAR(MAX) NOT NULL)
DECLARE @query  AS VARCHAR(MAX),@fixedColumns AS VARCHAR(MAX), @columns  AS NVARCHAR(MAX), @json_columns  AS NVARCHAR(MAX), @null_columns AS VARCHAR(MAX);

INSERT INTO #COLS	
SELECT ROW_NUMBER() OVER (ORDER BY [Key]) RN , 
CONCAT(QUOTENAME([Key]), ' NUMERIC(18,2) ''$."', [Key], '"''') SELECTION_COLS
FROM #dynamicColumns

SELECT @columns = STRING_AGG(QUOTENAME([KEY]), ','), @null_columns = STRING_AGG(CONCAT ('NULL ',QUOTENAME([KEY])), ',') FROM #dynamicColumns 



SELECT @json_columns = STRING_AGG(SELECTION_COLS, ',' + CHAR(10)) FROM
(
	SELECT * FROM #COLS 
) A
  

 
SET @query = '
SELECT A.VCHRNO, 0 FLG, NULL SNO,  NULL MCODE, CONCAT(A.VCHRNO, ''('', A.PIVCHRNO, '')'') CODE, SUPPLIERNAME ItemName, NULL Unit, NULL Quantity, NULL Rate, NULL ExRate, NULL NRate, NULL Amount 
, ' + @null_columns + ', NULL Total, NULL UnitCost, ''G'' TYPE FROM #ADDITIONALCOST_JSON A  
UNION ALL
SELECT A.VCHRNO, 1 FLG, B.Sno, B.MCODE, B.Code, B.ItemName, B.Unit, B.Quantity, B.Rate, B.ExRate, B.NRate, B.Amount
, '+ @columns+', B.Total, B.UnitCost, IIF(B.ItemName = ''Total'', ''G'', ''A'') TYPE FROM #ADDITIONALCOST_JSON A CROSS APPLY OPENJSON(A.JSONADDITIONALCOST)    
WITH
(
	Sno INT ''$.Sno'',
	Mcode VARCHAR(25) ''$.Mcode'',
	Code VARCHAR(25) ''$.Code'',
	ItemName VARCHAR(500) ''$.Description'',
    Unit VARCHAR(50) ''$.Unit'',
	Quantity NUMERIC(18,3) ''$.Quantity'',
    Rate NUMERIC(18,2) ''$.Rate'',
    ExRate NUMERIC(18,2) ''$.ExRate'',
    NRate NUMERIC(18,2) ''$.NRate'',
	Amount NUMERIC(18,2) ''$.Amount'',
	' + @json_columns + ',
	[UnitCost] NUMERIC(18,2) ''$."UnitCost"'',
	Total NUMERIC(18,2) ''$.Total''
) B  
UNION ALL
SELECT A.VCHRNO, 2 FLG, NULL SNO, NULL MCODE, NULL CODE, NULL ItemName, NULL Unit, NULL Quantity, NULL Rate, NULL ExRate, NULL NRate, NULL Amount 
, ' + @null_columns +', NULL Total, NULL UnitCost, ''A'' TYPE FROM #ADDITIONALCOST_JSON A
ORDER BY VCHRNO, FLG
'

print @columns
print @query

EXECUTE(@QUERY)