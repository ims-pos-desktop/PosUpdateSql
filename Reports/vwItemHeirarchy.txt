CREATE OR ALTER VIEW [dbo].[vwItemHeirarchy]
AS
SELECT MI.MCODE,MG.MCODE MGCode, MG.DESCA [Main Group],null MCCODE, NULL [Main Category], NULL SCCode, NULL [Sub Category], NULL SPCode, NULL [Super Category],mi.MCAT MCATEGORY, 
IIF(COALESCE(MI.ShelfLife,0) = 0, MG.ShelfLife, MI.ShelfLife) ShelfLife, MI.MENUCODE, MI.DESCA, MI.SUPCODE FROM MENUITEM MI 
JOIN MENUITEM MG ON MI.PARENT = MG.MCODE
WHERE MG.PARENT = 'MI' AND MI.TYPE = 'A'
UNION ALL
SELECT MI.MCODE,MG.MCODE, MG.DESCA, MC.MCODE, MC.DESCA, NULL, NULL, NULL, NULL,mi.MCAT MCATEGORY, 
IIF(COALESCE(MI.ShelfLife,0) = 0, 
    IIF(COALESCE(MC.ShelfLife,0) = 0, MG.ShelfLife, MC.ShelfLife),
	MI.ShelfLife) ShelfLife, MI.MENUCODE, MI.DESCA, MI.SUPCODE FROM MENUITEM MI
JOIN MENUITEM MC  ON MI.PARENT = MC.MCODE 
JOIN MENUITEM MG ON MC.PARENT = MG.MCODE
WHERE MG.PARENT = 'MI' AND MI.TYPE = 'A'
UNION ALL
SELECT MI.MCODE,MG.MCODE, MG.DESCA, MC.mcode, MC.DESCA, SC.MCODE, SC.DESCA, NULL, NULL,mi.MCAT MCATEGORY,
IIF(COALESCE(MI.ShelfLife,0) = 0, 
    IIF(COALESCE(SC.ShelfLife,0) = 0, 
		IIF(COALESCE(MC.ShelfLife,0) = 0, MG.ShelfLife, MC.ShelfLife),
			SC.ShelfLife),
				MI.ShelfLife) ShelfLife, MI.MENUCODE, MI.DESCA, MI.SUPCODE FROM MENUITEM MI
JOIN MENUITEM SC ON MI.PARENT = SC.MCODE 
JOIN MENUITEM MC  ON SC.PARENT = MC.MCODE 
JOIN MENUITEM MG ON MC.PARENT = MG.MCODE
WHERE MG.PARENT = 'MI' AND MI.TYPE = 'A'
UNION ALL
SELECT MI.MCODE,MG.MCODE, MG.DESCA, MC.mcode, MC.DESCA, SC.MCODE, SC.DESCA, SS.MCODE, SS.DESCA,mi.MCAT MCATEGORY, 
IIF(COALESCE(MI.ShelfLife,0) = 0, 
	IIF(COALESCE(SS.ShelfLife,0) = 0, 
		IIF(COALESCE(SC.ShelfLife,0) = 0, 
			IIF(COALESCE(MC.ShelfLife,0) = 0, MG.ShelfLife, MC.ShelfLife),
				SC.ShelfLife),
					SS.ShelfLife),
						MI.ShelfLife) ShelfLife, MI.MENUCODE, MI.DESCA, MI.SUPCODE FROM MENUITEM MI 
JOIN MENUITEM SS ON MI.PARENT = SS.MCODE 
JOIN MENUITEM SC ON SS.PARENT = SC.MCODE 
JOIN MENUITEM MC  ON SC.PARENT = MC.MCODE 
JOIN MENUITEM MG ON MC.PARENT = MG.MCODE
WHERE MG.PARENT = 'MI' AND MI.TYPE = 'A'