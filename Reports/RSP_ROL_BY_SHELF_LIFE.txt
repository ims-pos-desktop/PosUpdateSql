CREATE OR ALTER PROCEDURE RSP_ROL_BY_SHELF_LIFE
--DECLARE
 @DIVISION VARCHAR(20)='%',
 @MGROUP VARCHAR(50)='%' ,
 @MCAT VARCHAR(200)='%'
AS

--DECLARE @DIVISION VARCHAR(20)='%',@MGROUP VARCHAR(50)='%' ,@MCAT VARCHAR(200)='%', @FYID VARCHAR(10) = '78/79'
SET NOCOUNT ON;
IF OBJECT_ID('TEMPDB..#SHELF') IS NOT NULL DROP TABLE #SHELF
IF OBJECT_ID('TEMPDB..#STOCK') IS NOT NULL DROP TABLE #STOCK
    
DECLARE @DATE DATETIME = CAST(GETDATE() AS DATE)
DECLARE @FirstSalesDate DATETIME 
DECLARE @FYID VARCHAR(10)
	
SELECT @FirstSalesDate = DATEADD(D, -MAX(SHELFLIFE), @DATE) FROM MENUITEM
SELECT @FYID = PhiscalID FROM PhiscalYear WHERE @DATE BETWEEN Begindate AND EndDate
	
SELECT MCODE, SUM(REALQTY_IN-RealQty) StockQty INTO #STOCK FROM  RMD_TRNPROD TP WHERE tp.DIVISION LIKE @DIVISION AND TP.PhiscalID = @FYID
GROUP BY MCODE
	
SELECT A.MCODE, SUM(A.salesqty) SALES into #SHELF 
FROM 
(
        SELECT TRNDATE,TP.MCODE ,SUM(RealQty - REALQTY_IN) salesqty
        FROM SALES_TRNMAIN TM JOIN SALES_TRNPROD TP ON tm.VCHRNO=tp.VCHRNO
		WHERE TM.DIVISION LIKE @DIVISION AND  TRNDATE>= @FirstSalesDate
        group by MCODE, TRNDATE
)A 
JOIN vwItemHeirarchy MG ON A.MCODE = MG.MCODE
WHERE datediff(DAY,TRNDATE,@date)<=MG.SHELFLIFE
GROUP BY A.MCODE

SELECT ROW_NUMBER() over (order by menucode) SN,VH.[Main Group] [Major Group], vh.[Main Category], vh.[Sub Category], vh.[Super Category], vh.MCATEGORY, vh.MENUCODE [Item Code],vh.DESCA [Item Name] , vh.SHELFLIFE [Shelf Life],
s.SALES [Sales in last Cycle Period],sk.stockqty [Closing Stock],s.SALES-sk.stockqty [Quantity Required], A.ACNAME [Supplier Name]
FROM vwItemHeirarchy vh
JOIN RMD_ACLIST A ON vh.SUPCODE = A.ACID
LEFT JOIN #SHELF S ON S.MCODE = vh.MCODE
LEFT JOIN #STOCK SK on VH.MCODE=sk.MCODE
WHERE COALESCE(vh.ShelfLife ,0) <> 0 AND ISNULL(vh.MGCode,'%') LIKE @MGROUP AND ISNULL(vh.MCATEGORY,'%') LIKE  @MCAT
