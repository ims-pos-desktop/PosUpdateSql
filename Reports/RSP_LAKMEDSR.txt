CREATE OR ALTER     PROCEDURE [dbo].[RSP_LAKMEDSR]
--DECLARE 
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIVISION VARCHAR(3) = '%'
AS
--SET @DATE1 = '01-01-2017'; SET @DATE2 = '04-01-2019' 
set nocount on
	IF OBJECT_ID('TEMPDB..#REPDATA') is not null drop table #REPDATA	
	SELECT ISNULL(A.BILLTOMOB, A.MEMBERNO) MOBILENO, S.NAME SALESMAN, 
	CASE WHEN X.PTYPE >= 10 THEN ISNULL(B.ITEMDESC, X.DESCA) ELSE '' END SERVICENAME,
	CASE WHEN X.PTYPE < 10 THEN ISNULL(B.ITEMDESC, X.DESCA) ELSE '' END PRODUCTNAME, B.MCODE,A.VCHRNO,A.CHALANNO,A.REFORDBILL,A.REFBILL,A.TRNDATE,A.BSDATE,A.DIVISION,
	CASE WHEN TRNMODE = 'CREDIT' THEN Z.ACNAME ELSE CASE WHEN ISNULL(BILLTO,'') <> '' THEN BILLTO ELSE Z.ACNAME END END BILLTO, BILLTOADD,
	B.BC BARCODE, UNIT BILLUNIT,QUANTITY BILLQTY,RATE BILLRATE, 
	X.BASEUNIT BASEUNIT, CASE WHEN LEFT(A.VCHRNO,2) IN ('SI','TI','IC') THEN REALQTY ELSE REALQTY_IN END BASEQTY,REALRATE BASERATE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.AMOUNT*-1 ELSE B.AMOUNT END AMOUNT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.DISCOUNT*-1 ELSE B.DISCOUNT END DISCOUNT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.SERVICETAX *-1 ELSE B.SERVICETAX END SCHARGE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN (B.TAXABLE+B.NONTAXABLE) *-1 ELSE (B.TAXABLE+B.NONTAXABLE) END NETSALE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.TAXABLE*-1 ELSE B.TAXABLE END TAXABLE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.NONTAXABLE*-1 ELSE B.NONTAXABLE END NONTAXABLE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.VAT*-1 ELSE B.VAT END VAT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN (B.TAXABLE+B.NONTAXABLE+B.VAT)*-1 ELSE (B.TAXABLE+B.NONTAXABLE+B.VAT) END NETAMNT,
	A.STAMP,A.TRNUSER,A.TRNTIME, TPS.StartTime, TPS.EndTime 
	INTO #REPDATA
	FROM RMD_SALESPROD B INNER JOIN RMD_TRNMAIN A ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND ISNULL(A.PhiscalID,'') = ISNULL(B.PHISCALID,'')
	INNER JOIN MENUITEM X ON B.MCODE = X.MCODE a
	LEFT JOIN DIVISION Y ON B.DIVISION = Y.INITIAL	
	LEFT JOIN RMD_TRNPROD_STATUS TPS ON B.VCHRNO = TPS.VCHRNO AND B.MCODE = TPS.MCODE AND B.SNO = TPS.SNO
	LEFT JOIN RMD_ACLIST Z ON A.TRNAC = Z.ACID 
	LEFT JOIN SALESMAN S ON S.SALESMANID = CASE WHEN B.SALESMANID>0 THEN B.SALESMANID ELSE dbo.splitandgettop1( TPS.SalesMan, ',') END
	WHERE LEFT(A.VCHRNO,2) IN ('SI','TI','CN','RE')
	AND	A.TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.DIVISION LIKE @DIVISION
	
	SELECT TRNDATE,BSDATE,VCHRNO,REFBILL REFNO, SERVICENAME, PRODUCTNAME, BILLTO,BILLTOADD,BARCODE,BILLUNIT,BILLQTY,BILLRATE,BASEUNIT,BASEQTY,BASERATE,AMOUNT,DISCOUNT,SCHARGE,NETSALE,TAXABLE,NONTAXABLE,VAT,NETAMNT,TRNUSER,TRNTIME,B.NAME DIVISION, SALESMAN, MOBILENO, StartTime, EndTime
	FROM #REPDATA A LEFT JOIN DIVISION B ON A.DIVISION = B.INITIAL ORDER BY TRNDATE,STAMP
	

IF OBJECT_ID('TEMPDB..#REPDATA') is not null drop table #REPDATA
IF OBJECT_ID('TEMPDB..#REPDATA_1') is not null drop table #REPDATA_1

set nocount off