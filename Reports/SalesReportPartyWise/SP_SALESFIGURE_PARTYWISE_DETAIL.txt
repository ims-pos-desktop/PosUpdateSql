CREATE OR ALTER     PROCEDURE [dbo].[SP_SALESFIGURE_PARTYWISE_DETAIL]
--DECLARE
    @RMODE AS TINYINT = 0,
	@DATE1 AS DATETIME,
	@DATE2 AS DATETIME,
	@ACID AS VARCHAR(25) = '%',
	@PTYPE AS TINYINT = 0,
	@TOPNSORT AS TINYINT,
	@DIV AS VARCHAR(10) = '%',
	@AREA_ID INT = 0,
	@CATEGORY_ID INT = 0

AS
--SET @DATE1 = '2020-07-16'; SET @DATE2 = '2021-07-15'

if OBJECT_ID('tempdb..#PARTYFILTER') is not null drop table #PARTYFILTER
select * INTO #PARTYFILTER from fnPartyFilter(@AREA_ID,@CATEGORY_ID,@ACID,0,0,0,0,0)

--CUSTOMER WISE SUMMARY SALES FIGURE REPORT
IF @PTYPE= 0 	-- CUSTOMER WISE
	SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT, CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
	SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
	,ca.AREA_NAME,ca.CATEGORY_NAME
	FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
	join #PARTYFILTER ca on ca.ACID=b.TRNAC
	WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','SR','TI','CN','RE') AND B.TRNAC LIKE @ACID
	GROUP BY MCODE,MENUCODE,DESCA,RATE,ca.AREA_NAME,ca.CATEGORY_NAME
	HAVING SUM(A.AMOUNT)<>0
	ORDER BY DESCA
ELSE
	SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT,CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
	SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
	,ca.AREA_NAME,ca.CATEGORY_NAME
	FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
	join #PARTYFILTER ca on ca.ACID=b.TRNAC
	WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','SR','TI','CN','RE') AND ISNULL(A.SUPCODE,'') LIKE @ACID
	GROUP BY MCODE,MENUCODE,DESCA,RATE,ca.AREA_NAME,ca.CATEGORY_NAME
	HAVING SUM(A.AMOUNT)<>0
	ORDER BY DESCA



