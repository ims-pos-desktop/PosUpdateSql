CREATE OR ALTER     PROCEDURE [dbo].[SP_SALESFIGURE_PARTYWISE_DETAIL]
	@RMODE AS TINYINT = 0,
	@DATE1 AS DATETIME,
	@DATE2 AS DATETIME,
	@ACID AS VARCHAR(25) = '%',
	@PTYPE AS TINYINT = 0,
	@TOPNSORT AS TINYINT,
	@DIV AS VARCHAR(10)

AS
--CUSTOMER WISE SUMMARY SALES FIGURE REPORT
IF @RMODE = 0			--REGULAR SALES ONLY	
	BEGIN
		IF @PTYPE= 0 	-- CUSTOMER WISE
			SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT, CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
			SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
			FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
			WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','SR','TI','CN','RE') AND B.TRNAC LIKE @ACID
			GROUP BY MCODE,MENUCODE,DESCA,RATE 
			HAVING SUM(A.AMOUNT)<>0
			ORDER BY DESCA
		ELSE
			SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT,CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
			SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
			FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
			WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','SR','TI','CN','RE') AND ISNULL(A.SUPCODE,'') LIKE @ACID
			GROUP BY MCODE,MENUCODE,DESCA,RATE 
			HAVING SUM(A.AMOUNT)<>0
			ORDER BY DESCA
 	END

ELSE IF @RMODE = 1		--INTERCOMPANY SALE
	BEGIN
		IF @PTYPE= 0 	-- CUSTOMER WISE
			SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT, CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
			SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
			FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
			WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('IC','IR') AND B.TRNAC LIKE @ACID
			GROUP BY MCODE,MENUCODE,DESCA,RATE 
			HAVING SUM(A.AMOUNT)<>0
			ORDER BY DESCA
		ELSE
			SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT, CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
			SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
			FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
			WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('IC','IR') AND ISNULL(A.SUPCODE,'') LIKE @ACID
			GROUP BY MCODE,MENUCODE,DESCA,RATE 
			HAVING SUM(A.AMOUNT)<>0
			ORDER BY DESCA
 	END

ELSE IF @RMODE = 2		--INTERCOMPANY SALE
	BEGIN
		IF @PTYPE= 0 	-- CUSTOMER WISE
			SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT, CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
			SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
			FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
			WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','SR','TI','CN','IC','IR','RE') AND B.TRNAC LIKE @ACID
			GROUP BY MCODE,MENUCODE,DESCA,RATE 
			HAVING SUM(A.AMOUNT)<>0
			ORDER BY DESCA
		ELSE
			SELECT MENUCODE,DESCA,SUM(REALQTY) - SUM(REALQTY_IN) AS QUANTITY, RATE,SUM(AMOUNT) AS AMOUNT,CONVERT(DECIMAL(18,2), (SUM(A.LOYALTY)/SUM(AMOUNT))*100) [LOYALTY DISCOUNT(%)],
			SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE+A.NONTAXABLE) AS NETSALE, SUM(A.TAXABLE) AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXBLE, SUM(VRATE) AS VAT,SUM(NETAMOUNT) AS BILLAMNT,MCODE
			FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION
			WHERE B.DIVISION LIKE @DIV AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND LEFT(A.VCHRNO,2) IN ('SI','SR','TI','CN','IC','IR','RE') AND ISNULL(A.SUPCODE,'') LIKE @ACID
			GROUP BY MCODE,MENUCODE,DESCA,RATE 
			HAVING SUM(A.AMOUNT)<>0
			ORDER BY DESCA
 	END



