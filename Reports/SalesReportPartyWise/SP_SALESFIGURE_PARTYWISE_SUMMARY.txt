CREATE OR ALTER     PROCEDURE [dbo].[SP_SALESFIGURE_PARTYWISE_SUMMARY]
	@RMODE AS TINYINT = 0,
	@DATE1 AS DATETIME,
	@DATE2 AS DATETIME,
	@ACID AS VARCHAR(25) = '%',
	@PTYPE AS TINYINT = 0,
	@TOPNSORT AS TINYINT,
	@DIV AS VARCHAR(10),
	@AMOUNT AS NUMERIC(18,2) = 0,
	@PARTYTYPE AS INT = -1
AS

set nocount on

BEGIN
	IF OBJECT_ID('TEMPDB..#PARTYTYPE') is not null drop table #PARTYTYPE
	CREATE TABLE #PARTYTYPE (ID INT,PARTYTYPE VARCHAR(50))
	INSERT INTO #PARTYTYPE(ID,PARTYTYPE) VALUES(0,'General')
	INSERT INTO #PARTYTYPE(ID,PARTYTYPE) VALUES(1,'Distributor')
	INSERT INTO #PARTYTYPE(ID,PARTYTYPE) VALUES(2,'Whole Seller')
	INSERT INTO #PARTYTYPE(ID,PARTYTYPE) VALUES(3,'Retailer')
	INSERT INTO #PARTYTYPE(ID,PARTYTYPE) VALUES(4,'Flat Rated')
END

--CUSTOMER WISE SUMMARY SALES FIGURE REPORT
IF @RMODE = 0			--REGULAR SALES ONLY	
	BEGIN
		IF @PTYPE= 0 	-- CUSTOMER WISE
			SELECT ROW_NUMBER() OVER (ORDER BY CASE WHEN @TOPNSORT = 1 THEN BILLAMNT END DESC,ACNAME) AS SNO, * FROM 
			(
			SELECT CNAME ACNAME,BILLTOTEL VATNO,B.PARTYTYPE,CONVERT(DECIMAL(18,2), SUM(TOTAMNT)) AS GROSS,CONVERT(DECIMAL(18,2), SUM(DCAMNT)) AS DISCOUNT,
			CONVERT(DECIMAL(18,2), SUM(TAXABLE) + SUM(NONTAXABLE)) AS NETSALE,CONVERT(DECIMAL(18,2), SUM(TAXABLE))AS TAXABLE, CONVERT(DECIMAL(18,2), SUM(NONTAXABLE)) AS NONTAXABLE,
			CONVERT(DECIMAL(18,2), SUM(VATAMNT)) AS VATAMNT, CONVERT(DECIMAL(18,2), SUM(NETAMNT)) AS BILLAMNT FROM TRNMAIN_VIEW_SREPORT A LEFT JOIN #PARTYTYPE B ON A.RATETYPE = B.ID
			WHERE DIVISION LIKE @DIV AND TRNDATE BETWEEN @DATE1 AND @DATE2 AND TRNAC LIKE @ACID AND
			LEFT(VCHRNO,2) IN ('SI','SR','TI','CN','RE') AND ((@PARTYTYPE<0 AND A.RATETYPE>=0) OR (@PARTYTYPE>0 AND A.RATETYPE=@PARTYTYPE))
			GROUP BY CNAME,BILLTOTEL,B.PARTYTYPE
			) A WHERE (@AMOUNT=0 AND ABS(NETSALE)>=@AMOUNT) OR (@AMOUNT<>0 AND NETSALE >=@AMOUNT) 
			ORDER BY CASE WHEN @TOPNSORT = 1 THEN BILLAMNT END DESC,ACNAME
		ELSE
			--SUPPLIER WISE SUMMARY SALES FIGURE REPORT
			SELECT * FROM 
			(
			SELECT NULL AS SNO,ISNULL(B.ACNAME,'UNKNOWN SUPPLIER') AS ACNAME,VATNO,NULL PTYPE, CONVERT(DECIMAL(18,2), SUM(AMOUNT)) AS GROSS, CONVERT(DECIMAL(18,2), SUM(DISCOUNT)) AS DISCOUNT,
			CONVERT(DECIMAL(18,2), SUM(A.TAXABLE) + SUM(A.NONTAXABLE)) AS NETSALE,CONVERT(DECIMAL(18,2), SUM(A.TAXABLE)) AS TAXABLE, CONVERT(DECIMAL(18,2), SUM(A.NONTAXABLE)) AS NONTAXABLE,
			CONVERT(DECIMAL(18,2), SUM(VATAMNT)) AS VATAMNT,CONVERT(DECIMAL(18,2), SUM(NETAMOUNT)) AS NETAMOUNT,B.ACID
			FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN C ON A.VCHRNO = C.VCHRNO AND A.DIVISION = C.DIVISION AND A.PHISCALID = C.PhiscalID 
			LEFT JOIN RMD_ACLIST B ON A.SUPCODE = B.ACID WHERE C.DIVISION LIKE @DIV AND C.TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.SUPCODE LIKE @ACID AND
			LEFT (A.VCHRNO,2) IN ('SI','SR','TI','CN','RE')
			GROUP BY B.ACNAME,B.ACID,VATNO
			) A WHERE (@AMOUNT=0 AND ABS(NETSALE)>=0) OR (@AMOUNT<>0 AND NETSALE >=@AMOUNT) 
			ORDER BY CASE WHEN @TOPNSORT = 1 THEN NETAMOUNT END DESC,ACNAME
	END

ELSE IF @RMODE = 1		--INTERCOMPANY SALES ONLY

BEGIN
	IF @PTYPE= 0 	-- CUSTOMER WISE
		SELECT A.* FROM 
		(
		SELECT NULL AS SNO,ACNAME,VATNO,NULL PTYPE,SUM(TOTAMNT)AS GROSS,SUM(DCAMNT) AS DISCOUNT,SUM(TAXABLE) + SUM(NONTAXABLE) AS NETSALE,SUM(TAXABLE)AS TAXABLE, SUM(NONTAXABLE) AS NONTAXABLE,
		SUM(VATAMNT) AS VATAMNT, SUM(NETAMNT) AS BILLAMNT,TRNAC FROM TRNMAIN_VIEW_SREPORT
		WHERE DIVISION LIKE @DIV AND TRNDATE BETWEEN @DATE1 AND @DATE2 AND TRNAC LIKE @ACID AND
		LEFT(VCHRNO,2) IN ('IC','IR')
		GROUP BY ACNAME,TRNAC,VATNO
		) A WHERE (@AMOUNT=0 AND ABS(NETSALE)>=0) OR (@AMOUNT<>0 AND NETSALE >=@AMOUNT) 
		ORDER BY CASE WHEN @TOPNSORT = 1 THEN BILLAMNT END DESC,ACNAME
	ELSE
		--SUPPLIER WISE SUMMARY SALES FIGURE REPORT
		SELECT A.* FROM 
		(
		SELECT NULL AS SNO,ISNULL(B.ACNAME,'UNKNOWN SUPPLIER') AS ACNAME,VATNO,NULL PTYPE, SUM(AMOUNT) AS GROSS, SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE) + SUM(A.NONTAXABLE) AS NETSALE,SUM(A.TAXABLE)AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXABLE,
		SUM(VATAMNT) AS VATAMNT,SUM(NETAMOUNT) AS NETAMOUNT,B.ACID
		FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN C ON A.VCHRNO = C.VCHRNO AND A.DIVISION = C.DIVISION AND A.PHISCALID = C.PhiscalID 
		LEFT JOIN RMD_ACLIST B ON A.SUPCODE = B.ACID WHERE C.DIVISION LIKE @DIV AND C.TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.SUPCODE LIKE @ACID AND
		LEFT (A.VCHRNO,2) IN ('IC','IR')
		GROUP BY B.ACNAME,B.ACID,VATNO
		) A WHERE (@AMOUNT=0 AND ABS(NETSALE)>=0) OR (@AMOUNT<>0 AND NETSALE >=@AMOUNT) 
		ORDER BY CASE WHEN @TOPNSORT = 1 THEN NETAMOUNT END DESC,ACNAME
END

ELSE IF @RMODE = 2
BEGIN
	IF @PTYPE= 0 	-- CUSTOMER WISE
		SELECT * FROM 
		(
		SELECT NULL AS SNO,ACNAME,VATNO,B.PARTYTYPE,SUM(TOTAMNT)AS GROSS,SUM(DCAMNT) AS DISCOUNT,SUM(TAXABLE) + SUM(NONTAXABLE) AS NETSALE,SUM(TAXABLE)AS TAXABLE, SUM(NONTAXABLE) AS NONTAXABLE,
		SUM(VATAMNT) AS VATAMNT, SUM(NETAMNT) AS BILLAMNT,TRNAC FROM TRNMAIN_VIEW_SREPORT A LEFT JOIN #PARTYTYPE B ON A.RATETYPE = B.ID 
		WHERE DIVISION LIKE @DIV AND TRNDATE BETWEEN @DATE1 AND @DATE2 AND TRNAC LIKE @ACID AND 
		LEFT(VCHRNO,2) IN ('SI','SR','TI','CN','IC','IR','RE') AND ((@PARTYTYPE<0 AND A.RATETYPE>=0) OR (@PARTYTYPE>0 AND A.RATETYPE=@PARTYTYPE))
		GROUP BY ACNAME,TRNAC,VATNO,B.PARTYTYPE
		) A WHERE (@AMOUNT=0 AND ABS(NETSALE)>=0) OR (@AMOUNT<>0 AND NETSALE >=@AMOUNT) 
		ORDER BY CASE WHEN @TOPNSORT = 1 THEN BILLAMNT END DESC,ACNAME
	ELSE
		--SUPPLIER WISE SUMMARY SALES FIGURE REPORT
		SELECT * FROM 
		(
		SELECT NULL AS SNO,ISNULL(B.ACNAME,'UNKNOWN SUPPLIER') AS ACNAME, VATNO,NULL PARTYTYPE,SUM(AMOUNT) AS GROSS, SUM(DISCOUNT) AS DISCOUNT,SUM(A.TAXABLE) + SUM(A.NONTAXABLE) AS NETSALE,SUM(A.TAXABLE)AS TAXABLE, SUM(A.NONTAXABLE) AS NONTAXABLE,
		SUM(VATAMNT) AS VATAMNT,SUM(NETAMOUNT) AS NETAMOUNT,B.ACID
		FROM TRNPROD_VIEW_SREPORT A INNER JOIN RMD_TRNMAIN C ON A.VCHRNO = C.VCHRNO AND A.DIVISION = C.DIVISION AND A.PHISCALID = C.PhiscalID
		LEFT JOIN RMD_ACLIST B ON A.SUPCODE = B.ACID WHERE C.DIVISION LIKE @DIV AND C.TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.SUPCODE LIKE @ACID AND
		LEFT (A.VCHRNO,2) IN ('SI','SR','TI','CN','IC','IR','RE')
		GROUP BY B.ACNAME,B.ACID,VATNO
		) A WHERE (@AMOUNT=0 AND ABS(NETSALE)>=0) OR (@AMOUNT<>0 AND NETSALE >=@AMOUNT)
		 ORDER BY CASE WHEN @TOPNSORT = 1 THEN NETAMOUNT END DESC,ACNAME
	
END

IF OBJECT_ID('TEMPDB..#PARTYTYPE') is not null drop table #PARTYTYPE

set nocount OFF

