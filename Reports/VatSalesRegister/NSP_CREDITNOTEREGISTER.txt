CREATE OR ALTER PROCEDURE [dbo].[NSP_CREDITNOTEREGISTER]
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@TMR VARCHAR(25) = '%',
@DIVISION AS VARCHAR(25) = '%',
@CHK_OLDFORMAT TINYINT = 0                       --OldFomrat:1:0

AS
IF @CHK_OLDFORMAT = 1 
	EXEC NSP_CNREGISTER_OLDFORMAT @DATE1, @DATE2, @TMR, @DIVISION
ELSE 
BEGIN
	--SET @DATE1 = '01-15-16'; SET @DATE2 = '01-15-17';SET @TMR = '%'; SET @DIV = '%'
	set nocount on
	IF OBJECT_ID('TEMPDB..#REPORT') is not null drop table #REPORT

	SELECT TRNDATE, BSDATE, A.VCHRNO, REFBILL,
	IIF(ISNULL(BILLTO,'') = '', IIF(C.ACNAME IS NULL, 'Cash Sales', ACNAME), BILLTO) PARTICULARS,
	IIF(ISNULL(BILLTO,'') = '', IIF(C.ACNAME IS NULL, 'Cash Sales', ACNAME), BILLTOTEL) VATNO,
	B.ITEMDESC ItemName, B.ALTQTY_IN Quantity, B.AltUnit Unit,
	(B.TAXABLE + B.NONTAXABLE) SALESAMOUNT, B.NONTAXABLE AS NONTAXABLE, NULL EXPORTSALES, B.TAXABLE, B.VAT VATAMNT, A.REMARKS,
	ISNULL(A.VNUM,A.VCHRNO) VNO, A.DIVISION INTO #REPORT 
	FROM RMD_TRNMAIN A JOIN RMD_TRNPROD B ON A.VCHRNO = B.VCHRNO
	LEFT JOIN RMD_ACLIST C ON A.PARAC = C.ACID 
	WHERE A.VoucherType in ('CN','SR')
	AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND ISNULL(TERMINAL,'') LIKE @TMR 		
	AND A.DIVISION LIKE @DIVISION 

	SELECT TRNDATE, RIGHT(BSDATE,4) + '.' + SUBSTRING(BSDATE,4,2) + '.' + LEFT(BSDATE,2) BSDATE,VCHRNO,REFBILL, PARTICULARS,VATNO,ItemName, Quantity, Unit,
	CONVERT(NUMERIC(18,2),SALESAMOUNT) SALESAMOUNT,
	CONVERT(NUMERIC(18,2),NONTAXABLE) NONTAXABLE,
	CONVERT(NUMERIC(18,2),TAXABLE) TAXABLE,
	CONVERT(NUMERIC(18,2),VATAMNT) VATAMNT,
	CONVERT(NUMERIC(18,2),EXPORTSALES) EXPORTSALES,
	NULL COUNTRY, NULL PGPNO, NULL PGPDATE,
	REMARKS,VCHRNO,DIVISION, [TYPE] FROM
	(
		SELECT TRNDATE,BSDATE,VCHRNO,REFBILL,PARTICULARS,VATNO,ItemName, Quantity, Unit, SALESAMOUNT,NONTAXABLE, EXPORTSALES, TAXABLE, VATAMNT, REMARKS,VNO,DIVISION,'A' FLG, 'A' [TYPE] FROM #REPORT
		UNION ALL
		SELECT NULL,NULL,NULL,NULL,'TOTAL >>' PARTICULARS,NULL VATNO, NULL, SUM(Quantity), Null, SUM(SALESAMOUNT),SUM(NONTAXABLE),SUM(EXPORTSALES),SUM(TAXABLE),SUM(VATAMNT), NULL REMARKS,NULL VNO,NULL DIVISION,'B' FLG, 'G' [TYPE] FROM #REPORT
	)A ORDER BY FLG,TRNDATE, left(VNO,2),CAST(SUBSTRING(VNO,3,LEN(VNO)) AS NUMERIC)
END