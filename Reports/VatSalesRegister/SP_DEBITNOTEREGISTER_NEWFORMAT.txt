CREATE OR ALTER procedure [dbo].[sp_DebitNoteRegister]
--DECLARE 
@DATE1 DATETIME,
@DATE2 DATETIME,
@DIVISION VARCHAR(10)='%', 
@FYID VARCHAR(10)='',
@CHK_OLDFORMAT TINYINT = 0                       --OldFomrat:1:0
AS
--set @DATE1='2020-07-16';set @DATE2='2021-07-16'; SET @FYID = '77/78'
IF @CHK_OLDFORMAT = 1 
	EXEC sp_DebitNoteRegister_OldFormat @DATE1, @DATE2, @DIVISION, @FYID
ELSE 
BEGIN
	SELECT * FROM 
	( 
		SELECT TRNDATE [Date],RIGHT(BSDATE,4) + '.' + SUBSTRING(BSDATE,4,2) +'.'+LEFT(BSDATE,2) [Miti],A.VCHRNO, A.VCHRNO [Bill No],	
			CASE WHEN ISNULL(A.BILLTO,'') = '' THEN B.ACNAME ELSE A.BILLTO END [Supplier Name],
			CASE WHEN ISNULL(A.BILLTOTEL,'') = '' THEN B.VATNO ELSE A.BILLTOTEL END [Supplier PAN]
			,P.ITEMDESC ItemName, p.Quantity,
			(P.TAXABLE + P.NONTAXABLE + P.VAT) AS [Total Amount], P.NONTAXABLE [Non Taxable Amount],
			CASE WHEN ISNULL(VMODE,1) <=1 THEN  P.TAXABLE else null end as[Purchase Amount] , 
			CASE WHEN ISNULL(VMODE,0)<=1 THEN  P.VAT ELSE NULL END AS [Tax Amount],
			CASE WHEN ISNULL(VMODE,1) =2 THEN  P.TAXABLE else null end as[Import Purchase Amount] ,
			CASE WHEN ISNULL(VMODE,1)=2 THEN  P.VAT ELSE NULL END AS [Tax Amount1],
			CASE WHEN ISNULL(VMODE,1) =3 THEN  P.TAXABLE else null end as[Capitalized Purchase Amount], 
			CASE WHEN ISNULL(VMODE,1)=3 THEN  P.VAT ELSE NULL END AS [Tax Amount2],
			VNUM, A.VCHRNO
			FROM RMD_TRNMAIN A JOIN RMD_TRNPROD P ON A.VCHRNO = P.VCHRNO
			LEFT JOIN RMD_ACLIST B ON A.PARAC=B.ACID 
			LEFT JOIN RMD_ACLIST C ON A.PARAC= C.ACID where A.VoucherType IN ('DN') AND A.PhiscalID = @FYID AND A.DIVISION like @DIVISION and trndate between @DATE1 and @DATE2
	) A ORDER BY A.[DATE],CAST(SUBSTRING( [Bill No],3,CHARINDEX('-', [Bill No], 1) -3) AS NUMERIC)
END