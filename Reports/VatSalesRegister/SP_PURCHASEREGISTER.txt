CREATE OR ALTER   procedure [dbo].[sp_PurchaseRegister]
--DECLARE 
@DATE1 DATETIME,
@DATE2 DATETIME,
@DIVISION VARCHAR(10)='%', 
@CHK_INCLUDEDEBITNOTE VARCHAR(2) = '',          --IncludeDebitNotes:DN:0
@FYID VARCHAR(10)=''
AS
--set @DATE1='1-JAN-2021';set @DATE2='1-MAY-2021'

IF @FYID='' SELECT @FYID= PhiscalID  FROM COMPANY

SELECT * FROM 
(
	SELECT TRNDATE [Date],BSDATE [Miti],A.VCHRNO,A.CHALANNO [Bill No],	
	CASE WHEN ISNULL(A.BILLTO,'') = '' THEN B.ACNAME ELSE A.BILLTO END [Supplier Name],
	CASE WHEN ISNULL(A.BILLTOTEL,'') = '' THEN B.VATNO ELSE A.BILLTO END [Supplier PAN],
	TAXABLE+NONTAXABLE+VATAMNT AS [Total Amount],NONTAXABLE [Non Taxable Amount],
	CASE WHEN ISNULL(VMODE,1) <=1 THEN  TAXABLE else null end as[Purchase Amount] , 
	CASE WHEN ISNULL(VMODE,0)<=1 THEN  VATAMNT ELSE NULL END AS [Tax Amount],
	CASE WHEN ISNULL(VMODE,1) =2 THEN  TAXABLE else null end as[Import Purchase Amount] , 
	CASE WHEN ISNULL(VMODE,1)=2 THEN  VATAMNT ELSE NULL END AS [Tax Amount1],
	CASE WHEN ISNULL(VMODE,1) =3 THEN  TAXABLE else null end as[Capitalized Purchase Amount] , 
	CASE WHEN ISNULL(VMODE,1)=3 THEN  VATAMNT ELSE NULL END AS [Tax Amount2],
	VNUM
	FROM RMD_TRNMAIN A LEFT JOIN RMD_ACLIST B ON A.PARAC=B.ACID 
	LEFT JOIN RMD_ACLIST C ON A.PARAC= C.ACID where VoucherType IN ('PI', 'CP') and isnull(a.status,0) = 0
	and PhiscalID = @FYID  and DIVISION like @DIVISION and trndate between @DATE1 and @DATE2

	UNION ALL

	SELECT TRNDATE [Date],BSDATE [Miti],A.VCHRNO,A.CHALANNO [Bill No],	
	CASE WHEN ISNULL(A.BILLTO,'') = '' THEN B.ACNAME ELSE A.BILLTO END [Supplier Name],
	CASE WHEN ISNULL(A.BILLTOTEL,'') = '' THEN B.VATNO ELSE A.BILLTO END [Supplier PAN],
	(TAXABLE+NONTAXABLE+VATAMNT) * -1 AS [Total Amount], NONTAXABLE * -1 [Non Taxable Amount],
	CASE WHEN ISNULL(VMODE,1) <=1 THEN  TAXABLE * -1 else null end as[Purchase Amount] , 
	CASE WHEN ISNULL(VMODE,0)<=1 THEN  VATAMNT * -1 ELSE NULL END AS [Tax Amount],
	CASE WHEN ISNULL(VMODE,1) =2 THEN  TAXABLE * -1 else null end as[Import Purchase Amount] , 
	CASE WHEN ISNULL(VMODE,1)=2 THEN  VATAMNT * -1 ELSE NULL END AS [Tax Amount1],
	CASE WHEN ISNULL(VMODE,1) =3 THEN  TAXABLE * -1 else null end as[Capitalized Purchase Amount] , 
	CASE WHEN ISNULL(VMODE,1)=3 THEN  VATAMNT * -1 ELSE NULL END AS [Tax Amount2],
	VNUM
	FROM RMD_TRNMAIN A LEFT JOIN RMD_ACLIST B ON A.PARAC=B.ACID 
	LEFT JOIN RMD_ACLIST C ON A.PARAC= C.ACID where VoucherType IN (@CHK_INCLUDEDEBITNOTE) and isnull(a.status,0) = 0
	and PhiscalID = @FYID  and DIVISION like @DIVISION and trndate between @DATE1 and @DATE2
) A ORDER BY [Date],CAST(SUBSTRING(VNUM,3,LEN(VNUM)) AS NUMERIC)