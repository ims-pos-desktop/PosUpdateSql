CREATE OR ALTER PROCEDURE [dbo].[RSP_VATOTHERADJUSTMENTREPORT]
--DECLARE
	@DATE1 VARCHAR(25),
	@DATE2 VARCHAR(25),
	@DIVISION AS VARCHAR(25) = '%',
	@FYID VARCHAR(10)='%'
AS

--EXEC WSP_VATOTHERADJUSTMENTREPORT @DATE1 = '07-17-2021', @DATE2 = '07-17-2022', @DIV = '%',@PHISCALID='78/79', @COMPANYID='NT001'

--SET @DATE1 = '07-16-2020'; SET @DATE2 = '02-02-2022';SET @DIV = 'MMM'; SET @COMPANYID = 'NT001';SET @PHISCALID='77/78'

SELECT ISNULL(NARATION,'')NARATION,B.VCHRNO,B.DIVISION,B.PhiscalID INTO #PARTICULARS FROM RMD_TRNTRAN A 
INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO
LEFT JOIN RMD_TRNPROD P ON B.VCHRNO = P.VCHRNO
WHERE A.VoucherType IN ('CN','DN') AND A.SNO = 1 AND P.VCHRNO IS NULL 
AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 AND B.DIVISION LIKE @DIVISION AND B.PhiscalID = @FYID

SELECT FORMAT(A.TRNDATE,'MM-dd-yyyy')TRNDATE, A.BSDATE, A.VCHRNO,C.ACNAME PARTYNAME,CASE WHEN B.NARATION <> '' THEN B.NARATION ELSE A.REMARKS END PARTICULARS,
A.NONTAXABLE,A.TAXABLE,CASE WHEN A.VCHRNO LIKE 'CN%' THEN A.VATAMNT ELSE 0 END DR_VAT,CASE WHEN A.VCHRNO LIKE 'DN%' THEN A.VATAMNT ELSE 0 END CR_VAT,A.DIVISION,A.STAMP INTO #RESULT
FROM RMD_TRNMAIN A JOIN #PARTICULARS B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PhiscalID = B.PhiscalID 
LEFT JOIN RMD_aCLIST C ON A.TRNAC = C.ACID
WHERE LEFT(A.VCHRNO,2) IN ('CN','DN') --AND A.CNDN_MODE = 1 
AND A.TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.DIVISION LIKE @DIVISION AND A.PhiscalID = @FYID

SELECT TRNDATE,BSDATE,VCHRNO,PARTYNAME,PARTICULARS,FORMAT(NONTAXABLE,'N2')NONTAXABLE,FORMAT(TAXABLE,'N2')TAXABLE,FORMAT(DR_VAT,'N2')DR_VAT,FORMAT(CR_VAT,'N2')CR_VAT,NULL BALANCE,0 FLG, 'A' [TYPE] FROM #RESULT A 
UNION ALL
SELECT NULL, NULL, NULL, NULL, 'TOTAL >>' ,FORMAT(SUM(NONTAXABLE),'N2')NONTAXABLE,FORMAT(SUM(TAXABLE),'N2')TAXABLE,FORMAT(SUM(DR_VAT),'N2')DR_VAT,FORMAT(SUM(CR_VAT),'N2')CR_VAT,FORMAT(ABS(SUM(DR_VAT)-SUM(CR_VAT)),'N2') + CASE WHEN SUM(DR_VAT)-SUM(CR_VAT)>=0 THEN ' DR' ELSE ' CR' END BALANCE,1 FLG , 'G' [TYPE] FROM #RESULT

IF OBJECT_ID('TEMPDB..#RESULT') is not null drop table #RESULT
IF OBJECT_ID('TEMPDB..#PARTICULARS') is not null drop table #PARTICULARS					
set nocount OFF