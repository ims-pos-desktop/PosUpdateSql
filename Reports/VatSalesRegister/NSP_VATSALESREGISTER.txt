CREATE OR ALTER PROCEDURE [dbo].[NSP_VATSALESREGISTER]
	--DECLARE
	@DATE1 VARCHAR(25),
	@DATE2 VARCHAR(25),
	@DIV AS VARCHAR(25) = '%',
	@V1 AS VARCHAR(2) = '%',
	@V2 AS VARCHAR(2) = '%',
	@REPMODE AS VARCHAR(25) = '%'

AS

--SET @DATE1 = '07-15-2016'; SET @DATE2 = '07-15-2018';SET @DIV = '%';SET @V1  = 'SI'; set @V2 ='CN'; SET @REPMODE = 0

set nocount on


DECLARE @TMRVCHRNO AS TINYINT
SELECT @TMRVCHRNO = TERMINALVCHR  FROM SETTING

IF @REPMODE = 0
	BEGIN
		IF OBJECT_ID('TEMPDB..#REPORT') is not null drop table #REPORT
		SELECT * INTO #REPORT FROM
		(
		SELECT TRNDATE, BSDATE, VCHRNO,
		CASE WHEN BILLTO = '' THEN CASE WHEN TRNMODE = 'Cash' OR TRNMODE = 'MixedMode' THEN 'Cash Sales' ELSE ACNAME END ELSE BILLTO END  AS PARTICULARS,
		CASE WHEN BILLTOTEL = '' THEN CASE WHEN TRNMODE = 'Cash' OR TRNMODE = 'MixedMode' THEN '' ELSE VATNO END ELSE BILLTOTEL END  AS VATNO,
		CASE WHEN VCHRNO LIKE 'TI%' THEN (TAXABLE+NONTAXABLE+DCAMNT) ELSE (TAXABLE+NONTAXABLE+DCAMNT)*-1 END SALESAMOUNT,
		CASE WHEN VCHRNO LIKE 'TI%' THEN (NONTAXABLE) ELSE (NONTAXABLE)*-1 END NONTAXABLE,	
		NULL EXPORTSALES,
		CASE WHEN VCHRNO LIKE 'TI%' THEN (DCAMNT) ELSE (DCAMNT)*-1 END DISCOUNT,
		CASE WHEN VCHRNO LIKE 'TI%' THEN (TAXABLE) ELSE (TAXABLE)*-1 END TAXABLE,
		CASE WHEN VCHRNO LIKE 'TI%' THEN (VATAMNT) ELSE (VATAMNT)*-1 END VATAMNT, ISNULL(VNUM,VCHRNO) VNO,DIVISION,
		CASE WHEN VCHRNO LIKE 'RE%' THEN REFBILL ELSE VNUM END XVNO 
		FROM RMD_TRNMAIN LEFT JOIN RMD_ACLIST ON RMD_TRNMAIN.TRNAC = RMD_ACLIST.ACID WHERE LEFT(VCHRNO,2) IN ('TI','RE')
		AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND DIVISION LIKE @DIV
		UNION ALL
		SELECT TRNDATE,BSDATE,
		'SI' + CAST(MIN(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) + ' - ' + 'SI' + CAST(MAX(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) AS VOUCHER,
		'Abb. Tax Invoice' as Particular,NULL [VATNO],SUM(NETSALE) AS NETSALE,SUM(NONTAXABLE) AS NONTAXABLE,NULL EXPORTSALES,
		SUM(DCAMNT) DISCOUNT, SUM(TAXABLE) AS TAXABLE, SUM(VAT) AS VAT,'SI0000' VNO,DIVISION,'SI1' XVNO
		FROM 
		(
		SELECT VCHRNO,TRNDATE, BSDATE,TOTAMNT,DCAMNT,ISNULL(TAXABLE,0)+ISNULL(NONTAXABLE,0) + ISNULL(DCAMNT,0) AS NETSALE, TAXABLE,VATAMNT AS VAT, 
		NONTAXABLE,NETAMNT,DIVISION,ISNULL(VNUM,VCHRNO) VNUM FROM RMD_TRNMAIN WHERE LEFT(VCHRNO,2) = @V1  AND (TRNDATE >= @DATE1 AND TRNDATE < =  @DATE2) AND DIVISION LIKE @DIV
		) X GROUP BY TRNDATE,BSDATE,DIVISION

		UNION ALL

		SELECT TRNDATE, BSDATE, VCHRNO,
		CASE WHEN BILLTO = '' THEN CASE WHEN TRNMODE = 'Cash' OR TRNMODE = 'MixedMode' THEN 'Cash Sales' ELSE ACNAME END ELSE BILLTO END  AS PARTICULARS,
		CASE WHEN BILLTOTEL = '' THEN CASE WHEN TRNMODE = 'Cash' OR TRNMODE = 'MixedMode' THEN '' ELSE VATNO END ELSE BILLTOTEL END  AS VATNO,
		(TAXABLE+NONTAXABLE+DCAMNT)*-1 SALESAMOUNT,	(NONTAXABLE)*-1 NONTAXABLE,	NULL EXPORTSALES,
		DCAMNT *-1 DISCOUNT, (TAXABLE)*-1 TAXABLE,(VATAMNT)*-1 VATAMNT, ISNULL(VNUM,VCHRNO) VNO,DIVISION, VNUM XVNO 
		FROM RMD_TRNMAIN LEFT JOIN RMD_ACLIST ON RMD_TRNMAIN.TRNAC = RMD_ACLIST.ACID WHERE LEFT(VCHRNO,2) = @V2
		AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND DIVISION LIKE @DIV
		) A

		SELECT TRNDATE,BSDATE,VCHRNO,PARTICULARS PARTICULAR,VATNO,CONVERT(VARCHAR,CAST(SALESAMOUNT AS MONEY),1) SALESAMOUNT,CONVERT(VARCHAR,CAST(NONTAXABLE AS MONEY),1) NONTAXABLE,
		CONVERT(VARCHAR,CAST(EXPORTSALES AS MONEY),1)EXPORTSALES,CONVERT(VARCHAR,CAST(DISCOUNT AS MONEY),1) DISCOUNT,CONVERT(VARCHAR,CAST(TAXABLE AS MONEY),1)TAXABLE,
		CONVERT(VARCHAR,CAST(VATAMNT AS MONEY),1) VATAMNT,VNO,DIVISION   FROM 
		(
		SELECT TRNDATE,BSDATE,VCHRNO,PARTICULARS,VATNO,SALESAMOUNT,NONTAXABLE,EXPORTSALES,DISCOUNT,TAXABLE,VATAMNT,VNO,DIVISION,'A'FLG,XVNO FROM #REPORT
		UNION ALL
		SELECT NULL,NULL,NULL,'TOTAL >>',NULL,SUM(SALESAMOUNT),SUM(NONTAXABLE),SUM(EXPORTSALES),SUM(DISCOUNT),SUM(TAXABLE),SUM(VATAMNT),'ZZ00000001' VNO,'XXXXXXXXX' DIVISION,'B' FLG,'ZZ00000001' XVNO FROM #REPORT
		) A ORDER BY FLG,trndate,left(XVNO,2)DESC,CAST(SUBSTRING(A.XVNO,3,LEN(A.XVNO)) AS NUMERIC)
	END

ELSE IF @REPMODE = 1
	BEGIN
		IF OBJECT_ID('TEMPDB..#REPORT1') is not null drop table #REPORT1
	
		SELECT * INTO #REPORT1 FROM
		(
		SELECT TRNDATE,BSDATE,
		'TI' + CAST(MIN(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) + ' - ' + 'TI' + CAST(MAX(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) AS VOUCHER,
		'Tax Invoice' as Particular,NULL [VATNO],
		SUM((TAXABLE+NONTAXABLE+DCAMNT)) SALESAMOUNT,SUM(NONTAXABLE) NONTAXABLE,NULL EXPORTSALES, SUM(DCAMNT) DISCOUNT, SUM(TAXABLE) TAXABLE, SUM(VATAMNT) VAT,
		'TI0000' VNO,DIVISION,'TI1' XVNO FROM RMD_TRNMAIN WHERE LEFT(VCHRNO,2) LIKE 'TI' AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND DIVISION LIKE @DIV
		GROUP BY TRNDATE,BSDATE,DIVISION
	
		UNION ALL

		SELECT TRNDATE,BSDATE,
		'RE' + CAST(MIN(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) + ' - ' + 'RE' + CAST(MAX(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) AS VOUCHER,
		'Tax Invoice' as Particular,NULL [VATNO],
		SUM((TAXABLE+NONTAXABLE+DCAMNT))*-1 SALESAMOUNT,SUM(NONTAXABLE)*-1 NONTAXABLE,NULL EXPORTSALES, SUM(DCAMNT)*-1 DISCOUNT,SUM(TAXABLE)*-1 TAXABLE,  SUM(VATAMNT)*-1 VAT,
		'TI0000' VNO,DIVISION,'TI1' XVNO FROM RMD_TRNMAIN WHERE LEFT(VCHRNO,2) LIKE 'RE' AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND DIVISION LIKE @DIV
		GROUP BY TRNDATE,BSDATE,DIVISION
	
		UNION ALL

		SELECT TRNDATE,BSDATE,
		'SI' + CAST(MIN(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) + ' - ' + 'SI' + CAST(MAX(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) AS VOUCHER,
		'Abb. Tax Invoice' as Particular,NULL [VATNO],SUM(SALESAMOUNT) AS SALESAMOUNT,SUM(NONTAXABLE) AS NONTAXABLE,NULL EXPORTSALES,
		SUM(DCAMNT) DISCOUNT, SUM(TAXABLE) AS TAXABLE, SUM(VAT) AS VAT,'SI0000' VNO,DIVISION,'SI1' XVNO
		FROM 
		(
		SELECT VCHRNO,TRNDATE, BSDATE,TOTAMNT,DCAMNT,ISNULL(TAXABLE,0)+ISNULL(NONTAXABLE,0) + ISNULL(DCAMNT,0) AS SALESAMOUNT, TAXABLE,VATAMNT AS VAT, 
		NONTAXABLE,NETAMNT,DIVISION,ISNULL(VNUM,VCHRNO) VNUM FROM RMD_TRNMAIN WHERE LEFT(VCHRNO,2) = @V1 AND (TRNDATE >= @DATE1 AND TRNDATE < =  @DATE2) AND DIVISION LIKE @DIV
		) X GROUP BY TRNDATE,BSDATE,DIVISION

		UNION ALL

		SELECT TRNDATE,BSDATE,
		'CN' + CAST(MIN(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) + ' - ' + 'CN' + CAST(MAX(CAST(SUBSTRING(VNUM, 3,LEN(VNUM)) AS INTEGER)) AS VARCHAR) AS VOUCHER,
		'Tax Invoice' as Particular,NULL [VATNO],
		SUM((TAXABLE+NONTAXABLE+DCAMNT))*-1 SALESAMOUNT,SUM(NONTAXABLE)*-1 NONTAXABLE, NULL EXPORTSALES, SUM(DCAMNT)*-1 DISCOUNT, SUM(TAXABLE)*-1 TAXABLE, SUM(VATAMNT)*-1 VAT,
		'CN0000' VNO,DIVISION,'CN1' XVNO FROM RMD_TRNMAIN WHERE LEFT(VCHRNO,2) LIKE @V2 AND (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2) AND DIVISION LIKE @DIV
		GROUP BY TRNDATE,BSDATE,DIVISION	
		) A

		SELECT TRNDATE,BSDATE,VOUCHER VCHRNO,PARTICULAR,VATNO,CONVERT(VARCHAR,CAST(SALESAMOUNT AS MONEY),1) SALESAMOUNT,CONVERT(VARCHAR,CAST(NONTAXABLE AS MONEY),1) NONTAXABLE,
		CONVERT(VARCHAR,CAST(EXPORTSALES AS MONEY),1)EXPORTSALES,CONVERT(VARCHAR,CAST(DISCOUNT AS MONEY),1) DISCOUNT,CONVERT(VARCHAR,CAST(TAXABLE AS MONEY),1)TAXABLE,
		CONVERT(VARCHAR,CAST(VATAMNT AS MONEY),1) VATAMNT,VNO,DIVISION   FROM 
		(
		SELECT TRNDATE,BSDATE,VOUCHER,PARTICULAR,VATNO,SALESAMOUNT,NONTAXABLE,EXPORTSALES,DISCOUNT,TAXABLE,VAT VATAMNT,VNO,DIVISION,'A'FLG,XVNO FROM #REPORT1
		UNION ALL
		SELECT NULL,NULL,NULL,'TOTAL >>',NULL,SUM(SALESAMOUNT),SUM(NONTAXABLE),SUM(EXPORTSALES),SUM(DISCOUNT),SUM(TAXABLE),SUM(VAT),'ZZ00000001' VNO,'XXXXXXXXX' DIVISION,'B' FLG,'ZZ00000001' XVNO FROM #REPORT1
		) A ORDER BY FLG,trndate,left(XVNO,2)DESC,CAST(SUBSTRING(A.XVNO,3,LEN(A.XVNO)) AS NUMERIC)
END

