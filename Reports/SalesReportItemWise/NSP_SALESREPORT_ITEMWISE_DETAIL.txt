CREATE OR ALTER PROCEDURE [dbo].[NSP_SALESREPORT_ITEMWISE_DETAIL]
--DECLARE 
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIV VARCHAR(3) = '%',
	@MC VARCHAR(25) = '%',
	@BC VARCHAR(MAX)= '%',	
	@BARCODEWISEREPORT TINYINT = 0,
	@BARCODEDETAIL TINYINT =0,
	@DIVISIONWISEREPORT TINYINT = 0,
	@WISE VARCHAR(25) = 'BILLWISE',
	@SHOWINTERCOMPANYONLY TINYINT = 0,
	@PTYPE INT = 100

AS

--SET @DATE1 = '01-01-2017'; SET @DATE2 = '04-01-2019' ; SET @DIVISIONWISEREPORT = 0; SET @WISE = 'DAYWISE'
set nocount on

DECLARE @SHOWBARCODEDETAIL TINYINT=1
DECLARE @BCDETAIL_QUERY VARCHAR(500)
DECLARE  @BARCODECOMPULOSRYMODE TINYINT = 0

SELECT @BCDETAIL_QUERY = 'SELECT BARCODE,COLOR,SIZE,MCODE FROM BARCODE_DETAIL',@SHOWBARCODEDETAIL = ISNULL(EnableBarcodeDetails,0),@BARCODECOMPULOSRYMODE = ENABLEBARCODECOMPULSORY FROM SETTING


	IF OBJECT_ID('TEMPDB..#REPDATA') is not null drop table #REPDATA
	
	SELECT ISNULL(A.BILLTOMOB, A.MEMBERNO) MOBILENO, S.NAME SALESMAN, B.ITEMDESC, B.MCODE,A.VCHRNO,A.CHALANNO,A.REFORDBILL,A.REFBILL,A.TRNDATE,A.BSDATE,A.DIVISION,
	CASE WHEN TRNMODE = 'CREDIT' THEN Z.ACNAME ELSE CASE WHEN ISNULL(BILLTO,'') <> '' THEN BILLTO ELSE Z.ACNAME END END BILLTO,
	B.BC BARCODE, UNIT BILLUNIT,QUANTITY BILLQTY,RATE BILLRATE, 
	X.BASEUNIT BASEUNIT, CASE WHEN LEFT(A.VCHRNO,2) IN ('SI','TI','IC') THEN REALQTY ELSE REALQTY_IN END BASEQTY,REALRATE BASERATE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.AMOUNT*-1 ELSE B.AMOUNT END AMOUNT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.DISCOUNT*-1 ELSE B.DISCOUNT END DISCOUNT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.SERVICETAX *-1 ELSE B.SERVICETAX END SCHARGE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN (B.TAXABLE+B.NONTAXABLE) *-1 ELSE (B.TAXABLE+B.NONTAXABLE) END NETSALE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.TAXABLE*-1 ELSE B.TAXABLE END TAXABLE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.NONTAXABLE*-1 ELSE B.NONTAXABLE END NONTAXABLE,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN B.VAT*-1 ELSE B.VAT END VAT,
	CASE WHEN LEFT(B.VCHRNO,2) IN ('CN','RE','IR') THEN (B.TAXABLE+B.NONTAXABLE+B.VAT)*-1 ELSE (B.TAXABLE+B.NONTAXABLE+B.VAT) END NETAMNT,
	CASE WHEN @DIVISIONWISEREPORT = 1 THEN Y.NAME ELSE '' END DIVISION_NAME,A.STAMP,A.TRNUSER,A.TRNTIME, TPS.StartTime, TPS.EndTime 
	INTO #REPDATA
	FROM RMD_SALESPROD B INNER JOIN RMD_TRNMAIN A ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND ISNULL(A.PhiscalID,'') = ISNULL(B.PHISCALID,'')
	INNER JOIN MENUITEM X ON B.MCODE = X.MCODE LEFT JOIN DIVISION Y ON B.DIVISION = Y.INITIAL
	LEFT JOIN RMD_TRNPROD_STATUS TPS ON B.VCHRNO = TPS.VCHRNO AND B.MCODE = TPS.MCODE AND B.SNO = TPS.SNO
	LEFT JOIN RMD_ACLIST Z ON A.TRNAC = Z.ACID 
	LEFT JOIN SALESMAN S ON S.SALESMANID = B.SALESMANID
	WHERE ((@SHOWINTERCOMPANYONLY=0 AND LEFT(A.VCHRNO,2) IN ('SI','TI','CN','RE')) OR (@SHOWINTERCOMPANYONLY=1 AND LEFT(A.VCHRNO,2) IN ('IC','IR')))
	AND	A.TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.DIVISION LIKE @DIV AND B.MCODE LIKE @MC AND ((@BARCODEWISEREPORT = 1 AND ISNULL(B.BC,'') LIKE @BC) OR (@BARCODEWISEREPORT = 0 AND ISNULL(B.BC,'') LIKE '%')) 
	AND (@PTYPE = 100 OR X.PTYPE = @PTYPE)
	BEGIN
		IF @WISE = 'BILLWISE'
			BEGIN
			IF @BARCODEDETAIL = 0
				SELECT TRNDATE,BSDATE,VCHRNO,REFBILL REFNO, ITEMDESC DESCA,BILLTO,BARCODE,BILLUNIT,BILLQTY,BILLRATE,BASEUNIT,BASEQTY,BASERATE,AMOUNT,DISCOUNT,SCHARGE,NETSALE,TAXABLE,NONTAXABLE,VAT,NETAMNT,TRNUSER,TRNTIME,B.NAME DIVISION, SALESMAN, MOBILENO, StartTime, EndTime
				FROM #REPDATA A LEFT JOIN DIVISION B ON A.DIVISION = B.INITIAL ORDER BY TRNDATE,A.STAMP

			ELSE IF @BARCODEDETAIL = 1
				BEGIN
					DECLARE @SQL VARCHAR(MAX)
					SET @SQL = N'
					SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.REFBILL REFNO,A.ITEMDESC DESCA,A.BILLTO,A.BILLUNIT,A.BILLQTY,A.BILLRATE,A.BASEUNIT,A.BASEQTY,A.BASERATE,A.AMOUNT,A.DISCOUNT,A.SCHARGE,A.NETSALE,A.TAXABLE,A.NONTAXABLE,A.VAT,A.NETAMNT,
					B.*,A.TRNUSER,A.TRNTIME,A.DIVISION,A.SALESMAN, A.MOBILENO FROM #REPDATA A LEFT JOIN (' + @BCDETAIL_QUERY + ') B ON A.MCODE = B.MCODE AND A.BARCODE = B.BARCODE
					ORDER BY A.TRNDATE,A.STAMP'					
					--print @sql
					EXEC(@SQL)
				END
			END
		ELSE IF @WISE = 'DAYWISE'
			IF @BARCODEDETAIL = 0
				SELECT TRNDATE,BSDATE,X.MENUCODE,X.DESCA,CASE WHEN @BARCODEWISEREPORT = 1 THEN A.BARCODE ELSE '' END BARCODE,X.BASEUNIT UNIT,SUM(BASEQTY) BASEQTY,SUM(AMOUNT) AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(SCHARGE) SCHARGE,
				SUM(NETSALE) NETSALE,SUM(TAXABLE)TAXABLE,SUM(NONTAXABLE) NONTAXABLE, SUM(A.VAT) VAT,SUM(NETAMNT)NETAMNT,DIVISION_NAME, A.SALESMAN
				FROM #REPDATA A INNER JOIN MENUITEM X ON A.MCODE = X.MCODE GROUP BY TRNDATE,DIVISION_NAME,BSDATE,X.MENUCODE,X.DESCA,X.BASEUNIT,(CASE WHEN @BARCODEWISEREPORT = 1 THEN A.BARCODE ELSE '' END), SALESMAN ORDER BY TRNDATE,X.DESCA
			ELSE
				BEGIN
					SELECT TRNDATE,BSDATE,X.MENUCODE,X.DESCA,A.BARCODE,X.BASEUNIT UNIT,SUM(BASEQTY) BASEQTY,SUM(AMOUNT) AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(SCHARGE) SCHARGE,
					SUM(NETSALE) NETSALE,SUM(TAXABLE)TAXABLE,SUM(NONTAXABLE) NONTAXABLE, SUM(A.VAT) VAT,SUM(NETAMNT)NETAMNT,DIVISION_NAME,X.MCODE
					INTO #REPDATA_1 FROM #REPDATA A INNER JOIN MENUITEM X ON A.MCODE = X.MCODE GROUP BY TRNDATE,BSDATE,X.MENUCODE,X.DESCA,X.BASEUNIT,A.BARCODE,DIVISION_NAME,X.MCODE

					DECLARE @SQL1 VARCHAR(MAX)
					SET @SQL1 = N'
					SELECT A.TRNDATE,A.BSDATE,A.MENUCODE,A.DESCA,A.UNIT,A.BASEQTY,A.AMOUNT,A.DISCOUNT,A.SCHARGE,A.NETSALE,A.TAXABLE,A.NONTAXABLE,A.VAT,A.NETAMNT,
					B.*,A.DIVISION_NAME FROM #REPDATA_1 A LEFT JOIN (' + @BCDETAIL_QUERY + ') B ON A.MCODE = B.MCODE AND A.BARCODE = B.BARCODE
					ORDER BY A.TRNDATE'					
					--Print @sql
					EXEC(@SQL1)
				END
	END

IF OBJECT_ID('TEMPDB..#REPDATA') is not null drop table #REPDATA
IF OBJECT_ID('TEMPDB..#REPDATA_1') is not null drop table #REPDATA_1

set nocount off




