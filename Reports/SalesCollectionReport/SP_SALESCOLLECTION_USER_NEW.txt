CREATE OR ALTER   PROCEDURE [dbo].[SP_SALESCOLLECTION_USER_NEW]
@DATE1 DATETIME,
@DATE2 DATETIME,
@div varchar(10),
@VCHR1 VARCHAR(15) ,
@SMODE VARCHAR(25) ,
@USER VARCHAR(25)
AS

DECLARE @ISVAT AS SMALLINT
SELECT @ISVAT = ISVAC FROM SETTING

DECLARE @VCHR2 VARCHAR(25)
DECLARE @VCHR3 VARCHAR(25)

IF @VCHR1= 'SR' 
	SET @VCHR2 ='CN'
	SET @VCHR3 = 'NR'

SELECT * FROM
(
SELECT CONVERT(VARCHAR(25),A.TRNDATE,1) AS TRNDATE,A.BSDATE, CASE WHEN @ISVAT = 0 THEN A.VCHRNO ELSE A.CHALANNO END AS VCHRNO, A.CHALANNO, CASE WHEN (A.TRNMODE = 'MIXEDMODE') THEN 'N/A (MIXED PAYMENT)' ELSE B.ACNAME END AS PARTY,
CONVERT(VARCHAR(25),CONVERT(MONEY, (CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN TOTAMNT * -1 ELSE TOTAMNT END)),1) AS GROSS,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.DCAMNT *-1 ELSE A.DCAMNT END),1) AS DCAMNT,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.STAX *-1 ELSE A.STAX END),1) AS STAX,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.TAXABLE + A.NONTAXABLE) *-1 ELSE (A.TAXABLE + A.NONTAXABLE) END),1) AS NETSALE,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.VATAMNT * -1 ELSE A.VATAMNT END),1) AS VATAMNT,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END),1) AS NETAMNT,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN (A.TRNMODE = 'CASH') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NETCASH ELSE NULL END END),1)AS CASH,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN (A.TRNMODE IN ('CreditCard', 'Credit Card')) THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NCREDITCARD ELSE NULL END END),1) AS CreditCard,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN (A.TRNMODE = 'CREDIT') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NCREDIT ELSE NULL END END),1) AS CREDIT,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN (A.TRNMODE IN ('ONLINE', 'ESEWA', 'FONEPAY', 'QR', 'QR MODE')) THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN N_ONLINE ELSE NULL END END),1) AS [ONLINE],
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN (A.TRNMODE = 'Sales Return Voucher') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NSalesReturnVoucher ELSE NULL END END),1) AS SalesReturnVoucher,
CONVERT(VARCHAR(25),CONVERT(MONEY,CASE WHEN (A.TRNMODE = 'Complimentary') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NComplimentary ELSE NULL END END),1) AS Complimentary,
TRNTIME,TRNUSER, TRNDATE AS TDATE,'B' AS FLG, VCHRNO AS VNO, A.VNUM, DIVISION, CONVERT(INT, A.CUSTOMER_COUNT) PAX, TRANSACTIONID FROM RMD_TRNMAIN A INNER JOIN RMD_ACLIST B ON A.TRNAC = B.ACID
LEFT JOIN BILLTENDER X ON A.VCHRNO = X.VNO AND A.DIVISION = X.DIV AND A.PhiscalID = X.PHISCALID
WHERE (LEFT(A.VCHRNO,2) IN ('SI','TI','NC','RE',@VCHR1,@VCHR2,@VCHR3) AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) and division like @div) 
AND A.TRNUSER LIKE @USER AND A.TRNMODE LIKE @SMODE
AND ((@SMODE = 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') <> '') OR (@SMODE <> 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') LIKE '%'))

UNION ALL

SELECT NULL, NULL, NULL,NULL,'TOTAL', CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(GROSS)),1) AS GROSS, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(DCAMNT)),1) AS DCAMNT, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(STAX)),1) AS STAX, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(NETSALE)),1) AS NETSALES, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(VATAMNT)),1) AS VATAMNT,
CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(NETAMNT)),1) AS NETAMNT, CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(CASH)),1) AS CASH, 
CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(CreditCard)),1) AS CreditCard, CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(CREDIT)),1) AS CREDIT, 
CONVERT(VARCHAR(25),CONVERT(MONEY, SUM([ONLINE])),1) AS [ONLINE], CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(SalesReturnVoucher)),1) AS SalesReturnVoucher, 
CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(Complimentary)),1) AS Complimentary, NULL,TRNUSER,NULL, 'C' AS FLG,NULL AS VNO,NULL, NULL, CONVERT(INT,SUM(PAX)) PAX, NULL
FROM 
(SELECT A.TRNDATE,A.BSDATE, A.VCHRNO, A.CHALANNO, B.ACNAME AS PARTY,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (TOTAMNT) * -1 ELSE TOTAMNT END AS GROSS,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.DCAMNT *-1 ELSE A.DCAMNT END AS DCAMNT,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.STAX *-1 ELSE A.STAX END AS STAX,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.TAXABLE + A.NONTAXABLE) *-1 ELSE (A.TAXABLE + A.NONTAXABLE) END AS NETSALE,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.VATAMNT * -1 ELSE A.VATAMNT END AS VATAMNT,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END AS NETAMNT,
CASE WHEN (A.TRNMODE = 'CASH') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NETCASH ELSE NULL END END AS CASH,
CASE WHEN (A.TRNMODE IN ('CreditCard', 'Credit Card')) THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NCREDITCARD ELSE NULL END END  AS CreditCard,
CASE WHEN (A.TRNMODE = 'CREDIT') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NCREDIT ELSE NULL END END AS CREDIT,
CASE WHEN (A.TRNMODE IN ('ONLINE', 'ESEWA', 'FONEPAY', 'QR', 'QR MODE')) THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN N_ONLINE ELSE NULL END END AS [ONLINE],
CASE WHEN (A.TRNMODE = 'Sales Return Voucher') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NSalesReturnVoucher ELSE NULL END END AS SalesReturnVoucher,
CASE WHEN (A.TRNMODE = 'Complimentary') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NComplimentary ELSE NULL END END AS Complimentary,
TRNUSER, TRNTIME,TRNDATE AS TDATE,'B' AS FLG, VCHRNO AS VNO, TERMINAL,DIVISION, A.Customer_Count PAX FROM RMD_TRNMAIN A INNER JOIN RMD_ACLIST B ON A.TRNAC = B.ACID
LEFT JOIN BILLTENDER X ON A.VCHRNO = X.VNO AND A.DIVISION = X.DIV AND A.PhiscalID = X.PHISCALID
WHERE (LEFT(A.VCHRNO,2) IN ('SI','TI','NC','RE',@VCHR1,@VCHR2,@VCHR3) AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) and division like @div) 
AND A.TRNUSER LIKE @USER AND A.TRNMODE LIKE @SMODE AND ((@SMODE = 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') <> '') OR (@SMODE <> 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') LIKE '%'))
) AS Z GROUP BY TRNUSER


UNION ALL

SELECT UPPER(TRNUSER),NULL,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, TRNUSER, NULL,  'A' AS FLG,NULL AS VNO, NULL,NULL, NULL, NULL FROM (
SELECT DISTINCT TRNUSER FROM RMD_TRNMAIN A WHERE (LEFT(A.VCHRNO,2) IN('SI','TI',@VCHR1,@VCHR2,'RE') AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) and division like @div)
AND TRNUSER LIKE @USER AND TRNMODE LIKE @SMODE ) AS A

UNION ALL

SELECT NULL, NULL, NULL,NULL,'GRAND TOTAL', CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(GROSS)),1) AS GROSS, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(DCAMNT)),1) AS DCAMNT, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(STAX)),1) AS STAX, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(NETSALE)),1) AS NETSALE,CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(VATAMNT)),1) AS VATAMNT,
CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(NETAMNT)),1) AS NETAMNT, CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(CASH)),1) AS CASH, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(CreditCard)),1) AS CreditCard, CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(CREDIT)),1) AS CREDIT, CONVERT(VARCHAR(25),CONVERT(MONEY, SUM([ONLINE])),1) AS [ONLINE], CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(SalesReturnVoucher)),1) AS SalesReturnVoucher,
CONVERT(VARCHAR(25),CONVERT(MONEY, SUM(Complimentary)),1) AS Complimentary, NULL,'ZZZZZZZZZ' AS TRNUSER,NULL, 'D' AS FLG,NULL AS VNO,NULL, NULL, CONVERT(INT,SUM(PAX)) PAX, NULL
FROM 
(SELECT A.TRNDATE,A.BSDATE, A.VCHRNO, A.CHALANNO,B.ACNAME AS PARTY,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (TOTAMNT) * -1 ELSE TOTAMNT END AS GROSS,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.DCAMNT *-1 ELSE A.DCAMNT END AS DCAMNT,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.STAX *-1 ELSE A.STAX END AS STAX,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.TAXABLE + A.NONTAXABLE) *-1 ELSE (A.TAXABLE + A.NONTAXABLE) END AS NETSALE,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN A.VATAMNT * -1 ELSE A.VATAMNT END AS VATAMNT,
CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END AS NETAMNT,
CASE WHEN (A.TRNMODE = 'CASH') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NETCASH ELSE NULL END END AS CASH,
CASE WHEN (A.TRNMODE IN ('CreditCard', 'Credit Card')) THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NCREDITCARD ELSE NULL END END  AS CreditCard,
CASE WHEN (A.TRNMODE = 'CREDIT') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NCREDIT ELSE NULL END END AS CREDIT,
CASE WHEN (A.TRNMODE IN ('ONLINE', 'ESEWA', 'FONEPAY', 'QR', 'QR MODE')) THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN N_ONLINE ELSE NULL END END AS [ONLINE],
CASE WHEN (A.TRNMODE = 'Sales Return Voucher') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NSalesReturnVoucher ELSE NULL END END AS SalesReturnVoucher,
CASE WHEN (A.TRNMODE = 'Complimentary') THEN CASE WHEN A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE') THEN (A.NETAMNT) *-1 ELSE A.NETAMNT END ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'Mixed') THEN NComplimentary ELSE NULL END END AS Complimentary,
DIVISION, TRNTIME,TRNDATE AS TDATE,TRNUSER, A.Customer_Count PAX FROM RMD_TRNMAIN A INNER JOIN RMD_ACLIST B ON A.TRNAC = B.ACID
LEFT JOIN BILLTENDER X ON A.VCHRNO = X.VNO AND A.DIVISION = X.DIV AND A.PhiscalID = X.PHISCALID
WHERE (LEFT(A.VCHRNO,2) IN ('SI','TI','NC','RE',@VCHR1,@VCHR2,@VCHR3) AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) and division like @div) 
AND A.TRNUSER LIKE @USER  AND A.TRNMODE LIKE @SMODE AND ((@SMODE = 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') <> '') OR (@SMODE <> 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') LIKE '%'))
) AS Z
) AS M
ORDER BY M.TRNUSER, M.FLG,M.TDATE,left(M.VCHRNO,2)DESC,CAST(RIGHT(M.VNUM,len(M.VNUM)-2) as numeric)