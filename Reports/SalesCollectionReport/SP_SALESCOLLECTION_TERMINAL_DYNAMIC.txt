CREATE OR ALTER    PROCEDURE [dbo].[SP_SALESCOLLECTION_TERMINAL_DYNAMIC]
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@div varchar(10),
@VCHR1 VARCHAR(15),
@SMODE VARCHAR(25)='%',
@TERMINAL VARCHAR(25),
@FLAG TINYINT = 0
AS
--SET @DATE1='2020-07-16'; SET @DATE2='2020-12-01'; SET @div = '%'; SET @VCHR1 = 'SR'; SET @TERMINAL = '%'

EXEC OSP_PopulateTblBillTender

DECLARE @VCHR2 VARCHAR(25)
DECLARE @VCHR3 VARCHAR(25)
DECLARE @VDISCOUNT AS VARCHAR(25)
SET @VDISCOUNT = '%'
--SELECT @ISVAT = ISVAC FROM SETTING

IF @VCHR1= 'SR' 
BEGIN
	SET @VCHR2 = 'CN'
	set @vchr3 = 'NR'
END

BEGIN
	IF @SMODE = 'C-Card Discount'
		BEGIN
			SET @VDISCOUNT = 'CARD DISCOUNT'
			SET @SMODE = 'CreditCard'  
		END
	ELSE
		BEGIN
			SET @VDISCOUNT = '%'	
		END
END

BEGIN
	DECLARE @PaymentCols AS NVARCHAR(MAX), 
	@PaymentNullCols NVARCHAR(MAX),
	@PaymentSumCols NVARCHAR(MAX),
    @query  AS NVARCHAR(MAX);

	SET @PaymentCols = STUFF((SELECT distinct ',' + QUOTENAME(COLUMN_NAME) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'tblBillTender' AND COLUMN_NAME NOT IN ('VCHRNO','DIVISION','PHISCALID', 'COMPANYID','TRANSACTIONID') FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)') ,1,1,'')
	SET @PaymentSumCols = STUFF((SELECT distinct ',SUM(' + QUOTENAME(COLUMN_NAME) + ')' FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'tblBillTender' AND COLUMN_NAME NOT IN ('VCHRNO','DIVISION','PHISCALID', 'COMPANYID','TRANSACTIONID') FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)') ,1,1,'')
	SET @PaymentNullCols = STUFF((SELECT ', NULL' FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'tblBillTender' AND COLUMN_NAME NOT IN ('VCHRNO','DIVISION','PHISCALID', 'COMPANYID','TRANSACTIONID') FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)') ,1,1,'')
	
	IF OBJECT_ID('TEMPDB..#DATA') is not null drop table #DATA

	SELECT A.TRNDATE, A.BSDATE, A.VCHRNO BILLNO, A.CHALANNO, A.PARTY,
	CONVERT(NUMERIC(18,2), A.TOTAMNT * A.MULTIPLIER) GROSS,
	CONVERT(NUMERIC(18,2), A.DCAMNT * A.MULTIPLIER) DCAMNT,
	CONVERT(NUMERIC(18,2), A.STAX * A.MULTIPLIER)  STAX,
	CONVERT(NUMERIC(18,2), A.NETSALE * A.MULTIPLIER) NETSALE,
	CONVERT(NUMERIC(18,2), A.VATAMNT * A.MULTIPLIER) VATAMNT,
	CONVERT(NUMERIC(18,2), A.NETAMNT * A.MULTIPLIER) NETAMNT,
	X.*, TRNUSER, TRNTIME, TDATE, VNO,TERMINAL,A.DIVISION BRANCHID, PAX,
	A.BILLTOPAN, A.BILLTOMOB INTO #DATA
	FROM
	(
		SELECT CONVERT(VARCHAR(25),A.TRNDATE,1) AS TRNDATE,A.BSDATE, A.VCHRNO, A.CHALANNO, A.PHISCALID,
		IIF(ISNULL(A.BILLTO,'') <> '', A.BILLTO, B.ACNAME) PARTY, A.TOTAMNT, A.DCAMNT, A.STAX, A.TAXABLE + A.NONTAXABLE NETSALE, A.VATAMNT, A.NETAMNT, 
		A.TRNUSER, TRNTIME,TRNDATE AS TDATE, ISNULL(A.VNUM,A.VCHRNO) AS VNO,TERMINAL,A.DIVISION, CONVERT(INT, A.Customer_Count) PAX,
		ISNULL(A.BILLTOTEL, '') BILLTOPAN, A.BILLTOMOB, IIF(A.VoucherType IN (@VCHR1, @VCHR2, @VCHR3, 'RE'), -1, 1) Multiplier
		FROM RMD_TRNMAIN A INNER JOIN RMD_ACLIST B ON A.TRNAC = B.ACID
		WHERE A.VoucherType IN ('SI','TI','NC','RE',@VCHR1,@VCHR2,@VCHR3) 
		AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) 
		and A.division like @div 
		AND A.TERMINAL LIKE @TERMINAL 
		AND A.TRNMODE LIKE @SMODE AND A.TRNMODE NOT IN ('CUSTOMER','SUPPLIER')
		AND ISNULL(A.CHOLDER,'') LIKE @VDISCOUNT 
		AND ((@SMODE = 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') <> '') OR (@SMODE <> 'MEMBERSHIP' AND ISNULL(A.MEMBERNAME ,'') LIKE '%'))
	) A
	LEFT JOIN tblBillTender X ON A.VCHRNO = X.VCHRNO AND A.DIVISION = X.DIVISION AND A.PHISCALID = X.PHISCALID 

	SET @query = N'SELECT * FROM 
	(
		SELECT A.TRNDATE, A.BSDATE, A.BILLNO VCHRNO, A.CHALANNO, A.PARTY, GROSS, DCAMNT, STAX, NETSALE, VATAMNT, NETAMNT, '+@PaymentCols+', TRNUSER, TRNTIME, TDATE, VNO, TERMINAL, A.BRANCHID, PAX, ''B'' FLG FROM #DATA A
		UNION ALL
		SELECT NULL, NULL, NULL, NULL, ''TOTAL'', SUM(GROSS), SUM(DCAMNT), SUM(STAX), SUM(NETSALE), SUM(VATAMNT), SUM(NETAMNT), '+ @PaymentSumCols +', NULL, NULL, NULL, NULL, TERMINAL, NULL, SUM(PAX), ''C'' FLG FROM #DATA A GROUP BY TERMINAL
		UNION ALL
		SELECT TNAME, NULL, NULL, NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,'+@PaymentNullCols+', NULL, NULL,NULL,NULL,TERMINAL, NULL, NULL, ''A'' FLG FROM
		(
			SELECT DISTINCT B.NAME TNAME, A.TERMINAL FROM #DATA A JOIN SALESTERMINAL B ON A.TERMINAL = B.INITIAL 
		) A
		UNION ALL
		SELECT NULL, NULL, NULL, NULL, ''GRAND TOTAL'', SUM(GROSS), SUM(DCAMNT), SUM(STAX), SUM(NETSALE), SUM(VATAMNT), SUM(NETAMNT), '+ @PaymentSumCols +', NULL, NULL, NULL, NULL, ''ZZZZZ'', NULL, SUM(PAX), ''D'' FLG FROM #DATA A
    ) M ORDER BY M.TERMINAL, M.FLG, CAST(M.TDATE AS DATETIME), left(M.VNO,2) desc,CAST(RIGHT(VNO,len(VNO)-2) as numeric)
	'
	PRINT @QUERY
	EXECUTE(@query)	
END