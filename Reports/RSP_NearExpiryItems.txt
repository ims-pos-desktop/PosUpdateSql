CREATE OR ALTER PROC RSP_NearExpiryItems
@DIVISION CHAR(3),
@PhiscalId VARCHAR(10),
@ExpiryWithin SMALLINT,
@OFFSET INT = 0,
@ROWS INT = 999999
AS
SELECT ROW_NUMBER() OVER (ORDER BY BM.EXPDATE) SNO, MI.MENUCODE, MI.DESCA, P.*, BM.EXPDATE
FROM
(
	SELECT P.MCODE, P.BATCH,  SUM(P.REALQTY_IN - P.RealQty) ClosingStock FROM RMD_TRNMAIN M JOIN RMD_TRNPROD P ON M.VCHRNO = P.VCHRNO
	WHERE P.DIVISION = @DIVISION AND P.PHISCALID = @PhiscalId 
	GROUP BY P.MCODE, P.BATCH
	HAVING SUM(P.REALQTY_IN - P.RealQty) <> 0
) P
JOIN BATCHPRICE_MASTER BM ON P.MCODE = BM.MCODE AND P.BATCH = BM.BATCHCODE
JOIN MENUITEM MI ON P.MCODE = MI.MCODE
WHERE DATEDIFF(DAY, CONVERT(DATE, GETDATE()), BM.EXPDATE) <= @ExpiryWithin
ORDER BY BM.EXPDATE
OFFSET @OFFSET * @ROWS ROWS FETCH NEXT @ROWS ROWS ONLY