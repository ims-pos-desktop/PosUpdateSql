CREATE OR ALTER PROCEDURE [dbo].[SP_DAILYSALESPOSITION_NEW_DAYWISE]
@DATE1 DATETIME,
@DATE2 DATETIME,
@DIV VARCHAR(25),
@COUNTER VARCHAR(50) = '%',
@flag int =0  ---0 filter by TRNDATE |1 filter by DAYSTARTDATE
AS

--DECLARE @DATE1 VARCHAR(25)='2020-10-17',@DATE2 DATETIME='2020-10-17',@DIV VARCHAR(25)='%',@COUNTER VARCHAR(50) = '%',@flag int =1
SET @DATE2 = @DATE2 + '23:59:59.990'
SELECT TRNDATE, DM.MITI BSDATE,
	B.NAME AS TNAME, 
	CONVERT(MONEY,SUM(CASHSALE)) AS CASHSALE, 
	CONVERT(MONEY,SUM(CREDITCARD)) AS CREDITCARD, 
	CONVERT(MONEY,SUM(CREDIT)) AS CREDIT,
	CONVERT(MONEY,SUM([Online])) AS [ONLINE],
	CONVERT(MONEY,SUM([SalesReturnVoucher])) AS [SalesReturnVoucher],
	CONVERT(MONEY,SUM([Complimentary])) AS [Complimentary],
	CONVERT(MONEY,SUM(TOT)) AS TOT, 
	CONVERT(MONEY,SUM(SRETURN)) AS SRETURN, 
	CONVERT(MONEY,SUM(NET)) AS NET,
	SUM(NOS) AS NOS,
	CASE WHEN(SUM(NOS) >0) THEN CONVERT(MONEY,(round(SUM(NET)/SUM(NOS),2)),1) ELSE NULL END AS AVG, 
	A.TERMINAL
FROM 
(
	SELECT CASE WHEN @flag = 0 THEN TRNDATE ELSE CONVERT(DATE,d.DAYSTARTDATE) END TRNDATE,TERMINAL, 
	CASE WHEN(TRNMODE = 'Cash' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN ISNULL(NETCASH,0) ELSE 0 END END AS CASHSALE,
	CASE WHEN(TRNMODE IN('CreditCard', 'Credit Card') AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN ISNULL(NCREDITCARD,0) ELSE 0 END  END AS CREDITCARD,
	CASE WHEN(TRNMODE = 'Credit' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN ISNULL(NCREDIT,0) ELSE 0 END  END AS CREDIT,
	CASE WHEN(TRNMODE IN ('ONLINE', 'ESEWA', 'FONEPAY', 'QR', 'QR MODE' , 'MOCO' , 'Nepal Pay' , 'IME Pay' , 'Smart QR' , 'Khalti' , 'MocoPay' , 'HamroÂ Pay') AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN ISNULL(N_ONLINE,0) ELSE 0 END  END AS ONLINE,
	CASE WHEN(TRNMODE = 'Sales Return Voucher' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN ISNULL(NSalesReturnVoucher,0) ELSE 0 END  END AS SalesReturnVoucher,
	CASE WHEN(TRNMODE = 'Complimentary' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN ISNULL(NComplimentary,0) ELSE 0 END  END AS Complimentary,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE 0 END AS TOT, 
	CASE WHEN(VCHRNO LIKE 'SR%' OR VCHRNO LIKE 'CN%' OR VCHRNO LIKE 'NR%' ) THEN NETAMNT ELSE 0 END AS SRETURN,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN NETAMNT ELSE NETAMNT *-1 END AS NET,
	CASE WHEN (LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN 1 ELSE 0 END AS NOS
	FROM RMD_TRNMAIN A LEFT JOIN BILLTENDER X ON A.VCHRNO = X.VNO AND A.DIVISION = X.DIV AND A.PhiscalID = X.PHISCALID 
	left JOIN SESSION S ON A.[SHIFT]= S.SESSIONID AND A.PHISCALID = S.PHISCALID
	left JOIN DAYS D ON S.DAYSTARTID = D.DAYSTARTID AND D.PHISCALID = S.PHISCALID
	WHERE (CASE WHEN @flag=1 THEN D.DAYSTARTDATE ELSE  TRNDATE END between @DATE1 and @DATE2) AND A.DIVISION LIKE @DIV AND LEFT(VCHRNO,2) IN ('SI','SR','TI','CN','NR','RE')
) AS A 
JOIN DATEMITI DM ON A.TRNDATE = DM.AD
LEFT JOIN SALESTERMINAL B ON A.TERMINAL = B.INITIAL	
WHERE ISNULL(B.INITIAL,'') LIKE @COUNTER  
GROUP BY A.TERMINAL, B.NAME,TRNDATE, DM.MITI 
ORDER BY TRNDATE,NAME
