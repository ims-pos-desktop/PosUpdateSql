CREATE OR ALTER PROCEDURE [dbo].[SP_DAILYSALESPOSITION_USERWISE_NEW]
@DATE1 VARCHAR(25),
@DATE2 VARCHAR(25),
@DIV VARCHAR(25),
@USER VARCHAR(50) = '%'
AS

	SELECT TRNDATE AS TRNDATE, TRNUSER, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(CASHSALE)),1) AS CASHSALE, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(CREDITCARD)),1) AS CREDITCARD, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(CREDIT)),1) AS CREDIT,
	CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(TOT)),1) AS TOT, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(SRETURN)),1) AS SRETURN, CONVERT(VARCHAR(25),CONVERT(MONEY,SUM(NET)),1) AS NET,SUM(NOS) AS NOS,CASE WHEN(SUM(NOS) >0) THEN CONVERT(MONEY,(round(SUM(NET)/SUM(NOS),2)),1) ELSE NULL END AS AVG, A.TRNUSER
	FROM (
	SELECT TRNDATE,TRNUSER, 
	CASE WHEN(TRNMODE = 'Cash' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN NETCASH ELSE 0 END  END AS CASHSALE,
	CASE WHEN(TRNMODE IN ('CreditCard', 'Credit Card') AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN NCREDITCARD ELSE 0 END  END AS CREDITCARD,
	CASE WHEN(TRNMODE = 'Credit' AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE = 'MIXEDMODE' THEN NCREDIT ELSE 0 END  END AS CREDIT,
	CASE WHEN(TRNMODE NOT IN ('Cash','CreditCard', 'Credit Card', 'Credit') AND LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE CASE WHEN A.TRNMODE IN ('MIXEDMODE', 'MIXED') THEN NCREDITCARD ELSE 0 END  END AS OTHER,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR')) THEN (CASE WHEN VCHRNO LIKE 'RE%' THEN NETAMNT*-1 ELSE NETAMNT END) ELSE 0 END AS TOT, 
	CASE WHEN(VCHRNO LIKE 'SR%' OR VCHRNO LIKE 'CN%' OR VCHRNO LIKE 'NR%') THEN NETAMNT ELSE 0 END AS SRETURN,
	CASE WHEN(LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN NETAMNT ELSE NETAMNT *-1 END AS NET,
	CASE WHEN (LEFT(VCHRNO,2) NOT IN ('SR','CN','NR','RE')) THEN 1 ELSE 0 END AS NOS
	FROM RMD_TRNMAIN A LEFT JOIN BILLTENDER X ON A.VCHRNO = X.VNO AND A.DIVISION = X.DIV AND A.PhiscalID = X.PHISCALID 
	WHERE (TRNDATE > = @DATE1 AND TRNDATE < = @DATE2)
	AND DIVISION LIKE @DIV AND LEFT(VCHRNO,2) IN ('SI','SR','TI','CN','NR','RE') AND ISNULL(TRNUSER,'') LIKE @USER) AS A 
	GROUP BY A.TRNUSER,TRNDATE ORDER BY TRNDATE, A.TRNUSER
