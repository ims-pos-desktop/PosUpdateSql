CREATE OR ALTER PROC RSP_RECEIPEREPORT
	@MENUCAT VARCHAR(100) ='%',
	@MGROUP VARCHAR(20) = '%',
	@GROUP VARCHAR(25)='%'
AS
SELECT RM.ENO, M.MCODE, IH.[Main Group], IH.[Main Category], IH.[Sub Category], IH.[Super Category], M.DESCA, RM.FACTOR QTY, SUM(RP.QTY * ISNULL(RI.CRATE, RI.PRATE_A)) COST_PRICE, M.BASEUNIT, M.RATE_A, 0 FLG, 'G' TYPE  FROM MENUITEM M 
JOIN vwItemHeirarchy IH ON M.MCODE = IH.MCODE
JOIN ReceipeMain RM ON RM.MCODE = M.MCODE
JOIN RECEIPEPROD RP ON RP.ENO = RM.ENO
JOIN MENUITEM RI ON RP.RMCODE = RI.MCODE
WHERE M.PTYPE = 10 AND M.MCAT LIKE @MENUCAT AND M.PARENT LIKE @GROUP AND M.MGROUP LIKE @MGROUP
GROUP BY RM.ENO, M.MCODE, IH.[Main Group], IH.[Main Category], IH.[Sub Category], IH.[Super Category], M.DESCA, RM.FACTOR,M.BASEUNIT, M.RATE_A

UNION ALL

SELECT RM.ENO, RM.MCODE, NULL, NULL, NULL,NULL, M.DESCA, RP.QTY, ISNULL(M.CRATE, M.PRATE_A), M.BASEUNIT, NULL, 1, 'A'  FROM MENUITEM M 
JOIN RECEIPEPROD RP ON RP.RMCODE = M.MCODE
JOIN ReceipeMain RM ON RM.ENO = RP.ENO
JOIN MENUITEM MR ON RM.MCODE = MR.MCODE
WHERE MR.PTYPE = 10 AND MR.MCAT LIKE @MENUCAT AND MR.PARENT LIKE @GROUP AND MR.MGROUP LIKE @MGROUP

UNION ALL

SELECT RM.ENO, M.MCODE, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 2 FLG, 'G' TYPE  FROM MENUITEM M 
JOIN vwItemHeirarchy IH ON M.MCODE = IH.MCODE
JOIN ReceipeMain RM ON RM.MCODE = M.MCODE
WHERE M.PTYPE = 10 AND M.MCAT LIKE @MENUCAT AND M.PARENT LIKE @GROUP AND M.MGROUP LIKE @MGROUP
ORDER BY ENO, MCODE, FLG