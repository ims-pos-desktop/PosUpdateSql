CREATE OR ALTER PROCEDURE [dbo].[RSP_BRANCHWISE_CONSOLIDATED_SALES]
--DECLARE 
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@MCODE VARCHAR(25) = '%',
	@PATH VARCHAR(MAX) = '%',
	@MGROUP VARCHAR(25) = '%',
	@MENUCAT VARCHAR(50) = '%',
	@PTYPE INT = 0,
	@SUPPLIER_ACID VARCHAR(25) = '%',
	@ITEMLIST VARCHAR(MAX) = '',
	@CHK_BarcodeWise TINYINT =0,
	@OPT_WISE VARCHAR(25) = 'ITEM',  --Item:Item,Mgroup:Mgroup,MCat:MCat,PType:PType
	@OPT_TREE TINYINT = 0            --NonTree:0,Tree:1
AS

--SET @DATE1 = '1 NOV 2021'; SET @DATE2 = '1 NOV 2022' ; 
SET NOCOUNT ON

	
DECLARE @SHOWBARCODEDETAIL TINYINT,@SalesFigureIncVat TINYINT
SELECT @SHOWBARCODEDETAIL = CONVERT(TINYINT, EnableBarcodeDetails) | ISNULL(HASVEHICLESALE,0) FROM SETTING
SELECT TOP 1 @SalesFigureIncVat = SettingValue FROM ReportSetting WHERE ReportName = 'Branchwise Consolidated Sales' AND SettingName = 'SalesFigureIncVat'

IF OBJECT_ID('TEMPDB..#REPDATA') is not null drop table #REPDATA
IF OBJECT_ID('TEMPDB..#SALESDATA') is not null drop table #SALESDATA
IF OBJECT_ID('TEMPDB..#TREE') IS NOT NULL DROP TABLE #TREE
IF OBJECT_ID('TEMPDB..#RESULT1') IS NOT NULL DROP TABLE #RESULT1
IF OBJECT_ID('TEMPDB..#MENUITEM') is not null drop table #MENUITEM
IF OBJECT_ID('TEMPDB..#RESULT') IS NOT NULL DROP TABLE #RESULT	

CREATE TABLE #MENUITEM (MCODE VARCHAR(25),MENUCODE VARCHAR(50),DESCA VARCHAR(250),MGROUP VARCHAR(25),MCAT VARCHAR(50),BASEUNIT VARCHAR(25),SUPCODE VARCHAR(25),PTYPE TINYINT,PATH VARCHAR(2000))

CREATE TABLE #RESULT (ID INT, SYMBOL VARCHAR(10), DESCA VARCHAR(500), MENUCODE VARCHAR(25), BC VARCHAR(25), UNIT VARCHAR(25), SQTY NUMERIC(13,3), RQTY NUMERIC(13,3), NETQTY NUMERIC(13,3), 
							TOTVALUE NUMERIC(22,12), DISCOUNT NUMERIC(22,12), SCHARGE NUMERIC(22,12), NETSALE NUMERIC(22,12), TAXABLE NUMERIC(22,12), NONTAXABLE NUMERIC(22,12), VAMNT NUMERIC(22,12),
							NETAMNT NUMERIC(22,12), SUPPLIER VARCHAR(250), MCODE VARCHAR(25), [TYPE] CHAR(1), DIVISION VARCHAR(3))

if @ITEMLIST = ''
	INSERT INTO #MENUITEM (MCODE,MENUCODE,DESCA,MGROUP,MCAT,BASEUNIT,SUPCODE,PTYPE,PATH)
	SELECT MCODE,MENUCODE,DESCA,MGROUP,MCAT,BASEUNIT,SUPCODE,PTYPE,PATH FROM MENUITEM WHERE TYPE = 'A'
ELSE
	INSERT INTO #MENUITEM (MCODE,MENUCODE,DESCA,MGROUP,MCAT,BASEUNIT,SUPCODE,PTYPE,PATH) 
	SELECT MCODE,MENUCODE,DESCA,MGROUP,MCAT,BASEUNIT,SUPCODE,PTYPE,PATH FROM MENUITEM A 
	INNER JOIN 
	(
		SELECT * FROM dbo.split(@ITEMLIST,',')
	) B ON A.MCODE = B.ITEMS				


SELECT B.MCODE,A.DIVISION,ISNULL(B.BC,'') BC,
	ISNULL(REALQTY,0) SALESQTY, ISNULL(REALQTY_IN,0) RETURNQTY,
	ISNULL(REALQTY,0)-ISNULL(REALQTY_IN,0) NETQTY,	
	B.AMOUNT * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) TOTVALUE,
	B.DISCOUNT * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) DISCOUNT,
	B.SERVICETAX * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) SCHARGE,
	(B.TAXABLE+B.NONTAXABLE) * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) NETSALE,
	B.TAXABLE * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) TAXABLE,
	B.NONTAXABLE * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) NONTAXABLE,
	B.VAT * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) VAMNT,
	(B.TAXABLE+B.NONTAXABLE+B.VAT) * IIF(B.VOUCHERTYPE IN ('CN','RE'), -1,1) NETAMNT
	INTO #SALESDATA
	FROM SALES_TRNPROD B INNER JOIN SALES_TRNMAIN A ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PhiscalID = B.PHISCALID
	WHERE LEFT(A.VCHRNO,2) IN ('SI','TI','CN','RE', 'RR')
	AND	A.TRNDATE BETWEEN @DATE1 AND @DATE2 AND B.MCODE LIKE @MCODE 	
	
SELECT X.MENUCODE,X.DESCA,X.MGROUP,X.MCAT,X.BASEUNIT UNIT,ISNULL(X.SUPCODE,'')SUPCODE,ISNULL(X.PTYPE,0) PTYPE, A.*
	INTO #REPDATA FROM #SALESDATA A
	INNER JOIN #MENUITEM X ON A.MCODE = X.MCODE 
	WHERE X.MGROUP LIKE @MGROUP AND ISNULL(X.MCAT, '') LIKE @MENUCAT
	AND	((@PTYPE = 100 AND ISNULL(X.PTYPE,0) < @PTYPE) OR (@PTYPE <> 100 AND ISNULL(X.PTYPE,0) = @PTYPE))
	AND ISNULL(X.PATH,'') LIKE @PATH AND ISNULL(X.SUPCODE,'') LIKE @SUPPLIER_ACID
UNION ALL
SELECT X.MENUCODE,X.DESCA,X.MGROUP,X.MCAT,X.BASEUNIT UNIT,ISNULL(X.SUPCODE,'')SUPCODE,ISNULL(X.PTYPE,0) PTYPE, A.MCODE, 'ZZZ' DIVISION, A.BC, A.SALESQTY, A.RETURNQTY, A.NETQTY, A.TOTVALUE
	,A.DISCOUNT, A.SCHARGE, A.NETSALE, A.TAXABLE, A.NONTAXABLE, A.VAMNT, A.NETAMNT
	FROM #SALESDATA A
	INNER JOIN #MENUITEM X ON A.MCODE = X.MCODE 
	WHERE X.MGROUP LIKE @MGROUP AND ISNULL(X.MCAT, '') LIKE @MENUCAT
	AND	((@PTYPE = 100 AND ISNULL(X.PTYPE,0) < @PTYPE) OR (@PTYPE <> 100 AND ISNULL(X.PTYPE,0) = @PTYPE))
	AND ISNULL(X.PATH,'') LIKE @PATH AND ISNULL(X.SUPCODE,'') LIKE @SUPPLIER_ACID
	
	--SELECT * FROM #REPDATA
	
IF @OPT_TREE = 0 
	BEGIN
		IF @OPT_WISE = 'ITEM'
			INSERT INTO #RESULT
			SELECT 0,'',DESCA, MENUCODE,IIF(@CHK_BarcodeWise = 1, A.BC,'') BC, UNIT, SUM(SALESQTY), SUM(RETURNQTY), SUM(NETQTY), SUM(TOTVALUE), SUM(DISCOUNT), SUM(SCHARGE), SUM(NETSALE), SUM(TAXABLE),
			SUM(NONTAXABLE), SUM(VAMNT), SUM(NETAMNT), X.ACNAME SUPPLIER, MCODE, 'A', DIVISION FROM #REPDATA A LEFT JOIN RMD_ACLIST X ON A.SUPCODE = X.ACID
			GROUP BY MENUCODE,DESCA,MCODE,UNIT,X.ACNAME, A.DIVISION,IIF(@CHK_BarcodeWise = 1, A.BC,'')
				
		ELSE IF @OPT_WISE = 'MGROUP'
			INSERT INTO #RESULT
			SELECT 0, '', B.DESCA MAINGROUP, NULL CODE, NULL BC, NULL UNIT, SUM(SALESQTY) SQTY, SUM(RETURNQTY) RQTY, SUM(NETQTY) NETQTY, SUM(TOTVALUE) TOTVALUE, SUM(DISCOUNT)DISCOUNT, SUM(SCHARGE)SCHARGE
			, SUM(NETSALE) NETSALE, SUM(TAXABLE)TAXABLE, SUM(NONTAXABLE) NONTAXABLE, SUM(VAMNT) VAMNT, SUM(NETAMNT) NETAMNT, NULL SUPPLIER , B.MCODE ,'A' FLG, A.DIVISION FROM #REPDATA A 
			INNER JOIN MENUITEM B ON A.MGROUP = B.MCODE
			GROUP BY B.DESCA,B.MCODE, A.DIVISION

		ELSE IF @OPT_WISE = 'MCAT'
			INSERT INTO #RESULT
			SELECT 0 ID, '' SYMBOL,A.MCAT, NULL CODE, NULL BC, NULL UNIT, SUM(SALESQTY) SQTY, SUM(RETURNQTY) RQTY, SUM(NETQTY) NETQTY, SUM(TOTVALUE) TOTVALUE, SUM(DISCOUNT)DISCOUNT, SUM(SCHARGE)SCHARGE
			, SUM(NETSALE) NETSALE, SUM(TAXABLE)TAXABLE, SUM(NONTAXABLE) NONTAXABLE, SUM(VAMNT) VAMNT, SUM(NETAMNT) NETAMNT, NULL SUPPLIER , NULL MCODE ,'A' FLG, A.DIVISION FROM #REPDATA A 
			GROUP BY A.MCAT, A.DIVISION
			

		ELSE IF @OPT_WISE = 'PTYPE'
			INSERT INTO #RESULT
			SELECT 0 ID, '' SYMBOL,ISNULL(X.PTYPENAME,'N/A') PTYPENAME, A.PTYPE CODE, NULL BC, NULL UNIT, SUM(SALESQTY) SQTY, SUM(RETURNQTY) RQTY, SUM(NETQTY) NETQTY, SUM(TOTVALUE) TOTVALUE, SUM(DISCOUNT)DISCOUNT, SUM(SCHARGE)SCHARGE
			, SUM(NETSALE) NETSALE, SUM(TAXABLE)TAXABLE, SUM(NONTAXABLE) NONTAXABLE, SUM(VAMNT) VAMNT, SUM(NETAMNT) NETAMNT, NULL SUPPLIER ,  NULL MCODE ,'A' FLG, A.DIVISION FROM #REPDATA A 
			LEFT JOIN PTYPE X ON ISNULL(A.PTYPE,0) = X.PTYPEID
			GROUP BY ISNULL(X.PTYPENAME,'N/A'), A.DIVISION, A.PTYPE
	END
ELSE
	--PREPARING TREE
	BEGIN
		
		SELECT IIF(@CHK_BarcodeWise = 1, A.BC,'') BC,UNIT,SUM(SALESQTY)SQTY,SUM(RETURNQTY)RQTY,SUM(NETQTY)NETQTY,SUM(TOTVALUE) TOTVALUE, SUM(DISCOUNT)DISCOUNT, SUM(SCHARGE)SCHARGE, SUM(NETSALE) NETSALE, SUM(TAXABLE)TAXABLE,
		SUM(NONTAXABLE)NONTAXABLE,SUM(VAMNT) VAMNT,SUM(NETAMNT) NETAMNT,X.ACNAME SUPPLIER,MCODE MC, A.DIVISION INTO #RESULT1 FROM #REPDATA A LEFT JOIN RMD_ACLIST X ON A.SUPCODE = X.ACID
		GROUP BY IIF(@CHK_BarcodeWise = 1, A.BC,''),MENUCODE,DESCA,MCODE,UNIT,X.ACNAME, A.DIVISION
		
		IF OBJECT_ID('TEMPDB..#TREE') IS NOT NULL DROP TABLE #TREE
		
		SELECT CASE WHEN A.TYPE='G' THEN '-' ELSE NULL END AS SYMBOL, A.DESCRIPTION,A.CODE MENUCODE,A.LEVEL,B.*,X.PARENT,A.ID,A.TYPE,A.MCODE 	
		INTO #TREE 
		FROM TreeExpand_function ('MI','PRODUCT LIST',0) AS A LEFT JOIN #RESULT1 B ON A.MCODE = B.MC 
		LEFT JOIN MENUITEM X ON A.MCODE = X.MCODE
		
		--SUMMING GROUP
		DECLARE @LVL INT
		select @LVL=MAX(LEVEL) from #TREE 
		PRINT @LVL

		WHILE @lvl > 0
			BEGIN
				UPDATE A SET A.SQTY=B.SQTY,A.RQTY = B.RQTY,A.NETQTY = B.NETQTY,A.TOTVALUE = B.TOTVALUE,A.DISCOUNT = B.DISCOUNT,A.SCHARGE = B.SCHARGE,
				A.NETSALE = B.NETSALE,A.TAXABLE = B.TAXABLE,A.NONTAXABLE = B.NONTAXABLE,A.VAMNT = B.VAMNT,A.NETAMNT = B.NETAMNT
				FROM #TREE A INNER JOIN 
				(select PARENT,ISNULL(SUM(SQTY),0)SQTY,ISNULL(SUM(RQTY),0) RQTY,ISNULL(SUM(NETQTY),0) NETQTY,ISNULL(SUM(TOTVALUE),0) TOTVALUE,
				ISNULL(SUM(DISCOUNT),0) DISCOUNT,
				ISNULL(SUM(SCHARGE),0) SCHARGE, ISNULL(SUM(NETSALE),0) NETSALE,ISNULL(SUM(TAXABLE),0) TAXABLE,ISNULL(SUM(NONTAXABLE),0) NONTAXABLE,ISNULL(SUM(VAMNT),0) VAMNT,
				ISNULL(SUM(NETAMNT),0) NETAMNT 
				FROM #TREE where level= @lvl
				GROUP BY PARENT) B on A.MCODE =B.PARENT
				SET @lvl = @lvl - 1;
			END

		--DISPLAYING RESULT
		------------------
		INSERT INTO #RESULT
		SELECT ID, SYMBOL,DESCRIPTION DESCA,MENUCODE,BC,UNIT,SQTY,RQTY,NETQTY,TOTVALUE,DISCOUNT,SCHARGE,NETSALE,TAXABLE,NONTAXABLE,
		VAMNT,NETAMNT,SUPPLIER,MCODE,TYPE, DIVISION FROM #TREE
		WHERE SQTY <> 0 or RQTY <>0 or NETQTY <>0 or TOTVALUE <>0 or DISCOUNT <> 0 or SCHARGE <> 0 or NETSALE <> 0 or TAXABLE <> 0 or NONTAXABLE <> 0 OR VAMNT <> 0 OR NETAMNT <> 0 
		ORDER BY ID

	END

--SELECT * FROM #RESULT
DECLARE @HasVariant BIT = @SHOWBARCODEDETAIL & @CHK_BarcodeWise


DECLARE @query  AS VARCHAR(MAX)
	,@colQty  AS NVARCHAR(MAX)
	,@colValue AS NVARCHAR(MAX)
	,@colOUT  AS NVARCHAR(MAX)
	,@colBAL  AS NVARCHAR(MAX)
	,@colheader  AS NVARCHAR(MAX)
	,@opDrCr AS VARCHAR(MAX) = ''
	,@clDrCr AS VARCHAR(MAX) = ''
	,@SalesFigure AS VARCHAR(20) = 'NETSALE'
	--CONVERT(VARCHAR,CAST(ABS(OPAMNT) AS MONEY),1)

IF @SalesFigureIncVat = 1 SET @SalesFigure = 'NETAMNT'

SET @colheader = 'CONVERT(DECIMAL(18,2), SUM(ISNULL([ZZZ_QTY],0))) [ZZZ_QTY],CONVERT(DECIMAL(18,2), SUM(ISNULL([ZZZ_VALUE],0)))[ZZZ_VALUE],'
	+ STUFF((SELECT distinct ',' +'CONVERT(DECIMAL(18,2), SUM(ISNULL(' + QUOTENAME(INITIAL+'_QTY') +',0))) ' +QUOTENAME([INITIAL]+'_QTY')
	+',' +'CONVERT(DECIMAL(18,2), SUM(ISNULL(' + QUOTENAME(INITIAL+'_VALUE') +',0)))' +QUOTENAME([INITIAL]+'_VALUE')
	FROM DIVISION  FOR XML PATH(''), TYPE  ).value('.', 'NVARCHAR(MAX)')  ,1,1,'')
	


--PRINT(@COLHEADER)

SET @colQty = STUFF((SELECT distinct ',' + QUOTENAME(INITIAL + '_QTY' ) 
            FROM DIVISION  FOR XML PATH(''), TYPE  ).value('.', 'NVARCHAR(MAX)')  ,1,1,'') + ',[ZZZ_QTY]'

SET @colValue = STUFF((SELECT distinct ',' + QUOTENAME(INITIAL + '_VALUE') 
            FROM DIVISION  FOR XML PATH(''), TYPE  ).value('.', 'NVARCHAR(MAX)')  ,1,1,'') + ',[ZZZ_VALUE]'

SET  @QUERY ='
SELECT [Main Group], [Main Category], [Sub Category], [Super Category], [ID], [SYMBOL], DESCA, MENUCODE, BC, UNIT, SUPPLIER, MCODE, [TYPE],  ' + IIF(@HasVariant = 1,' SIZE, COLOR, ','') + @colheader + ' FROM
(    
    SELECT IH.[Main Group], IH.[Main Category], IH.[Sub Category], IH.[Super Category], A.[ID], A.[SYMBOL], A.DESCA, A.MENUCODE, A.BC,' + IIF(@HasVariant = 1,' SIZE, COLOR, ','') + ' A.UNIT, A.DIVISION + ''_QTY'' DIV_QTY
	, A.DIVISION + ''_VALUE'' DIV_VALUE
	, A.NETQTY, A.'+@SalesFigure+', A.SUPPLIER, A.MCODE, A.[TYPE]  FROM #RESULT A 
	LEFT JOIN vwItemHeirarchy IH ON A.MCODE = IH.MCODE'
	+ IIF(@HasVariant = 1, 'LEFT JOIN BARCODE_DETAIL BD ON A.MCODE = BD.MCODE AND A.BC = BD.BARCODE','') + '
) AS S
PIVOT
(
	SUM(NETQTY) for DIV_QTY in ('+@colQTY+')
) AS OP
PIVOT
(
	SUM('+@SalesFigure+') for DIV_VALUE in ('+@colValue+')
) AS I
GROUP BY  [Main Group], [Main Category], [Sub Category], [Super Category], [ID], [SYMBOL], DESCA, MENUCODE, BC, UNIT, SUPPLIER, MCODE, [TYPE]
ORDER BY [ID]'
--PRINT @QUERY
EXECUTE(@QUERY)

set nocount off
