
CREATE OR ALTER PROC RSP_BATCHPRICE_BREAKDOWN
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@VCHR VARCHAR(25) = '%',
@MCODE VARCHAR(25) = '%'
AS
SELECT 0 FLAG, MI.MCODE + P.VCHRNO SORTCOLUMN, P.VCHRNO, MI.MCODE, MI.MENUCODE, MI.DESCA, P.BATCH, P.ALTUNIT UNIT, P.ALTQTY_IN QTY, CONVERT(NUMERIC(18,2), P.ALTRATE) RATE, 
P.QUANTITY BASE_QTY, CONVERT(NUMERIC(18,2), P.RATE) BASE_RATE, 
CONVERT(NUMERIC(18,2), P.AMOUNT) AMOUNT, 
CONVERT(NUMERIC(18,2), P.INDDISCOUNT) INDDISCOUNT, 
CONVERT(NUMERIC(18,2), P.FLATDISCOUNT) FLATDISCOUNT, 
CONVERT(NUMERIC(18,2), P.TAXABLE + P.NONTAXABLE) NET_AMOUNT
INTO #REPORT FROM  PURPROD P 
JOIN PURMAIN M ON P.VCHRNO = M.VCHRNO
JOIN BATCHPRICE_MASTER B ON P.MCODE = B.MCODE AND P.BATCH = B.BATCHCODE AND P.VCHRNO = B.BatchCreateVoucher
JOIN MENUITEM MI ON P.MCODE = MI.MCODE
WHERE M.TRNDATE BETWEEN @DATE1 AND @DATE2 AND P.VoucherType = 'PI' AND P.MCODE LIKE @MCODE AND P.VCHRNO LIKE @VCHR

SELECT 0 FLAG, SORTCOLUMN, VCHRNO, MCODE, MENUCODE, DESCA, BATCH, UNIT,  QTY, RATE, BASE_QTY, BASE_RATE, AMOUNT, INDDISCOUNT, 
FLATDISCOUNT, NET_AMOUNT
FROM #REPORT
UNION ALL
SELECT 1, SORTCOLUMN, NULL, NULL, NULL, 'SUMMARY', NULL, NULL, NULL, NULL, 
SUM(BASE_QTY) , SUM(NET_AMOUNT)/ SUM(BASE_QTY), SUM(AMOUNT), SUM(INDDISCOUNT), SUM(FLATDISCOUNT), SUM(NET_AMOUNT)
FROM #REPORT
GROUP BY MCODE, SORTCOLUMN
UNION ALL
SELECT 2, SORTCOLUMN, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 
NULL , NULL, NULL, NULL, NULL, NULL
FROM #REPORT 
GROUP BY MCODE, SORTCOLUMN
ORDER BY SORTCOLUMN, FLAG
