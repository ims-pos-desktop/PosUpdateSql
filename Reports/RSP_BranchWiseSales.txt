CREATE OR ALTER    PROCEDURE [dbo].[RSP_BranchWiseSale]
--DECLARE 
@DATE1 DATETIME, 
@DATE2 DATETIME
AS
--SET @DATE1 ='2020-08-16'; SET @DATE2 ='2020-09-16'
DECLARE @PaymentSumCols NVARCHAR(MAX),
    @query  AS NVARCHAR(MAX);

SET @PaymentSumCols = STUFF((SELECT distinct ',SUM(' + QUOTENAME(COLUMN_NAME) + ')'+QUOTENAME(COLUMN_NAME)+'' FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'tblBillTender' AND COLUMN_NAME NOT IN ('VCHRNO','DIVISION','PHISCALID', 'COMPANYID','TRANSACTIONID') FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)') ,1,1,'')
	
	
IF OBJECT_ID('TEMPDB..#DATA') is not null drop table #DATA

SELECT ra.ACCODE [Branch Code], A.DIVISION [Branch Division], D.NAME [Branch Name],
CONVERT(NUMERIC(18,2), (A.TOTAMNT * A.MULTIPLIER)) [Gross Amount],
CONVERT(NUMERIC(18,2), (A.DCAMNT * A.MULTIPLIER)) [Discount Amount],
CONVERT(NUMERIC(18,2), (A.VATAMNT * A.MULTIPLIER)) [Vat Amount],
CONVERT(NUMERIC(18,2), (A.NETAMNT * A.MULTIPLIER)) [Net Amount],
X.*, A.VNO INTO #DATA
FROM 
(
	SELECT A.VCHRNO VNO ,A.DIVISION, A.TOTAMNT, A.DCAMNT, A.VATAMNT, A.NETAMNT,
	IIF(A.VoucherType = 'CN',-1, 1) Multiplier, A.PhiscalID
	FROM RMD_TRNMAIN A JOIN RMD_ACLIST B ON A.TRNAC = B.ACID
	WHERE A.VoucherType IN ('SI','TI','CN') AND (A.TRNDATE BETWEEN @DATE1 AND @DATE2)
)A 
LEFT JOIN tblBillTender X ON A.VNO = X.VCHRNO AND A.DIVISION = X.DIVISION AND A.PHISCALID = X.PHISCALID  
LEFT JOIN DIVISION D ON A.DIVISION=D.INITIAL
LEFT JOIN RMD_ACLIST ra on ra.ACID=d.ACID

SET @query =N'SELECT D.[Branch Code], D.[Branch Division],D.[Branch Name], SUM(D.[Gross Amount]) [Gross Amount], SUM(D.[Discount Amount]) [Discount Amount],
			SUM(D.[Vat Amount]) [Vat Amount], SUM(D.[Net Amount]) [Net Amount],'+@PaymentSumCols+', COUNT(DISTINCT(D.VNO)) [No Of Transaction]
			FROM #DATA D GROUP BY D.[Branch Division], D.[Branch Code], D.[Branch Name] ORDER BY D.[Branch Code] DESC'

--PRINT @query
EXECUTE(@QUERY)