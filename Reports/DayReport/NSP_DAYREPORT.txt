CREATE OR ALTER   PROCEDURE [dbo].[NSP_DAYREPORT]
--DECLARE
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIVISION VARCHAR(3) = '%',
	@USER VARCHAR(50) = '%',
	@ENTRYDATEWISE TINYINT = 0,
	@FROMVNO NUMERIC(18),
	@TOVNO NUMERIC(18),
	@VTYPE VARCHAR(25),
	@SERIES VARCHAR(25),
	@DETAILREPORT TINYINT = 0
AS
set nocount on
--SET @DETAILREPORT = 1
--SET @DATE1 = '07-16-2018';SET  @DATE2 = '07-16-2019';SET @ENTRYDATEWISE = 1;SET @FROMVNO = 0;SET @TOVNO=0;SET @VTYPE ='%';SET @SERIES = ''

if OBJECT_ID('Tempdb..#TRNMAIN') is not null drop table #TRNMAIN

SELECT TRNDATE,BSDATE,VCHRNO,DIVISION,CHALANNO,dbo.GetParticularForLedger(VCHRNO,DIVISION) VTYPENAME, VoucherType VTYPE,CASE WHEN VoucherType IN ('PV','RV') THEN PARAC ELSE TRNAC END ACID,
REMARKS,NETAMNT,TRNUSER,TRNTIME, CASE WHEN ISNULL(VNUM,VCHRNO)<>'' THEN ISNULL(VNUM,VCHRNO) ELSE VCHRNO END VNUM,A.DIVISION DIVID
INTO #TRNMAIN FROM RMD_TRNMAIN A WHERE LEFT(VCHRNO,2) NOT IN ('OP','AO') AND A.DIVISION LIKE @DIVISION AND A.TRNUSER LIKE @USER
AND ((@ENTRYDATEWISE =0 AND CONVERT(NUMERIC,RIGHT(ISNULL(VNUM,VCHRNO),len(ISNULL(VNUM,VCHRNO))-2)) BETWEEN @FROMVNO AND @TOVNO) OR (@ENTRYDATEWISE =1 AND A.TRNDATE BETWEEN @DATE1 AND @DATE2))
AND ((@VTYPE = '%' AND A.VoucherType IN ('JV','PV','RV','CN','DN','SI','TI','SR','PI','PR','RE')) OR (@VTYPE <> '%' AND A.VoucherType LIKE @VTYPE)) 
AND ((@SERIES = '' AND LEFT(A.VCHRNO,2) LIKE '%') OR (@SERIES <> '' AND LEFT(A.VCHRNO,2) LIKE @SERIES))

--SELECT * FROM #TRNMAIN

if OBJECT_ID('Tempdb..#TRNTRAN') is not null drop table #TRNTRAN
 
--DETAIL REPORT
---------------
IF @DETAILREPORT = 1
	
	SELECT NULL TRNDATE,'' BSDATE,'' VCHRNO,'' CHALANNO,'' VTYPENAME,C.ACNAME PARTICULARS,A.DRAMNT,A.CRAMNT,
	(CASE WHEN B.REMARKS = A.NARATION THEN '' ELSE A.NARATION END) NARATION,A.CHEQUENO,A.CHEQUEDATE,
	ISNULL(A.COSTCENTER,'') COSTCENTER,'' TRNUSER,'' TRNTIME,'' DIVISION,A.VCHRNO VNO,
	CASE WHEN ISNULL(B.VNUM,B.VCHRNO)<>'' THEN ISNULL(B.VNUM,B.VCHRNO) ELSE B.VCHRNO END VNUM,'B' FLG, B.TRNDATE TDATE 
	INTO #TRNTRAN FROM RMD_TRNMAIN B INNER JOIN 
	(
		SELECT VCHRNO,DIVISION,PHISCALID,A_ACID ACID,SUM(DRAMNT) DRAMNT, SUM(CRAMNT) CRAMNT,NARATION,CHEQUENO,CHEQUEDATE,COSTCENTER FROM 
		(
			SELECT DISTINCT * FROM 
			(
				SELECT VCHRNO,DIVISION,A_ACID,DRAMNT,CRAMNT,NARATION,CHEQUENO,CHEQUEDATE,COSTCENTER,PHISCALID FROM RMD_TRNTRAN 
				UNION ALL 
				SELECT VCHRNO,DIVISION,A_ACID,DRAMNT,CRAMNT,NARATION,CHEQUENO,CHEQUEDATE,COSTCENTER,PHISCALID FROM TMPRMD_TRNTRAN
			)A
		)A
		GROUP BY VCHRNO,DIVISION,PHISCALID,A_aCID,NARATION,CHEQUENO,CHEQUEDATE,COSTCENTER
	) A
	ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION LEFT JOIN RMD_ACLIST C ON A.ACID = C.ACID
	WHERE LEFT(B.VCHRNO,2) NOT IN ('OP','AO') AND B.DIVISION LIKE @DIVISION AND B.TRNUSER LIKE @USER
	AND ((@ENTRYDATEWISE =0 AND CONVERT(NUMERIC,RIGHT(ISNULL(B.VNUM,A.VCHRNO),len(ISNULL(B.VNUM,A.VCHRNO))-2)) BETWEEN @FROMVNO AND @TOVNO) OR (@ENTRYDATEWISE =1 AND B.TRNDATE BETWEEN @DATE1 AND @DATE2))
	AND ((@VTYPE = '%' AND B.VoucherType IN ('JV','PV','RV','CN','DN','SI','TI','SR','PI','PR','RE')) OR (@VTYPE <> '%' AND B.VoucherType LIKE @VTYPE)) 
	AND ((@SERIES = '' AND LEFT(A.VCHRNO,2) LIKE '%') OR (@SERIES <> '' AND LEFT(A.VCHRNO,2) LIKE @SERIES))

--RESULT
--------

IF @DETAILREPORT = 0
	SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.CHALANNO REFNO,A.VTYPENAME,B.ACNAME PARTICULARS,
	CONVERT(VARCHAR,CAST(CASE WHEN VTYPE IN ('JV') THEN CASE WHEN NETAMNT>0 THEN NETAMNT ELSE 0 END ELSE CASE WHEN VTYPE IN ('RV','SI','TI','IV','DN') THEN NETAMNT ELSE 0 END END AS MONEY),1) DRAMNT,
	CONVERT(VARCHAR,CAST(CASE WHEN VTYPE IN ('JV') THEN CASE WHEN NETAMNT<0 THEN NETAMNT ELSE 0 END ELSE CASE WHEN VTYPE IN ('PV','SR','CN','RE') THEN NETAMNT ELSE 0 END END  AS MONEY),1) CRAMNT,
	A.REMARKS,NULL CHEQUENO, NULL CHEQUEDATE,NULL COSTCENTER,TRNUSER, TRNTIME,C.NAME DIVISION,A.DIVISION DIVID FROM #TRNMAIN A LEFT JOIN RMD_ACLIST B ON A.ACID = B.ACID 
	LEFT JOIN DIVISION C ON A.DIVISION = C.INITIAL ORDER BY TRNDATE,LEFT(VNUM,2),CONVERT(NUMERIC,RIGHT(VNUM,LEN(VNUM)-2))
ELSE
	SELECT * FROM 
	(
	SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.CHALANNO REFNO,A.VTYPENAME,NULL PARTICULARS,NULL DRAMNT,NULL CRAMNT,A.REMARKS,NULL CHEQUENO,NULL CHEQUEDATE,
	NULL COSTCENTER,A.TRNUSER,A.TRNTIME,A.DIVISION,VNUM,A.TRNDATE TDATE,'A' FLG,A.DIVID	FROM #TRNMAIN A
	UNION ALL
	SELECT A.TRNDATE,A.BSDATE,A.VCHRNO,A.CHALANNO,
	A.VTYPENAME,A.PARTICULARS,CONVERT(VARCHAR,CAST(A.DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(A.CRAMNT AS MONEY),1) DRAMNT,A.NARATION,A.CHEQUENO,A.CHEQUEDATE,A.COSTCENTER,A.TRNUSER,A.TRNTIME,A.DIVISION,VNUM,A.TDATE,A.FLG,'' DIVID FROM  #TRNTRAN A
	UNION ALL
	SELECT NULL,NULL,NULL,NULL,NULL,'TOTAL >>',CONVERT(VARCHAR,CAST(SUM(DRAMNT) AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(SUM(CRAMNT) AS MONEY),1) CRAMNT,NULL,NULL,NULL,NULL,NULL,NULL,NULL,VNUM,TDATE,'C' FLG,'' DIVID FROM #TRNTRAN GROUP BY VNUM,TDATE
	UNION ALL
	SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,VNUM,A.TRNDATE TDATE,'D' FLG,'' DIVID FROM #TRNMAIN A GROUP BY VNUM,A.TRNDATE
	) A ORDER BY LEFT(VNUM,2),CONVERT(NUMERIC,RIGHT(VNUM,LEN(VNUM)-2)),FLG,TDATE

set nocount off