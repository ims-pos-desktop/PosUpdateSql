CREATE OR ALTER  PROC RSP_ANNEX13REPORT
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@FYID VARCHAR(10),
@DIVISION VARCHAR(3) = '%',
@AMOUNT  NUMERIC(18,2) = 0,
@includeAcBaseCnDn BIT = 0

AS

--SET @DATE1 = '17 JUL 2023'; SET @DATE2 = '16 JUL 2024'; SET @FYID = '80/81'


SELECT A.ACID, A.ACNAME, A.VATNO, O.BAL OPENING,
IIF( VOUCHERTYPE IN ('CP') , SUM(GOODS_NET) , 0 ) CAPITAL_GOODS_PURCHASE,
IIF( VOUCHERTYPE IN ('CP') , SUM(SERVICE_NET) , 0 ) CAPITAL_SERVICE_PURCHASE,
IIF( VOUCHERTYPE IN ('PI','DN') , SUM(GOODS_NET * MULTIPLIER) , 0 ) GOODS_PURCHASE,
IIF( VOUCHERTYPE IN ('PI','DN') , SUM(SERVICE_NET * MULTIPLIER) , 0 ) SERVICE_PURCHASE,
IIF( VOUCHERTYPE IN ('SI','TI','CN') , SUM(GOODS_NET * MULTIPLIER) , 0 ) GOODS_SALES,
IIF( VOUCHERTYPE IN ('SI','TI','CN') , SUM(SERVICE_NET * MULTIPLIER) , 0 ) SERVICE_SALES
,C.BAL CLOSING 
FROM
(
	SELECT M.VCHRNO, M.TRNDATE, ISNULL(A.ACNAME, M.BILLTO) ACNAME, ISNULL(A.VATNO, M.BILLTOTEL) VATNO, MI.MENUCODE, MI.DESCA, 
	CASE WHEN M.VOUCHERTYPE IN ('PI','DN') THEN 'PI' 
		 WHEN M.VoucherType IN ('SI', 'TI','CN') THEN 'TI' ELSE M.VoucherType END VoucherType, VMODE, ISNULL(ACID,'') ACID,
	CONVERT(NUMERIC(18,2), IIF( MI.PTYPE < 10 , ISNULL(P.TAXABLE, M.TAXABLE) + ISNULL(P.NONTAXABLE, M.NONTAXABLE) , 0 )) GOODS_NET, 
	CONVERT(NUMERIC(18,2), IIF( MI.PTYPE >= 10 , ISNULL(P.TAXABLE, M.TAXABLE) + ISNULL(P.NONTAXABLE, M.NONTAXABLE) , 0 )) SERVICE_NET, 
	IIF( M.VoucherType IN ('CN','DN') , -1 , 1 ) MULTIPLIER 
	FROM RMD_TRNMAIN M 
	JOIN RMD_TRNPROD P ON M.VCHRNO = P.VCHRNO
	JOIN MENUITEM MI ON MI.MCODE = P.MCODE
	LEFT JOIN RMD_ACLIST A ON M.PARAC = A.ACID
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND M.TRNDATE BETWEEN @DATE1 AND @DATE2 AND M.VOUCHERTYPE IN ('SI','TI', 'PI', 'CN', 'DN', 'CP') 
	AND ISNULL(ISNULL(A.ACNAME, M.BILLTO),'') <> ''

	UNION ALL

	SELECT M.VCHRNO, M.TRNDATE, ISNULL(A.ACNAME, M.BILLTO) ACNAME, ISNULL(A.VATNO, M.BILLTOTEL) VATNO, NULL MENUCODE, NULL DESCA, 
	CASE WHEN A.PType = 'V' THEN 'PI' 
		 WHEN A.PType = 'C' THEN 'TI' ELSE '~' END VoucherType, VMODE, ISNULL(ACID,'') ACID, 
	CONVERT(NUMERIC(18,2), M.TAXABLE + M.NONTAXABLE) GOODS_NET, 
	0 SERVICE_NET,
	CASE WHEN A.PType = 'V' THEN IIF( M.VOUCHERTYPE = 'DN' , -1 , 1 ) 
		 WHEN A.PType = 'C' THEN IIF( M.VOUCHERTYPE = 'CN' , -1 , 1 ) END MULTIPLIER
	FROM RMD_TRNMAIN M
	JOIN RMD_ACLIST A ON M.PARAC = A.ACID
	WHERE @includeAcBaseCnDN = 1 AND M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND M.TRNDATE BETWEEN @DATE1 AND @DATE2 AND M.VOUCHERTYPE IN ('CN' , 'DN') 
	AND ISNULL(ISNULL(A.ACNAME, M.BILLTO),'') <> ''
	AND M.TRNMODE IN ('Customer','Supplier')

) A 
LEFT JOIN
(
	SELECT A_ACID, CONVERT(NUMERIC(18,2), SUM(DRAMNT-CRAMNT)) BAL FROM RMD_TRNMAIN M JOIN RMD_TRNTRAN T ON M.VCHRNO = T.VCHRNO
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND A_ACID LIKE'PA%' AND  (M.TRNDATE < @DATE1 OR M.VoucherType IN ('AO','OB'))
	GROUP BY A_ACID 
) O ON A.ACID = O.A_ACID
LEFT JOIN
(
	SELECT A_ACID, CONVERT(NUMERIC(18,2), SUM(DRAMNT-CRAMNT)) BAL FROM RMD_TRNMAIN M JOIN RMD_TRNTRAN T ON M.VCHRNO = T.VCHRNO
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND A_ACID LIKE'PA%' AND  M.TRNDATE <= @DATE2
	GROUP BY A_ACID 
) C ON A.ACID = C.A_ACID
GROUP BY A.ACID, ACNAME, VATNO, VOUCHERTYPE,VMODE, O.BAL, C.BAL
HAVING SUM(GOODS_NET * MULTIPLIER) >= @AMOUNT OR SUM(SERVICE_NET * MULTIPLIER) >= @AMOUNT
ORDER BY ACNAME