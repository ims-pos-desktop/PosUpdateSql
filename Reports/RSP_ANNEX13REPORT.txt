CREATE OR ALTER  PROC RSP_ANNEX13REPORT
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME,
@FYID VARCHAR(10),
@DIVISION VARCHAR(3) = '%',
@AMOUNT  NUMERIC(18,2) = 0
AS
--select @date1='2023-07-17',@DATE2='2024-01-05' ,@DIVISION='%',@FYID='80/81' 
 
 	 
	  

SELECT A.ACID, A.ACNAME, A.VATNO, O.BAL OPENING,
SUM(IIF(VOUCHERTYPE='CP',GOODS_NET  ,0 ))   CAPITAL_GOODS_PURCHASE,
SUM(IIF(VOUCHERTYPE='CP',SERVICE_NET  ,0 ) )   CAPITAL_SERVICE_PURCHASE,
SUM(IIF(VOUCHERTYPE IN ('PI','DN') ,GOODS_NET * MULTIPLIER,0)) GOODS_PURCHASE,
SUM(IIF( VOUCHERTYPE IN ('PI','DN') ,SERVICE_NET * MULTIPLIER,0)) SERVICE_PURCHASE,
SUM(IIF( VOUCHERTYPE IN ('SI','TI', 'CN')  ,GOODS_NET * MULTIPLIER,0))   GOODS_SALES,
SUM(IIF (VOUCHERTYPE IN ('SI','TI', 'CN') ,  SERVICE_NET * MULTIPLIER ,0)) SERVICE_SALES
,C.BAL CLOSING 
FROM
(
	SELECT M.VCHRNO, M.TRNDATE, ISNULL(A.ACNAME, M.BILLTO) ACNAME, ISNULL(A.VATNO, M.BILLTOTEL) VATNO, MI.MENUCODE, MI.DESCA, 
	CASE WHEN M.VOUCHERTYPE IN ('PI','DN') THEN 'PI' 
		 WHEN M.VoucherType IN ('SI', 'TI','CN') THEN 'TI' ELSE M.VoucherType END VoucherType, VMODE, ISNULL(ACID,'') ACID,
	CONVERT(NUMERIC(18,2), CASE WHEN MI.PTYPE < 10 THEN ISNULL(P.TAXABLE, M.TAXABLE) + ISNULL(P.NONTAXABLE, M.TAXABLE) ELSE 0 END) GOODS_NET, 
	CONVERT(NUMERIC(18,2), CASE WHEN MI.PTYPE >= 10 THEN ISNULL(P.TAXABLE, M.TAXABLE) + ISNULL(P.NONTAXABLE, M.TAXABLE) ELSE 0 END) SERVICE_NET,
	CASE WHEN M.VoucherType IN ('CN','DN') THEN -1 ELSE 1 END MULTIPLIER FROM RMD_TRNMAIN M 
	JOIN RMD_TRNPROD P ON M.VCHRNO = P.VCHRNO
	JOIN MENUITEM MI  WITH (NOLOCK) ON MI.MCODE = P.MCODE 
	LEFT JOIN RMD_ACLIST A WITH (NOLOCK) ON M.PARAC = A.ACID
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND M.TRNDATE BETWEEN @DATE1 AND @DATE2 AND M.VOUCHERTYPE IN ('SI','TI', 'PI', 'CN', 'DN' ) 
	AND ISNULL(ISNULL(A.ACNAME, M.BILLTO),'') <> ''	
	
	UNION   ALL

	 --CAPTIAL PURCHASE
	SELECT M.VCHRNO, M.TRNDATE,  M.BILLTO ACNAME, M.BILLTOTEL VATNO, NULL MENUCODE, NULL DESCA, 'CP' VOUCHERTYPE,VMODE, ra.ACID ACID,
	IIF(VMODE=3 , (M.TAXABLE+M.NONTAXABLE),0) GOODS_NET, IIF(VMODE=4 , (M.TAXABLE+M.NONTAXABLE),0) SERVICE_NET, 1 MULTIPLIER
	FROM PURMAIN M WITH (NOLOCK)
	LEFT JOIN    RMD_ACLIST  ra WITH (NOLOCK) on  RA.VATNO= M.BILLTOTEL AND M.BILLTO=RA.ACNAME
	WHERE  M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND M.TRNDATE BETWEEN @DATE1 AND @DATE2  AND VOUCHERTYPE='CP'
	AND ISNULL(  M.BILLTO ,'') <> ''	
	
	UNION ALL
	
	--NONTRADING
	 SELECT M.VCHRNO, M.TRNDATE, ISNULL(A.ACNAME, M.BILLTO) ACNAME, ISNULL(A.VATNO, M.BILLTOTEL) VATNO, MI.MENUCODE, MI.DESCA,  'CP' VoucherType, VMODE, ISNULL(ACID,'') ACID,
	CONVERT(NUMERIC(18,2), CASE WHEN P.ITEMTYPE = 1 THEN  P.TAXABLE  +  P.NONTAXABLE  ELSE 0 END) GOODS_NET, 
	CONVERT(NUMERIC(18,2), CASE WHEN P.ITEMTYPE = 2 THEN P.TAXABLE +  P.NONTAXABLE  ELSE 0 END) SERVICE_NET,1 MULTIPLIER FROM PURMAIN M 
	JOIN TRNPROD_NONTRADING P ON M.VCHRNO = P.VCHRNO
	JOIN MENUITEM MI  WITH (NOLOCK) ON MI.MCODE = P.MCODE 
	LEFT JOIN RMD_ACLIST A WITH (NOLOCK) ON M.PARAC = A.ACID
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND M.TRNDATE BETWEEN @DATE1 AND @DATE2 AND M.VOUCHERTYPE = ('PI'  ) 
	 
) A 
LEFT JOIN
(
	SELECT A_ACID, CONVERT(NUMERIC(18,2), SUM(DRAMNT-CRAMNT)) BAL FROM RMD_TRNMAIN M JOIN RMD_TRNTRAN T ON M.VCHRNO = T.VCHRNO
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND A_ACID LIKE'PA%' AND  (M.TRNDATE < @DATE1 OR M.VoucherType IN ('AO','OB'))
	GROUP BY A_ACID 
) O ON A.ACID = O.A_ACID
LEFT JOIN
(
	SELECT A_ACID, CONVERT(NUMERIC(18,2), SUM(DRAMNT-CRAMNT)) BAL FROM RMD_TRNMAIN M JOIN RMD_TRNTRAN T ON M.VCHRNO = T.VCHRNO
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND A_ACID LIKE'PA%' AND  M.TRNDATE <= @DATE2
	GROUP BY A_ACID 
) C ON A.ACID = C.A_ACID
GROUP BY A.ACID, ACNAME, VATNO,  O.BAL, C.BAL
HAVING SUM(GOODS_NET * MULTIPLIER) >= @AMOUNT OR SUM(SERVICE_NET * MULTIPLIER) >= @AMOUNT
ORDER BY ACNAME
 