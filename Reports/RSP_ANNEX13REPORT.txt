CREATE OR ALTER PROC RSP_ANNEX13REPORT
@DATE1 DATETIME,
@DATE2 DATETIME,
@FYID VARCHAR(10),
@DIVISION VARCHAR(3) = '%',
@AMOUNT  NUMERIC(18,2) = 0
AS
SELECT A.ACNAME, A.VATNO, O.BAL OPENING,
CASE WHEN VOUCHERTYPE IN ('CP') THEN SUM(GOODS_NET) ELSE 0 END CAPITAL_GOODS_PURCHASE,
CASE WHEN VOUCHERTYPE IN ('CP') THEN SUM(SERVICE_NET) ELSE 0 END CAPITAL_SERVICE_PURCHASE,
CASE WHEN VOUCHERTYPE IN ('PI','DN') THEN SUM(GOODS_NET * MULTIPLIER) ELSE 0 END GOODS_PURCHASE,
CASE WHEN VOUCHERTYPE IN ('PI','DN') THEN SUM(SERVICE_NET * MULTIPLIER) ELSE 0 END SERVICE_PURCHASE,
CASE WHEN VOUCHERTYPE IN ('SI','TI', 'CN') THEN SUM(GOODS_NET * MULTIPLIER) ELSE 0 END GOODS_SALES,
CASE WHEN VOUCHERTYPE IN ('SI','TI', 'CN') THEN SUM(SERVICE_NET * MULTIPLIER) ELSE 0 END SERVICE_SALES
,C.BAL CLOSING
FROM
(
	SELECT M.VCHRNO, M.TRNDATE, ISNULL(A.ACNAME, M.BILLTO) ACNAME, ISNULL(A.VATNO, M.BILLTOTEL) VATNO, MI.MENUCODE, MI.DESCA, M.VOUCHERTYPE, VMODE, ISNULL(ACID,'') ACID,
	CONVERT(NUMERIC(18,2), CASE WHEN MI.PTYPE < 10 THEN ISNULL(P.TAXABLE, M.TAXABLE) + ISNULL(P.NONTAXABLE, M.TAXABLE) ELSE 0 END) GOODS_NET, 
	CONVERT(NUMERIC(18,2), CASE WHEN MI.PTYPE >= 10 THEN ISNULL(P.TAXABLE, M.TAXABLE) + ISNULL(P.NONTAXABLE, M.TAXABLE) ELSE 0 END) SERVICE_NET,
	CASE WHEN M.VoucherType IN ('CN','DN') THEN -1 ELSE 1 END MULTIPLIER FROM RMD_TRNMAIN M 
	LEFT JOIN RMD_TRNPROD P ON M.VCHRNO = P.VCHRNO
	JOIN MENUITEM MI ON MI.MCODE = P.MCODE 
	LEFT JOIN RMD_ACLIST A ON M.PARAC = A.ACID
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND M.TRNDATE BETWEEN @DATE1 AND @DATE2 AND M.VOUCHERTYPE IN ('SI','TI', 'PI', 'CN', 'DN', 'CP') 
	AND ISNULL(ISNULL(A.ACNAME, M.BILLTO),'') <> ''
) A 
LEFT JOIN
(
	SELECT A_ACID, CONVERT(NUMERIC(18,2), SUM(DRAMNT-CRAMNT)) BAL FROM RMD_TRNMAIN M JOIN RMD_TRNTRAN T ON M.VCHRNO = T.VCHRNO
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND A_ACID LIKE'PA%' AND  (M.TRNDATE < @DATE1 OR M.VoucherType IN ('AO','OB'))
	GROUP BY A_ACID 
) O ON A.ACID = O.A_ACID
LEFT JOIN
(
	SELECT A_ACID, CONVERT(NUMERIC(18,2), SUM(DRAMNT-CRAMNT)) BAL FROM RMD_TRNMAIN M JOIN RMD_TRNTRAN T ON M.VCHRNO = T.VCHRNO
	WHERE M.PhiscalID = @FYID AND M.DIVISION LIKE @DIVISION AND A_ACID LIKE'PA%' AND  M.TRNDATE <= @DATE2
	GROUP BY A_ACID 
) C ON A.ACID = C.A_ACID
GROUP BY ACNAME, VATNO, VOUCHERTYPE,VMODE, O.BAL, C.BAL
HAVING SUM(GOODS_NET * MULTIPLIER) >= @AMOUNT
