CREATE OR ALTER  PROC [dbo].[RSP_ORDERVSSALES]
@DATE1 DATETIME,
@DATE2 DATETIME,
@OPT_SHOWSUMMARY_REPORT TINYINT = 0,   --Summary:1,Detail:0
@DIVISION VARCHAR(3) = '%',
@CUSTOMER_ACID VARCHAR(25) = '%'
AS
IF @OPT_SHOWSUMMARY_REPORT = 0
BEGIN
	SELECT OM.CHALANNO, OM.REFNO, MI.DESCA, OP.QUANTITY PO_QTY, OP.RATE, OP.AMOUNT, TM.INV_QTY, TM.INV_AMOUNT, OP.QUANTITY - ISNULL(TM.INV_QTY, 0) REM_QTY, OP.AMOUNT  - ISNULL(TM.INV_AMOUNT, 0) REM_AMOUNT FROM RMD_ORDERMAIN OM JOIN RMD_ORDERPROD OP ON OM.VCHRNO = OP.VCHRNO
	JOIN MENUITEM MI ON OP.MCODE = MI.MCODE
	LEFT JOIN 
	( 
		SELECT TM.VCHRNO, TM.REFORDBILL, TP.MCODE, SUM(TP.QUANTITY) INV_QTY, SUM(TP.AMOUNT) INV_AMOUNT FROM  RMD_TRNMAIN TM
		JOIN RMD_TRNPROD TP ON TM.VCHRNO = TP.VCHRNO 
		GROUP BY TM.VCHRNO, TM.REFORDBILL, TP.MCODE
	) TM ON TM.REFORDBILL = OM.VCHRNO AND TM.MCODE = OP.MCODE
	WHERE OM.TRNDATE BETWEEN @DATE1 AND @DATE2 AND OM.DIVISION LIKE @DIVISION AND OM.TRNAC LIKE @CUSTOMER_ACID
END

ELSE

BEGIN
	SELECT OM.CHALANNO, OM.REFNO, sum(OP.QUANTITY) PO_QTY, sum(OP.AMOUNT) AMOUNT, sum(TM.INV_QTY) INV_QTY, sum(TM.INV_AMOUNT) INV_AMOUNT, sum(OP.QUANTITY - ISNULL(TM.INV_QTY, 0)) REM_QTY, sum(OP.AMOUNT  - ISNULL(TM.INV_AMOUNT, 0)) REM_AMOUNT 
	FROM RMD_ORDERMAIN OM 
	JOIN RMD_ORDERPROD OP 
	ON OM.VCHRNO = OP.VCHRNO
	JOIN MENUITEM MI ON OP.MCODE = MI.MCODE
	LEFT JOIN 
	( 
		SELECT TM.VCHRNO, TM.REFORDBILL, TP.MCODE, SUM(TP.QUANTITY) INV_QTY, SUM(TP.AMOUNT) INV_AMOUNT FROM  RMD_TRNMAIN TM
		JOIN RMD_TRNPROD TP ON TM.VCHRNO = TP.VCHRNO 
		GROUP BY TM.VCHRNO, TM.REFORDBILL, TP.MCODE
	) TM ON TM.REFORDBILL = OM.VCHRNO AND TM.MCODE = OP.MCODE
	WHERE  OM.TRNDATE BETWEEN @DATE1 AND @DATE2 AND OM.DIVISION LIKE @DIVISION AND OM.TRNAC LIKE @CUSTOMER_ACID group by OM.CHALANNO, OM.REFNO
END