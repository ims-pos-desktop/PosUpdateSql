CREATE OR ALTER PROCEDURE [dbo].[NSP_PROFITIBILITYSALESANALYSIS]
--DECLARE
	@MGROUP VARCHAR(25) = '%',
	@DIV VARCHAR(3) = '%',
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@SCHEME VARCHAR(15),
	@PARTY VARCHAR(25),
	@EXVAT TINYINT = 0,
	@Flg tinyint =4			--Flg=0 Mgroup wise,flg=1 item wise,Flg=2 Datewise,FLG=3 CUSTOMERWISE(TRNAC WISE),FLG=4 MCATWISE
	
--SET @EXVAT = 1;SET @PARTY = '%';SET @MGROUP = '%';SET  @SCHEME='%';SET @DIV='%';SET @date1= '02/08/15';SET @date2='04/08/15'


AS
SET NOCOUNT ON

DECLARE @DATEFORMAT INT
select @DATEFORMAT=dateformat from SETTING 
declare @days int ,@MonthDays int
select @Monthdays=datediff(day, dateadd(day, 1-day(@date2), @date2),
              dateadd(month, 1, dateadd(day, 1-day(@date2), @date2)))
select @days=day(@date2)

DECLARE @RMD_TRNPROD_REPORT TABLE 
	(
	VCHRNO VARCHAR(20),CHALANNO VARCHAR(20), DIVISION VARCHAR(5),UNIT VARCHAR(20),QUANTITY NUMERIC(18,2),REALQTY_IN NUMERIC(18,2),REALQTY NUMERIC(18,2),RATE NUMERIC(18,2),REALRATE NUMERIC(18,2),OPQTY NUMERIC(18,2),WAREHOUSE VARCHAR(50),PRATE NUMERIC(18,2),
	AMOUNT NUMERIC(18,2),DISCOUNT NUMERIC(18,2),VAT NUMERIC(18,2),AMOUNT_INVAT NUMERIC(18,2),AMOUNT_EXVAT NUMERIC(18,2),NETAMOUNT NUMERIC(18,2),
	TAXABLE NUMERIC(18,8),NONTAXABLE NUMERIC(18,8),VRATE NUMERIC(18,8),ITEMNAME VARCHAR(200),MENUCODE varchar(200),MCODE VARCHAR(200),CRATE NUMERIC(18,2),PRATE_A NUMERIC(18,2)
	)

---INSERTING INTO TEMPORARY TABLE
-----------------------------------
INSERT INTO @RMD_TRNPROD_REPORT
	SELECT A.VCHRNO,A.CHALANNO, A.DIVISION,A.UNIT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN QUANTITY *-1 ELSE QUANTITY END AS QUANTITY,
	REALQTY_IN,REALQTY,RATE,REALRATE,OPQTY,WAREHOUSE,PRATE * CASE WHEN C.VAT = 1 AND @EXVAT = 0 THEN 1.13 ELSE 1 END PRATE,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN  AMOUNT *-1 ELSE AMOUNT END  AS AMOUNT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('CN','SR','RE') THEN DISCOUNT *-1 ELSE DISCOUNT END AS DISCOUNT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('CN','SR','RE') THEN A.VAT *-1 ELSE A.VAT END AS VAT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('CN','SR','RE') THEN (AMOUNT + A.VAT) *-1 ELSE (AMOUNT + A.VAT) END AMOUNT_IN,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN AMOUNT *-1 ELSE AMOUNT END AMOUNT_EXVAT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN A.TAXABLE + A.NONTAXABLE + A.VAT * -1 ELSE A.TAXABLE + A.NONTAXABLE + A.VAT END NETAMOUNT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN A.TAXABLE *-1 ELSE A.TAXABLE END AS TAXABLE,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN A.NONTAXABLE *-1 ELSE A.NONTAXABLE END AS NONTAXABLE,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN VRATE *-1 ELSE VRATE END AS VRATE,
	CASE @FLG WHEN 0 THEN X.DESCA WHEN 1 THEN C.DESCA WHEN 2 THEN CONVERT(VARCHAR,B.TRNDATE,@DATEFORMAT) WHEN 3 THEN E.ACNAME WHEN 4 THEN C.MCAT   END AS ITEMNAME,
	CASE @FLG WHEN 0 THEN X.MENUCODE WHEN 1 THEN C.MENUCODE WHEN 2 THEN B.BSDATE WHEN 3 THEN E.ACCODE WHEN 4 THEN C.MCAT  END AS MENUCODE,
	CASE @FLG WHEN 0 THEN C.MGROUP WHEN 1 THEN C.MCODE WHEN 2 THEN CONVERT(VARCHAR,B.TRNDATE,@DATEFORMAT) WHEN 3  THEN C.SUPCODE WHEN 4 THEN C.MCAT END AS MCODE,
	C.CRATE * CASE WHEN C.VAT = 1 AND @EXVAT = 0 THEN 1.13 ELSE 1 END CRATE,C.PRATE_A * CASE WHEN C.VAT = 1 AND @EXVAT = 0 THEN 1.13 ELSE 1 END PRATE_A
	FROM RMD_TRNPROD A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO=B.VCHRNO AND A.DIVISION=B.DIVISION and isnull(A.PhiscalID,'')=isnull(B.PhiscalID ,'')
	INNER JOIN MENUITEM C ON A.MCODE = C.MCODE LEFT JOIN MENUITEM X ON C.MGROUP = X.MCODE
	LEFT OUTER JOIN RMD_ACLIST E ON C.SUPCODE=E.ACID 
	WHERE  B.TRNDATE BETWEEN @date1 AND @date2
	AND ISNULL(C.SUPCODE ,'') LIKE @PARTY AND A.DIVISION LIKE @div AND C.MGROUP LIKE @MGROUP
	And ((@SCHEME <> '%' and ISNULL(B.MEMBERNO, '') in (SELECT MEMID FROM MEMBERSHIP WHERE SCHEMEID = @SCHEME)) OR (@SCHEME='%' AND ISNULL(B.MEMBERNO, '') LIKE '%') ) 
	and LEFT(A.VCHRNO,2) IN ('SI','SR','TI','CN','RE') 


--REPORT OUT
------------
Declare @Qty numeric(18,2),@sales numeric(18,2),@SalesReturn numeric(18,2),@Discount numeric(18,2),@NetSales numeric(18,2),@cost numeric(18,2),@Profit numeric(18,2),@ProfitOnCost numeric(18,2),@ProfitOnSales numeric(18,2)

SELECT @QTY=SUM(ISNULL(REALQTY,0))-SUM(ISNULL(REALQTY_IN,0)),
@SALES=	SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SI','TI','RE') THEN (CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) ,
@SalesRetuRn=SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN') THEN ABS(CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) ,
@Discount=SUM(DISCOUNT),	
@Cost=SUM((CASE WHEN ISNULL(PRATE,0) = 0 THEN CASE WHEN ISNULL(CRATE,0) = 0 THEN ISNULL(PRATE_A,0) ELSE ISNULL(CRATE,0) END ELSE PRATE END) * (ISNULL(REALQTY,0) - ISNULL(REALQTY_IN,0))) 
FROM @RMD_TRNPROD_REPORT A 
PRINT @QTY
SELECT MENUCODE AS MENUCODE,ITEMNAME,L.QTY,(L.QTY/@QTY)*100 AS [QTY CONTRIBUTION],L.SALES,L.S_RETURN,L.DISCOUNT,L.SALES-L.S_RETURN -L.DISCOUNT AS NET,((L.SALES-L.S_RETURN -L.DISCOUNT)/(@sales-@SalesReturn-@Discount))* 100 [SALES CONTRIBUTION], L.COST AS COST,(L.SALES-L.S_RETURN -L.DISCOUNT)-(COST) AS PROFIT,
CASE WHEN(L.COST)=0 THEN 0 ELSE((L.SALES-L.S_RETURN -L.DISCOUNT)-(L.COST))/(L.COST)*100 END AS MARGINONCOST,
CASE WHEN((L.SALES-L.S_RETURN -L.DISCOUNT) =0) THEN 0 ELSE (((L.SALES-L.S_RETURN-L.DISCOUNT)-(COST))/(L.SALES-L.S_RETURN -L.DISCOUNT))*100 END AS MARGINONSALES,
[ForeCast Qty]=(L.qty/@days) * @Monthdays,[Forecast Sales]= ((L.SALES-L.S_RETURN -L.DISCOUNT)/@days)*@MonthDays ,[Forecast Profit]=(((L.SALES-L.S_RETURN -L.DISCOUNT)-(COST))/@days)*@MonthDays,
'A' ORD FROM
(	
	SELECT MENUCODE,ITEMNAME, MCODE,SUM(ISNULL(REALQTY,0))-SUM(ISNULL(REALQTY_IN,0)) AS QTY,NULL AS UNIT,
	SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SI','TI','RE') THEN (CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) AS SALES,
	SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN') THEN ABS(CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) AS S_RETURN,
	SUM(DISCOUNT) AS DISCOUNT,	
	SUM((CASE WHEN ISNULL(PRATE,0) = 0 THEN CASE WHEN ISNULL(CRATE,0) = 0 THEN ISNULL(PRATE_A,0) ELSE ISNULL(CRATE,0) END ELSE PRATE END) * (ISNULL(REALQTY,0) - ISNULL(REALQTY_IN,0))) AS COST
	FROM @RMD_TRNPROD_REPORT A GROUP BY MCODE,MENUCODE,ITEMNAME 
) AS L	
UNION ALL
SELECT NULL MENUCODE,NULL DESCA,NULL ,NULL ,NULL,NULL,NULL,NULL AS NET,NULL,NULL,NULL AS PROFIT,NULL,NULL,null,null,null,'B' ORD
UNION ALL
SELECT NULL MENUCODE,'TOTAL' DESCA,@QTY,100,@SALES,@SALESRETURN,@DISCOUNT,@SALES-@SALESRETURN-@DISCOUNT AS NET,100,@COST,@SALES-@SALESRETURN-@DISCOUNT-@COST AS PROFIT,
(@SALES-@SALESRETURN-@DISCOUNT-@COST)/@COST*100,(@SALES-@SALESRETURN-@DISCOUNT-@COST)/(@SALES-@SALESRETURN-@DISCOUNT)*100,(@Qty/@days)*@MonthDays,((@SALES-@SALESRETURN-@DISCOUNT)/@days)*@MonthDays,((@SALES-@SALESRETURN-@DISCOUNT-@COST)/@Days)*@MonthDays,'C' ORD 
ORDER BY ORD,L.ITEMNAME 


SET NOCOUNT OFF			


