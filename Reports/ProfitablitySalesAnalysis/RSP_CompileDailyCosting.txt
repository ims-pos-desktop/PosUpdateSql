CREATE OR ALTER PROCEDURE RSP_CompileDailyCosting
--DECLARE 
@FYID VARCHAR(10)
AS
DECLARE @DATE DATE, @TODAY DATE, @FBDATE DATE, @FEDATE DATE

--SET @TODAY = CURRENT DATE OR FISCAL YEAR END DATE IF CURDATE IS LATER THAN FISCAL YEAR SELLECTED
SELECT @FBDATE =  Begindate, @FEDATE = EndDate, @TODAY = IIF(CONVERT(DATE,GETDATE()) > EndDate, EndDate, GETDATE()) FROM PhiscalYear WHERE PhiscalID = @FYID

--SET @DATE = A DAY LATER THAN LAST COMPILED DATE
SELECT @DATE = DATEADD(D,1, MAX(TRNDATE)) FROM COSTING_DAYWISE WHERE TRNDATE BETWEEN @FBDATE AND @FEDATE

--IF COST IS NEVER COMPILED SET @DATE = TRANSACTION BEGIN DATE
IF @DATE IS NULL
SELECT @DATE = MIN(TRNDATE) FROM RMD_TRNMAIN WHERE PhiscalID = @FYID

--ITERATE THROUGH ALL DATES TO POPULATE COSING_DAYWISE
WHILE @DATE <= @TODAY
BEGIN
	EXEC NSP_STOCKVALUATIONREPORT @DATE,'%',@FYID,101,'%',1,'F'
	SET @DATE =DATEADD(D,1,@DATE)
END
