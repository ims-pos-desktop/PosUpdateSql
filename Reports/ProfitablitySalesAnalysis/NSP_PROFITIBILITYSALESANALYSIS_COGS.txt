 CREATE OR ALTER   PROCEDURE [dbo].[NSP_PROFITIBILITYSALESANALYSIS_COGS]
--DECLARE
	@MGROUP VARCHAR(25) = '%',
	@DIV VARCHAR(3) = '%',
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@SCHEME VARCHAR(15) = '%',
	@PARTY VARCHAR(25) = '%',
	@EXVAT TINYINT = 0,
	@Flg tinyint =1,		--Flg=0 Mgroup wise,flg=1 item wise,Flg=2 Datewise,FLG=3 CUSTOMERWISE(TRNAC WISE),FLG=4 MCATWISE
	@SALESTERMINAL VARCHAR(3) = '%',
	@TRNMODE VARCHAR(50) = '%'

AS
SET NOCOUNT ON
 
--SELECT @DATE2 = '21 JUL 2022',  @DATE1 = '21 SEP 2023', @SCHEME = 'SchemeA'

DECLARE @DATEFORMAT INT
select @DATEFORMAT=dateformat from SETTING 
DECLARE @days int ,@MonthDays int
select @Monthdays=datediff(day, dateadd(day, 1-day(@date2), @date2),
				dateadd(month, 1, dateadd(day, 1-day(@date2), @date2)))
select @days=day(@date2)

DECLARE @RMD_TRNPROD_REPORT TABLE 
(
	VCHRNO VARCHAR(20),CHALANNO VARCHAR(20), DIVISION VARCHAR(5),UNIT VARCHAR(20),QUANTITY NUMERIC(18,2),REALQTY_IN NUMERIC(18,2),REALQTY NUMERIC(18,2),RATE NUMERIC(18,2),REALRATE NUMERIC(18,2),OPQTY NUMERIC(18,2),WAREHOUSE VARCHAR(50),PRATE NUMERIC(18,2),
	AMOUNT NUMERIC(18,2),DISCOUNT NUMERIC(18,2),VAT NUMERIC(18,2),AMOUNT_INVAT NUMERIC(18,2),AMOUNT_EXVAT NUMERIC(18,2),NETAMOUNT NUMERIC(18,2),
	TAXABLE NUMERIC(18,8),NONTAXABLE NUMERIC(18,8),VRATE NUMERIC(18,8),ITEMNAME VARCHAR(200),MENUCODE varchar(200),MCODE VARCHAR(200),CRATE NUMERIC(18,2),PRATE_A NUMERIC(18,2)
)
			
IF OBJECT_ID('tempdb..#MAIN') IS NOT NULL DROP TABLE #MAIN
SELECT M.VCHRNO, M.BSDATE, M.TRNDATE, M.DIVISION, M.PhiscalID, M.MEMBERNO, C.CUSTID, C.CUSTNAME, C.PANNO INTO #MAIN FROM SALES_TRNMAIN M WITH (NOLOCK) 
LEFT JOIN  CustomerProfile C WITH (NOLOCK) ON M.RECEIVEBY = C.CUSTID
LEFT JOIN 
(
	SELECT MEMID, SCHEMEID FROM MEMBERSHIP WITH (NOLOCK) WHERE SCHEMEID = @SCHEME
) L ON M.MEMBERNO = L.MEMID
WHERE TRNDATE BETWEEN @date1 AND @date2 AND DIVISION LIKE @DIV AND TERMINAL LIKE @SALESTERMINAL AND ISNULL(L.SCHEMEID,'%') LIKE @SCHEME AND M.TRNMODE LIKE @TRNMODE
 
IF OBJECT_ID('tempdb..#MENUITEM') IS NOT NULL DROP TABLE #MENUITEM
select C.VAT, C.DESCA, C.MENUCODE, C.MGROUP, C.MCODE, C.CRATE, C.MCAT, C.PRATE_A, C.SUPCODE, E.ACID, E.ACNAME, E.ACCODE, MG.DESCA MGROUPNAME, MG.MENUCODE MGROUPCODE INTO #MENUITEM FROM MENUITEM C WITH (NOLOCK)
LEFT JOIN MENUITEM MG ON C.MGROUP = MG.MCODE
LEFT OUTER JOIN RMD_ACLIST E WITH (NOLOCK) ON C.SUPCODE=E.ACID 
WHERE C.MGROUP LIKE @MGROUP AND ISNULL(C.SUPCODE ,'') LIKE @PARTY 

	 

---INSERTING INTO TEMPORARY TABLE
-----------------------------------
INSERT INTO @RMD_TRNPROD_REPORT
	SELECT A.VCHRNO,A.CHALANNO, A.DIVISION,A.UNIT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN A.QUANTITY *-1 ELSE A.QUANTITY END AS QUANTITY,
		REALQTY_IN,REALQTY,RATE,REALRATE,OPQTY,WAREHOUSE,PRATE * CASE WHEN C.VAT = 1 AND @EXVAT = 0 THEN 1.13 ELSE 1 END PRATE,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN  AMOUNT *-1 ELSE AMOUNT END  AS AMOUNT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('CN','SR','RE') THEN DISCOUNT *-1 ELSE DISCOUNT END AS DISCOUNT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('CN','SR','RE') THEN A.VAT *-1 ELSE A.VAT END AS VAT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('CN','SR','RE') THEN (AMOUNT + A.VAT) *-1 ELSE (AMOUNT + A.VAT) END AMOUNT_IN,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN AMOUNT *-1 ELSE AMOUNT END AMOUNT_EXVAT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN A.TAXABLE + A.NONTAXABLE + A.VAT * -1 ELSE A.TAXABLE + A.NONTAXABLE + A.VAT
		END NETAMOUNT,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN A.TAXABLE *-1 ELSE A.TAXABLE END AS TAXABLE,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN A.NONTAXABLE *-1 ELSE A.NONTAXABLE END AS NONTAXABLE,
	CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN','RE') THEN VRATE *-1 ELSE VRATE END AS VRATE,
	CASE @FLG WHEN 0 THEN C.MGROUPNAME 
		WHEN 1 THEN C.DESCA 
		WHEN 2 THEN CONVERT(VARCHAR,B.TRNDATE,@DATEFORMAT) 
		WHEN 3 THEN B.CUSTNAME 
		WHEN 4 THEN C.MCAT   END AS ITEMNAME,
	CASE @FLG WHEN 0 THEN C.MGROUPCODE 
		WHEN 1 THEN C.MENUCODE 
		WHEN 2 THEN B.BSDATE 
		WHEN 3 THEN B.PANNO 
		WHEN 4 THEN C.MCAT  END AS MENUCODE,
	CASE @FLG WHEN 0 THEN C.MGROUP 
		WHEN 1 THEN C.MCODE 
		WHEN 2 THEN CONVERT(VARCHAR,B.TRNDATE,@DATEFORMAT) 
		WHEN 3  THEN B.CUSTID
		WHEN 4 THEN C.MCAT END AS MCODE,
		isnull(VW.crate,C.CRATE)* CASE WHEN C.VAT = 1 AND @EXVAT = 0 THEN 1.13 ELSE 1 END  AS CRATE
		,C.PRATE_A * CASE WHEN C.VAT = 1 AND @EXVAT = 0 THEN 1.13 ELSE 1 END PRATE_A
	FROM SALES_TRNPROD A WITH (NOLOCK) INNER JOIN #MAIN B WITH (NOLOCK) ON A.VCHRNO=B.VCHRNO 
		INNER JOIN #MENUITEM C WITH (NOLOCK) ON A.MCODE = C.MCODE 
		 LEFT join vwTrnProd_COGS_Summary VW WITH (NOLOCK) ON  VW.VCHRNO=A.VCHRNO AND VW.SNO=A.SNO AND VW.MCODE=A.MCODE	
	 
--REPORT OUT
------------
	Declare @Qty numeric(18,2),@sales numeric(18,2),@SalesReturn numeric(18,2),@Discount numeric(18,2),@NetSales numeric(18,2),@cost numeric(18,2)
	,@Profit numeric(18,2),@ProfitOnCost numeric(18,2),@ProfitOnSales numeric(18,2)

	SELECT @QTY=SUM(ISNULL(REALQTY,0))-SUM(ISNULL(REALQTY_IN,0)),
	@SALES=	SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SI','TI','RE') THEN (CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) ,
	@SalesRetuRn=SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN') THEN ABS(CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) ,
	@Discount=SUM(DISCOUNT),	
	@Cost=  SUM((CASE WHEN ISNULL(CRATE,0) = 0 THEN CASE WHEN ISNULL(PRATE,0) = 0 THEN ISNULL(PRATE_A,0) ELSE ISNULL(PRATE,0) END ELSE CRATE END) * (ISNULL(REALQTY,0) - ISNULL(REALQTY_IN,0)))   
	FROM @RMD_TRNPROD_REPORT A 
	
	SELECT MENUCODE AS MENUCODE,ITEMNAME,L.QTY,(L.QTY/@QTY)*100 AS [QTY CONTRIBUTION],L.SALES,L.S_RETURN,L.DISCOUNT,L.SALES-L.S_RETURN -L.DISCOUNT AS NET,((L.SALES-L.S_RETURN -L.DISCOUNT)/(@sales-@SalesReturn-@Discount))* 100 [SALES CONTRIBUTION], L.COST AS COST,(L.SALES-L.S_RETURN -L.DISCOUNT)-(COST) AS PROFIT,
	CASE WHEN(L.COST)=0 THEN 0 ELSE((L.SALES-L.S_RETURN -L.DISCOUNT)-(L.COST))/(L.COST)*100 END AS MARGINONCOST,
	CASE WHEN((L.SALES-L.S_RETURN -L.DISCOUNT) =0) THEN 0 ELSE (((L.SALES-L.S_RETURN-L.DISCOUNT)-(COST))/(L.SALES-L.S_RETURN -L.DISCOUNT))*100 END AS MARGINONSALES,
	[ForeCast Qty]=(L.qty/@days) * @Monthdays,[Forecast Sales]= ((L.SALES-L.S_RETURN -L.DISCOUNT)/@days)*@MonthDays ,[Forecast Profit]=(((L.SALES-L.S_RETURN -L.DISCOUNT)-(COST))/@days)*@MonthDays,
	'A' ORD, MCODE FROM
	(	
		SELECT MENUCODE,ITEMNAME, MCODE,SUM(ISNULL(REALQTY,0))-SUM(ISNULL(REALQTY_IN,0)) AS QTY,NULL AS UNIT,
		SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SI','TI','RE') THEN (CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) AS SALES,
		SUM(CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN') THEN ABS(CASE @EXVAT WHEN 0 THEN AMOUNT_INVAT ELSE AMOUNT_EXVAT END) ELSE 0 END) AS S_RETURN,
		SUM(DISCOUNT) AS DISCOUNT, SUM( (CASE WHEN ISNULL(CRATE,0) = 0 THEN CASE WHEN ISNULL(PRATE,0) = 0 THEN ISNULL(PRATE_A,0) ELSE ISNULL(PRATE,0) END ELSE ISNULL(CRATE,0) END) * (ISNULL(REALQTY,0) - ISNULL(REALQTY_IN,0)))  AS COST
		FROM @RMD_TRNPROD_REPORT A GROUP BY MCODE,MENUCODE,ITEMNAME 
	) AS L	
	UNION ALL
	SELECT NULL MENUCODE,NULL DESCA,NULL ,NULL ,NULL,NULL,NULL,NULL AS NET,NULL,NULL,NULL AS PROFIT,NULL,NULL,null,null,null,'B' ORD, NULL
	UNION ALL
	SELECT NULL MENUCODE,'TOTAL' DESCA,@QTY,100,@SALES,@SALESRETURN,@DISCOUNT,@SALES-@SALESRETURN-@DISCOUNT AS NET,100,@COST,@SALES-@SALESRETURN-@DISCOUNT-@COST AS PROFIT,
	(@SALES-@SALESRETURN-@DISCOUNT-@COST)/@COST*100,(@SALES-@SALESRETURN-@DISCOUNT-@COST)/(@SALES-@SALESRETURN-@DISCOUNT)*100,(@Qty/@days)*@MonthDays,((@SALES-@SALESRETURN-@DISCOUNT)/@days)*@MonthDays,((@SALES-@SALESRETURN-@DISCOUNT-@COST)/@Days)*@MonthDays,'C' ORD, NULL 
	ORDER BY ORD,L.ITEMNAME 

	IF OBJECT_ID('tempdb..#MAIN') IS NOT NULL
		DROP TABLE #MAIN
	IF OBJECT_ID('tempdb..#MENUITEMSUPCODE') IS NOT NULL
		DROP TABLE #MENUITEMSUPCODE

	SET NOCOUNT OFF