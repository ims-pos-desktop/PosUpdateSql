CREATE OR ALTER PROCEDURE [dbo].[sp_UserWLogDetail] 
@Flg as int =1,
@SDate as smalldatetime,
@EDate as smalldatetime,
@UserID as varchar(100)='%',
@HostNM as varchar(200)='%',
@FormNM as varchar(250)='%',
@ActionNM as varchar(100)='%'
AS
IF @Flg=1 
BEGIN
SELECT WL.UserId,  FormName, HostName, TrnDate,TrnTime,TrnMode,WorkDetail,VchrNo,Remarks FROM TBLUSERWORKINGLOG WL --INNER JOIN TBLUSERLOGINLOG UL ON WL.USERSESSID=UL.USERSESSID
	WHERE FORMNAME LIKE @FormNM AND WL.USERID LIKE @UserId AND  TrnMode LIKE @ActionNM AND ISNULL(HOSTNAME, '') LIKE @HostNM AND TRNDATE BETWEEN @SDate And @EDate --AND USERSESSID=USERSESSID
	ORDER BY TRNDATE,CAST(TRNTIME AS SMALLDATETIME),WL.USERID,FORMNAME
END	
	
ELSE IF @Flg=2
BEGIN
SELECT WL.UserId, FormName,
		SUM(CASE WHEN TRNMODE='New' THEN 1 ELSE 0 END) AS TOT_NEW, 
		SUM(CASE WHEN TRNMODE='Edit' THEN 1 ELSE 0 END) AS TOT_EDIT,
		SUM(CASE WHEN TRNMODE='Delete' THEN 1 ELSE 0 END) AS TOT_DELETE, 
		SUM(CASE WHEN TRNMODE='Re-Print' THEN 1 ELSE 0 END) AS TOT_REPRINT, 
		SUM(CASE WHEN TRNMODE='View' THEN 1 ELSE 0 END) AS TOT_VIEW, 
		SUM(CASE WHEN TRNMODE='Import' OR TRNMODE='Export' THEN 1 ELSE 0 END) AS TOT_IMP_EXP,
		SUM(CASE WHEN TRNMODE='Backup' OR TRNMODE='Restore' THEN 1 ELSE 0 END) AS TOT_BKP_RES  
	FROM TBLUSERWORKINGLOG WL -- INNER JOIN TBLUSERLOGINLOG UL ON WL.USERSESSID=UL.USERSESSID
	WHERE FORMNAME LIKE @FormNM AND WL.USERID LIKE @UserId AND TrnMode LIKE @ActionNM AND ISNULL(HOSTNAME, '') LIKE @HostNM AND TRNDATE BETWEEN @SDate And @EDate --AND USERSESSID=USERSESSID
	GROUP BY WL.UserId, FormName
	ORDER BY WL.USERID,FORMNAME	
END

ELSE IF @Flg=3
BEGIN
SELECT WL.UserId, 
		SUM(CASE WHEN TRNMODE='New' THEN 1 ELSE 0 END) AS TOT_NEW, 
		SUM(CASE WHEN TRNMODE='Edit' THEN 1 ELSE 0 END) AS TOT_EDIT,
		SUM(CASE WHEN TRNMODE='Delete' THEN 1 ELSE 0 END) AS TOT_DELETE, 
		SUM(CASE WHEN TRNMODE='Re-Print' THEN 1 ELSE 0 END) AS TOT_REPRINT, 
		SUM(CASE WHEN TRNMODE='View' THEN 1 ELSE 0 END) AS TOT_VIEW, 
		SUM(CASE WHEN TRNMODE='Import' OR TRNMODE='Export' THEN 1 ELSE 0 END) AS TOT_IMP_EXP,
		SUM(CASE WHEN TRNMODE='Backup' OR TRNMODE='Restore' THEN 1 ELSE 0 END) AS TOT_BKP_RES 
	FROM TBLUSERWORKINGLOG WL -- INNER JOIN TBLUSERLOGINLOG UL ON WL.USERSESSID=UL.USERSESSID
	WHERE FORMNAME LIKE @FormNM AND WL.USERID LIKE @UserId AND TrnMode LIKE @ActionNM AND ISNULL(HOSTNAME, '') LIKE @HostNM AND TRNDATE BETWEEN @SDate And @EDate --AND USERSESSID=USERSESSID
	GROUP BY WL.UserId
	ORDER BY WL.USERID	
END