CREATE OR ALTER PROC RSP_DUEVOUCHERREPORT
@DATE1 DATETIME,
@CHK_ShowPaidVchr TINYINT = 0,    --CHK_ShowPaidVchr:1:0
@PLEDGER_ACID VARCHAR(10) = '%',
@OPT_WISE TINYINT = 1,               --Vendor:1,Customer:0
@AREA_ID INT = 0,
@CATEGORY_ID INT = 0
AS
SELECT A.ACID, CASE WHEN @OPT_WISE = 1 THEN SUM(T.DRAMNT) ELSE SUM(T.CRAMNT) END Paid INTO #PaidBalance FROM RMD_TRNTRAN T 
JOIN RMD_TRNMAIN M ON T.VCHRNO = M.VCHRNO
JOIN RMD_ACLIST A ON T.A_ACID = A.ACID WHERE A.ACID LIKE 'PA%' AND A.PType = CASE WHEN @OPT_WISE  = 1 THEN 'V' ELSE 'C' END AND M.TRNDATE < @DATE1 AND A.ACID LIKE @PLEDGER_ACID
GROUP BY  A.ACID

SELECT * INTO #BILLS FROM
(
	SELECT ROW_NUMBER() OVER (ORDER BY A.ACID, TRNDATE) SNO, A.ACID, M.VCHRNO, M.TRNDATE, M.BSDATE, CASE WHEN @OPT_WISE = 1 THEN SUM(T.CRAMNT) ELSE SUM(T.DRAMNT) END BILL_AMNT, M.VoucherStatus FROM RMD_TRNTRAN T 
	JOIN RMD_TRNMAIN M ON T.VCHRNO = M.VCHRNO
	JOIN RMD_ACLIST A ON T.A_ACID = A.ACID 
	WHERE A.ACID LIKE 'PA%' AND A.PType = CASE WHEN @OPT_WISE  = 1 THEN 'V' ELSE 'C' END AND 
	CASE WHEN @OPT_WISE  = 1 THEN CRAMNT ELSE DRAMNT END > 0 AND M.TRNDATE < @DATE1 AND A.ACID LIKE @PLEDGER_ACID
	GROUP BY  A.ACID, M.VCHRNO, M.TRNDATE, M.BSDATE, M.VoucherStatus
) A WHERE ISNULL(VoucherStatus,'') <> 'Carry Forward'
ORDER BY A.ACID, A.TRNDATE DESC, A.VCHRNO DESC
--SELECT * FROM #BILLS

SELECT ACID, VCHRNO, TRNDATE, BSDATE, CONVERT(NUMERIC(18,2), BILL_AMNT) BILL_AMNT, 
CONVERT(NUMERIC(18,2), CASE WHEN A < 0 THEN BILL_AMNT ELSE CASE WHEN BILL_AMNT - A > 0 THEN BILL_AMNT - A ELSE 0 END END) PAID, 
CONVERT(NUMERIC(18,2), BILL_AMNT - CASE WHEN A < 0 THEN BILL_AMNT ELSE CASE WHEN BILL_AMNT - A > 0 THEN BILL_AMNT - A ELSE 0 END END) BALANCE INTO #RESULT FROM
(
	SELECT d.Paid, B.*, SUM(B.BILL_AMNT) OVER (PARTITION BY D.ACID ORDER BY SNO) -  D.Paid  A FROM #PaidBalance D JOIN #BILLS B ON D.ACID = B.ACID
) A 

SELECT * FROM
(
	SELECT R.*, DATEDIFF(d, R.TRNDATE, @DATE1) BILL_AGE, DATEADD(D, A.CrPeriod, R.TRNDATE) MaturityDate, IIF(DATEDIFF(d, R.TRNDATE, @DATE1) >= A.CRPERIOD, 'Matured','') IsMatured, 1 FLAG, 'A' [TYPE] FROM #RESULT R JOIN RMD_ACLIST A ON R.ACID = A.ACID WHERE @CHK_ShowPaidVchr = 1 OR R.BALANCE > 0
	UNION ALL 
	SELECT DISTINCT A.ACID, A.ACNAME, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, 'G' FROM #RESULT R JOIN RMD_ACLIST A ON R.ACID = A.ACID
	UNION ALL
	SELECT ACID, 'TOTAL : ', NULL, NULL, SUM(BILL_AMNT) , SUM(PAID), SUM(BALANCE), NULL, NULL, NULL, 2, 'G' FROM #RESULT GROUP BY ACID
	UNION ALL 
	SELECT DISTINCT ACID, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL, 3, 'A' FROM #RESULT
) A 
ORDER BY ACID, FLAG, TRNDATE



