CREATE OR ALTER PROCEDURE [dbo].[NSP_DEBTORS_REPORT]
--DECLARE
	@DATE1 VARCHAR(25),
	@DATE2 VARCHAR(25),
	@DIV AS VARCHAR(15) = '%',
	@FLG TINYINT = 1,
	@SHOWDETAIL TINYINT = 0,
	@OPNINGONLY TINYINT = 0,
	@EXNEGETIVE TINYINT=0,
	@CostCenter varchar(25) = '%',
	@TREE TINYINT=0,
	@DebtorOrCreditor char(1) = 'C',
	@SHOWFALLOWUPRMK TINYINT = 0,
	@FYID VARCHAR(10) = '%',
	@AREA_ID INT=0,
	@CATEGORY_ID INT =0

--SET @DATE1 = '07/15/16';SET @DATE2 = '07/16/17';SET @DIV = '%';SET @FLG = 1;SET @SHOWDETAIL =0;SET @OPNINGONLY = 0;SET @EXNEGETIVE = 0;SET @TREE =0
AS
set nocount on

if @FLG = 1
	BEGIN
		if OBJECT_ID('tempdb..#result') is not null drop table #result
				
		SELECT C.ACCODE, C.ACNAME AS PARTYNAME,  
		SUM(CASE WHEN A.VoucherType IN ('AO', 'OB') OR B.TRNDATE<@DATE1 THEN DRAMNT-CRAMNT ELSE 0 END ) OPAMNT, 
		SUM(CASE WHEN A.VoucherType NOT IN ('AO', 'OB') AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 THEN CASE WHEN LEFT(A.VCHRNO,2) IN ('SR','CN') THEN CRAMNT *-1 ELSE DRAMNT END ELSE 0 END) DRAMNT,
		SUM(CASE WHEN A.VoucherType NOT IN ('AO', 'OB')  AND B.TRNDATE BETWEEN @DATE1 AND @DATE2 THEN CASE WHEN LEFT(A.VCHRNO,2) NOT IN ('SR','CN') THEN CRAMNT ELSE 0 END ELSE 0 END) CRAMNT,
		SUM(DRAMNT) - SUM(CRAMNT) AMOUNT, A_ACID ACID 
		into #result
		FROM RMD_TRNTRAN A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION INNER JOIN RMD_ACLIST C ON A.A_ACID = C.ACID
		WHERE  A_ACID LIKE 'PA%' 
		AND PTYPE = @DebtorOrCreditor  
		AND (B.TRNDATE < =  @date2  OR B.VoucherType IN('AO','OB'))
		AND ISNULL(B.DIVISION,'') LIKE  @DIV  
		AND ISNULL(A.CostCenter,'') LIKE @CostCenter 
		AND B.PhiscalID = @FYID
		AND ((@OPNINGONLY = 0 and A.VCHRNO LIKE '%') or (@OPNINGONLY <> 0 and A.VoucherType IN ('AO', 'OB')))
		GROUP BY A_ACID,C.ACNAME,C.ACCODE
		having ((@EXNEGETIVE =0 and  (CONVERT(DECIMAL(18,2),sum(dramnt)- sum(cramnt))) <> 0) or (@EXNEGETIVE =1 and (sum(dramnt)- sum(cramnt)) > 0) or (@EXNEGETIVE =2 and (sum(dramnt)- sum(cramnt)) < 0 ) or (@EXNEGETIVE =10 and (sum(dramnt)- sum(cramnt)) like '%'))
		order by ACNAME
				 	
		IF @TREE=0
			BEGIN
				IF @SHOWFALLOWUPRMK = 0 AND @SHOWDETAIL = 0
					SELECT * FROM 
					(
					SELECT ACCODE,PARTYNAME,CONVERT(VARCHAR,CAST(ABS(OPAMNT) AS MONEY),1) + CASE WHEN OPAMNT>=0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(AMOUNT) AS MONEY),1) + CASE WHEN AMOUNT>=0 THEN ' DR' ELSE ' CR' END AMOUNT,ACID,'A' FLG FROM #RESULT
					UNION ALL
					SELECT NULL,'TOTAL >>',CONVERT(VARCHAR,CAST(ABS(SUM(OPAMNT)) AS MONEY),1) + CASE WHEN SUM(OPAMNT)>=0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(SUM(DRAMNT) AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(SUM(CRAMNT) AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(SUM(AMOUNT)) AS MONEY),1) + CASE WHEN SUM(AMOUNT) >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,'ZZZZZZZZZZZZZZ' ACID,'G' FLG FROM #RESULT
					) A ORDER BY FLG,PARTYNAME

				ELSE IF @SHOWFALLOWUPRMK = 0 AND @SHOWDETAIL = 1
					SELECT * FROM 
					(
					SELECT A.ACCODE,A.PARTYNAME,CONVERT(VARCHAR,CAST(ABS(OPAMNT) AS MONEY),1) + CASE WHEN OPAMNT>=0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(AMOUNT) AS MONEY),1) + CASE WHEN AMOUNT>=0 THEN ' DR' ELSE ' CR' END AMOUNT,B.ADDRESS,B.PHONE,C.CONTACTNAME,C.CDESIGNATION,C.CCONTACT_A,A.ACID,'A' FLG FROM #RESULT A
					INNER JOIN RMD_ACLIST B ON A.ACID = B.ACID LEFT JOIN PARTY_ADDITIONALINFO C ON A.ACID = C.ACID 
					UNION ALL
					SELECT NULL,'TOTAL >>',CONVERT(VARCHAR,CAST(ABS(SUM(OPAMNT)) AS MONEY),1)  + CASE WHEN SUM(OPAMNT) >= 0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(SUM(DRAMNT) AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(SUM(CRAMNT) AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(SUM(AMOUNT)) AS MONEY),1) + CASE WHEN SUM(AMOUNT) >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,NULL,NULL,NULL,NULL,NULL,'ZZZZZZZZZZZZZZ' ACID,'G' FLG FROM #RESULT
					) A ORDER BY FLG,PARTYNAME

				ELSE IF @SHOWFALLOWUPRMK = 1
					if @SHOWDETAIL = 0
						SELECT * FROM
						(
						SELECT ACCODE,PARTYNAME,CONVERT(VARCHAR,CAST(ABS(OPAMNT) AS MONEY),1) + CASE WHEN OPAMNT>=0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(AMOUNT) AS MONEY),1) + CASE WHEN AMOUNT>=0 THEN ' DR' ELSE ' CR' END AMOUNT,A.ACID,B.DT FWDATE,B.RMK1 FWREMARKS,B.RMK2 DEALBY,'A' FLG 
						FROM #RESULT A LEFT JOIN PFALLOWUP B ON A.ACID = B.ACID
						UNION ALL
						SELECT NULL,'TOTAL >>',CONVERT(VARCHAR,CAST(ABS(SUM(OPAMNT)) AS MONEY),1)  + CASE WHEN SUM(OPAMNT) >= 0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(SUM(DRAMNT) AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(SUM(CRAMNT) AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(SUM(AMOUNT)) AS MONEY),1) + CASE WHEN SUM(AMOUNT) >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,'ZZZZZZZZZZZZZZ' ACID,NULL DT,NULL RMK1, NULL RMK2,'G' FLG FROM #RESULT
						) A ORDER BY FLG,PARTYNAME
					ELSE IF @SHOWDETAIL = 1
						SELECT * FROM
						(
						SELECT A.ACCODE,PARTYNAME,CONVERT(VARCHAR,CAST(ABS(OPAMNT) AS MONEY),1) + CASE WHEN OPAMNT>=0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(AMOUNT) AS MONEY),1) + CASE WHEN AMOUNT>=0 THEN ' DR' ELSE ' CR' END AMOUNT,D.ADDRESS,D.PHONE,C.CONTACTNAME,C.CDESIGNATION,C.CCONTACT_A,A.ACID,B.DT FWDATE,B.RMK1 FWREMARKS,B.RMK2 DEALBY,'A' FLG 
						FROM #RESULT A LEFT JOIN PFALLOWUP B ON A.ACID = B.ACID
						INNER JOIN RMD_ACLIST D ON A.ACID = D.ACID LEFT JOIN PARTY_ADDITIONALINFO C ON A.ACID = C.ACID
						UNION ALL
						SELECT NULL,'TOTAL >>',CONVERT(VARCHAR,CAST(ABS(SUM(OPAMNT)) AS MONEY),1)  + CASE WHEN SUM(OPAMNT) >= 0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(SUM(DRAMNT) AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(SUM(CRAMNT) AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(SUM(AMOUNT)) AS MONEY),1) + CASE WHEN SUM(AMOUNT) >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,NULL,NULL,NULL,NULL,NULL,'ZZZZZZZZZZZZZZ' ACID,NULL DT,NULL RMK1, NULL RMK2,'G' FLG FROM #RESULT
						) A ORDER BY FLG,PARTYNAME		


					----ELSE
					----	SELECT A.*,B.DT,B.RMK2 DEALBY,C.* FROM #RESULT A LEFT JOIN PFALLOWUP B ON A.ACID = B.ACID CROSS APPLY DBO.GetPfallowUpRmks(A.ACID,@DATE2) C 
					----	WHERE A.ACID = C.AC ORDER BY PARTYNAME							
			END
		ELSE IF @TREE = 1
			BEGIN
				IF OBJECT_ID('TEMPDB..#TREE') is not null drop table #TREE
								
				select A.ID,A.ACID,A.PARENT,A.TYPE,A.LEVEL,A.ACCODE,A.ACNAME,B.OPAMNT,B.DRAMNT,B.CRAMNT,B.AMOUNT  
				INTO #TREE from dbo.TreeExpandFunction_Account('PX','PARTY',0,0,0,1) AS A
				LEFT JOIN #RESULT B ON A.ACID=B.ACID
									
				IF OBJECT_ID('TEMPDB..#TOTAL') is not null drop table #TOTAL
				SELECT SUM(ISNULL(OPAMNT,0)) OPAMNT,SUM(ISNULL(DRAMNT,0)) DRAMNT,SUM(ISNULL(CRAMNT,0))CRAMNT, SUM(ISNULL(AMOUNT,0))AMOUNT INTO #TOTAL FROM #TREE
				--TOTALING WITH IN TREE
				-----------------------		
				DECLARE @LVL INT
				select @LVL=MAX(LEVEL) from #TREE 
				WHILE @lvl > 0
				BEGIN
					UPDATE A SET A.OPAMNT = B.OPAMNT,A.DRAMNT= B.DRAMNT,A.CRAMNT= B.CRAMNT,A.AMOUNT= B.AMOUNT
					FROM #TREE A INNER JOIN
					(
						SELECT PARENT,SUM(ISNULL(OPAMNT,0)) OPAMNT,SUM(ISNULL(DRAMNT,0)) DRAMNT,SUM(ISNULL(CRAMNT,0))CRAMNT, SUM(ISNULL(AMOUNT,0))AMOUNT
						FROM #TREE WHERE LEVEL = @LVL GROUP BY PARENT
					) B ON A.ACID = B.PARENT

					SET @lvl = @lvl - 1;
				END

				if @SHOWDETAIL = 0
					SELECT * FROM (
						SELECT A.ACNAME,A.ACCODE,CONVERT(VARCHAR,CAST(ABS(A.OPAMNT) AS MONEY),1) + CASE WHEN A.OPAMNT >= 0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(A.CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(A.AMOUNT) AS MONEY),1) + CASE WHEN A.AMOUNT >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,A.ACID,A.TYPE,A.ID FROM #TREE A
						WHERE ABS(ISNULL(A.OPAMNT,0))+ISNULL(DRAMNT,0)+ISNULL(CRAMNT,0) <> 0
						UNION ALL
						SELECT 'TOTAL >>' ACNAME,NULL ACCODE,CONVERT(VARCHAR,CAST(OPAMNT AS MONEY),1) + CASE WHEN A.OPAMNT >= 0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(AMOUNT AS MONEY),1) + CASE WHEN A.AMOUNT >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,'ZZXXXZZZ' ACID,'G' TYPE,99999 ID FROM #TOTAL A 
					) A WHERE ID>1 ORDER BY A.ID
				ELSE
					SELECT * FROM (
						SELECT A.ACNAME,A.ACCODE,CONVERT(VARCHAR,CAST(ABS(A.OPAMNT) AS MONEY),1) + CASE WHEN A.OPAMNT >= 0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(A.CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(ABS(A.AMOUNT) AS MONEY),1) + CASE WHEN A.AMOUNT >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,B.ADDRESS,B.PHONE,C.CONTACTNAME,C.CDESIGNATION,C.CCONTACT_A,A.ACID,A.TYPE,A.ID FROM #TREE A
						INNER JOIN RMD_aCLIST B ON A.ACID = B.ACID LEFT JOIN PARTY_ADDITIONALINFO C ON A.ACID = C.ACID 
						WHERE ABS(ISNULL(A.OPAMNT,0))+ISNULL(DRAMNT,0)+ISNULL(CRAMNT,0) <> 0
						UNION ALL
						SELECT 'TOTAL >>' ACNAME,NULL ACCODE,CONVERT(VARCHAR,CAST(OPAMNT AS MONEY),1)  + CASE WHEN A.OPAMNT >= 0 THEN ' DR' ELSE ' CR' END OPAMNT,CONVERT(VARCHAR,CAST(DRAMNT AS MONEY),1) DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT,CONVERT(VARCHAR,CAST(AMOUNT AS MONEY),1) + CASE WHEN A.AMOUNT >= 0 THEN ' DR' ELSE ' CR' END AMOUNT,NULL,NULL,NULL,NULL,NULL,'ZZXXXZZZ' ACID,'G' TYPE,99999 ID FROM #TOTAL A 
					) A WHERE ID > 1 ORDER BY A.ID
			END
	END

ELSE IF @FLG = 2  -- OPENING WITH STATUS

	BEGIN
		if OBJECT_ID('tempdb..#result2') is not null drop table #result2			
			
		SELECT A.ACCODE,A.PARTYNAME,A.OPAMOUNT OPAMNT,0 DRAMNT, CASE WHEN A.OPAMOUNT > 0 THEN CASE WHEN B.CRAMOUNT>= ISNULL(A.OPAMOUNT,0) THEN A.OPAMOUNT ELSE ISNULL(B.CRAMOUNT,0) END ELSE 0 END CRAMNT, 
		CASE WHEN A.OPAMOUNT > 0 THEN CASE WHEN A.OPAMOUNT>= ISNULL(B.CRAMOUNT,0) THEN A.OPAMOUNT - ISNULL(B.CRAMOUNT,0) ELSE 0 END ELSE A.OPAMOUNT END DUEAMNT,A.ACID
		into #result2
		FROM
		( 
			SELECT C.ACCODE, C.ACNAME AS PARTYNAME,  
			SUM(DRAMNT)-SUM(CRAMNT) OPAMOUNT, A_ACID ACID 
			FROM RMD_TRNTRAN A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION 
			INNER JOIN RMD_ACLIST C ON A.A_ACID = C.ACID
			WHERE a_acid like 'PA%' AND PTYPE = @DebtorOrCreditor  AND A.VoucherType IN ('AO', 'OB') AND ISNULL(B.DIVISION,'') LIKE @DIV AND ISNULL(A.CostCenter,'') LIKE @CostCenter
			AND B.PHISCALID = @FYID
			group by a_acid,C.ACNAME,C.ACCODE HAVING   (sum(dramnt)- sum(cramnt)) <>0
		) A 
		LEFT JOIN 
		(
			SELECT A_ACID ACID,
			SUM(CASE WHEN A.VoucherType NOT IN ('AO', 'OB') THEN DRAMNT ELSE 0 END) DRAMOUNT,
			SUM(CASE WHEN A.VoucherType NOT IN ('AO', 'OB') THEN CRAMNT ELSE 0 END) CRAMOUNT,
			SUM(DRAMNT)-SUM(CRAMNT) BALANCEAMOUNT
			FROM RMD_TRNTRAN A INNER JOIN RMD_TRNMAIN B ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION 
			INNER JOIN RMD_ACLIST C ON A.A_ACID = C.ACID 
			WHERE  a_acid like 'PA%' AND PTYPE = @DebtorOrCreditor AND (B.trndate < = @date2)  AND ISNULL(B.DIVISION,'') LIKE @DIV AND ISNULL(A.CostCenter,'') LIKE @CostCenter
			AND B.PHISCALID = @FYID
			group by a_acid
		) B ON A.ACID = B.ACID ORDER BY A.PARTYNAME

		SELECT * FROM 
		(
			SELECT ACCODE,PARTYNAME
			,CONVERT(VARCHAR,CAST(ABS(OPAMNT) AS MONEY),1) + IIF(OPAMNT >= 0, ' DR', ' CR') OPAMNT
			,DRAMNT,CONVERT(VARCHAR,CAST(CRAMNT AS MONEY),1) CRAMNT
			,CONVERT(VARCHAR,CAST(ABS(DUEAMNT) AS MONEY),1)  + IIF(DUEAMNT >= 0, ' DR', ' CR') DUEMANT
			,ACID,'A' FLG FROM #result2
			UNION ALL
			SELECT NULL, 'TOTAL >>' 
			, CONVERT(VARCHAR,CAST(ABS(SUM(OPAMNT)) AS MONEY),1) + IIF(SUM(OPAMNT) >= 0, ' DR', ' CR') OPAMNT
			,0, CONVERT(VARCHAR,CAST(SUM(CRAMNT) AS MONEY),1) F
			,CONVERT(VARCHAR,CAST(ABS(SUM(DUEAMNT)) AS MONEY),1) +  IIF(SUM(DUEAMNT) >= 0, ' DR', ' CR') DUEAMNT
			,'ZZZZZZZZ' ACID,'B' FLG FROM #result2
		) A
	END
set nocount off
