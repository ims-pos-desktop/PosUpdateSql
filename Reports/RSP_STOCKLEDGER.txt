CREATE OR ALTER  PROCEDURE [dbo].[RSP_STOCKLEDGER]
--declare
@MCODE VARCHAR(20),
@WAREHOUSE VARCHAR(100), 
@DATE1 SMALLDATETIME,
@DATE2 SMALLDATETIME,
@DIVISION VARCHAR(3) = '%',
@FYID VARCHAR(10) = '%',
@CHK_GRNWise TINYINT = 0                     --CHK_GRNWise:1:0	  
AS
--set @MCODE='JS23379';set @WAREHOUSE='%';set @DATE1='2018-1-1';set @DATE2='2018-6-1'

DECLARE @RATEMODE TINYINT
SELECT @RATEMODE = enableratediscount FROM SETTING

IF OBJECT_ID('TEMPDB..#RESULTTABLE') IS NOT NULL DROP TABLE #RESULTTABLE

SELECT * INTO #RESULTTABLE FROM 
(
	SELECT NULL AS TRNDATE,NULL AS BSDATE, NULL AS VCHRNO,NULL AS CHALANNO,'OPENING STOCK' AS PARTYNAME,NULL AS VATNO,NULL AS UNIT,NULL AS BILLQTY, NULL AS BUNIT,NULL AS RATE,
	CASE WHEN (OPBAL >0) THEN OPBAL ELSE NULL END AS REALQTY_IN,
	CASE WHEN(OPBAL <0) THEN ABS(OPBAL) ELSE NULL END AS REALQTY, 
	OPBAL as bal,NULL AS REMARKS,NULL AS TERMINAL,null as division FROM 
	(
		SELECT SUM(REALQTY_IN)-SUM(REALQTY) AS OPBAL FROM DBO.RMD_TRNPROD_FN(@CHK_GRNWise,@FYID) A 
		INNER JOIN DBO.RMD_TRNMAIN_FN(@CHK_GRNWise,@FYID) B ON A.VCHRNO=B.VCHRNO AND A.DIVISION =B.DIVISION
		INNER JOIN RMD_WAREHOUSE Z ON A.WAREHOUSE = Z.NAME  
		WHERE (TRNDATE < @DATE1 OR LEFT(A.VCHRNO,2) ='OP') AND A.WAREHOUSE LIKE @WAREHOUSE AND A.DIVISION LIKE @DIVISION AND Z.ISADJUSTMENT = 0 AND MCODE=@MCODE
	) B
	UNION ALL
	SELECT TRNDATE, BSDATE, VCHRNO, CHALANNO, PARTYNAME, VATNO, UNIT, QUANTITY, C.BASEUNIT, RATE, REALQTY_IN, REALQTY_OUT, BAL, REMARKS, TERMINAL, DIVISION	FROM
	(
		SELECT  M.TRNDATE,M.BSDATE, M.VCHRNO,M.CHALANNO,M.PARTYNAME,VATNO,UNIT,
		CASE WHEN LEFT(M.VCHRNO,2) IN ('PI') THEN CASE WHEN ISNULL(N.CRATE,0) <> 0 THEN ISNULL(N.CRATE,0) ELSE N.REALRATE END ELSE N.REALRATE END AS RATE,
		CASE WHEN(REALQTY_IN=0) THEN null ELSE realqty_in END AS REALQTY_IN,
		CASE WHEN(REALQTY=0) THEN NULL ELSE REALQTY END REALQTY_OUT,
		null as bal,M.REMARKS,M.TERMINAL,m.division,N.MCODE,N.QUANTITY FROM 
		(
			SELECT A.VCHRNO,DIVISION,CHALANNO,TRNDATE,BSDATE,TRNTIME,TRNUSER,TERMINAL,PARTY,REMARKS,
			CASE WHEN (LEFT(VCHRNO,2)='IS') THEN 'ISSUE' ELSE
			CASE WHEN (LEFT(VCHRNO,2)='SA') THEN 'STOCK ADJUSTMENT' ELSE
			CASE WHEN (LEFT(VCHRNO,2)='CN') THEN 'CREDIT NOTE' ELSE 
			CASE WHEN (LEFT(VCHRNO,2)='SR') THEN 'SALES RETURN' ELSE
			CASE WHEN (LEFT(VCHRNO,2)='PR') THEN 'PURCHASE RETURN' ELSE
			CASE WHEN (LEFT(VCHRNO,2)='DM') THEN 'STOCK SETTLEMENT - ' + UPPER(TRNMODE) ELSE
			CASE WHEN (LEFT(VCHRNO,2)='TO') THEN 'BRANCH TRANSFER OUT'  ELSE
			CASE WHEN (LEFT(VCHRNO,2)='TR') THEN 'BRANCH TRANSFER RETURN'  ELSE
			CASE WHEN (LEFT(VCHRNO,2)='TI') THEN A.BILLTO ELSE
			CASE WHEN (LEFT(VCHRNO,2)='SI') THEN A.BILLTO ELSE
			B.ACNAME END END END END END END END END END END AS PARTYNAME,VATNO FROM 
			(
				SELECT VCHRNO, DIVISION, 
				CASE WHEN @RATEMODE = 1 AND VCHRNO LIKE 'TI%' THEN REFBILL ELSE CHALANNO END CHALANNO, 
				TRNDATE, BSDATE, TRNTIME,TRNUSER, TERMINAL, REMARKS,TRNMODE,
				CASE WHEN (PARAC IS NULL AND TRNAC IS NOT NULL) THEN TRNAC ELSE 
					CASE WHEN ((PARAC IS NULL AND TRNAC IS NULL)) THEN 'AT01002' ELSE PARAC END 
				END AS PARTY,BILLTO FROM DBO.RMD_TRNMAIN_FN(@CHK_GRNWise,@FYID) 
				WHERE TRNDATE >=@DATE1 AND TRNDATE <= @DATE2 AND DIVISION LIKE @DIVISION
			) A 
			LEFT JOIN RMD_ACLIST B ON A.PARTY=B.ACID 
		) M 
		INNER JOIN DBO.RMD_TRNPROD_FN(@CHK_GRNWise,@FYID) N ON M.VCHRNO=N.VCHRNO AND M.DIVISION=N.DIVISION
		INNER JOIN RMD_WAREHOUSE Z ON Z.NAME = N.WAREHOUSE 
		WHERE N.MCODE =@MCODE AND 
		WAREHOUSE LIKE @WAREHOUSE  AND Z.ISADJUSTMENT = 0 AND LEFT (M.VCHRNO,2) <> 'OP'
	) AS Z, MENUITEM C WHERE Z.MCODE = C.MCODE
) A order by A.trndate

SELECT TRNDATE,BSDATE MITI,VCHRNO VOUCHERNO,CHALANNO,PARTYNAME PARTICULAR,VATNO,
BUNIT UNIT,RATE,REALQTY_IN INQTY,REALQTY OUTQTY,SUM(ISNULL(REALQTY_IN,0)-ISNULL(REALQTY,0)) OVER(ORDER BY TRNDATE,VCHRNO RANGE UNBOUNDED PRECEDING) BALANCE,
REMARKS,TERMINAL,DIVISION,'A' ORD
FROM #RESULTTABLE 
UNION ALL
SELECT NULL TRNDATE,NULL BSDATE,NULL VCHRNO,NULL CHALANNO,'TOTAL' PARTYNAME,NULL VATNO,
NULL UNIT,NULL RATE,SUM(REALQTY_IN),SUM(REALQTY),SUM(REALQTY_IN)-SUM(REALQTY) BALANCE,
NULL,NULL,NULL,'B' ORD
FROM #RESULTTABLE ORDER BY ORD
