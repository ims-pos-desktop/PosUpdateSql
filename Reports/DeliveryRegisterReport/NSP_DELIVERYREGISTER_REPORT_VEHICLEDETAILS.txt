CREATE OR ALTER  PROCEDURE [dbo].[NSP_DELIVERYREGISTER_REPORT_VEHICLEDETAILS]  
--DECLARE   
 @DATE1 DATETIME,  
 @DATE2 DATETIME,  
 @ACID VARCHAR(25)='%',  
 @AGE NUMERIC(5,0) = 0,  
 @BILLED TINYINT = 0,  
 @DType VARCHAR(3) = '%',  
 @WARE VARCHAR(25) = '%',  
 @REPORT_TYPE TINYINT = 4,  
 @MC VARCHAR(25) ='%',  
 @PTYPE INT = 4  
AS  
  
--SET @DATE1 = '07-16-2020'  
--SET @DATE2 = '09-19-2020'  
  
  
IF @PTYPE = 100  
SET @PTYPE = NULL  
set nocount on  
IF OBJECT_ID('TEMPDB..#TRNMAIN_DL') IS NOT NULL DROP TABLE #TRNMAIN_DL  
IF OBJECT_ID('TEMPDB..#TRNPROD_DL') IS NOT NULL DROP TABLE #TRNPROD_DL  
IF OBJECT_ID('TEMPDB..#WAREHOUSE') IS NOT NULL DROP TABLE #WAREHOUSE  
IF OBJECT_ID('TEMPDB..#SalesMain') IS NOT NULL DROP TABLE #SalesMain  
  
;WITH SalesMain AS  
(  
 SELECT DISTINCT M.VCHRNO, ISNULL(M.REFBILL, P.INVOICENO) REFBILL FROM TRNMAIN M JOIN TRNPROD P ON M.VCHRNO = P.VCHRNO
 UNION ALL  
 SELECT DISTINCT M.VCHRNO, ISNULL(M.REFBILL, P.INVOICENO) REFBILL FROM ABBMAIN M JOIN ABBPROD P ON M.VCHRNO = P.VCHRNO
)  
SELECT * INTO #SalesMain FROM SalesMain  
  
SELECT * INTO #WAREHOUSE FROM RMD_WAREHOUSE WHERE ISNULL(ISVIRTUAL, 0) = 0 AND ISNULL(ISDELWARE, '') = 0  
  
SELECT * INTO #TRNMAIN_DL FROM  
(  
 SELECT DISTINCT A.VCHRNO,A.TRNDATE, A.BSDATE,DATEDIFF(DAY,A.TRNDATE,GETDATE()) AGE,ISNULL(B.ACNAME, A.BILLTO) CUSTOMER, '' [ITEM CODE],'' ITEM,'' VEHICLEREGISTRATIONNO, '' VEHICLEENGINENO, '' VEHICLECHASISNO, '' VEHICLEMODEL, '' COLOR, NULL QTY, NULL RATE, NULL AMOUNT, NULL DISCOUNT, X.INVOICENO BILNO, A.REMARKS,A.BILLTO [TAKEN GIVEN BY],'A' AS FLG,  
 A.VCHRNO VNO,1 SNO,DATEDIFF(DAY,A.TRNDATE,GETDATE()) TAT, S.VCHRNO BILLNO,B.ACNAME CST,A.TRNDATE TDATE,A.BSDATE BDATE,A.REMARKS RMK, A.BILLTO TKNBY  
 FROM RMD_TRNMAIN A INNER JOIN RMD_TRNPROD X ON A.VCHRNO = X.VCHRNO AND A.DIVISION = X.DIVISION   
 INNER JOIN MENUITEM MI ON X.MCODE = MI.MCODE  
 LEFT JOIN RMD_ACLIST B ON A.TRNAC = B.ACID   
 LEFT JOIN #SalesMain S ON S.REFBILL = A.VCHRNO  
 WHERE ((@DType = '%' AND LEFT(A.VCHRNO,2) IN ('DL','DR')) OR (@DType <> '%' AND A.VCHRNO LIKE @DType))  
 AND A.TRNDATE BETWEEN @DATE1 AND @DATE2 AND ISNULL(A.TRNAC, '') LIKE @ACID AND ((@AGE = 0 AND DATEDIFF(DAY,A.TRNDATE,GETDATE()) < 1000000) OR (@AGE <> 0 AND DATEDIFF(DAY,A.TRNDATE,GETDATE()) > @AGE))   
AND ((@BILLED = 1 AND ISNULL(S.VCHRNO,'') <> '') OR (@BILLED = 2 AND ISNULL(S.VCHRNO,'') = '')  OR (@BILLED = 0 AND ISNULL(S.VCHRNO,'') LIKE '%'))  
AND X.WAREHOUSE LIKE @WARE AND X.MCODE LIKE @MC AND ISNULL(@PTYPE, MI.PTYPE) = MI.PTYPE  
) A  
  
  
  
  
SELECT * INTO #TRNPROD_DL FROM   
(  
 SELECT '' VCHRNO,NULL TRNDATE,'' BSDATE ,NULL AGE,'' CUSTOMER,MI.MENUCODE,MI.DESCA, 
 BD.VEHICLEREGISTRATIONNO, BD.VEHICLEENGINENO, BD.VEHICLECHASISNO, BD.VEHICLEMODEL, BD.COLOR, 
 CASE WHEN LEFT(A.VCHRNO,2) <> 'DR' THEN A.QUANTITY ELSE A.QUANTITY *-1 END QUANTITY,  
 A.RATE,
 CASE WHEN LEFT(A.VCHRNO,2) <> 'DR' THEN A.AMOUNT ELSE A.AMOUNT*-1 END AMOUNT,  
 CASE WHEN LEFT(A.VCHRNO,2) <> 'DR' THEN A.DISCOUNT ELSE A.DISCOUNT*-1 END DISCOUNT,  
 '' REFBILL,'' REMARKS,'' TAKENBY,'B' AS FLG,A.VCHRNO VNO,A.SNO,DATEDIFF(DAY,C.TRN_DATE,GETDATE()) TAT,S.VCHRNO BILLNO,X.ACNAME CST,C.TRNDATE TDATE,C.BSDATE BDATE,C.REMARKS RMK, C.BILLTO TKNBY   
 FROM RMD_TRNPROD A INNER JOIN RMD_TRNMAIN C ON A.VCHRNO = C.VCHRNO AND A.DIVISION = C.DIVISION   
 JOIN MENUITEM MI ON A.MCODE = MI.MCODE  
 LEFT JOIN BARCODE_DETAIL BD ON A.BC = BD.BARCODE
 JOIN #WAREHOUSE W ON A.WAREHOUSE = W.NAME  
 LEFT JOIN RMD_ACLIST X ON C.TRNAC = X.ACID  
 LEFT JOIN #SalesMain S ON S.REFBILL = C.VCHRNO  
 WHERE  A.WAREHOUSE LIKE @WARE AND A.MCODE LIKE @MC AND ISNULL(@PTYPE, MI.PTYPE) = MI.PTYPE AND  
 ((@DType = '%' AND LEFT(A.VCHRNO,2) IN ('DL','DR')) OR (@DType <> '%' AND A.VCHRNO LIKE @DType))  
 AND C.TRNDATE BETWEEN @DATE1 AND @DATE2 AND ISNULL(C.TRNAC,'') LIKE @ACID AND ((@AGE = 0 AND DATEDIFF(DAY,C.TRNDATE,GETDATE()) < 1000000) OR (@AGE <> 0 AND DATEDIFF(DAY,C.TRNDATE,GETDATE()) > @AGE))  
 AND ((@BILLED = 1 AND ISNULL(S.VCHRNO,'') <> '') OR (@BILLED = 2 AND ISNULL(S.VCHRNO,'') = '')  OR (@BILLED = 0 AND ISNULL(S.VCHRNO,'') LIKE '%'))  
)A  
  
--SELECT * FROM #TRNPROD_DL   
  
IF @REPORT_TYPE = 1   -- ENTRY WISE  
 SELECT * FROM   
 (  
 SELECT * FROM #TRNMAIN_DL  
 UNION ALL  
 SELECT * FROM #TRNPROD_DL  
 UNION ALL  
 SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'TOTAL >>' DESCA,SUM(QUANTITY),NULL RATE,SUM(AMOUNT),SUM(DISCOUNT),NULL,NULL,NULL,'C'FLG,VNO,0 SNO,0 TAT, NULL BILLNO,CST,'01-01-90',NULL,NULL,NULL  
 FROM #TRNPROD_DL GROUP BY VNO,CST  
 UNION ALL  
 SELECT DISTINCT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'D' FLG,VNO,SNO,TAT,NULL BILLNO,CST,'01-01-90',NULL,NULL,NULL FROM #TRNMAIN_DL  
 UNION ALL  
 SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'GRAND TOTAL >>' DESCA,SUM(QUANTITY),NULL RATE,SUM(AMOUNT),SUM(DISCOUNT),NULL,NULL,NULL,'E'FLG,'ZZZZZZZZZZZZZZZZZ' VNO,0 SNO,0 TAT, NULL BILLNO,'ZZZZZZZZZZZZZZZZZZZZZZZZZ' ,'01-01-90' ,NULL,NULL,NULL  
 FROM #TRNPROD_DL   
   
 ) A ORDER BY CST,VNO,FLG,ITEM  
  
ELSE IF @REPORT_TYPE = 2   -- CUSTOMER WISE  
 SELECT * FROM   
 (  
  SELECT DISTINCT 'CUSTOMER :' VCHRNO,NULL TRNDATE,NULL BSDATE,NULL AGE, NULL ITEMCODE,A.CUSTOMER ITEM,NULL VEHICLEREGISTRATIONNO, NULL VEHICLEENGINENO, NULL VEHICLECHASISNO, NULL VEHICLEMODEL, NULL COLOR,NULL QTY, NULL RATE,NULL AMOUNT, NULL DISCOUNT,NULL BILLNO,NULL REMARKS,NULL TAKENBY,'A' FLG,A.CST,NULL TDATE FROM #TRNMAIN_DL A  
  UNION ALL  
  SELECT VNO VCHRNO,A.TDATE,A.BDATE,A.TAT,A.MENUCODE,A.DESCA,A.VEHICLEREGISTRATIONNO, A.VEHICLEENGINENO, A.VEHICLECHASISNO, A.VEHICLEMODEL, A.COLOR, A.QUANTITY,A.RATE,A.AMOUNT, A.DISCOUNT,A.BILLNO,A.RMK,A.TKNBY,'B' FLG,A.CST,A.TDATE FROM #TRNPROD_DL A   
  UNION ALL  
  SELECT NULL VCHRNO,NULL TDATE,NULL BDATE,NULL TAT,NULL MENUCODE,NULL,NULL,NULL,NULL,NULL,'TOTAL >>' DESCA,SUM(A.QUANTITY)QTY ,NULL RATE,SUM(A.AMOUNT) AMOUNT, SUM(A.DISCOUNT) DISCOUNT,NULL BILLNO,NULL RMK,NULL TKNBY,'C' FLG,A.CST,NULL TDATE FROM #TRNPROD_DL A GROUP BY A.CST  
  UNION ALL  
  SELECT DISTINCT NULL VCHRNO,NULL TRNDATE,NULL BSDATE,NULL AGE,NULL,NULL,NULL,NULL,NULL, NULL ITEMCODE,NULL ITEM,NULL QTY, NULL RATE,NULL AMOUNT, NULL DISCOUNT,NULL BILLNO,NULL REMARKS,NULL TAKENBY,'D' FLG,A.CST,NULL TDATE FROM #TRNMAIN_DL A  
  UNION ALL  
  SELECT NULL VCHRNO,NULL TDATE,NULL BDATE,NULL TAT,NULL MENUCODE,NULL,NULL,NULL,NULL,NULL,'GRAND TOTAL >>' DESCA,SUM(A.QUANTITY)QTY ,NULL RATE,SUM(A.AMOUNT) AMOUNT, SUM(A.DISCOUNT) DISCOUNT,NULL BILLNO,NULL RMK,NULL TKNBY,'E' FLG,'ZZZZZZZZZZZZ' CST,NULL TDATE FROM #TRNPROD_DL A  
 ) A ORDER BY CST,FLG,TDATE  
  
ELSE IF @REPORT_TYPE = 3   -- ITEM WISE  
 SELECT * FROM   
 (  
 SELECT DISTINCT 'ITEM :' VCHRNO,NULL TRNDATE,NULL BSDATE,NULL AGE, A.MENUCODE ITEMCODE,A.DESCA ITEM,'' VEHICLEREGISTRATIONNO, '' VEHICLEENGINENO, '' VEHICLECHASISNO, '' VEHICLEMODEL,'' COLOR, NULL QTY, NULL RATE,NULL AMOUNT, NULL DISCOUNT,NULL BILLNO,NULL REMARKS,NULL TAKENBY,'A' FLG,A.DESCA MC FROM #TRNPROD_DL A  
 UNION ALL  
 SELECT VNO VCHRNO,A.TDATE,A.BDATE,A.TAT,NULL MENUCODE,A.CST DESCA,A.VEHICLEREGISTRATIONNO, A.VEHICLEENGINENO, A.VEHICLECHASISNO, A.VEHICLEMODEL, A.COLOR, A.QUANTITY,A.RATE,A.AMOUNT, A.DISCOUNT,A.BILLNO,A.RMK,A.TKNBY,'B' FLG,A.DESCA MC FROM #TRNPROD_DL A   
 UNION ALL  
 SELECT NULL VCHRNO,NULL TDATE,NULL BDATE,NULL TAT,NULL MENUCODE,NULL,NULL,NULL,NULL,NULL,'TOTAL >>' DESCA,SUM(A.QUANTITY)QTY ,NULL RATE,SUM(A.AMOUNT) AMOUNT, SUM(A.DISCOUNT) DISCOUNT,NULL BILLNO,NULL RMK,NULL TKNBY,'C' FLG,A.DESCA MC FROM #TRNPROD_DL A GROUP BY A.DESCA  
 UNION ALL  
 SELECT DISTINCT NULL VCHRNO,NULL TRNDATE,NULL BSDATE,NULL AGE, NULL ITEMCODE,NULL ITEM,NULL,NULL,NULL,NULL,NULL,NULL QTY, NULL RATE,NULL AMOUNT, NULL DISCOUNT,NULL BILLNO,NULL REMARKS,NULL TAKENBY,'D' FLG,A.DESCA MC FROM #TRNPROD_DL A  
 UNION ALL  
 SELECT NULL VCHRNO,NULL TDATE,NULL BDATE,NULL TAT,NULL MENUCODE,NULL,NULL,NULL,NULL,NULL,'GRAND TOTAL >>' DESCA,SUM(A.QUANTITY)QTY ,NULL RATE,SUM(A.AMOUNT) AMOUNT, SUM(A.DISCOUNT) DISCOUNT,NULL BILLNO,NULL RMK,NULL TKNBY,'E' FLG,'ZZZZZZZZZZZZZZZZZZZZ' MC FROM #TRNPROD_DL A   
 ) A ORDER BY MC,FLG  
  
ELSE IF @REPORT_TYPE = 4   -- CUSTOMER WISE (SUMMAREY REPORT)  
 SELECT * FROM   
 (  
  SELECT DISTINCT A.CST CUSTOMER,NULL ITEMCODE,NULL DESCA,NULL VEHICLEREGISTRATIONNO, NULL VEHICLEENGINENO, NULL VEHICLECHASISNO, NULL VEHICLEMODEL, NULL COLOR,NULL DELQTY,NULL DRETURNQTY,NULL NETQTY, NULL RATE,NULL AMOUNT, NULL DISCOUNT,'A' FLG,A.CST FROM #TRNPROD_DL A GROUP BY A.MENUCODE,A.DESCA,A.CST HAVING SUM(QUANTITY) <> 0  
  UNION ALL  
  SELECT NULL VNO,A.MENUCODE,A.DESCA,A.VEHICLEREGISTRATIONNO, A.VEHICLEENGINENO, A.VEHICLECHASISNO, A.VEHICLEMODEL, A.COLOR,SUM(CASE WHEN LEFT(VNO,2) = 'DL' THEN A.QUANTITY ELSE 0 END) DQTY,SUM(CASE WHEN A.VNO LIKE 'DR%' THEN ABS(A.QUANTITY) ELSE 0 END) DRQTY,SUM(QUANTITY) NETQTY,CASE WHEN SUM(QUANTITY) = 0 THEN NULL ELSE SUM(AMOUNT)/SUM(QUANTITY) END RATE,SUM(A.AMOUNT) AMOUNT, SUM(A.DISCOUNT) DISCOUNT,'B' FLG,A.CST FROM #TRNPROD_DL A   
  GROUP BY A.MENUCODE,A.DESCA,A.CST,A.VEHICLEREGISTRATIONNO, A.VEHICLEENGINENO, A.VEHICLECHASISNO, A.VEHICLEMODEL, A.COLOR HAVING SUM(QUANTITY) <> 0  
  UNION ALL  
  SELECT NULL VCHRNO,NULL MENUCODE,NULL,NULL,NULL,NULL,NULL,'TOTAL >>' DESCA,SUM(CASE WHEN VNO LIKE 'DL%' THEN A.QUANTITY ELSE 0 END) DQTY,SUM(CASE WHEN VNO LIKE 'DR%' THEN ABS(A.QUANTITY) ELSE 0 END) DRQTY,SUM(QUANTITY) NETQTY,NULL RATE,SUM(A.AMOUNT) AMOUNT, SUM(A.DISCOUNT) DISCOUNT,'C' FLG,A.CST TDATE FROM #TRNPROD_DL A GROUP BY A.CST  HAVING SUM(QUANTITY) <> 0  
  UNION ALL  
  SELECT DISTINCT NULL VCHRNO,NULL ITEMCODE,NULL ITEM,NULL,NULL,NULL,NULL,NULL,NULL DQTY,NULL RQTY,NULL NQTY, NULL RATE,NULL AMOUNT, NULL DISCOUNT,'D' FLG,A.CST FROM #TRNPROD_DL A GROUP BY A.MENUCODE,A.DESCA,A.CST HAVING SUM(QUANTITY) <> 0  
  UNION ALL  
  SELECT NULL VCHRNO,NULL MENUCODE,NULL,NULL,NULL,NULL,NULL,'GRAND TOTAL >>' DESCA,NULL,NULL,SUM(A.QUANTITY) QTY,NULL RATE,SUM(A.AMOUNT) AMOUNT, SUM(A.DISCOUNT) DISCOUNT,'E' FLG,'ZZZZZZZZZZZZ' CST FROM #TRNPROD_DL A  
 ) A ORDER BY CST,FLG,DESCA  
  
 set nocount OFF

