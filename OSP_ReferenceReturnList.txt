CREATE OR ALTER PROC OSP_ReferenceReturnList
--DECLARE 
@VCHRNO VARCHAR(25),
@VoucherType VARCHAR(2),
@ReturnVoucherType VARCHAR(2),
@NoteVoucherType VARCHAR(2)
AS
--SET @VCHRNO = 'PI1-MMM-77/78'
--SET @VoucherType = 'PI'
--SET @ReturnVoucherType = 'SR'
--SET @NoteVoucherType = 'DN'
SELECT MCODE, BC, UNIT, ITEMDESC DESCA, ALTRATE RATE, SNO, BATCH,AMOUNT, EXPDATE, MENUCODE , ISVAT, CONFACTOR,
TRANQTY, RETURNQTY, NOTEQTY, (TRANQTY-RETURNQTY-NOTEQTY) Quantity, (TRANQTY-RETURNQTY-NOTEQTY) Qty FROM 
(
	SELECT TP.MCODE, TP.BC, TP.ITEMDESC, TP.Quantity, TP.RATE, TP.ALTUNIT UNIT, TP.REALRATE, TP.ALTRATE, TP.SNO, TP.BATCH, TP.EXPDATE,TP.AMOUNT,  MI.MENUCODE, MI.VAT ISVAT, ISNULL(UOM.CONFACTOR,1) CONFACTOR, 
	ABS(TP.ALTQTY_IN-TP.AltQty) TRANQTY, 
	ABS(ISNULL(SUM(ISNULL(TP_R.AltQty, 0)-ISNULL(TP_R.ALTQTY_IN, 0)), 0)) RETURNQTY, 
	ABS(SUM(ISNULL(TP_N.ALTQTY, 0)-ISNULL(TP_N.ALTQTY_IN, 0))) NOTEQTY 
	FROM RMD_TRNMAIN TM WITH (NOLOCK) 
	INNER JOIN RMD_TRNPROD TP WITH (NOLOCK) ON TM.VCHRNO=TP.VCHRNO AND TM.DIVISION=TP.DIVISION AND TM.PhiscalID=TP.PhiscalID
	JOIN MENUITEM MI WITH (NOLOCK) ON TP.MCODE=MI.MCODE
	LEFT JOIN MULTIALTUNIT UOM WITH (NOLOCK) ON TP.MCODE = UOM.MCODE AND TP.ALTUNIT = UOM.ALTUNIT
	LEFT JOIN 
	(
		SELECT * FROM RMD_TRNPROD WITH (NOLOCK) WHERE VoucherType = @ReturnVoucherType AND (ISNULL(REALQTY, 0)-ISNULL(ALTQTY_IN, 0))>=0 
	) TP_R ON TP.DIVISION=TP_R.DIVISION AND TP.PhiscalID=TP_R.PhiscalID AND TP.VCHRNO=TP_R.INVOICENO AND TP.MCODE=TP_R.MCODE AND TP.WAREHOUSE=TP_R.WAREHOUSE
	LEFT JOIN 
	(
		SELECT * FROM RMD_TRNPROD WITH (NOLOCK) WHERE VoucherType = @NoteVoucherType AND (ISNULL(REALQTY, 0)-ISNULL(ALTQTY_IN, 0))>=0 
	) TP_N ON TP.DIVISION=TP_N.DIVISION AND TP.PhiscalID=TP_N.PhiscalID AND TP.VCHRNO=TP_N.INVOICENO AND TP.MCODE=TP_N.MCODE AND TP.WAREHOUSE=TP_N.WAREHOUSE	  
	WHERE TP.VCHRNO = @VCHRNO AND TM.VoucherType = @VoucherType
	GROUP BY TP.MCODE, TP.BC, TP.UNIT, TP.ITEMDESC, TP.Quantity, TP.RATE, TP.ALTUNIT, TP.REALRATE, TP.ALTRATE,TP.AMOUNT, TP.SNO, TP.BATCH, TP.EXPDATE,  MI.MENUCODE, MI.VAT, ISNULL(UOM.CONFACTOR,1),(TP.ALTQTY_IN-TP.AltQty)
) AS A 
WHERE (TRANQTY-RETURNQTY-NOTEQTY)>0