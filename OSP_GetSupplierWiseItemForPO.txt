CREATE OR ALTER PROC OSP_GetSupplierWiseItemForPO
@SUPCODE VARCHAR(25),
@PhiscalID VARCHAR(10),
@RateGroupId INT
AS
DECLARE @BCStock BIT
SELECT @BCStock = CONVERT(BIT,COALESCE(EnableBarcodeDetails,0)) & CONVERT(BIT,COALESCE(HasVehicleSale,0)) FROM SETTING

SELECT *, (SELECT SUM(RealQty - REALQTY_IN) FROM RMD_TRNMAIN c INNER JOIN RMD_SALESPROD B ON c.VCHRNO=B.VCHRNO AND c.DIVISION = B.DIVISION AND c.PhiscalID= B.PhiscalID WHERE B.MCODE =a.mcode AND C.VoucherType IN ('SI', 'TI', 'CN') AND C.TRNDATE >= A.LastPurchaseDate) PeriodicSalesQty 
FROM
(
	SELECT BC.BCODE BC, a.mcode, A.menucode,A.desca ITEMDESC, A.Prate_A rate, A.Baseunit  UNIT,A.Mcat,A.MGROUP, CAST(ISNULL(C.RG_RATE, A.RATE_A) * IIF(A.VAT = 1, 1.13, 1) AS Numeric(18,2)) SPRICE, A.VAT ISVAT, A.LPDATE LastPurchaseDate,S.STOCK	
	FROM menuitem a WITH (NOLOCK) LEFT JOIN BARCODE BC WITH (NOLOCK) ON IIF(@BCStock=1,A.MCODE,'') = BC.MCODE 
	OUTER APPLY dbo.fnGetRateGroup(A.MCODE, A.RATE_A, @RateGroupId) C
	LEFT JOIN
	(
		SELECT MCODE, IIF(@BCStock=1,BC,'') BC, SUM(REALQTY_IN - REALQTY) STOCK FROM RMD_TRNPROD WITH (NOLOCK) WHERE PhiscalID = @PhiscalID GROUP BY MCODE, IIF(@BCStock=1,BC,'')
	) S ON A.MCODE = S.MCODE AND IIF(@BCStock=1,BC.BCODE,'') = S.BC
	where A.SUPCODE = @SUPCODE AND A.IsActive = 1
) A
