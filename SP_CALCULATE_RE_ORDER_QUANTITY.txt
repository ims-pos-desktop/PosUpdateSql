CREATE OR ALTER PROC [dbo].[SP_CALCULATE_RE_ORDER_QUANTITY]
@DIVISION  VARCHAR(3),
@WAREHOUSE VARCHAR(25),
@DATE1 DATETIME,
@DATE2 DATETIME,
@ITEMTYPE VARCHAR(25),
@COVERAGEPERIOD INT, 
@LEADPERIOD INT
AS

--DECLARE @DIVISION  VARCHAR(3)= 'SMK'
--DECLARE @WAREHOUSE VARCHAR(25) = 'SAMAKHUSI2'
--DECLARE @DATE1 DATETIME = '2020-03-08'
--DECLARE @DATE2 DATETIME = '2020-03-15'
--DECLARE @ITEMTYPE VARCHAR(25) = 'Perishable'
--DECLARE @COVERAGEPERIOD INT = 7
--DECLARE @LEADPERIOD INT = 0
SET NOCOUNT ON
IF OBJECT_ID('TEMPDB..#STOCK') IS NOT NULL
DROP TABLE #STOCK
IF OBJECT_ID('TEMPDB..#SALES') IS NOT NULL
DROP TABLE #SALES
IF OBJECT_ID('TEMPDB..#MENUITEM') IS NOT NULL
DROP TABLE #MENUITEM

DECLARE @SAMPLEPERIOD INT
SELECT @SAMPLEPERIOD = DATEDIFF(D, @DATE1, @DATE2)
DECLARE @NATURETYPE INT = 0
IF @ITEMTYPE = 'Perishable' SET @NATURETYPE = 7

SELECT MI.MCODE, ISNULL(STOCK,0) STOCK INTO #STOCK FROM MENUITEM MI
JOIN PTYPE T ON MI.PTYPE = T.PTYPEID
LEFT JOIN 
(
	SELECT TP.MCODE, SUM (REALQTY_IN-REALQTY) STOCK FROM RMD_TRNMAIN TM JOIN RMD_TRNPROD TP ON TM.VCHRNO = TP.VCHRNO
	WHERE TM.DIVISION = @DIVISION AND TP.WAREHOUSE = @WAREHOUSE
	GROUP BY  TP.MCODE
) TP ON MI.MCODE = TP.MCODE
WHERE MI.PTYPE < 10 AND T.NATURETYPE = @NATURETYPE

SELECT MI.MCODE, ISNULL(TOTAL_SALES,0) TOTAL_SALES, ISNULL(AVG_SALES,0) AVG_SALES  INTO #SALES  FROM MENUITEM MI
JOIN PTYPE T ON MI.PTYPE = T.PTYPEID
LEFT JOIN
(
	SELECT TP.MCODE, SUM (REALQTY-REALQTY_IN) TOTAL_SALES, CEILING(SUM(REALQTY-REALQTY_IN)/@SAMPLEPERIOD) AVG_SALES 
	FROM RMD_TRNMAIN TM JOIN RMD_TRNPROD TP ON TM.VCHRNO = TP.VCHRNO
	WHERE TM.TRNDATE BETWEEN @DATE1 AND @DATE2 AND TM.DIVISION = @DIVISION
	AND TP.WAREHOUSE = @WAREHOUSE AND TM.VoucherType IN ('SI', 'TI', 'CN')
	GROUP BY  TP.MCODE
) TP ON MI.MCODE = TP.MCODE
WHERE MI.PTYPE < 10 AND T.NATURETYPE = @NATURETYPE

SELECT MI.MCODE, MI.MENUCODE, MI.DESCA, ISNULL(MSL.MINLEVEL, MI.MINLEVEL) MINLEVEL, ISNULL(MSL.MAXLEVEL, MI.MAXLEVEL) MAXLEVEL ,
ISNULL(MSL.ROLEVEL,MI.ROLEVEL) ROLEVEL, CASE WHEN @COVERAGEPERIOD > @LEADPERIOD THEN @COVERAGEPERIOD ELSE @LEADPERIOD END ShelfLife INTO #MENUITEM  
FROM MENUITEM MI
JOIN PTYPE T ON MI.PTYPE = T.PTYPEID
LEFT JOIN MULTISTOCKLEVEL MSL ON MSL.MCODE = MI.MCODE AND MSL.WAREHOUSE = @WAREHOUSE
WHERE MI.[TYPE] = 'A' AND MI.PTYPE < 10 AND T.NATURETYPE = @NATURETYPE

--select * from #menuitem
--selecT * from #SALES
--SELECT * FROM #STOCK

SELECT MI.MCODE, MI.MENUCODE, MI.DESCA, MINLEVEL, MAXLEVEL, ROLEVEL, S.TOTAL_SALES, S.AVG_SALES, I.STOCK,
(AVG_SALES * ShelfLife + MINLEVEL - STOCK) ROQTY FROM #MENUITEM MI
LEFT JOIN #SALES S ON MI.MCODE = S.MCODE
LEFT JOIN #STOCK I ON MI.MCODE = I.MCODE
WHERE AVG_SALES * ShelfLife + MINLEVEL > STOCK
ORDER BY TOTAL_SALES DESC

SET NOCOUNT OFF
