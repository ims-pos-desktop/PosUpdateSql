CREATE OR ALTER PROC [dbo].[OSP_GetCounterOrderAdvance]
@OrderNo VARCHAR(25),
@AdvanceAc VARCHAR(25)
AS
SELECT M.PhiscalID FISCALID,M.VCHRNO, M.ORDERNO ORDNO, M.TRNDATE,M.NETAMNT, M.TRNTIME,M.MEMBERNO,M.DELIVERYDATE ESTIMATEDDELIVERY,M.REMARKS,M.TRNUSER,M.DELIVERYADDRESS, M.CHALANNO, M.CustomerName,
M.MOBILENO, IIF(M.STATUS = 8,ISNULL(B.ADVANCE, 0),M.ADVANCE) ADVANCE, M.TRNMODE, P.ITEMDESC, P.MCODE, P.BC ,AC.ACID,AC.ACNAME,
AC.ADDRESS,AC.PHONE, P.ALTQTY - ISNULL(T.QUANTITY, 0) QUANTITY, P.ALTRATE RATE, (P.ALTQTY - ISNULL(T.QUANTITY, 0)) * P.ALTRATE AMOUNT, MT.DESCA,AC.VATNO PANNo,
ISNULL(P.INDDISCOUNTRATE,0) INDDISRATE, M.DCRATE * 100 DCRATE, P.ALTUNIT,P.INDDISCOUNTRATE, CONVERT(INT, P.SNO) SNO
from RMD_ORDERMAIN M 
join RMD_ORDERPROD P on P.VCHRNO = M.VCHRNO 
join MENUITEM MT on P.MCODE = MT.MCODE 
LEFT JOIN RMD_ACLIST AC ON M.TRNAC = AC.ACID
LEFT JOIN
( 
	SELECT TM.REFORDBILL, TP.MCODE, SUM(TP.Quantity) Quantity FROM RMD_TRNMAIN TM 
	JOIN RMD_TRNPROD TP ON TM.VCHRNO = TP.VCHRNO         
	GROUP BY TM.REFORDBILL, TP.MCODE
) T ON M.VCHRNO = T.REFORDBILL AND P.MCODE = T.MCODE 
LEFT JOIN
(
	select RTM.VCHRNO,  SUM(ATN.CRAMNT - ATN.DRAMNT) ADVANCE from RMD_ORDERMAIN RTM 
	join RMD_TRNMAIN AC on RTM.VCHRNO = AC.REFORDBILL
	join RMD_TRNTRAN ATN on AC.VCHRNO = ATN.VCHRNO
	WHERE ATN.A_ACID= @AdvanceAc and RTM.VCHRNO = @OrderNo
	GROUP BY RTM.VCHRNO
) B ON B.VCHRNO = M.VCHRNO
WHERE P.QUANTITY - isnull(T.Quantity, 0) > 0 AND M.VCHRNO LIKE 'SO%'AND M.ORDERNO = @OrderNo
